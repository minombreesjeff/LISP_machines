// (C) Copyright 1997, Christopher R. Vincent.  ç// All Rights Reserved.ç// cvince@mit.eduç// http://mit.edu/cvince/çç// to do:ç// handle more than absolute urls?ç// expand two uses of the same dir separately?ççimport java.applet.Applet;çimport java.awt.*;çimport java.util.*;çimport java.net.URL;çimport java.net.MalformedURLException;ççpublic class hdir extends java.applet.Applet implements Runnable {ç  Thread engine = null;ç  item[] items;ç  dir[] dirs;ç  node[] top;ç  int fontSize = 10;ç  Color fontColor = Color.black;ç  Color markerColor = Color.black;ç  Font nameFont;                    // display fontç  int ySpace = 15;                  // space between entriesç  int xSpace = 15;                  // indentation spaceç  Vector display = new Vector();    // nodes currently displayedç  boolean full_repaint = true;ç  boolean debug = false;ç  int hdirMode = 0;                 // 0 for normal, ç                                    // -1 for unrecoverable errorç  çpublic String getAppletInfo() {ç  return "(C) Copyright 1997, Christopher R. Vincent. All Rights Reserved.";ç}ççpublic void reportError(String s) {ç  hdirMode = -1;ç  full_repaint = true;ç  System.out.println(s);ç}ççpublic void reportError(Exception e, String s) {ç  hdirMode = -1;ç  full_repaint = true;ç  System.out.println(s);ç  e.printStackTrace();ç}ççpublic String[] parseCommaList(String s) throws Exception {ç  // Parse a comma-separated list of strings.  Leading andç  // trailing whitespace ignored in each item.ç  Vector resultVec = new Vector();ç  int start;ç  int end = -1;ç  while (end < s.length()) {ç    start = end+1;ç    end = s.indexOf(",",start);ç    if (end == -1)ç      end = s.length();ç    resultVec.addElement(s.substring(start,end).trim());ç  }ç  String[] res = new String[resultVec.size()];ç  resultVec.copyInto(res);ç  return res;ç}ççpublic Color parseHexColor(String s) {ç  // Parse a color in the form of #rrggbb.ç  return new Color(Integer.parseInt(s.substring(1), 16));  ç}ççpublic void parseItms() {ç  String s = null;ç  int i = 0;ç  String[] els = null;ç  URL u = null;ç  Vector nodeVec = new Vector(); ç  try {ç    while (true) {ç      s = getParameter("itm"+i);ç      if (s == null) break;ç      els = parseCommaList(s);ç      if (els.length != 3)çâreportError("Wrong number of elements in itm"+i+": "+s);ç      if (els[1].length() != 0) {çâtry { u = new URL(els[1]); }çâcatch(MalformedURLException e) {çâ  reportError(e,"Malformed URL in itm"+i+": "+s); }çâif (els[2].length() == 0)çâ  els[2] = "_self";ç      }ç      nodeVec.addElement(new item(els[0],u,els[2]));ç      if (debug) System.out.println("itm"+i);ç      i++;ç    }ç  }ç  catch(Exception e) {ç    reportError(e,"Unable to parse itm"+i+": "+s); }ç  items = new item[nodeVec.size()];ç  nodeVec.copyInto(items); ç}ççpublic void parseDirs() {ç  int params = 4;ç  String s = null;ç  int i = 0;ç  int j = 0;ç  int idx = 0;ç  String[] els = null;ç  URL u = null;ç  node[] nodes = null;ç  Vector nodeVec = new Vector(); ç  try {ç    while (true) {ç      s = getParameter("dir"+i);ç      if (s == null) break;ç      els = parseCommaList(s);ç      if (els.length < params)çâreportError("Too few elements in dir"+i+": "+s);ç      if (els[1].length() != 0) {çâtry { u = new URL(els[1]); }çâcatch(MalformedURLException e) {çâ  reportError(e,"Malformed URL in dir"+i+": "+s); }ç      }ç      if (els[2].length() == 0)çâels[2] = "_self";ç      boolean open = els[3].equals("yes");ç      nodes = new node[els.length-params];ç      for(j = params; j < els.length; j++) {çâidx = Integer.valueOf(els[j].substring(3)).intValue();çâif (els[j].substring(0,3).equals("itm"))çâ  nodes[j-params] = items[idx];çâelseçâ  nodes[j-params] = (node)nodeVec.elementAt(idx);ç      }ç      nodeVec.addElement(new dir(els[0],u,els[2],nodes,open)); ç      if (debug) System.out.println("dir"+i); ç      i++;ç    }ç  }ç  catch(Exception e) {ç    reportError(e,"Unable to parse dir"+i+": "+s); }ç  dirs = new dir[nodeVec.size()];ç  nodeVec.copyInto(dirs); ç}ççpublic void parseTop() {ç  String s = getParameter("top");ç  try {ç    if (s == null)ç      reportError("No top parameter supplied.");ç    String[] els = parseCommaList(s);ç    if (els.length == 0)ç      reportError("No top nodes defined.");ç    int idx;ç    top = new node[els.length];ç    for(int i = 0; i < els.length; i++) {ç      idx = Integer.valueOf(els[i].substring(3)).intValue();ç      if (s.substring(0,3).equals("itm"))çâtop[i] = items[idx];ç      elseçâtop[i] = dirs[idx];ç    } ç    if (debug) System.out.println("top"); ç  }ç  catch(Exception e) {ç    reportError(e,"Unable to parse top: "+s); }ç}ççpublic void init() {ç  try {ç    String s;   ç    s = getParameter("debug");ç    if (s != null)ç      debug = s.equals("yes");ç    parseItms();ç    parseDirs();ç    parseTop();ç    int i = 0;ç    // set up displayç    s = getParameter("bgcolor");ç    if (s != null)ç      setBackground(parseHexColor(s));ç    s = getParameter("fontcolor");ç    if (s != null)ç      fontColor = parseHexColor(s);ç    s = getParameter("markercolor");ç    if (s != null)ç      markerColor = parseHexColor(s);ç    s = getParameter("xspace");ç    if (s != null)ç      xSpace = Integer.valueOf(s).intValue();ç    s = getParameter("yspace");ç    if (s != null)ç      ySpace = Integer.valueOf(s).intValue();ç    s = getParameter("fontsize");ç    if (s != null)ç      fontSize = Integer.valueOf(s).intValue();ç    nameFont = new Font("Dialog", Font.PLAIN, fontSize);ç  }  ç  catch (Exception e) {ç    reportError(e,"Initialization error."); }ç}ççpublic void registerNode(node n, int x, int y) {ç  display.addElement(new nodeReg(n,x,y));ç}ççpublic void showDocument(URL u, String f) {ç  if (debug) System.out.println(u.toExternalForm()+" -> "+f);ç  getAppletContext().showDocument(u,f);ç}ççpublic void paint(Graphics g) {ç  if (hdirMode == -1) {ç    setBackground(Color.black);ç    g.setColor(Color.red);ç    g.drawString("fatal error",10,20);ç    full_repaint = false;ç    return;ç  }ç  g.setFont(nameFont);ç  display.removeAllElements();ç  int ypos = 0;ç  for (int i = 0; i < top.length; i++) {ç    ypos = top[i].paintNode(this,g,20,ypos+ySpace,xSpace,ySpace);ç  }ç  full_repaint = false;ç}ççpublic boolean mouseMove(java.awt.Event evt, int x, int y) {ç  if (hdirMode == -1)ç    return true;ç  int line = (y - (ySpace/2)) / ySpace;ç  if (line > display.size()-1) {ç    showStatus(null);ç    return true; }ç  nodeReg reg = (nodeReg)display.elementAt(line);ç  if (x < reg.x)ç    reg.node.leftStatus(this);ç  else ç    reg.node.rightStatus(this);ç  return true;ç}  ççpublic boolean mouseDown(java.awt.Event evt, int x, int y) {ç  if (hdirMode == -1)ç    return true;ç  int line = (y - (ySpace/2)) / ySpace;ç  if (line > display.size()-1) return true;ç  nodeReg reg = (nodeReg)display.elementAt(line);ç  if (x < reg.x)ç    reg.node.leftAction(this);ç  else ç    reg.node.rightAction(this);ç  full_repaint = true;ç  return true;ç}ç  çpublic void start() {ç  if (engine == null) {ç    engine = new Thread(this);ç    engine.start(); }ç}ç  çpublic void stop() {ç  if (engine != null && engine.isAlive()) {ç    engine.stop(); }ç  engine = null;ç}ç  çpublic void run() {ç  Thread me = Thread.currentThread();ç  while (engine == me) {ç    try {Thread.currentThread().sleep(100);} ç    catch (InterruptedException e){}ç    if (full_repaint)ç      repaint();ç  }ç}ç  ç}çççclass nodeReg {çpublic node node;çpublic int x;çpublic int y;çç  nodeReg(node n, int x1, int y1) {ç    node = n;ç    x = x1;ç    y = y1;ç  }çç}çççclass node {çpublic String name;çpublic URL url;çpublic String frame;ççpublic int paintNode(hdir hd, Graphics g, int x, int y, int xdiff, int ydiff) {ç  // Returns y coord of last node drawn.ç  return y;ç}ççpublic void leftAction(hdir hd) {}ççpublic void rightAction(hdir hd) {ç  if (url != null)ç    hd.showDocument(url,frame);ç}ççpublic void leftStatus(hdir hd) {ç  hd.showStatus(null);ç}ççpublic void rightStatus(hdir hd) {ç  if (url == null)ç    hd.showStatus(null);ç  elseç    hd.showStatus(url.toExternalForm());ç}çç}ççclass item extends node {ç  ç  item(String n, URL u, String f) {ç    name = n;ç    url = u;ç    frame = f;ç  }ççpublic int paintNode(hdir hd, Graphics g, int x, int y, int xdiff, int ydiff) {ç  g.setColor(hd.fontColor);ç  g.drawString(name,x,y);ç  hd.registerNode(this,x,y);ç  return y;ç}çç}ççclass dir extends node {çpublic node[] nodes; çpublic boolean expand;çç  dir(String n, URL u, String f, node[] nds, boolean exp) {ç    name = n;ç    url = u;ç    frame = f;ç    nodes = nds;ç    expand = exp;ç  }ççpublic void paintMarker(Graphics g, boolean open, Color c, int x, int y) {ç  g.setColor(c);ç  Polygon p = new Polygon();ç  if (open) {ç    p.addPoint(x-13,y-6);ç    p.addPoint(x-9,y-2);ç    p.addPoint(x-5,y-6); }ç  else {ç    p.addPoint(x-11,y-9);ç    p.addPoint(x-11,y-1);ç    p.addPoint(x-7,y-5); }ç  g.fillPolygon(p);ç}ççpublic int paintNode(hdir hd, Graphics g, int x, int y, int xdiff, int ydiff) {ç  paintMarker(g,expand,hd.markerColor,x,y);ç  g.setColor(hd.fontColor);ç  g.drawString(name,x,y);ç  hd.registerNode(this,x,y);ç  if (expand) {ç    int last = y;ç    for (int i = 0; i < nodes.length; i++)ç      last = nodes[i].paintNode(hd,g,x+xdiff,last+ydiff,xdiff,ydiff);ç    return last; }ç  elseç    return y;ç}ççpublic void leftAction(hdir hd) {ç  expand = !expand;ç}ç  ç}ç