;;; Lisp Machine mail reader -*- Base: 8; Mode: LISP; Package: ZWEI -*- 
;;; System templates
;;;>
;;;> *****************************************************************************************
;;;> ** (c) Copyright 1998-1982 Symbolics, Inc.  All rights reserved.
;;;> ** Portions of font library Copyright (c) 1984 Bitstream, Inc.  All Rights Reserved.
;;;>
;;;>    The software, data, and information contained herein are proprietary to,
;;;> and comprise valuable trade secrets of, Symbolics, Inc., which intends 
;;;> to keep such software, data, and information confidential and to preserve them
;;;> as trade secrets.  They are given in confidence by Symbolics pursuant 
;;;> to a written license agreement, and may be used, copied, transmitted, and stored
;;;> only in accordance with the terms of such license.
;;;> 
;;;> Symbolics, Symbolics 3600, Symbolics 3675, Symbolics 3630, Symbolics 3640,
;;;> Symbolics 3645, Symbolics 3650, Symbolics 3653, Symbolics 3620, Symbolics 3610,
;;;> Zetalisp, Open Genera, Virtual Lisp Machine, VLM, Wheels, Dynamic Windows,
;;;> SmartStore, Semanticue, Frame-Up, Firewall, Document Examiner,
;;;> Delivery Document Examiner, "Your Next Step in Computing", Ivory, MacIvory,
;;;> MacIvory model 1, MacIvory model 2, MacIvory model 3, XL400, XL1200, XL1201,
;;;> Symbolics UX400S, Symbolics UX1200S, NXP1000, Symbolics C, Symbolics Pascal,
;;;> Symbolics Prolog, Symbolics Fortran, CLOE, CLOE Application Generator,
;;;> CLOE Developer, CLOE Runtime, Common Lisp Developer, Symbolics Concordia,
;;;> Joshua, Statice, and Minima are trademarks of Symbolics, Inc.
;;;> 
;;;> Symbolics 3670, Symbolics Common Lisp, Symbolics-Lisp, and Genera are registered
;;;> trademarks of Symbolics, Inc.
;;;>
;;;> GOVERNMENT PURPOSE RIGHTS LEGEND
;;;> 
;;;>      Contract No.: various
;;;>      Contractor Name: Symbolics, Inc.
;;;>      Contractor Address: c/o Ropes & Gray
;;;> 			 One International Place
;;;> 			 Boston, Massachusetts 02110-2624
;;;>      Expiration Date: 2/27/2018
;;;>      
;;;> The Government's rights to use, modify, reproduce, release, perform, display or
;;;> disclose this software are restricted by paragraph (b)(2) of the "Rights in
;;;> Noncommercial Computer Software and Noncommercial Computer Software Documentation"
;;;> contained in the above identified contracts.  No restrictions apply after the
;;;> expiration date shown above.  Any reproduction of the software or portions thereof
;;;> marked with this legend must also reproduce the markings.  Questions regarding
;;;> the Government's rights may be referred to the AS&T Contracts Office of the
;;;> National Reconnaissance Office, Chantilly, Virginia 20151-1715.
;;;> 
;;;>      Symbolics, Inc.
;;;>      c/o Ropes & Gray
;;;>      One International Place
;;;>      Boston, Massachusetts 02110-2624
;;;>      781-937-7655
;;;>
;;;> *****************************************************************************************
;;;>
;;;>

;;;; Mail composition templates

;;; Default for mailing.
(DEFTEMPLATE COMPATIBLE-MAIL-TEMPLATE
  (:TYPE :COMPATIBLE-MAIL)
  (:NAME "Compatible mail")
  (:DOCUMENTATION "Mail with compatible special variable user options.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :MAIL)
  (:HEADER-FIELD :TO)
  (:IF (MEMQ *REQUIRE-SUBJECTS* '(T :INIT)) (:HEADER-FIELD :SUBJECT))
  (:TEMPLATE USER-TEMPLATE)
  (:STARTING-POINT :HEADERS :TO)) 

(DEFTEMPLATE DEFAULT-MAIL-TEMPLATE
  (:TYPE :MAIL)
  (:NAME "Normal mail")
  (:DOCUMENTATION "Initialized with just a To: field")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :MAIL)
  (:HEADER-FIELD :TO)
  (:TEMPLATE USER-TEMPLATE)
  (:STARTING-POINT :HEADERS :TO))

;;; This is used by click left on Mail.
(DEFTEMPLATE MAIL-TEMPLATE
  (:TYPE :INDIRECT)
;  (:TEMPLATE DEFAULT-MAIL-TEMPLATE)
  (:TEMPLATE COMPATIBLE-MAIL-TEMPLATE)
  (:COMMAND-TYPE :MAIL))

;;; Included in all compositions.
(DEFTEMPLATE USER-TEMPLATE
  (:TEMPLATE COMPATIBLE-USER-TEMPLATE)
  (:TYPE :COMPOSE))

;;; Compatibility with old init file composition options
(DEFTEMPLATE COMPATIBLE-USER-TEMPLATE
  (:TYPE :COMPATIBLE-COMPOSE)
  (:READ-ONLY)
  (:IF *DEFAULT-REPLY-TO-LIST* (:HEADER-FIELD :REPLY-TO *DEFAULT-REPLY-TO-LIST*))
  (:IF *DEFAULT-CC-LIST* (:HEADER-FIELD :CC *DEFAULT-CC-LIST*))
  (:IF *DEFAULT-BCC-LIST* (:HEADER-FIELD :BCC *DEFAULT-BCC-LIST*))
  (:IF *DEFAULT-FCC-LIST* (:HEADER-FIELD :FCC *DEFAULT-FCC-LIST*))
  (:IF *DEFAULT-BFCC-LIST* (:HEADER-FIELD :BFCC *DEFAULT-BFCC-LIST*))
  ;; (:COMPATIBLE-REQUIRE-SUBJECTS)
  )

;;;; Forwarding

(DEFTEMPLATE COMPATIBLE-FORWARD-TEMPLATE
  (:TYPE :COMPATIBLE-FORWARD)
  (:NAME "Compatible forward")
  (:DOCUMENTATION "Forwarding with compatible special variable user options.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :FORWARD)
  (:TEXT-FROM-MSGS :TEMPLATE (WHEN *REFORMAT-FORWARDED-MSGS*
			       'FORWARD-REFORMATTING-TEMPLATE)
		   :BEGIN-LINE *FORWARDED-MESSAGE-BEGIN*
		   :SEPARATOR-LINE *FORWARDED-MESSAGE-SEPARATOR*
		   :END-LINE *FORWARDED-MESSAGE-END*
		   :INDENTED *INDENT-FORWARDED-MSGS*)
  (:HEADER-FIELD :TO)
  (:IF *FORWARDED-ADD-SUBJECT* (:FORWARDED-SUBJECT))
  (:FILE-REFERENCES)
  (:INCLUDED-MSGS)
  (:INCLUDED-REFERENCES)
  (:TEMPLATE USER-TEMPLATE)
  (:STARTING-POINT :HEADERS :TO))

(DEFTEMPLATE DEFAULT-FORWARD-TEMPLATE
  (:TYPE :FORWARD)
  (:NAME "Normal forward")
  (:DOCUMENTATION "Text of message(s) and normal forwarding subject.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :FORWARD)
  (:TEXT-FROM-MSGS :TEMPLATE 'FORWARD-REFORMATTING-TEMPLATE)
  (:HEADER-FIELD :TO)
  (:FORWARDED-SUBJECT)
  (:FILE-REFERENCES)
  (:INCLUDED-MSGS)
  (:INCLUDED-REFERENCES)
  (:TEMPLATE USER-TEMPLATE)
  (:STARTING-POINT :HEADERS :TO))

(DEFTEMPLATE FORWARD-TEMPLATE
  (:TYPE :INDIRECT)
; (:TEMPLATE DEFAULT-FORWARD-TEMPLATE)
  (:TEMPLATE COMPATIBLE-FORWARD-TEMPLATE)
  (:COMMAND-TYPE :FORWARD))

;;;; Bug reporting

(DEFTEMPLATE BUG-REPORT-OTHER-TEMPLATE
  (:TYPE :MAIL)
  (:NAME "Other" FONTS:HL12I)
  (:DOCUMENTATION "Report other problems.  Prompts for bug mailing list name")
  (:TEMPLATE BUG-REPORT-TEMPLATE)
  (:AVAILABLE-FOR-COMMANDS :BUG-REPORT)
  (:BUG-REPORT :OTHER))

(DEFTEMPLATE BUG-REPORT-TEMPLATE
  (:TYPE :COMPATIBLE-MAIL)
  (:IF (MEMQ *REQUIRE-SUBJECTS* '(T :INIT :BUG))
   (:HEADER-FIELD :SUBJECT)
   (:STARTING-POINT :HEADERS :SUBJECT))
  (:TEMPLATE USER-TEMPLATE))

;; Bug recipient definitions for Editor (Zwei), Zmail, Hardcopy, Document
;; Examiner, Command Processor, Documentation, and Lisp Compiler are now
;; done where they should be: via :BUG-REPORTS declarations in the the
;; DEFSYSTEMs for those systems and subsystems.

;; Special-cased here because this doesn't refer to an actual system
(ADD-BUG-RECIPIENT "HARDWARE" "Report problems with the hardware" "Hardware")
;; Special-cased here because the template needs to be named BUG-GENERA-TEMPLATE
(ADD-BUG-RECIPIENT "LISPM" "Report problems in the Genera software" "LispM")


;;;; Replying

(DEFTEMPLATE COMPATIBLE-REPLY-TEMPLATE
  (:TYPE :COMPATIBLE-REPLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY)
  (:TEMPLATE COMPATIBLE-DONT-REPLY-TO-TEMPLATE)
  (:COMPATIBLE-REPLY-MODES *REPLY-MODE* *REPLY-WINDOW-MODE*)
  (:TEMPLATE USER-REPLY-TEMPLATE))

(DEFTEMPLATE DEFAULT-REPLY-TEMPLATE
  (:TYPE :REPLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY)
  (:TEMPLATE REPLY-RECIPIENT-ALL-TEMPLATE)
  (:TEMPLATE REPLY-TWO-WINDOWS-TEMPLATE)
  (:TEMPLATE USER-REPLY-TEMPLATE))

(DEFTEMPLATE REPLY-TEMPLATE
  (:TYPE :INDIRECT)
; (:TEMPLATE DEFAULT-REPLY-TEMPLATE)
  (:TEMPLATE COMPATIBLE-REPLY-TEMPLATE)
  (:COMMAND-TYPE :REPLY))

(DEFTEMPLATE COMPATIBLE-REPLY-MIDDLE-TEMPLATE
  (:TYPE :COMPATIBLE-REPLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY)
  (:TEMPLATE COMPATIBLE-DONT-REPLY-TO-TEMPLATE)
  (:COMPATIBLE-REPLY-MODES *MIDDLE-REPLY-MODE* *MIDDLE-REPLY-WINDOW-MODE*)
  (:TEMPLATE USER-REPLY-TEMPLATE))

(DEFTEMPLATE DEFAULT-REPLY-MIDDLE-TEMPLATE
  (:TYPE :REPLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY)
  (:TEMPLATE REPLY-RECIPIENT-SENDER-TEMPLATE)
  (:TEMPLATE REPLY-TWO-WINDOWS-TEMPLATE)
  (:TEMPLATE USER-REPLY-TEMPLATE))

(DEFTEMPLATE REPLY-MIDDLE-TEMPLATE
  (:TYPE :INDIRECT)
; (:TEMPLATE DEFAULT-REPLY-MIDDLE-TEMPLATE)
  (:TEMPLATE COMPATIBLE-REPLY-MIDDLE-TEMPLATE)
  (:COMMAND-TYPE :REPLY))

(DEFTEMPLATE 1R-REPLY-TEMPLATE
  (:TYPE :INDIRECT)
; (:TEMPLATE DEFAULT-1R-REPLY-TEMPLATE)
  (:TEMPLATE COMPATIBLE-1R-REPLY-TEMPLATE)
  (:COMMAND-TYPE :REPLY))

(DEFTEMPLATE COMPATIBLE-1R-REPLY-TEMPLATE
  (:TYPE :COMPATIBLE-REPLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY)
  (:TEMPLATE COMPATIBLE-DONT-REPLY-TO-TEMPLATE)
  (:COMPATIBLE-REPLY-MODES *1R-REPLY-MODE* *REPLY-WINDOW-MODE*)
  (:TEMPLATE USER-REPLY-TEMPLATE))

(DEFTEMPLATE DEFAULT-1R-REPLY-TEMPLATE
  (:TYPE :REPLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY)
  (:TEMPLATE REPLY-RECIPIENT-SENDER-TEMPLATE)
  (:TEMPLATE REPLY-TWO-WINDOWS-TEMPLATE)
  (:TEMPLATE USER-REPLY-TEMPLATE))

(DEFTEMPLATE 3R-REPLY-TEMPLATE
  (:TYPE :INDIRECT)
; (:TEMPLATE DEFAULT-3R-REPLY-TEMPLATE)
  (:TEMPLATE COMPATIBLE-3R-REPLY-TEMPLATE)
  (:COMMAND-TYPE :REPLY))

(DEFTEMPLATE COMPATIBLE-3R-REPLY-TEMPLATE
  (:TYPE :COMPATIBLE-REPLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY)
  (:TEMPLATE COMPATIBLE-DONT-REPLY-TO-TEMPLATE)
  (:COMPATIBLE-REPLY-MODES *REPLY-MODE* ':YANK)
  (:TEMPLATE USER-REPLY-TEMPLATE))

(DEFTEMPLATE DEFAULT-3R-REPLY-TEMPLATE
  (:TYPE :COMPATIBLE-REPLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY)
  (:TEMPLATE REPLY-RECIPIENT-ALL-TEMPLATE)
  (:TEMPLATE REPLY-YANK-TEMPLATE)
  (:TEMPLATE USER-REPLY-TEMPLATE))

(DEFTEMPLATE COMPATIBLE-REPLY-RIGHT-TEMPLATE
  (:TYPE :COMPATIBLE-REPLY)
  (:NAME "Menu")
  (:AVAILABLE-FOR-COMMANDS :REPLY)
  (:TEMPLATE COMPATIBLE-DONT-REPLY-TO-TEMPLATE)
  (:COMPATIBLE-CHOOSE-REPLY-MODES)
  (:TEMPLATE USER-REPLY-TEMPLATE))

(DEFTEMPLATE REPLY-RIGHT-TEMPLATE
  (:TYPE :INDIRECT)
; (:TEMPLATE DEFAULT-REPLY-RIGHT-TEMPLATE)
  (:TEMPLATE COMPATIBLE-REPLY-RIGHT-TEMPLATE)
  (:COMMAND-TYPE :REPLY))

(DEFTEMPLATE USER-REPLY-TEMPLATE
  (:TYPE :REPLY)
  (:TEMPLATE USER-TEMPLATE)
  (:TEMPLATE REPLY-SUBJECT-TEMPLATE)
  (:TEMPLATE COMPATIBLE-USER-REPLY-TEMPLATE))

(DEFTEMPLATE COMPATIBLE-DONT-REPLY-TO-TEMPLATE
  (:TYPE :COMPATIBLE-REPLY)
  (:COMPATIBLE-DONT-REPLY-TO))

(DEFTEMPLATE COMPATIBLE-USER-REPLY-TEMPLATE
  (:TYPE :COMPATIBLE-REPLY)
  (:READ-ONLY)
  (:COMPATIBLE-HEADER-FORMAT *REPLY-HEADER-FORMAT*)
  (:IF *GENERATE-IN-REPLY-TO-FIELD* (:IN-REPLY-TO)))

(DEFTEMPLATE REPLY-SUBJECT-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "Reply subject")
  (:DOCUMENTATION "Get subject and file-references from the original message")
  (:READ-ONLY)
  (:REPLY-HEADERS (:SUBJECT :SUBJECT) (:FILE-REFERENCES :FILE-REFERENCES)))

(DEFTEMPLATE REPLY-IN-REPLY-TO-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "In reply to")
  (:DOCUMENTATION "Include an In-reply-to field.")
  (:READ-ONLY)
  (:IN-REPLY-TO))

(DEFTEMPLATE REPLY-RECIPIENT-ALL-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "All")
  (:DOCUMENTATION "To field: Sender and original To, Cc field: original Cc.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY-MODE)
  (:REPLY-HEADERS (:TO :SENDER) (:TO :TO) (:CC :CC)))

(DEFTEMPLATE REPLY-RECIPIENT-ALL-CC-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "All-Cc")
  (:DOCUMENTATION "To field: Sender, Cc field: original To and Cc.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY-MODE)
  (:REPLY-HEADERS (:TO :SENDER) (:CC :TO) (:CC :CC)))

(DEFTEMPLATE REPLY-RECIPIENT-CC-ALL-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "Cc-All")
  (:DOCUMENTATION "To field: original To, Cc field: Sender and original Cc.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY-MODE)
  (:REPLY-HEADERS (:TO :TO) (:CC :SENDER) (:CC :CC)))

(DEFTEMPLATE REPLY-RECIPIENT-TO-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "To")
  (:DOCUMENTATION "To field: Sender and original To.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY-MODE)
  (:REPLY-HEADERS (:TO :SENDER) (:TO :TO)))

(DEFTEMPLATE REPLY-RECIPIENT-TO-CC-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "To-Cc")
  (:DOCUMENTATION "To field: Sender, Cc field: original To.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY-MODE)
  (:REPLY-HEADERS (:TO :SENDER) (:CC :TO)))

(DEFTEMPLATE REPLY-RECIPIENT-CC-TO-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "Cc-To")
  (:DOCUMENTATION "To field: original To, Cc field: Sender.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY-MODE)
  (:REPLY-HEADERS (:TO :TO) (:CC :SENDER)))

(DEFTEMPLATE REPLY-RECIPIENT-SENDER-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "Sender")
  (:DOCUMENTATION "To field: Sender.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY-MODE)
  (:REPLY-HEADERS (:TO :SENDER)))

(DEFTEMPLATE REPLY-TWO-WINDOWS-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "Two-windows")
  (:DOCUMENTATION "Message being replied to on top and reply below.")
  (:AVAILABLE-FOR-COMMANDS :REPLY-WINDOW-MODE)
  (:WINDOW-CONFIGURATION :REPLY))

(DEFTEMPLATE REPLY-ONE-WINDOW-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "One-window")
  (:DOCUMENTATION "Just text of reply.")
  (:AVAILABLE-FOR-COMMANDS :REPLY-WINDOW-MODE)
  (:WINDOW-CONFIGURATION :MAIL))

(DEFTEMPLATE REPLY-YANK-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "Yank")
  (:DOCUMENTATION "Just text of reply with message being replies to yanked in.")
  (:AVAILABLE-FOR-COMMANDS :REPLY-WINDOW-MODE)
  (:WINDOW-CONFIGURATION :MAIL)
  (:TEXT-FROM-MSGS :INDENTED T :TEMPLATE 'REPLY-YANK-REFORMAT-TEMPLATE))

(DEFTEMPLATE COMPATIBLE-BUG-REPORT-ADDRESSEES-TEMPLATE
  (:TYPE :COMPATIBLE-REPLY)
  (:COMPATIBLE-REPLY-MODES :ALL-CC :YANK))

(DEFTEMPLATE COMPATIBLE-BUG-REPORT-NO-ADDRESSEES-TEMPLATE
  (:TYPE :COMPATIBLE-REPLY)
  (:COMPATIBLE-REPLY-MODES :NONE :YANK))

(DEFVAR *DISPOSITION-ALIST*
	'(("Preemptive" . :PREEMPTIVE)
	  ("Non-preemptive" . :NON-PREEMPTIVE)
	  ("Low Priority" . :LOW-PRIORITY)
	  ("Completed" . :COMPLETED)
	  ("More Information Needed" . :MORE-INFORMATION-NEEDED)
	  ("Information Request Pending" . :INFORMATION-REQUEST-PENDING)
	  ("Long-term Design Issue" . :LONG-TERM-DESIGN-ISSUE)
	  ("Suggestion Noted" . :SUGGESTION-NOTED)
	  ("Already Fixed" . :ALREADY-FIXED)
	  ("Not My Bug" . :NOT-MY-BUG)
	  ("Flake" . :FLAKE)
	  ("Non-Bug" . :NON-BUG)))

(DEFVAR *BUG-REPORT-REPLY-DISPOSITION* NIL)

(DEFVAR *BUG-REPORT-ALTERNATIVE-REPLY-ALIST*
	'(("Bug-Genera" . "Bug-Genera-Completed")
	  ("BUG-LISPM" . "BUG-LISPM-COMPLETED")
	  ("REL60-BETA" . "REL60-BETA-COMPLETED")
	  ("BUG-LMDOC" . NIL)
	  ("BUG-DOC" . NIL)
	  ("BUG-DOCUMENTATION" . NIL)
	  ("DOC-CHANGES" . NIL)))

(DEFTEMPLATE BUG-REPORT-REPLY-TEMPLATE
  (:TYPE :REPLY)
  (:NAME "Bug-report-tracking-reply")
  (:DOCUMENTATION
   "Prompts for severity category and disposition, and inserts synopsis skeleton.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REPLY-MODE)
  (:HEADER-FIELD :DISPOSITION
		 (SETQ *BUG-REPORT-REPLY-DISPOSITION*
		       (TYPEIN-LINE-ACCEPT `((DW:MENU-CHOOSE :ALIST ,*DISPOSITION-ALIST*)
					     :DESCRIPTION "a bug report disposition")
					   :PROMPT "Disposition")))
  (:TEXT "Synopsis:   -- Fill in your brief summary of this problem --

  -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --

")
  (:IF (MEMQ *BUG-REPORT-REPLY-DISPOSITION*	;completed-type dispositions
	     '(:COMPLETED :LONG-TERM-DESIGN-ISSUE :SUGGESTION-NOTED :ALREADY-FIXED))
       (:ALTERNATIVE-REPLY-TO *BUG-REPORT-ALTERNATIVE-REPLY-ALIST*)
       :ELSE
       (:ADDITIONAL-DONT-REPLY-TO
	 (LOOP FOR (ADDR . FOO) IN *BUG-REPORT-ALTERNATIVE-REPLY-ALIST*
	       COLLECT ADDR)))
  (:TEMPLATE COMPATIBLE-DONT-REPLY-TO-TEMPLATE)
  (:IF (EQ *BUG-REPORT-REPLY-DISPOSITION* :NOT-MY-BUG)
       (:TEMPLATE COMPATIBLE-BUG-REPORT-NO-ADDRESSEES-TEMPLATE)
       (:TEMPLATE USER-REPLY-TEMPLATE)
       ;; simulating (:TEMPLATE REPLY-TEMPLATE)
       ;; except for forcing :None and :Yank modes
       (:HEADER-FIELD :TO "Bug-Tracker")	;then only tell the Bug-Tracker
    :ELSE
    (:TEMPLATE COMPATIBLE-BUG-REPORT-ADDRESSEES-TEMPLATE)
    (:TEMPLATE USER-REPLY-TEMPLATE)
    ;; simulating (:TEMPLATE REPLY-TEMPLATE)
    ;; except for forcing :All-CC and :Yank modes
    (:HEADER-FIELD :CC "Bug-Tracking-Replies"))
  (:REPLY-HEADERS-OR-HEADER-FIELDS (:CATEGORY :CATEGORY))
  (:STARTING-POINT :REPLY :START 0 11.)		;right after "Synopsis: "
  )


(DEFTEMPLATE REVOKE-MSG-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE IMMEDIATE-SEND-REVOKE-MSG-TEMPLATE)
  (:COMMAND-TYPE :REVOKE))

(DEFTEMPLATE IMMEDIATE-SEND-REVOKE-MSG-TEMPLATE
  (:TYPE :REVOKE)
  (:NAME "Immediate send")
  (:AVAILABLE-FOR-COMMANDS :REVOKE)
  (:REVOKE-SUBJECT)
  (:REVOKE-TO)
  (:REVOKES)
  (:TEXT "")
  (:COMPOSITION-FUNCTION IMMEDIATE-SEND-COMPOSITION-FUNCTION))

;;;; Transmission

(DEFTEMPLATE NORMAL-TRANSMIT-TEMPLATE
  (:TYPE :INDIRECT)
; (:TEMPLATE DEFAULT-TRANSMIT-TEMPLATE)
  (:TEMPLATE COMPATIBLE-TRANSMIT-TEMPLATE)
  (:COMMAND-TYPE :TRANSMIT))


(DEFTEMPLATE COMPATIBLE-TRANSMIT-TEMPLATE
  (:TYPE :COMPATIBLE-TRANSMIT)
  (:READ-ONLY)
  (:COMPATIBLE-HEADER-FORMAT *SEND-HEADER-FORMAT*)
  (:STANDARD-DATE)
  (:HEADER-FROM-DRAFT :FROM)
  (:IF *PROMPT-FOR-MISSING-HEADERS*
     (:STANDARD-FROM :FROM :PROMPT-FOR-IT)
   :ELSE
     (:STANDARD-FROM :FROM :COMPLAIN))
  (:HEADER-FROM-DRAFT :REPLY-TO)
  (:IF (OR (EQ *REQUIRE-SUBJECTS* T)
	   (AND (EQ *REQUIRE-SUBJECTS* :BUG)
		(LET ((TEM (GET PLIST :DRAFT-MSG)))
		  (AND TEM (SEND-IF-HANDLES TEM :BUG-REPORT)))))
    (:IF *PROMPT-FOR-MISSING-HEADERS*
       (:REQUIRED-HEADER-FROM-DRAFT :SUBJECT :PROMPT-FOR-IT)
     :ELSE
       (:REQUIRED-HEADER-FROM-DRAFT :SUBJECT))
   :ELSE
    (:HEADER-FROM-DRAFT :SUBJECT))
  (:IF *PROMPT-FOR-MISSING-HEADERS*
     (:REQUIRED-HEADER-FROM-DRAFT :TO :PROMPT-FOR-IT)
   :ELSE
     (:REQUIRED-HEADER-FROM-DRAFT :TO))
  (:HEADER-FROM-DRAFT :CC)
  (:HEADER-FROM-DRAFT :FCC)
  (:HEADER-FROM-DRAFT :IN-REPLY-TO)
  (:HEADER-FROM-DRAFT :REFERENCES)
  (:HEADER-FROM-DRAFT :SUPERSEDES)
  (:HEADER-FROM-DRAFT :REVOKES)
  (:HEADER-FROM-DRAFT :FILE-REFERENCES)
  (:HEADER-FROM-DRAFT :INCLUDED-MSGS)
  (:HEADER-FROM-DRAFT :INCLUDED-REFERENCES)
  (:HEADER-FROM-DRAFT :START-DATE)
  (:HEADER-FROM-DRAFT :REMINDER-PERIOD)
  (:HEADER-FROM-DRAFT :REMINDER-TIME)
  (:HEADER-FROM-DRAFT :EXPIRATION-DATE)
  (:HEADER-FROM-DRAFT :KEYWORDS)
  (:HEADER-FROM-DRAFT :PRIORITY)
  (:HEADER-FROM-DRAFT :TEMPLATE-FOR-REPLY)
  (:HEADER-FROM-DRAFT :DISPOSITION)
  (:HEADER-FROM-DRAFT :CATEGORY)
  (:HEADER-FROM-DRAFT :COMMENTS)
  (:STANDARD-ENCRYPTED)
  (:STANDARD-MESSAGE-ID)
  (:DEFAULT-CHARACTER-STYLE-FROM-DRAFT)
  (:CHARACTER-TYPE-MAPPINGS-FROM-DRAFT)
  (:TEXT-FROM-DRAFT)
  (:TEMPLATE USER-TRANSMIT-TEMPLATE)
  (:DEFAULT-HOST))

(DEFTEMPLATE DEFAULT-TRANSMIT-TEMPLATE
  (:TYPE :TRANSMIT)
  (:NAME "Normal transmit")
  (:READ-ONLY)
  (:HEADER-FORMAT :INCLUDE-PERSONAL)
  (:TEMPLATE BASIC-TRANSMIT-HEADER-TEMPLATE)
  (:TEMPLATE BASIC-TRANSMIT-CONTROL-TEMPLATE))

(DEFTEMPLATE BASIC-TRANSMIT-HEADER-TEMPLATE
  (:TYPE :TRANSMIT)
  (:STANDARD-DATE)
  (:HEADER-FROM-DRAFT :FROM)
  (:STANDARD-FROM)
  (:HEADER-FROM-DRAFT :REPLY-TO)
  (:HEADER-FROM-DRAFT :SUBJECT)
  (:HEADER-FROM-DRAFT :TO)
  (:HEADER-FROM-DRAFT :CC)
  (:HEADER-FROM-DRAFT :FCC)
  (:HEADER-FROM-DRAFT :IN-REPLY-TO)
  (:HEADER-FROM-DRAFT :REFERENCES)
  (:HEADER-FROM-DRAFT :SUPERSEDES)
  (:HEADER-FROM-DRAFT :REVOKES)
  (:HEADER-FROM-DRAFT :FILE-REFERENCES)
  (:HEADER-FROM-DRAFT :INCLUDED-MSGS)
  (:HEADER-FROM-DRAFT :INCLUDED-REFERENCES)
  (:HEADER-FROM-DRAFT :START-DATE)
  (:HEADER-FROM-DRAFT :REMINDER-PERIOD)
  (:HEADER-FROM-DRAFT :REMINDER-TIME)
  (:HEADER-FROM-DRAFT :EXPIRATION-DATE)
  (:HEADER-FROM-DRAFT :KEYWORDS)
  (:HEADER-FROM-DRAFT :PRIORITY)
  (:HEADER-FROM-DRAFT :TEMPLATE-FOR-REPLY)
  (:HEADER-FROM-DRAFT :DISPOSITION)
  (:HEADER-FROM-DRAFT :CATEGORY)
  (:HEADER-FROM-DRAFT :COMMENTS)
  (:STANDARD-ENCRYPTED)
  (:STANDARD-MESSAGE-ID)
  (:DEFAULT-CHARACTER-STYLE-FROM-DRAFT)
  (:CHARACTER-TYPE-MAPPINGS-FROM-DRAFT))

(DEFTEMPLATE BASIC-TRANSMIT-CONTROL-TEMPLATE
  (:TYPE :TRANSMIT)
  (:TEXT-FROM-DRAFT)
  (:TEMPLATE USER-TRANSMIT-TEMPLATE)
  (:DEFAULT-HOST))

(DEFTEMPLATE USER-TRANSMIT-TEMPLATE
  (:TYPE :TRANSMIT))

(DEFTEMPLATE BCC-TRANSMIT-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE DEFAULT-TRANSMIT-TEMPLATE-SHOWING-BCC)
  (:COMMAND-TYPE :TRANSMIT))

(DEFTEMPLATE DEFAULT-TRANSMIT-TEMPLATE-SHOWING-BCC
  (:TYPE :TRANSMIT)
  (:NAME "Normal transmit to Bcc recipients")
  (:READ-ONLY)
  (:HEADER-FORMAT :INCLUDE-PERSONAL)
  (:TEMPLATE BASIC-TRANSMIT-HEADER-TEMPLATE)
  (:HEADER-FROM-DRAFT :BCC)
  (:TEMPLATE BASIC-TRANSMIT-CONTROL-TEMPLATE))

(DEFTEMPLATE FCC-TRANSMIT-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE DEFAULT-FCC-TRANSMIT-TEMPLATE)
  (:COMMAND-TYPE :FCC-TRANSMIT))

(DEFTEMPLATE DEFAULT-FCC-TRANSMIT-TEMPLATE
  (:TYPE :TRANSMIT)
  (:READ-ONLY)
  (:TEMPLATE DEFAULT-TRANSMIT-TEMPLATE-SHOWING-BCC)
  (:HEADER-FROM-DRAFT :BFCC)
  (:SENDING-MODE FCC-SENDING-MODE)
  (:AVAILABLE-FOR-COMMANDS :FCC-TRANSMIT))

(DEFTEMPLATE BARF-WHEN-FILE-RECIPIENTS-TEMPLATE
  (:TYPE :TRANSMIT)
  (:READ-ONLY)
  (:REJECT-HEADER-IN-DRAFT :FCC)
  (:REJECT-HEADER-IN-DRAFT :BFCC))

;;;; Redistribution
(DEFTEMPLATE REDISTRIBUTE-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE DEFAULT-REDISTRIBUTE-COMPOSITION-TEMPLATE)
  (:COMMAND-TYPE :REDISTRIBUTE))

(DEFTEMPLATE DEFAULT-REDISTRIBUTE-COMPOSITION-TEMPLATE
  (:TYPE :REDISTRIBUTE-COMPOSE)
  (:NAME "Redistribute")
  (:DOCUMENTATION "Redistribute with Resent-x fields.")
  (:AVAILABLE-FOR-COMMANDS :REDISTRIBUTE)
  (:COMPOSITION-FUNCTION REDISTRIBUTE-COMPOSITION-FUNCTION)
  (:READ-ONLY)
  (:TRANSMIT-TEMPLATES REDISTRIBUTE-TRANSMISSION-TEMPLATE)
  (:HEADER-FIELD :REDISTRIBUTED-TO (PROMPT-FOR-ADDRESSES "Redistribute to:"))
  (:HEADER-FIELD :RESENT-COMMENTS (PROMPT-FOR-MULTI-LINE-HEADER "Comments (optional)")))

(DEFTEMPLATE REDISTRIBUTE-TRANSMISSION-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE RESENT-REDISTRIBUTE-TRANSMISSION-TEMPLATE)
  (:COMMAND-TYPE :REDISTRIBUTE))

(DEFTEMPLATE REDISTRIBUTED-REDISTRIBUTE-TRANSMISSION-TEMPLATE
  (:TYPE :REDISTRIBUTE-TRANSMIT)
  (:NAME "/"Redistributed-x/" redistribution format")
  (:READ-ONLY)
  (:HEADER-FORMAT :INCLUDE-PERSONAL)
  (:HEADERS-FROM-MSG)
  (:HEADER-FROM-DRAFT :REDISTRIBUTED-TO)
  (:STANDARD-FROM :REDISTRIBUTED-BY)
  (:STANDARD-DATE :REDISTRIBUTED-DATE)
  (:DEFAULT-HOST)
  (:DEFAULT-CHARACTER-STYLE-FROM-MSG)
  (:CHARACTER-TYPE-MAPPINGS-FROM-DRAFT)
  (:TEXT-FROM-DRAFT))

(DEFTEMPLATE RESENT-REDISTRIBUTE-TRANSMISSION-TEMPLATE
  (:TYPE :REDISTRIBUTE-TRANSMIT)
  (:NAME "/"Resent-x/" redistribution format")
  (:READ-ONLY)
  (:HEADER-FORMAT :INCLUDE-PERSONAL)
  (:HEADERS-FROM-MSG)
  (:HEADER-FROM-DRAFT :REDISTRIBUTED-TO :RESENT-TO)
  (:STANDARD-FROM :RESENT-FROM)
  (:STANDARD-DATE :RESENT-DATE)
  (:STANDARD-MESSAGE-ID :RESENT-MESSAGE-ID)
  (:HEADER-FROM-DRAFT :RESENT-COMMENTS)
  (:DEFAULT-HOST)
  (:DEFAULT-CHARACTER-STYLE-FROM-MSG)
  (:CHARACTER-TYPE-MAPPINGS-FROM-DRAFT)
  (:TEXT-FROM-DRAFT))

;;; Redirection from one mailing address(es) to another address(es)
(DEFTEMPLATE REDIRECT-REFERENCE-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE DEFAULT-REDIRECT-REFERENCE-TEMPLATE)
  (:COMMAND-TYPE :REDIRECT))

(DEFTEMPLATE DEFAULT-REDIRECT-REFERENCE-TEMPLATE
  (:TYPE :REDIRECT-COMPOSE)
  (:NAME "Redirect reference")
  (:DOCUMENTATION
   "Send a notice and reference of a redirected message to removed recipients.")
  (:AVAILABLE-FOR-COMMANDS :REDIRECT)
  (:ONLY-REMOVED-RECIPIENTS)
  (:REMOVED-REDIRECT-HEADERS (:TO :TO) (:TO :CC))
  (:HEADERS-FROM-REFERENCED-MSG :SUBJECT)
  (:REDIRECTED-TEXT "The referenced")
  (:REFERENCES)
  (:COMPOSITION-FUNCTION REDIRECT-COMPOSITION-FUNCTION)
  (:READ-ONLY)
  (:TRANSMIT-TEMPLATES REDIRECT-REFERENCE-TRANSMIT-TEMPLATE))

(DEFTEMPLATE REDIRECT-REFERENCE-TRANSMIT-TEMPLATE
  (:TYPE :REDIRECT-TRANSMIT)
  (:NAME "Reference phase of redirection")
  (:READ-ONLY)
  ;(:HEADERS-FROM-MSG)
  (:STANDARD-DATE)
  (:STANDARD-FROM)
  (:HEADER-FROM-DRAFT :TO)
  (:HEADER-FROM-DRAFT :CC)
  (:HEADER-FROM-DRAFT :SUBJECT)
  (:HEADER-FROM-DRAFT :REFERENCES)
  (:STANDARD-MESSAGE-ID)  
  (:DEFAULT-HOST)
  (:DEFAULT-CHARACTER-STYLE-FROM-DRAFT)
  (:CHARACTER-TYPE-MAPPINGS-FROM-DRAFT)
  (:TEXT-FROM-DRAFT))

(DEFTEMPLATE REDIRECT-REDISTRIBUTE-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE DEFAULT-REDIRECT-REDISTRIBUTE-TEMPLATE)
  (:COMMAND-TYPE :REDIRECT))

(DEFTEMPLATE DEFAULT-REDIRECT-REDISTRIBUTE-TEMPLATE
  (:TYPE :REDIRECT-COMPOSE)
  (:NAME "Redirect")
  (:DOCUMENTATION "Redirect to different addresses with To: and cc: fields.")
  (:AVAILABLE-FOR-COMMANDS :REDIRECT)
  (:HEADERS-FROM-REFERENCED-MSG :DATE :FROM :SENDER :REPLY-TO :SUBJECT :FCC
				:IN-REPLY-TO :REFERENCES :REVOKES :FILE-REFERENCES
				:INCLUDED-MSGS :INCLUDED-REFERENCES
				:START-DATE :REMINDER-PERIOD :REMINDER-TIME :EXPIRATION-DATE
				:KEYWORDS :PRIORITY
				:TEMPLATE-FOR-REPLY :DISPOSITION :CATEGORY :COMMENTS
				:SUPERSEDES :REDISTRIBUTED-TO :REDISTRIBUTED-BY
				:REDISTRIBUTED-DATE :RESENT-TO :RESENT-FROM
				:RESENT-DATE :RESENT-MESSAGE-ID :RESENT-COMMENTS)
  (:REMOVE-REMOVED-RECIPIENTS)
  (:RETAINED-REDIRECT-HEADERS (:TO :TO) (:CC :CC))
  (:ADD-ADDED-RECIPIENTS :TO)
  (:SUPERSEDES :CURRENT-MSGS
	       (AND *REDIRECT-REFERENCE-MSG*
		    (SEND *REDIRECT-REFERENCE-MSG* :TRANSMITTED-MESSAGE-ID)))
  (:REDIRECTED-TEXT "This")
  (:TEXT-FROM-MSGS :TEMPLATE 'TEXT-ONLY)
  (:COMPOSITION-FUNCTION REDIRECT-COMPOSITION-FUNCTION)
  (:READ-ONLY)
  (:TRANSMIT-TEMPLATES REDIRECT-TRANSMISSION-TEMPLATE))

(DEFTEMPLATE REDIRECT-TRANSMISSION-TEMPLATE
  (:TYPE :REDIRECT-TRANSMIT)
  (:NAME "Redistribution phase of redirection")
  (:READ-ONLY)
  (:HEADER-FROM-DRAFT :DATE)			;instead of (:STANDARD-DATE)
  (:HEADER-FROM-DRAFT :FROM)
  (:HEADER-FROM-DRAFT :SENDER)
  (:HEADER-FROM-DRAFT :REPLY-TO)
  (:HEADER-FROM-DRAFT :SUBJECT)
  (:HEADER-FROM-DRAFT :TO)
  (:HEADER-FROM-DRAFT :CC)
  (:HEADER-FROM-DRAFT :FCC)
  (:HEADER-FROM-DRAFT :IN-REPLY-TO)
  (:HEADER-FROM-DRAFT :REFERENCES)
  (:HEADER-FROM-DRAFT :REVOKES)
  (:HEADER-FROM-DRAFT :FILE-REFERENCES)
  (:HEADER-FROM-DRAFT :INCLUDED-MSGS)
  (:HEADER-FROM-DRAFT :INCLUDED-REFERENCES)
  (:HEADER-FROM-DRAFT :START-DATE)
  (:HEADER-FROM-DRAFT :REMINDER-PERIOD)
  (:HEADER-FROM-DRAFT :REMINDER-TIME)
  (:HEADER-FROM-DRAFT :EXPIRATION-DATE)
  (:HEADER-FROM-DRAFT :KEYWORDS)
  (:HEADER-FROM-DRAFT :PRIORITY)
  (:HEADER-FROM-DRAFT :TEMPLATE-FOR-REPLY)
  (:HEADER-FROM-DRAFT :DISPOSITION)
  (:HEADER-FROM-DRAFT :CATEGORY)
  (:HEADER-FROM-DRAFT :COMMENTS)
  (:HEADER-FROM-DRAFT :REDISTRIBUTED-TO)
  (:HEADER-FROM-DRAFT :REDISTRIBUTED-BY)
  (:HEADER-FROM-DRAFT :REDISTRIBUTED-DATE)
  (:HEADER-FROM-DRAFT :RESENT-TO)
  (:HEADER-FROM-DRAFT :RESENT-FROM)
  (:HEADER-FROM-DRAFT :RESENT-DATE)
  (:HEADER-FROM-DRAFT :RESENT-MESSAGE-ID)
  (:HEADER-FROM-DRAFT :RESENT-COMMENTS)
  (:STANDARD-ENCRYPTED)
  (:STANDARD-MESSAGE-ID)
  (:HEADER-FROM-DRAFT :SUPERSEDES)
  (:STANDARD-DATE :REDIRECTED-DATE)
  (:STANDARD-FROM :REDIRECTED-BY)
  (:DEFAULT-HOST)
  (:DEFAULT-CHARACTER-STYLE-FROM-MSG)
  (:DEFAULT-CHARACTER-STYLE-FROM-DRAFT)		D,#TD1PsT[Begin using 006 escapes](1 0 (NIL 0) (NIL :ITALIC NIL) "CPTFONTI");Eh?
0  (:CHARACTER-TYPE-MAPPINGS-FROM-DRAFT)
  (:TEXT-FROM-DRAFT))

(DEFTEMPLATE TEXT-ONLY
  (:TYPE :REFORMAT)
  (:READ-ONLY)
  (:HEADERS-FROM-ORIGINAL . NIL))

(DEFTEMPLATE LITERAL-WITH-ADDRESSES-REFORMAT-TEMPLATE
  (:TYPE :REFORMAT)
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REFORMAT)
  (:NAME "Copy redoing addresses and Message-ID")
  (:DOCUMENTATION
    "Use the original headers literally except reform the addresses and Message-ID")
  (:REFORMAT-HEADER-TYPES :ADDRESS :MESSAGE-ID)
  (:PRESERVE-ORDER)
  (:HEADERS-FROM-ORIGINAL-EXCEPT . NIL)
  )


(DEFTEMPLATE COMPATIBLE-FCC-LOCAL-MAIL-TEMPLATE
  (:TYPE :COMPATIBLE-MAIL)
  (:NAME "Fcc Local mail")
  (:DOCUMENTATION "Local mail by Fcc to the current buffer.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :LOCAL-MAIL)
  (:HEADER-FIELD :FCC (SEND (BUFFER-FOR-LOCAL-MAIL) ':NAME))
  (:IF (MEMQ *REQUIRE-SUBJECTS* '(T :INIT)) (:HEADER-FIELD :SUBJECT))
  (:TEMPLATE USER-TEMPLATE))

(DEFTEMPLATE COMPATIBLE-LOCAL-MAIL-TEMPLATE
  (:TYPE :COMPATIBLE-LOCAL)
  (:NAME "Compatible local mail")
  (:DOCUMENTATION "Local mail with compatible special variable user options.")
  (:AVAILABLE-FOR-COMMANDS :LOCAL-MAIL)
  (:COMPOSITION-FUNCTION COMPOSE-VIA-LOCAL-MAIL)
  (:COMPATIBLE-HEADER-FORMAT *LOCAL-MAIL-HEADER-FORCE*)
  (:STANDARD-DATE)
  (:STANDARD-FROM)
  (:DEFAULT-HOST)
  (:IF *LOCAL-MAIL-INCLUDE-SUBJECT*
    (:HEADER-FIELD :SUBJECT)
    (:STARTING-POINT :HEADERS :SUBJECT))
  (:TEMPLATE USER-TEMPLATE))

(DEFTEMPLATE DEFAULT-LOCAL-MAIL-TEMPLATE
  (:TYPE :LOCAL)
  (:NAME "Local mail")
  (:DOCUMENTATION "Create a message in current buffer and edit it.")
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :LOCAL-MAIL)
  (:COMPOSITION-FUNCTION COMPOSE-VIA-LOCAL-MAIL)
  (:HEADER-FORMAT :ITS)
  (:STANDARD-DATE)
  (:STANDARD-FROM)
  (:DEFAULT-HOST)
  (:HEADER-FIELD :SUBJECT)
  (:TEMPLATE USER-TEMPLATE)
  (:STARTING-POINT :HEADERS :SUBJECT))

(DEFTEMPLATE LOCAL-MAIL-TEMPLATE
  (:TYPE :INDIRECT)
  (:DOCUMENTATION
      "Local mail by Fcc to the current buffer.  R: Menu of local mail templates.")
; (:TEMPLATE DEFAULT-LOCAL-MAIL-TEMPLATE)
; (:TEMPLATE COMPATIBLE-LOCAL-MAIL-TEMPLATE)
  (:TEMPLATE COMPATIBLE-FCC-LOCAL-MAIL-TEMPLATE)
  (:COMMAND-TYPE :LOCAL-MAIL)
  (:AVAILABLE-FOR-COMMANDS :MAIL))

;;;; Reminder templates

;;; Default is to ask for type of reminder
(DEFTEMPLATE DEFAULT-REMINDER-TEMPLATE
  (:TYPE :REMINDER)
  (:IF (FQUERY *CHOOSE-REMINDER-TYPE-OPTIONS* "Periodic or Once-only reminder? ")
    (:TEMPLATE PERIODIC-REMINDER-TEMPLATE)
   :ELSE
    (:TEMPLATE ONCE-ONLY-REMINDER-TEMPLATE)))

(DEFTEMPLATE KBD-REMINDER-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE DEFAULT-REMINDER-TEMPLATE)
  (:COMMAND-TYPE :REMINDER))

(DEFTEMPLATE DEFAULT-PERIODIC-REMINDER-TEMPLATE
  (:TYPE :LOCAL-REMINDER)
  (:AVAILABLE-FOR-COMMANDS :REMINDER)
  (:NAME "Periodic")
  (:TEMPLATE BASIC-REMINDER-TEMPLATE)
  (:HEADER-FIELD :REMINDER-PERIOD (PROMPT-FOR-REMINDER-PERIOD))
  (:HEADER-FIELD-UNLESS-NIL :REMINDER-TIME (PROMPT-FOR-REMINDER-TIME))
  (:HEADER-FIELD-UNLESS-NIL :EXPIRATION-DATE (PROMPT-FOR-EXPIRATION-DATE)))

(DEFTEMPLATE PERIODIC-REMINDER-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE DEFAULT-PERIODIC-REMINDER-TEMPLATE)
  (:COMMAND-TYPE :REMINDER))

(DEFTEMPLATE MIDDLE-REMINDER-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE PERIODIC-REMINDER-TEMPLATE)
  (:COMMAND-TYPE :REMINDER))

(DEFTEMPLATE DEFAULT-ONCE-ONLY-REMINDER-TEMPLATE
  (:TYPE :LOCAL-REMINDER)
  (:AVAILABLE-FOR-COMMANDS :REMINDER)
  (:NAME "Once only")
  (:TEMPLATE BASIC-REMINDER-TEMPLATE)
  (:HEADER-FIELD :START-DATE (PROMPT-FOR-REMINDER-DATE-TIME))
  (:HEADER-FIELD-UNLESS-NIL :EXPIRATION-DATE (PROMPT-FOR-EXPIRATION-DATE (GET PLIST :HEADERS))
			    ))

(DEFTEMPLATE ONCE-ONLY-REMINDER-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE DEFAULT-ONCE-ONLY-REMINDER-TEMPLATE)
  (:COMMAND-TYPE :REMINDER))

(DEFTEMPLATE LEFT-REMINDER-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE ONCE-ONLY-REMINDER-TEMPLATE)
  (:COMMAND-TYPE :REMINDER))

(DEFTEMPLATE BASIC-REMINDER-TEMPLATE
  (:TYPE :LOCAL-REMINDER)
  (:COMPOSITION-FUNCTION COMPOSE-VIA-LOCAL-MAIL)
  (:HEADER-FORMAT :RFC733)
  (:STANDARD-DATE)
  (:STANDARD-MESSAGE-ID))

(DEFTEMPLATE REMINDER-ON-DAY-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE DEFAULT-REMINDER-ON-DAY-TEMPLATE)
  (:COMMAND-TYPE :REMINDER))

(DEFTEMPLATE DEFAULT-REMINDER-ON-DAY-TEMPLATE
  (:TYPE :LOCAL-REMINDER)
  (:TEMPLATE BASIC-REMINDER-TEMPLATE)
  (:START-DATE-FROM-COMMAND (PROMPT-FOR-REMINDER-TIME))
  (:HEADER-FIELD-UNLESS-NIL :EXPIRATION-DATE (PROMPT-FOR-EXPIRATION-DATE (GET PLIST :HEADERS))
			    ))

;;;; Reformatting templates

(DEFTEMPLATE LITERAL-REFORMAT-TEMPLATE
  (:TYPE :REFORMAT)
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REFORMAT)
  (:NAME "Literal")
  (:DOCUMENTATION "Use the original headers literally")
  (:PRESERVE-ORDER)
  (:HEADERS-FROM-ORIGINAL-EXCEPT . NIL)
  )

(DEFTEMPLATE ELIMINATE-OBVIOUS-JUNK-REFORMAT-TEMPLATE
  (:TYPE :REFORMAT)
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REFORMAT)
  (:NAME "Eliminate obvious junk")
  (:DOCUMENTATION "Get rid of Received and Return-path headers")
  (:PRESERVE-ORDER)
  (:HEADERS-FROM-ORIGINAL-EXCEPT :RECEIVED :RETURN-PATH)
  )

(DEFTEMPLATE COMMON-LOSERS-REFORMAT-TEMPLATE
  (:TYPE :REFORMAT)
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REFORMAT)
  (:NAME "Common losers")
  (:DOCUMENTATION
    "Reformat address and date headers, suppress headers intended only for machines.")
  (:REFORMAT-HEADER-TYPES :ADDRESS :DATE)
  (:HEADER-FORMAT :INCLUDE-PERSONAL)
  (:HEADERS-FROM-ORIGINAL-EXCEPT :RECEIVED :RETURN-PATH :DEFAULT-CHARACTER-STYLE
				 :CHARACTER-TYPE-MAPPINGS :CHARACTER-STYLES :FONTS :JAPANESE
				 :MAIL-FROM :MESSAGE-ID :RESENT-MESSAGE-ID :VIA
				 :BACKWARD-REFERENCES :FORWARD-REFERENCES
				 :INCLUDED-REFERENCES :INCLUDED-MSGS)
  )

(DEFTEMPLATE ONLY-MINIMUM-REFORMAT-TEMPLATE
  (:TYPE :REFORMAT)
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REFORMAT)
  (:NAME "Minimum")
  (:DOCUMENTATION "Only show the Date, From, Subject, To and Cc fields")
  (:REFORMAT-HEADER-TYPES :ADDRESS :DATE)
  (:HEADER-FORMAT :INCLUDE-PERSONAL)
  (:HEADERS-FROM-ORIGINAL :DATE :FROM :SUBJECT :TO :CC)
  )

(DEFINE-TEMPLATE-TYPE COMPATIBLE-REFORMAT-TEMPLATE :COMPATIBLE-REFORMAT
		      () (REFORMAT-TEMPLATE))

(DEFMETHOD (:EXPANSION-KEYWORD COMPATIBLE-REFORMAT-TEMPLATE :HEADERS-FROM-ORIGINAL)
	   (PLIST FORM)
  (SETF (GET PLIST ':HEADERS-FROM-ORIGINAL)
	(APPEND (GET PLIST ':HEADERS-FROM-ORIGINAL) (EVAL FORM))))

(COMPILE-FLAVOR-METHODS COMPATIBLE-REFORMAT-TEMPLATE)

(DEFTEMPLATE COMPATIBLE-REPLY-YANK-REFORMAT-TEMPLATE
  (:TYPE :COMPATIBLE-REFORMAT)
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REFORMAT)
  (:NAME "Compatible for Reply Yank")
  (:DOCUMENTATION "Prune headers if option is set")
  (:REFORMAT-HEADER-TYPES :DATE)
  (:IF *PRUNE-HEADERS-AFTER-YANKING*
    (:HEADERS-FROM-ORIGINAL *PRUNE-YANKED-HEADERS-KEEP-HEADERS*)
   :ELSE
    (:HEADERS-FROM-ORIGINAL-EXCEPT . NIL)))

(DEFTEMPLATE REPLY-YANK-REFORMAT-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE COMPATIBLE-REPLY-YANK-REFORMAT-TEMPLATE))

(DEFTEMPLATE FORWARD-REFORMATTING-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE COMMON-LOSERS-REFORMAT-TEMPLATE))

(DEFTEMPLATE DEFAULT-REDISTRIBUTE-REFORMAT-TEMPLATE
  (:TYPE :REFORMAT)
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REFORMAT)
  (:NAME "Redistribution reformatting")
  (:DOCUMENTATION "Use the original headers literally except those which are regenerated.")
  (:PRESERVE-ORDER)
  (:HEADERS-FROM-ORIGINAL-EXCEPT :DEFAULT-CHARACTER-STYLE :CHARACTER-TYPE-MAPPINGS
				 :CHARACTER-STYLES :FONTS :JAPANESE))

(DEFTEMPLATE REDISTRIBUTE-HEADERS-REFORMAT-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE DEFAULT-REDISTRIBUTE-REFORMAT-TEMPLATE))

(DEFTEMPLATE DEFAULT-REFORMAT-TEMPLATE
  (:TYPE :INDIRECT)
  (:TEMPLATE COMMON-LOSERS-REFORMAT-TEMPLATE))

(DEFTEMPLATE PERSONAL-REFORMAT-TEMPLATE
  (:TYPE :REFORMAT)
  (:READ-ONLY)
  (:AVAILABLE-FOR-COMMANDS :REFORMAT)
  (:NAME "Personal")
  (:DOCUMENTATION "Just show personal names, dates with numbers in English")
  (:REFORMAT-HEADER-TYPES :ADDRESS :DATE)
  (:HEADER-FORMAT :ONLY-PERSONAL)
  (:DATE-FORMAT :ENGLISH)
  (:HEADERS-FROM-ORIGINAL-EXCEPT :RECEIVED :RETURN-PATH :MESSAGE-ID :IN-REPLY-TO))
