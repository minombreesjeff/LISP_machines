;;; -*- Mode:LISP; Package:ZWEI; Base:8 -*-
;;; Lisp Machine mail reader
;;; Profile mode and commands, definition are in DEFS
;;;>
;;;> *****************************************************************************************
;;;> ** (c) Copyright 1998-1982 Symbolics, Inc.  All rights reserved.
;;;> ** Portions of font library Copyright (c) 1984 Bitstream, Inc.  All Rights Reserved.
;;;>
;;;>    The software, data, and information contained herein are proprietary to,
;;;> and comprise valuable trade secrets of, Symbolics, Inc., which intends 
;;;> to keep such software, data, and information confidential and to preserve them
;;;> as trade secrets.  They are given in confidence by Symbolics pursuant 
;;;> to a written license agreement, and may be used, copied, transmitted, and stored
;;;> only in accordance with the terms of such license.
;;;> 
;;;> Symbolics, Symbolics 3600, Symbolics 3675, Symbolics 3630, Symbolics 3640,
;;;> Symbolics 3645, Symbolics 3650, Symbolics 3653, Symbolics 3620, Symbolics 3610,
;;;> Zetalisp, Open Genera, Virtual Lisp Machine, VLM, Wheels, Dynamic Windows,
;;;> SmartStore, Semanticue, Frame-Up, Firewall, Document Examiner,
;;;> Delivery Document Examiner, "Your Next Step in Computing", Ivory, MacIvory,
;;;> MacIvory model 1, MacIvory model 2, MacIvory model 3, XL400, XL1200, XL1201,
;;;> Symbolics UX400S, Symbolics UX1200S, NXP1000, Symbolics C, Symbolics Pascal,
;;;> Symbolics Prolog, Symbolics Fortran, CLOE, CLOE Application Generator,
;;;> CLOE Developer, CLOE Runtime, Common Lisp Developer, Symbolics Concordia,
;;;> Joshua, Statice, and Minima are trademarks of Symbolics, Inc.
;;;> 
;;;> Symbolics 3670, Symbolics Common Lisp, Symbolics-Lisp, and Genera are registered
;;;> trademarks of Symbolics, Inc.
;;;>
;;;> GOVERNMENT PURPOSE RIGHTS LEGEND
;;;> 
;;;>      Contract No.: various
;;;>      Contractor Name: Symbolics, Inc.
;;;>      Contractor Address: c/o Ropes & Gray
;;;> 			 One International Place
;;;> 			 Boston, Massachusetts 02110-2624
;;;>      Expiration Date: 2/27/2018
;;;>      
;;;> The Government's rights to use, modify, reproduce, release, perform, display or
;;;> disclose this software are restricted by paragraph (b)(2) of the "Rights in
;;;> Noncommercial Computer Software and Noncommercial Computer Software Documentation"
;;;> contained in the above identified contracts.  No restrictions apply after the
;;;> expiration date shown above.  Any reproduction of the software or portions thereof
;;;> marked with this legend must also reproduce the markings.  Questions regarding
;;;> the Government's rights may be referred to the AS&T Contracts Office of the
;;;> National Reconnaissance Office, Chantilly, Virginia 20151-1715.
;;;> 
;;;>      Symbolics, Inc.
;;;>      c/o Ropes & Gray
;;;>      One International Place
;;;>      Boston, Massachusetts 02110-2624
;;;>      781-937-7655
;;;>
;;;> *****************************************************************************************
;;;>
;;;>

(DEFINE-ZMAIL-TOP-LEVEL-COMMAND COM-ZMAIL-PROFILE
				"Alter user options and edit Zmail profile."
				(NO-SEQUENCE-OK)
  (SET-ZMAIL-USER)
  (LET ((*PREVIOUS-WINDOW-CONFIGURATION* *WINDOW-CONFIGURATION*)
	(OLD-DOC (SEND (WINDOW-SHEET *PROFILE-EDITOR-WINDOW*)
		       :WHO-LINE-OVERRIDE-DOCUMENTATION-STRING))
	(OLD-*CMWSOM* *CALENDAR-MODE-WEEK-STARTS-ON-MONDAY*)
	(*EDITING-PROFILE* NIL))
    (UNWIND-PROTECT
	(PROGN
	  (SEND *CURRENT-COMMAND-LOOP* :SET-WINDOW-CONFIGURATION :PROFILE)
	  (SEND (WINDOW-SHEET *PROFILE-EDITOR-WINDOW*)
		:SET-WHO-LINE-OVERRIDE-DOCUMENTATION-STRING NIL)
	  (SEND *PROFILE-EDITOR* :EDIT-PROFILE))
      (WHEN (NEQ *CALENDAR-MODE-WEEK-STARTS-ON-MONDAY* OLD-*CMWSOM*)
	(SEND *CURRENT-COMMAND-LOOP* :UPDATE-CALENDAR-WINDOWS-FOR-NEW-START-OF-WEEK))
      (SEND (WINDOW-SHEET *PROFILE-EDITOR-WINDOW*)
	    :SET-WHO-LINE-OVERRIDE-DOCUMENTATION-STRING OLD-DOC)
      (SEND *CURRENT-COMMAND-LOOP* :SET-WINDOW-CONFIGURATION *PREVIOUS-WINDOW-CONFIGURATION*))
    )
  DIS-NONE)

(DEFUN CREATE-PROFILE-EDITOR (WINDOW)
  (MAKE-INSTANCE 'ZMAIL-PROFILE-EDITOR :*WINDOW* WINDOW))

(DEFMETHOD (:TOP-LEVEL-TAG ZMAIL-PROFILE-EDITOR) () 'EXIT-PROFILE-EDITOR)

(DEFUN-IN-FLAVOR (ZMAIL-PROFILE-EDITOR-MSG-REALLY-FOR-ZMAIL-FRAME ZMAIL-PROFILE-EDITOR)
		 (MSG ARGS)
  (LEXPR-SEND *ZMAIL-WINDOW* MSG ARGS))

(DEFMETHOD (:REFRESH ZMAIL-PROFILE-EDITOR) (&REST ARGS)
  (ZMAIL-PROFILE-EDITOR-MSG-REALLY-FOR-ZMAIL-FRAME :REFRESH ARGS))

(DEFMETHOD (:SELECT ZMAIL-PROFILE-EDITOR) (&REST ARGS)
  (ZMAIL-PROFILE-EDITOR-MSG-REALLY-FOR-ZMAIL-FRAME :SELECT ARGS))

(DEFMETHOD (:SELECT-RELATIVE ZMAIL-PROFILE-EDITOR) (&REST ARGS)
  (ZMAIL-PROFILE-EDITOR-MSG-REALLY-FOR-ZMAIL-FRAME :SELECT-RELATIVE ARGS))

(DEFMETHOD (:RESET-PROFILE ZMAIL-PROFILE-EDITOR) ()
  (SEND *INTERVAL* ':SET-FILE-INFO NIL)
  (SEND *INTERVAL* ':SET-PATHNAME NIL))		;carefully forget this pathname

(DEFMETHOD (:EDIT-PROFILE ZMAIL-PROFILE-EDITOR) ()
  (MULTIPLE-VALUE (*MODE-LINE-WINDOW* *TYPEIN-WINDOW* *MINI-BUFFER-WINDOW*)
    (WINDOW-MODE-LINE-WINDOWS *WINDOW*))
  (PKG-BIND "ZWEI"
    (LET ((*ZMAIL-PROFILE-NAME* (SETUP-ZMAIL-PROFILE)))
       (SEND *PROFILE-WINDOW* :SEND-PANE 'CHOOSE-WINDOW :SELECT NIL)
       (SEND SELF :COMMAND-LOOP))))

(DEFMETHOD (:NEW-USER ZMAIL-PROFILE-EDITOR) ()
  (SEND *INTERVAL* ':SET-PATHNAME (ZMAIL-PROFILE-PATHNAME ':LISP))
  (SEND *INTERVAL* ':SET-SETUP-P NIL))

(DEFUN SETUP-ZMAIL-PROFILE ()
  (SET-ZMAIL-USER)
  (LET ((NEED-TO-REVERT (NOT (SEND *INTERVAL* :SETUP-P))))
    (WHEN (NOT NEED-TO-REVERT)
      (LET ((PATHNAME (SEND *INTERVAL* :PATHNAME)))
	;; See if everything is still ok
	(WITH-OPEN-STREAM (STREAM
			    (CONDITION-CASE (.ERROR.)
				 (OPEN PATHNAME :DIRECTION :PROBE :IF-DOES-NOT-EXIST :ERROR)
			       (FS:FILE-NOT-FOUND
				 (WHEN (SEND *INTERVAL* :FILE-INFO)
				   (TYPEIN-LINE
				     "Note: file has been deleted on the file computer")))
			       (FS:FILE-OPERATION-FAILURE
				 (FERROR "Unexpected error probing ~A: ~A" PATHNAME .ERROR.))
			       ;; If nost not responding, arrange to warn if later attempt
			       ;; to overwrite.
			       ((SYS:HOST-NOT-RESPONDING-DURING-CONNECTION
				  SYS:CONNECTION-REFUSED)
				(UNLESS (SEND *INTERVAL* :FILE-INFO)
				  (TYPEIN-LINE
		 "Warning: file computer is not responding, cannot read profile into buffer.")
				  (SEND *INTERVAL* :SET-FILE-INFO :NEVER-READ)))))
	  (IF (AND STREAM (NOT (EQUAL (SEND *INTERVAL* :FILE-INFO) (SEND STREAM :INFO))))
	      (IF (FQUERY '(:SELECT T :BEEP T)
			  "There is a different version of this file on the file computer,~@
			   your version has~:[ not~] been modified.~@
			   Do you want the new version instead? "
			  (SEND *INTERVAL* :MODIFIED-P :FOR-SAVING))
		  (SETQ NEED-TO-REVERT T))))))
    (WHEN NEED-TO-REVERT
      (SEND *INTERVAL* :REVERT)))
  (SEND *INTERVAL* :NAME))

(DEFMETHOD (:REVERT ZMAIL-PROFILE-INTERVAL) (&AUX STREAM)
  (DELETE-INTERVAL SELF)
  (UNWIND-PROTECT
    (CONDITION-CASE ()
	(SETQ STREAM (OPEN PATHNAME ':DIRECTION ':INPUT ':CHARACTERS ':DEFAULT))
      (FS:FILE-NOT-FOUND
	(TYPEIN-LINE "Creating profile ~A" PATHNAME)
	(FORMAT
	  (OPEN-INTERVAL-STREAM SELF)
	  ";~A's ZMAIL profile -*-Mode:LISP; Syntax:Zetalisp; Base:10; Package:ZWEI-*-~2%"
	  USER-ID)
	(INSERT-CHANGED-VARIABLES T)
	(MOVE-BP (WINDOW-POINT *WINDOW*) LAST-BP)
	(SETQ FILE-INFO NIL READ-TICK (TICK) SAVE-TICK *TICK*))
      (:NO-ERROR
        (UNLESS (SEND STREAM ':CHARACTERS)
	  (BARF "There is a compiled file in ~A, which is supposed to be the source file"
		PATHNAME))
	(TYPEIN-LINE "Reading profile ~A" (SEND STREAM ':TRUENAME))
	(REPARSE-ATTRIBUTE-LIST-INTERNAL SELF STREAM)
	(SETQ READ-TICK (TICK) SAVE-TICK *TICK*)
	(SEND SELF ':SET-FILE-INFO (SEND STREAM ':INFO))
	(SECTIONIZE-BUFFER SELF STREAM)
	(DECIDE-IF-SOURCE-MATCHES-COMPILED STREAM)))
    (AND STREAM (SEND STREAM ':CLOSE)))
  (SETQ NAME (SEND PATHNAME ':STRING-FOR-PRINTING))
  (SETQ *VARIABLE-TICK* (TICK))			;Now assumed to be the same
  (SETQ *EDITOR-VARIABLE-TICK* *TICK*)
  (SETQ READ-TICK (TICK))
  (SETQ SAVE-TICK *TICK*)
  (PUSH* *WINDOW* *WINDOW-LIST*)
  (SETQ SETUP-P T)
  (MUST-REDISPLAY *WINDOW* DIS-TEXT))

(DEFMETHOD (:PROCESS-SPECIAL-COMMAND ZMAIL-PROFILE-EDITOR) (&REST ARGS)
  (APPLY #'ZMAIL-PROFILE-COMMAND-LIST ARGS))

(DEFWHOPPER (:EDIT ZMAIL-PROFILE-EDITOR) ()
  (LET ((*EDITING-PROFILE* T))
    (UNWIND-PROTECT
	(PROGN
	  (SETF (TV:BLINKER-DESELECTED-VISIBILITY (WINDOW-POINT-BLINKER *WINDOW*)) :ON)
	  (SEND *PROFILE-WINDOW* :SEND-PANE 'EDIT-BUTTON :SET-ACCENT T)
	  (CONTINUE-WHOPPER))
      (SEND *PROFILE-WINDOW* :SEND-PANE 'EDIT-BUTTON :SET-ACCENT NIL)
      (SETF (TV:BLINKER-DESELECTED-VISIBILITY (WINDOW-POINT-BLINKER *WINDOW*)) NIL)
      (SEND *PROFILE-WINDOW* :SEND-PANE 'CHOOSE-WINDOW :SELECT NIL))))

(DEFSELECT (ZMAIL-PROFILE-COMMAND-LIST ZMAIL-COMMAND-LIST-DEFAULT)
  (:VARIABLE-CHOICE (WINDOW ITEM CHOICE LINE-NO &OPTIONAL (BUTTON #\MOUSE-L-1))
    (UNWIND-PROTECT
	(LET* ((VARIABLE (FIRST ITEM))
	       (OLD-VALUE (SYMEVAL VARIABLE)))
	  (SEND *PROFILE-WINDOW* :SEND-PANE 'CHOOSE-WINDOW :SELECT NIL)
	  (TV:CHOOSE-VARIABLE-VALUES-CHOICE WINDOW ITEM CHOICE LINE-NO BUTTON)
	  (SETQ *VARIABLE-TICK* (TICK))
	  (LET ((*EXPLICIT-OPTION-UPDATE* T))
	    (UPDATE-COMMAND-DOCUMENTATION-ASSOCIATED-WITH-OPTION VARIABLE))
	  (LABELS ((UPDATE-CVV-PANE ()
		     (SEND *PROFILE-WINDOW* :SEND-PANE
			   'CHOOSE-WINDOW :SET-VARIABLES (TV:PRUNE-USER-OPTION-ALIST
							   *ZMAIL-USER-OPTION-ALIST*)
							 T))
		   (SHOW-OPTION (OPTION)
		     (REMPROP OPTION 'TV:NOT-SITE-KEYWORDS-RESTRICTION))
		   (HIDE-OPTION (OPTION)
		     (PUTPROP OPTION T 'TV:NOT-SITE-KEYWORDS-RESTRICTION)))
	    (SELECTQ VARIABLE
	      (*ASK-BEFORE-EXECUTING-DANGEROUS-ZMAIL-COMMANDS*
	       (SELECTQ *ASK-BEFORE-EXECUTING-DANGEROUS-ZMAIL-COMMANDS*
		 (:ALL
		  (HIDE-OPTION '*SELECTED-DANGEROUS-ZMAIL-COMMANDS*)
		  (SHOW-OPTION '*TOO-MANY-MSGS-QUERY-THRESHOLD*))
		 (:SELECTIVE
		  (SHOW-OPTION '*SELECTED-DANGEROUS-ZMAIL-COMMANDS*)
		  (IF (MEMQ 'COM-ZMAIL-MAP-OVER *SELECTED-DANGEROUS-ZMAIL-COMMANDS*)
		      (SHOW-OPTION '*TOO-MANY-MSGS-QUERY-THRESHOLD*)
		      (HIDE-OPTION '*TOO-MANY-MSGS-QUERY-THRESHOLD*)))
		 (:NONE
		  (HIDE-OPTION '*SELECTED-DANGEROUS-ZMAIL-COMMANDS*)
		  (HIDE-OPTION '*TOO-MANY-MSGS-QUERY-THRESHOLD*)))
	       (WHEN (NEQ *ASK-BEFORE-EXECUTING-DANGEROUS-ZMAIL-COMMANDS* OLD-VALUE)
		 (UPDATE-CVV-PANE)))
	      (*SELECTED-DANGEROUS-ZMAIL-COMMANDS*
	       (IF (MEMQ 'COM-ZMAIL-MAP-OVER *SELECTED-DANGEROUS-ZMAIL-COMMANDS*)
		   (SHOW-OPTION '*TOO-MANY-MSGS-QUERY-THRESHOLD*)
		   (HIDE-OPTION '*TOO-MANY-MSGS-QUERY-THRESHOLD*))
	       (WHEN (NEQ (MEMQ 'COM-ZMAIL-MAP-OVER *SELECTED-DANGEROUS-ZMAIL-COMMANDS*)
			  (MEMQ 'COM-ZMAIL-MAP-OVER OLD-VALUE))
		 (UPDATE-CVV-PANE)))
	      (*DONT-REPLY-TO*
	       (COMPUTE-DONT-REPLY-TO-DIFFERENCES)))))
      (SEND *ZMAIL-WINDOW* :SELECT NIL)))
  (:MOUSE-BUTTON (CH WINDOW IGNORE IGNORE &AUX WINDOW-NAME *ZMAIL-COMMAND-BUTTON* NEAR-MODE)
    (COND ((NOT (OPERATION-HANDLED-P WINDOW :SET-ACCENT))
	   (SEND WINDOW :BEEP)
	   (WHEN (OR (EQ WINDOW *TYPEIN-WINDOW*) (EQ WINDOW *MODE-LINE-WINDOW*))
	     (SEND *PROFILE-WINDOW* :SEND-PANE 'CHOOSE-WINDOW :SELECT NIL)))
	  (T
	   (SEND WINDOW :SET-ACCENT T)		;It may have gotten turned off
	   (SET-COMMAND-BUTTON CH)
	   (SETQ WINDOW-NAME (SEND *PROFILE-WINDOW* :PANE-NAME WINDOW)
		 NEAR-MODE `(:WINDOW ,WINDOW))
	   (UNWIND-PROTECT
	       (SELECTQ WINDOW-NAME
		 (FILTERS-BUTTON
		  (PROFILE-FILTERS-BUTTON NEAR-MODE))
		 (UNIVERSES-BUTTON
		  (PROFILE-UNIVERSES-BUTTON NEAR-MODE))
		 (MAIL-FILES-BUTTON
		  (PROFILE-MAIL-FILES-BUTTON NEAR-MODE))
		 (KEYWORDS-BUTTON
		  (PROFILE-KEYWORDS-BUTTON NEAR-MODE))
		 (HARDCOPY-BUTTON
		  (LET ((*EDITING-PROFILE* T))
		    (CHOOSE-HARDCOPY-OPTIONS *DEFAULT-HARDCOPY-OPTIONS* T T NEAR-MODE))
		  (WHEN (HARDCOPY-OPTIONS-EQUAL *LAST-HARDCOPY-OPTIONS*
						*DEFAULT-HARDCOPY-OPTIONS* T)
		    (USING-HARDCOPY-OPTIONS (*DEFAULT-HARDCOPY-OPTIONS*)
		      (COMPLETE-HARDCOPY-OPTIONS *LAST-HARDCOPY-OPTIONS* T)))
		  (UPDATE-COMMAND-DOCUMENTATION-ASSOCIATED-WITH-OPTION
		    '*LAST-HARDCOPY-OPTIONS*))
		 (FILE-OPTIONS-BUTTON
		  (MULTIPLE-VALUE-BIND (BUFFERS-ALIST IGNORE UNLOADED-FILES-ALIST)
		      (GET-SEQUENCE-ALISTS T)
		    (WHEN (AND (NULL BUFFERS-ALIST) (NULL UNLOADED-FILES-ALIST))
		      (BARF "No mail files available at this time."))
		    (LET* ((ALIST `(,@(TV:MAKE-MENU-ITEM-LIST BUFFERS-ALIST
						     "Alter the attributes of this mail file."
							      '(NIL :BOLD NIL))
				    ,@(TV:MAKE-MENU-ITEM-LIST UNLOADED-FILES-ALIST
			  "Read in or create this mail file and then alter its attributes.")))
			   (BUFFER (TV:MENU-CHOOSE ALIST NIL NEAR-MODE)))
		      (COND (BUFFER
			     (WHEN (TYPEP BUFFER 'FS:PATHNAME)
			       (LET ((*ZMAIL-COMMAND-BUTTON* :LEFT))	;Never ask for format.
				 (SETQ BUFFER (LOAD-OR-CREATE-MAIL-FILE BUFFER))))
			     (LET ((*EDITING-PROFILE* T))
			       (CHOOSE-MAIL-FILE-OPTIONS BUFFER)))))))
		 (DONE-BUTTON
		  (*THROW 'EXIT-PROFILE-EDITOR T))
		 ((RESET-BUTTON DEFAULTS-BUTTON)
		  (LOAD-ZMAIL-PROFILE :BACKGROUND NIL
				      :RESET T
				      :LOAD (EQ WINDOW-NAME 'RESET-BUTTON)
				      :UPDATE-CONFIGURATION NIL
				      :PROFILE-EDITOR T)
		  (IF (EQ WINDOW-NAME 'RESET-BUTTON)
		      (WITH-OPEN-FILE-CASE (SRC-FILE (ZMAIL-PROFILE-PATHNAME :LISP)
						     :DIRECTION :PROBE
						     :IF-DOES-NOT-EXIST :ERROR)
			(FS:FILE-NOT-FOUND
			  (SETQ *PROFILE-COMPILE-TICK* NIL))
			(:NO-ERROR
			  (DECIDE-IF-SOURCE-MATCHES-COMPILED SRC-FILE)))
		    (SETQ *PROFILE-COMPILE-TICK* NIL))
		  (SEND *PROFILE-WINDOW* :SEND-PANE
			'CHOOSE-WINDOW :SET-VARIABLES (TV:PRUNE-USER-OPTION-ALIST
							*ZMAIL-USER-OPTION-ALIST*)
						      T)
		  (SETQ *VARIABLE-TICK* (TICK))
		  (COND ((SEND *INTERVAL* :MODIFIED-P :FOR-SAVING)
			 (IF (AND (EQ WINDOW-NAME 'RESET-BUTTON)
				  (TYPEOUT-BEEP-YES-OR-NO-P "Revert file buffer too? "))
			     (SEND *INTERVAL* :REVERT)
			   (INSERT-CHANGED-VARIABLES :ASK)))
			((EQ WINDOW-NAME 'RESET-BUTTON)
			 (SETQ *EDITOR-VARIABLE-TICK* *TICK*))
			(T
			 (INSERT-CHANGED-VARIABLES :ASK))))
		 (SAVE-BUTTON
		  (PROFILE-SAVE-BUTTON NEAR-MODE))
		 (EDIT-BUTTON
		  (INSERT-CHANGED-VARIABLES NIL)
		  (UNWIND-PROTECT
		      (PROGN
			(SELECT-WINDOW *WINDOW*)
			(SEND *PROFILE-EDITOR* :EDIT)
			(SECTIONIZE-BUFFER *INTERVAL*))
		    (SEND *ZMAIL-WINDOW* :SELECT NIL)))
		 (OTHERWISE
		  (BARF "~S is not a recognized window" WINDOW)))
	     (SEND WINDOW :SET-ACCENT NIL))))))

(DEFUN MAYBE-COMPILE-PROFILE-FILE ()
  (IF (AND *PROFILE-COMPILE-TICK*
	   (NEQ (SEND *INTERVAL* ':SAVE-TICK) *PROFILE-COMPILE-TICK*)
	   (TYPEOUT-BEEP-YES-OR-NO-P "Recompile Zmail profile? "))
      (COMPILE-ZMAIL-PROFILE)))

(DEFUN COMPILE-ZMAIL-PROFILE ()
  (COMPILER:COMPILE-FILE (ZMAIL-PROFILE-PATHNAME :LISP)
			 (ZMAIL-PROFILE-PATHNAME SI:*DEFAULT-BINARY-FILE-TYPE*))
  (LOAD-ZMAIL-PROFILE :BACKGROUND NIL
		      :RESET T
		      :LOAD T
		      :UPDATE-CONFIGURATION NIL
		      :PROFILE-EDITOR T)
  (SETQ *PROFILE-COMPILE-TICK* (SEND *INTERVAL* :SAVE-TICK)))

(DEFUN DECIDE-IF-SOURCE-MATCHES-COMPILED (STREAM)
  ;; We decide if the COMPILED file is the one corresponding with
  ;; the source file we found by checking both the specific pathname
  ;; and the creation dates.  Our argument is a stream for the source
  ;; file.
  (WITH-OPEN-FILE-CASE (COMPILED-STREAM (ZMAIL-PROFILE-PATHNAME SI:*DEFAULT-BINARY-FILE-TYPE*)
					':DIRECTION ':INPUT ':CHARACTERS ':DEFAULT)
    (FS:FILE-NOT-FOUND
      (SETQ *PROFILE-COMPILE-TICK* NIL))
    (:NO-ERROR
      (WHEN (SEND COMPILED-STREAM ':CHARACTERS)
	(SETQ *PROFILE-COMPILE-TICK* NIL)
	(BARF "The file ~A isn't a compiled file" (SEND COMPILED-STREAM ':TRUENAME)))
      (LET ((SRC-FILE (SEND STREAM ':TRUENAME))
	    (COMPILED-FILE (LET ((TEM (SI:BINARY-FILE-STREAM-ATTRIBUTE-LIST COMPILED-STREAM)))
			     (GET (LOCF TEM) ':QFASL-SOURCE-FILE-UNIQUE-ID))))
	(COND ((NEQ SRC-FILE COMPILED-FILE)
	       (TYPEIN-LINE
		 "(Profile compiled from ~A, current source = ~A.)~
                  ~%(Click Middle on SAVE to recompile.)"
		 COMPILED-FILE SRC-FILE)
	       (SETQ *PROFILE-COMPILE-TICK* NIL))
	      ((> (SEND STREAM ':CREATION-DATE)
		  (SEND COMPILED-STREAM ':CREATION-DATE))
	       (SETQ *PROFILE-COMPILE-TICK* NIL)
	       (TYPEIN-LINE
		 "(Your Compiled profile is older than its source file.)~
                  ~%(Click Middle on SAVE to recompile.)"
		 ))
	      (T (SETQ *PROFILE-COMPILE-TICK* (SEND *INTERVAL* ':SAVE-TICK))))))))

(DEFVAR USER-OPTION-DISCLAIMER-LINES
   '(";;; *** This block contains forms representing the non-default settings of user"
     ";;;     options that you made using the profile menus.  It is generated"
     ";;;     automatically.  Avoid inserting any other forms before the end of the block."))

(DEFVAR USER-OPTION-BLOCK-END
	";;; *** End of automatically generated user-option settings.")

(DEFUN INSERT-CHANGED-VARIABLES (WHEN)
  (COMPUTE-DONT-REPLY-TO-DIFFERENCES)	; Be certain that ADD-TO/DELETE-FROM site's
					; DONT-REPLY-TO list are accurate in case
					; *DONT-REPLY-TO* is set outside the Zmail INIT
  (UNWIND-PROTECT
      (PROGN
	(INVERT-CONFIGURATION-OPTIONS '(:FILTERING-COMMANDS) '(:NEW))
	(WHEN (OR (EQ WHEN T)
		  (AND (> *VARIABLE-TICK* *EDITOR-VARIABLE-TICK*)
		       (OR (NEQ WHEN ':ASK)
			   (TYPEOUT-BEEP-YES-OR-NO-P "Insert changed variables? "))))
	  (LET* ((BP (DO* ((SBP (INTERVAL-FIRST-BP *INTERVAL*))
			   (START-BP
			     (UNLESS (STRING-EQUAL (BP-LINE SBP) "(" 0 0 1 1)
			       (DO ((EBP (FORWARD-DEFINITION SBP 1 T))
				    (WBP SBP (FORWARD-LINE WBP)))
				   (NIL)
				 (COND ((OR (NULL WBP)
					    (BP-< EBP WBP))
					(RETURN NIL))
				       ((LOOKING-AT WBP (FIRST USER-OPTION-DISCLAIMER-LINES))
					(RETURN WBP))))))
			   (BP (OR START-BP (INTERVAL-FIRST-BP *INTERVAL*)))
			   (LAST-END-BP
			     (WHEN START-BP
			       (DO ((WBP START-BP (FORWARD-LINE WBP)))
				   ((NOT WBP)
				    NIL)
				 (WHEN (LOOKING-AT WBP USER-OPTION-BLOCK-END)
				   (SETQ WBP (FORWARD-LINE WBP))
				   (LOOP WHILE (STRING-EQUAL (BP-LINE WBP) "")
					 DOING (SETQ WBP (FORWARD-LINE WBP)))
				   (RETURN WBP))))))
			  (NIL)
		       (OR LAST-END-BP
			   (STRING-EQUAL (BP-LINE BP) "(" 0 0 1 1)
			   (SETQ BP (FORWARD-DEFINITION BP 1 T)))
		       (COND ((AND (LOOKING-AT BP "(LOGIN-SETQ ")
				   (LET ((BP1 (FORWARD-ATOM (CREATE-BP (BP-LINE BP) 11.))))
				     (AND BP1
					  (ATOM-WORD-SYNTAX-BIND
					    (LET ((WORD (BOUND-WORD BP1)))
					      (OR (ASS #'STRING-EQUAL WORD
						       *ZMAIL-USER-OPTION-ALIST*)
						  (ASS #'STRING-EQUAL WORD
						       *ZMAIL-HARDCOPY-OPTION-ALIST*)))))))
			      (OR START-BP (SETQ START-BP BP))
			      (SETQ BP (FORWARD-SEXP BP 1 T))
			      (SETQ BP (BEG-LINE BP 1 T))
			      (SETQ LAST-END-BP BP))
			     (T
			      (AND START-BP (DELETE-INTERVAL START-BP (OR LAST-END-BP BP) T))
			      (RETURN (OR LAST-END-BP BP))))))
		 (STREAM (OPEN-INTERVAL-STREAM BP)))
	    (FORMAT STREAM "~&~{~A~%~}" USER-OPTION-DISCLAIMER-LINES)
	    (SCL:WITH-STANDARD-IO-ENVIRONMENT
	      (LET* ((SYNTAX (OR (SEND *INTERVAL* :GET :SYNTAX) :ZETALISP))
		     (CL:*READTABLE* (SI:LISP-SYNTAX-READTABLE
				       (SI:LISP-SYNTAX-FROM-KEYWORD SYNTAX)))
		     (CL:*PACKAGE* (OR (SEND *INTERVAL* :GET :PACKAGE) *EDITOR-PACKAGE*)))
		(WRITE-USER-OPTIONS *ZMAIL-USER-OPTION-ALIST* STREAM)
		(USING-HARDCOPY-OPTIONS (*DEFAULT-HARDCOPY-OPTIONS*)
		  (WRITE-USER-OPTIONS		;Save the right set of hardcopy options
		    (DEL-IF #'(LAMBDA (ITEM)
				(NOT (MEMQ (FIRST ITEM) *ZMAIL-PROFILE-HARDCOPY-OPTIONS*)))
			    (COPYLIST *ZMAIL-HARDCOPY-OPTION-ALIST*))
		    STREAM))))
	    (FORMAT STREAM "~&~%~A~2%" USER-OPTION-BLOCK-END)
	    (SEND STREAM ':TYO #\CR)
	    (MUST-REDISPLAY *WINDOW* DIS-TEXT)
	    (SETQ *EDITOR-VARIABLE-TICK* (TICK)))))
    (INVERT-CONFIGURATION-OPTIONS '(:NEW) '(:FILTERING-COMMANDS))))

(DEFUN UPDATE-PROFILE-FOR-RENAMED-MAIL-FILE (MAIL-FILE NEW-PATHNAME)
  (LET ((OLD-PATHNAME (SEND MAIL-FILE :PATHNAME))
	(NEW-PATHNAME-STRING (STRING NEW-PATHNAME))
	(CHANGED-PROFILE NIL))
    (LABELS ((MARK-PROFILE-CHANGED ()
	       (UNLESS CHANGED-PROFILE
		 (SEND *PROFILE-EDITOR* :VARIABLE-TICK)
		 (TYPEIN-LINE-DURABLE
		   "[~~:[Click on Profile in the command menu and then~%click~;Click~]~
		     ~1Ton Save to permanently record the renaming of ~A~@
		     to ~A in your profile.~]"
		   *EDITING-PROFILE* OLD-PATHNAME NEW-PATHNAME)
		 (SETQ CHANGED-PROFILE T)))
	     (PATHNAMES-EQ (PATHNAME-1 PATHNAME-2)
	       (EQ (FS:MERGE-PATHNAMES PATHNAME-1 *ZMAIL-PATHNAME-DEFAULTS*)
		   (FS:MERGE-PATHNAMES PATHNAME-2 *ZMAIL-PATHNAME-DEFAULTS*)))
	     (UPDATE-PATHNAME-OPTION (PATHNAME-OPTION)
	       (WHEN (SYMEVAL PATHNAME-OPTION)
		 (WHEN (PATHNAMES-EQ (SYMEVAL PATHNAME-OPTION) OLD-PATHNAME)
		   (SETF (SYMEVAL PATHNAME-OPTION) NEW-PATHNAME)
		   (MARK-PROFILE-CHANGED))))
	     (UPDATE-PATHNAME-LIST-OPTION (PATHNAME-LIST-OPTION)
	       (LOOP FOR PATHNAME ON PATHNAME-LIST-OPTION
		     WHEN (PATHNAMES-EQ (FIRST PATHNAME) OLD-PATHNAME)
		       DO (SETF (FIRST PATHNAME) NEW-PATHNAME)
			  (MARK-PROFILE-CHANGED)))
	     (UPDATE-FILTER-ASSOCIATIONS-OPTION (FILTER-ASSOCIATIONS-OPTION)
	       (LOOP FOR FILTER-ASSOCIATION ON FILTER-ASSOCIATIONS-OPTION
		     AS PATHNAME-OR-UNIVERSE = (CDR (FIRST FILTER-ASSOCIATION))
		     WHEN (AND (STRINGP PATHNAME-OR-UNIVERSE)
			       (PATHNAMES-EQ PATHNAME-OR-UNIVERSE OLD-PATHNAME))
		       DO (SETF (CDR (FIRST FILTER-ASSOCIATION)) NEW-PATHNAME-STRING)
			  (MARK-PROFILE-CHANGED))))
      (UPDATE-PATHNAME-OPTION '*ZMAIL-STARTUP-FILE-NAME*)
      (UPDATE-PATHNAME-OPTION '*DEFAULT-MOVE-MAIL-FILE-NAME*)
      (UPDATE-PATHNAME-OPTION '*MAIL-FILE-FOR-DRAFTS*)
      (UPDATE-PATHNAME-LIST-OPTION *OTHER-MAIL-FILE-NAMES*)
      (UPDATE-PATHNAME-LIST-OPTION *DEFAULT-BFCC-LIST*)
      (UPDATE-PATHNAME-LIST-OPTION *DEFAULT-FCC-LIST*)
      (UPDATE-FILTER-ASSOCIATIONS-OPTION *FILTER-MOVE-MAIL-FILE-ALIST*)
      (UPDATE-FILTER-ASSOCIATIONS-OPTION *FILTER-REFERENCE-UNIVERSE-ALIST*)
      (WHEN (AND *EDITING-PROFILE* CHANGED-PROFILE)
	(SEND *PROFILE-WINDOW* :SEND-PANE 'CHOOSE-WINDOW :REFRESH)))))

(DEFMETHOD (:VARIABLE-TICK ZMAIL-PROFILE-EDITOR) ()
  (SETQ *VARIABLE-TICK* (TICK)))

(DEFFLAVOR ZMAIL-CHOOSE-VARIABLE-VALUES-PANE
	() 
	TV:(CHOOSE-VARIABLE-VALUES-PANE-MIXIN BASIC-CHOOSE-VARIABLE-VALUES
	    BORDERS-MIXIN TOP-BOX-LABEL-MIXIN SCROLL-STUFF-ON-OFF-MIXIN WINDOW))

(DEFFLAVOR ZMAIL-PROFILE-FRAME
	()
	(TV:STREAM-MIXIN TV:BORDERS-MIXIN
	 TV:PANE-MIXIN TV:ITEM-LIST-PANE-KLUDGE TV:FRAME-WITH-XOR-BUTTONS
	 TV:CONSTRAINT-FRAME-WITH-SHARED-IO-BUFFER TV:MINIMUM-WINDOW))

(DEFMETHOD (:INIT ZMAIL-PROFILE-FRAME :BEFORE) (IGNORE)
  (SETQ TV:PANES `((FILTERS-BUTTON TV:BUTTON-PANE :NAME "Filters" :DOCUMENTATION 
  "L: Menu of filters saved in profile;  M: Filter associations;  R: menu.")
		   (UNIVERSES-BUTTON TV:BUTTON-PANE :NAME "Universes" :DOCUMENTATION
  "L: Menu of universes saved in profile;  M: Universe-Filter associations;  R: menu.")
		   (MAIL-FILES-BUTTON TV:BUTTON-PANE :NAME "Mail files" :DOCUMENTATION
 "L: Menu of mail files saved in profile;  M: Move associations;  R: menu."
		    )
		   (KEYWORDS-BUTTON TV:BUTTON-PANE :NAME "Keywords" :DOCUMENTATION
  "L: Edit mail file-keyword associations;  M: Keywords-Filter associations;  R: menu.")
		   (HARDCOPY-BUTTON TV:BUTTON-PANE :NAME "Hardcopy" :DOCUMENTATION
  "Give choose variable values window for hardcopy user options.")
		   (FILE-OPTIONS-BUTTON TV:BUTTON-PANE :NAME "File options" :DOCUMENTATION
  "Give menu for mail file and alter the attributes of that mail file.")
		   (CHOOSE-WINDOW ZMAIL-CHOOSE-VARIABLE-VALUES-PANE
				  :STACK-GROUP ,SYS:%CURRENT-STACK-GROUP
				  :LABEL "User options:"
				  :VARIABLES
				    ,(TV:PRUNE-USER-OPTION-ALIST *ZMAIL-USER-OPTION-ALIST*))
		   (DONE-BUTTON TV:BUTTON-PANE :NAME "Exit" :DOCUMENTATION
				"Return to main command level.")
		   (RESET-BUTTON TV:BUTTON-PANE :NAME "Reset" :DOCUMENTATION
  "Set all options back to values in profile.  Offer to revert buffer if modified.")
		   (DEFAULTS-BUTTON TV:BUTTON-PANE :NAME "Defaults" :DOCUMENTATION
				    "Set all options back to normal system default values.")
		   (SAVE-BUTTON TV:BUTTON-PANE :NAME "Save"
		    :DOCUMENTATION "L: Save profile;  M: Make profile compiled;  R: menu.")
		   (EDIT-BUTTON TV:BUTTON-PANE :NAME "Edit" :DOCUMENTATION
				"Edit profile buffer."))

	TV:CONSTRAINTS
	  `((ONLY . ( (WHOLE-THING)
		     ((WHOLE-THING :HORIZONTAL (:EVEN)
		       (WHOLE)
		       ((WHOLE TV:WHITE-INCLUDE-WHITESPACE	;Vert
			 (1.0) (:EVEN)
			 (EXTENDED CHOOSE CONTROLS)
			 ((EXTENDED TV:FLOATING-BUTTONS
			   (FILTERS-BUTTON UNIVERSES-BUTTON MAIL-FILES-BUTTON
			    FILE-OPTIONS-BUTTON KEYWORDS-BUTTON HARDCOPY-BUTTON)))
			 ((CONTROLS TV:FLOATING-BUTTONS
			   (DONE-BUTTON RESET-BUTTON DEFAULTS-BUTTON SAVE-BUTTON
			    EDIT-BUTTON)))
			 ((CHOOSE TV:WHITE-INCLUDE-WHITESPACE	;Horiz
			   (0.68 :LINES CHOOSE-WINDOW) (:EVEN)	;just fits in small Mac screen
			   (CHOOSE-WINDOW)
			   ((CHOOSE-WINDOW 0.975)))))))))))))

(DEFMETHOD (:INITIALIZE ZMAIL-PROFILE-FRAME) ()
  (SEND SELF ':SEND-PANE 'CHOOSE-WINDOW ':SET-STACK-GROUP SYS:%CURRENT-STACK-GROUP)
  (SEND SELF ':TURN-OFF-ACCENTS))

D,#TD1PsT[Begin using 006 escapes](1 0 (NIL 0) (NIL :ITALIC NIL) "CPTFONTI");;; Put a profile option in its proper place.
0(DEFUN PUT-PROFILE-OPTION-AFTER (NEW-OPTION AFTER-OPTION
				 &OPTIONAL (OPTION-LIST-SYMBOL '*ZMAIL-USER-OPTION-ALIST*))
  (LET* ((OPTION-LIST (SYMEVAL OPTION-LIST-SYMBOL))
	 (NEW-OPTION-POSITION (CL:POSITION NEW-OPTION OPTION-LIST :KEY #'FIRST))
	 (AFTER-OPTION-POSITION (CL:POSITION AFTER-OPTION OPTION-LIST :KEY #'FIRST)))
    (UNLESS (= NEW-OPTION-POSITION (1+ AFTER-OPTION-POSITION))
      (SET OPTION-LIST-SYMBOL
	   (APPEND (CL:SUBSEQ OPTION-LIST 0 NEW-OPTION-POSITION)
		   (CL:SUBSEQ OPTION-LIST (1+ NEW-OPTION-POSITION) (1+ AFTER-OPTION-POSITION))
		   (LIST (CL:ELT OPTION-LIST NEW-OPTION-POSITION))
		   (CL:SUBSEQ OPTION-LIST (1+ AFTER-OPTION-POSITION)))))))

1;;; Reconstruct the contents of Zmail's profile frame's CVV window --
;;;    Invoke this method after adding a new user option or changing the definition of
;;;    an exisiting user option to insure that the profile's CVV window will be accurate.
0(DEFMETHOD (RECONSTRUCT-PROFILE-CVV-WINDOW ZMAIL-FRAME) ()
  (WHEN (TYPEP *PROFILE-WINDOW* 'ZMAIL-PROFILE-FRAME)
    (SEND *PROFILE-WINDOW* :SEND-PANE
	  'CHOOSE-WINDOW :SET-VARIABLES (TV:PRUNE-USER-OPTION-ALIST *ZMAIL-USER-OPTION-ALIST*)
					T)))

(DEFUN PROFILE-FILTERS-OR-UNIVERSES (SYMBOL-LIST NEAR-MODE LABEL
				     NEW-FUNCTION DEFINITION-ACCESSOR DEFINITION-TYPE
				     &AUX ACTIVE-LIST OLD-ACTIVE-LIST)
  (CHECK-INTERVAL-SECTIONS *INTERVAL*)
  (DOLIST (SYM SYMBOL-LIST)
    (SETQ SYM (TV:MENU-EXECUTE-NO-SIDE-EFFECTS SYM))
    (AND (LOOP FOR (TYPE) IN (SI:FUNCTION-SPEC-GET SYM 'ZMACS-BUFFERS)
	       THEREIS (EQ TYPE DEFINITION-TYPE))
	 (PUSH SYM ACTIVE-LIST)))
  (SETQ ACTIVE-LIST (NREVERSE ACTIVE-LIST)
	OLD-ACTIVE-LIST ACTIVE-LIST)
  (MULTIPLE-VALUE (SYMBOL-LIST ACTIVE-LIST)
    (ZMAIL-MULTIPLE-MENU-CHOOSE (COPYLIST SYMBOL-LIST)	;Will get nconc'ed
				ACTIVE-LIST NEW-FUNCTION NEAR-MODE LABEL))
  (BLOCK ABORT
    (WHEN (EQUAL ACTIVE-LIST OLD-ACTIVE-LIST)
      (RETURN-FROM ABORT NIL))
    ;; Make sure we have definitions for everything before doing deletions
    (WHEN ACTIVE-LIST
      (DOLIST (SYM ACTIVE-LIST)
	(FUNCALL DEFINITION-ACCESSOR SYM)))
    ;; Check for dependencies
    (DOLIST (SYM OLD-ACTIVE-LIST)
      (UNLESS (MEMQ SYM ACTIVE-LIST)
	(SELECTQ DEFINITION-TYPE
	  (DEFINE-FILTER
	   (LET ((KEYWORDS (LOOP FOR (FILTER . KEYWORDS) IN *FILTER-KEYWORDS-ALIST*
				 WHEN (EQ SYM FILTER)
				 COLLECT KEYWORDS))
		 (MOVE-MAIL-FILES (LOOP FOR (FILTER . MF) IN *FILTER-MOVE-MAIL-FILE-ALIST*
					WHEN (EQ SYM FILTER)
					COLLECT MF))
		 (UNIVERSES (LOOP FOR (FILTER . UV) IN *FILTER-REFERENCE-UNIVERSE-ALIST*
				  WHEN (EQ SYM FILTER)
				  COLLECT UV)))
	     (WHEN (OR KEYWORDS MOVE-MAIL-FILES UNIVERSES)
	       (UNLESS (TYPEOUT-YES-OR-NO-P 
 "Filter ~A is associated with ~:[~3*~;keyword~P ~{~A~^, ~}~:[~;, ~]~]~
                               ~:[~3*~;mail file~P ~{~A~^, ~}~:[~;, ~]~]~
                               ~:[~2*~;universe~P ~{~A~^, ~}~].  OK? "
			SYM KEYWORDS (LENGTH KEYWORDS) KEYWORDS (OR MOVE-MAIL-FILES UNIVERSES)
			MOVE-MAIL-FILES (LENGTH MOVE-MAIL-FILES) MOVE-MAIL-FILES
			UNIVERSES UNIVERSES (LENGTH UNIVERSES) UNIVERSES)
		 (RETURN-FROM ABORT NIL))
	       (LOOP FOR X IN KEYWORDS
		     DO (LOOP FOR Y IN *FILTER-KEYWORDS-ALIST*
			      WHEN (EQ (CDR Y) X)
			      RETURN (SETQ *FILTER-KEYWORDS-ALIST*
					   (DELQ Y *FILTER-KEYWORDS-ALIST*))))
	       (LOOP FOR X IN MOVE-MAIL-FILES
		     DO (LOOP FOR Y IN *FILTER-MOVE-MAIL-FILE-ALIST*
			      WHEN (EQ (CDR Y) X)
			      RETURN (SETQ *FILTER-MOVE-MAIL-FILE-ALIST*
					   (DELQ Y *FILTER-MOVE-MAIL-FILE-ALIST*))))
	       (LOOP FOR X IN UNIVERSES
		     DO (LOOP FOR Y IN *FILTER-REFERENCE-UNIVERSE-ALIST*
			      WHEN (EQ (CDR Y) X)
			      RETURN (SETQ *FILTER-REFERENCE-UNIVERSE-ALIST*
					   (DELQ Y *FILTER-REFERENCE-UNIVERSE-ALIST*)))))))
	  (DEFINE-UNIVERSE
	   (LET ((FILTERS (LOOP FOR (FILTER . UNIVERSE) IN *FILTER-REFERENCE-UNIVERSE-ALIST*
				WHEN (EQ SYM UNIVERSE)
				COLLECT FILTER)))
	     (WHEN FILTERS
	       (UNLESS (TYPEOUT-YES-OR-NO-P 
  "Universe ~A is associated with filter~P ~{~A~^, ~}.  OK? " SYM (LENGTH FILTERS) FILTERS)
		 (RETURN-FROM ABORT NIL))
	       (LOOP FOR X IN FILTERS
		     DO (LOOP FOR Y IN *FILTER-REFERENCE-UNIVERSE-ALIST*
			      WHEN (EQ (CAR Y) X)
			      RETURN (SETQ *FILTER-REFERENCE-UNIVERSE-ALIST*
					   (DELQ Y *FILTER-REFERENCE-UNIVERSE-ALIST*)))))))
	  )))
    (DOLIST (SYM SYMBOL-LIST)			;Delete sections that aren't wanted
      (SETQ SYM (TV:MENU-EXECUTE-NO-SIDE-EFFECTS SYM))
      (LOOP FOR (TYPE SECTION) IN (SI:FUNCTION-SPEC-GET SYM 'ZMACS-BUFFERS)
	    WHEN (EQ TYPE DEFINITION-TYPE)
	      DO (DELETE-INTERVAL		;delete only the definition
		   (DEFINITION-INTERVAL
		     (CREATE-BP (SEND SECTION :DEFINITION-LINE) 0) 1 NIL T T))))
    (AND ACTIVE-LIST
	 (LET ((BP (INTERVAL-LAST-BP *INTERVAL*)))
	   (DOLIST (SYM ACTIVE-LIST)			;New ones to add
	     (INSERT BP #\CR)
	     (GRIND-INTO-BP BP (FUNCALL DEFINITION-ACCESSOR SYM))
	     (INSERT BP #\CR))
	   (MOVE-BP (WINDOW-POINT *WINDOW*) BP)))
    (MUST-REDISPLAY *WINDOW* DIS-TEXT)
    (SECTIONIZE-BUFFER *INTERVAL*)))

(DEFUN PROFILE-NEW-FILTER (WINDOW &OPTIONAL IGNORE IGNORE &AUX FILTER)
  (SEND WINDOW ':DEACTIVATE)
  (SETQ FILTER (DEFINE-NEW-FILTER))
  (ASSQ FILTER *USER-FILTER-ALIST*))		;Return a menu item

(DEFUN PROFILE-NEW-UNIVERSE (WINDOW &OPTIONAL IGNORE IGNORE)
  (SEND WINDOW :DEACTIVATE)
  (DEFINE-NEW-UNIVERSE))

(DEFUN EDIT-BUFFER-KEYWORDS (NEAR-MODE &AUX STRING)
  (MULTIPLE-VALUE-BIND (BUFFER-LIST IGNORE IGNORE)
      (GET-SEQUENCE-ALISTS)
    (DOLIST (BUFFER-ITEM BUFFER-LIST)
      (LET ((BUFFER (CDR BUFFER-ITEM)))
	(WHEN (MEMQ :KEYWORDS (POSSIBLE-MAIL-FILE-OPTIONS BUFFER))
	  (UPDATE-OPTIONS-IN-FILE BUFFER)	;Make sure string correct
	  (UNLESS STRING (SETQ STRING (MAKE-EMPTY-STRING 100.)))
	  (APPEND-TO-ARRAY STRING (SEND BUFFER :NAME))
	  (APPEND-TO-ARRAY STRING "::")
	  (APPEND-TO-ARRAY STRING (OR (SEND BUFFER :GET :KEYWORDS-STRING) ""))
	  (ARRAY-PUSH-EXTEND STRING #\CR)))))
  (UNLESS STRING (BARF "No mail files able to remember keywords."))
  (WHEN (SETQ STRING (POP-UP-EDSTRING STRING NEAR-MODE
				      `("Zmail " "Keywords"
					,(FORMAT NIL "     ~:@C ends, ~:@C aborts"
						 #\END #\ABORT))
				      #o600 #o100
				      "Format is Mail file::key1,key2,..."))
    (DO ((I 0 (1+ I))
	 (J)
	 (BUFFER))
	(NIL)
      (UNLESS (SETQ I (STRING-SEARCH-NOT-SET *WHITESPACE-CHARS* STRING I))
	(RETURN NIL))
      (UNLESS (SETQ J (STRING-SEARCH "::" STRING I))
	(BARF "Returned string in bad format, no colons found."))
      (SETQ BUFFER (SUBSTRING STRING I J))
      (SETQ BUFFER (OR (GET-MAIL-BUFFER-FROM-NAME BUFFER)
		       (BARF "No mail file named ~A." BUFFER)))
      (SETQ J (+ J 2)
	    I (STRING-SEARCH-CHAR #\CR STRING J))
      (LOOP WITH OPTIONS = (SEND BUFFER :PROPERTY-LIST-LOCATION)
	    FOR (PROPNAME PROPVAL) ON (PARSE-KEYWORDS-LIST NIL STRING J I) BY 'CDDR
	    DO (PUTPROP OPTIONS PROPVAL PROPNAME))    
      (UPDATE-OPTIONS-IN-FILE BUFFER)
      (UNLESS I
	(RETURN NIL)))))

(DEFVAR *PROFILE-SAVE-MENU-ALIST*
  '(("Insert changes" :VALUE :INSERT-CHANGED
		      :DOCUMENTATION
		        "Insert changed option settings but do not save the profile")
    ("Save" :VALUE :SAVE
	    :DOCUMENTATION "Save the profile but do not insert changed option settings")
    ("Compile" :VALUE :COMPILE-PROFILE
	       :DOCUMENTATION "Compile the profile which will make loading it faster")
    ("Reap" :VALUE :REAP :DOCUMENTATION "Offer to delete old versions of the profile")))

(DEFUN PROFILE-SAVE-BUTTON (NEAR-MODE)
  (LET ((MODE (SELECTQ *ZMAIL-COMMAND-BUTTON*
		((:LEFT :KBD) :SAVE-ALL)
		(:MIDDLE :COMPILE-PROFILE)
		(:RIGHT
		 (DW:MENU-CHOOSE *PROFILE-SAVE-MENU-ALIST* :PROMPT "Operation on profile:"
							   :NEAR-MODE NEAR-MODE)))))
    (SELECTQ MODE
      (:SAVE
       (COM-SAVE-FILE))
      (:INSERT-CHANGED
       (INSERT-CHANGED-VARIABLES T))
      (:REAP
       (REAP-FILE (SEND (ZMAIL-PROFILE-PATHNAME :WILD) :NEW-PATHNAME :VERSION :WILD)))
      (:COMPILE-PROFILE
       (INSERT-CHANGED-VARIABLES :ASK)
       (LET ((SAVED-PROFILE-IS-UP-TO-DATE (MAYBE-SAVE-ZMAIL-PROFILE)))
	 (WHEN (OR SAVED-PROFILE-IS-UP-TO-DATE
		   (TYPEOUT-BEEP-YES-OR-NO-P "The saved profile does not reflect your ~
					      current options settings or editing.~@
					      ~2@TCompile it anyway? "))
	   (COMPILE-ZMAIL-PROFILE))))
      (:SAVE-ALL
       (INSERT-CHANGED-VARIABLES :ASK)
       (COM-SAVE-FILE)
       (MAYBE-COMPILE-PROFILE-FILE)))))

1;;; Save the profile if needed and the user grants permission
0(DEFUN MAYBE-SAVE-ZMAIL-PROFILE ()
  (WHEN (AND (SEND *INTERVAL* :MODIFIED-P)
	     (TYPEOUT-BEEP-YES-OR-NO-P "Save Zmail profile? "))
    (SAVE-BUFFER *INTERVAL*))
  (NOT (OR (> *VARIABLE-TICK* *EDITOR-VARIABLE-TICK*) (SEND *INTERVAL* :MODIFIED-P))))

(DEFUN PROFILE-MAIL-FILES-BUTTON (NEAR-MODE &AUX MODE)
  (SETQ MODE (SELECTQ *ZMAIL-COMMAND-BUTTON*
	       ((:LEFT :KBD) ':OTHER-MAIL-FILES)
	       (:MIDDLE ':FILTER-ASSOCIATIONS)
	       (:RIGHT
		(TV:MENU-CHOOSE '(("Other mail files" :VALUE :OTHER-MAIL-FILES :DOCUMENTATION
 "Give a menu of non-default mail files to be remembered in profile.")
				  ("Filter associations" :VALUE :FILTER-ASSOCIATIONS
				   :DOCUMENTATION "Associate a mail file with filters."))
				NIL NEAR-MODE))))
  (SELECTQ MODE
    (:OTHER-MAIL-FILES (EDIT-OTHER-MAIL-FILES NEAR-MODE))
    (:FILTER-ASSOCIATIONS (GET-MAIL-FILE-FILTER-ASSOCIATIONS NEAR-MODE))))

(DEFUN EDIT-OTHER-MAIL-FILES (NEAR-MODE)
  (MULTIPLE-VALUE-BIND (BUFFERS-ALIST IGNORE UNLOADED-FILES-ALIST)
      (GET-SEQUENCE-ALISTS T)
    (LET* ((ALL-MAIL-FILES-LIST
	     (SORTCAR `(,@BUFFERS-ALIST ,@UNLOADED-FILES-ALIST) #'STRING-LESSP))
	   (FILES-IN-PROFILE-LIST
	     (LOOP FOR MAIL-FILE IN *OTHER-MAIL-FILE-NAMES*
		   AS MAIL-FILE-NAME = (SEND (FS:MERGE-PATHNAMES MAIL-FILE
								 *ZMAIL-PATHNAME-DEFAULTS*)
					     :STRING-FOR-EDITOR)
		   COLLECT (CDR (ASSOC MAIL-FILE-NAME ALL-MAIL-FILES-LIST)))))
      (MULTIPLE-VALUE-BIND (ALL-MAIL-FILES-LIST FILES-IN-PROFILE-LIST)
	  (ZMAIL-MULTIPLE-MENU-CHOOSE ALL-MAIL-FILES-LIST FILES-IN-PROFILE-LIST
				      'MULTIPLE-MENU-NEW-PATHNAME NEAR-MODE
				      "Mail files to be remembered in profile")
	(LET ((NEW-FILES-IN-PROFILE-LIST
		(LOOP FOR (NIL . FILE-OR-BUFFER) IN ALL-MAIL-FILES-LIST
		      WHEN (MEMQ FILE-OR-BUFFER FILES-IN-PROFILE-LIST)
			COLLECT (SEND FILE-OR-BUFFER :STRING-FOR-PRINTING))))
	  (WHEN (NOT (EQUAL *OTHER-MAIL-FILE-NAMES* NEW-FILES-IN-PROFILE-LIST))
	    (SETQ *OTHER-MAIL-FILE-NAMES* NEW-FILES-IN-PROFILE-LIST
		  *VARIABLE-TICK* (TICK))))))))

(DEFUN PROFILE-KEYWORDS-BUTTON (NEAR-MODE &AUX MODE)
  (SETQ MODE (SELECTQ *ZMAIL-COMMAND-BUTTON*
	       ((:LEFT :KBD) ':EDIT-KEYWORDS)
	       (:MIDDLE ':FILTER-ASSOCIATIONS)
	       (:RIGHT
		(TV:MENU-CHOOSE '(("Mail files keywords" :VALUE :EDIT-KEYWORDS
				   :DOCUMENTATION
				   "Edit the keywords associated with a mail file.")
				  ("Filter associations" :VALUE :FILTER-ASSOCIATIONS
				   :DOCUMENTATION "Associate a keyword with filters."))
				NIL NEAR-MODE))))
  (SELECTQ MODE
    (:EDIT-KEYWORDS (EDIT-BUFFER-KEYWORDS NEAR-MODE))
    (:FILTER-ASSOCIATIONS (GET-KEYWORD-FILTER-ASSOCIATIONS NEAR-MODE))))

(DEFUN PROFILE-FILTERS-BUTTON (NEAR-MODE &AUX MODE)
  (SETQ MODE (SELECTQ *ZMAIL-COMMAND-BUTTON*
	       ((:LEFT :KBD) ':EDIT-FILTERS)
	       (:MIDDLE ':FILTER-ASSOCIATIONS)
	       (:RIGHT
		(TV:MENU-CHOOSE '(("Edit filter list" :VALUE :EDIT-FILTERS :DOCUMENTATION
				   "Give a menu of filters to be remembered in profile.")
				  ("Filter associations" :VALUE :FILTER-ASSOCIATIONS
				   :DOCUMENTATION
  "Associate a filter with keywords, move mail files, or universes.")
				  ("Edit existing filter" :VALUE :EDIT-FILTER
				   :DOCUMENTATION "Edit an already defined filter.")
				  )
				NIL NEAR-MODE))))
  (SELECTQ MODE
    (:EDIT-FILTERS
      (PROFILE-FILTERS-OR-UNIVERSES *USER-FILTER-ALIST* NEAR-MODE
				    "Filters to be remembered in profile"
				    'PROFILE-NEW-FILTER 'GET-FILTER-DEFINITION
				    'DEFINE-FILTER))
    (:FILTER-ASSOCIATIONS
     (GET-FILTER-ASSOCIATIONS NEAR-MODE))
    (:EDIT-FILTER
     (EDIT-EXISTING-FILTER NEAR-MODE))))

(DEFUN PROFILE-UNIVERSES-BUTTON (NEAR-MODE &AUX MODE)
  (SETQ MODE (SELECTQ *ZMAIL-COMMAND-BUTTON*
	       ((:LEFT :KBD) ':EDIT-UNIVERSES)
	       (:MIDDLE ':FILTER-ASSOCIATIONS)
	       (:RIGHT
		(TV:MENU-CHOOSE '(("Edit universe list" :VALUE :EDIT-UNIVERSES :DOCUMENTATION
				   "Give a menu of universes to be remembered in profile.")
				  ("Filter associations" :VALUE :FILTER-ASSOCIATIONS
				   :DOCUMENTATION "Associate a universe with filters.")
				  ("Edit existing universe" :VALUE :EDIT-UNIVERSE
				   :DOCUMENTATION "Edit an already defined universe."))
				NIL NEAR-MODE))))
  (SELECTQ MODE
    (:EDIT-UNIVERSES
     (PROFILE-FILTERS-OR-UNIVERSES *UNIVERSE-LIST* NEAR-MODE
				   "Universes to be remembered in profile"
				   'PROFILE-NEW-UNIVERSE 'GET-UNIVERSE-DEFINITION
				   'DEFINE-UNIVERSE))
    (:FILTER-ASSOCIATIONS
     (GET-UNIVERSE-FILTER-ASSOCIATIONS NEAR-MODE))
    (:EDIT-UNIVERSE
     (EDIT-EXISTING-UNIVERSE NEAR-MODE))))

(DEFUN GET-MAIL-FILE-FILTER-ASSOCIATIONS (NEAR-MODE)
  (LET* ((MAIL-FILE
	   (GET-MAIL-FILE-OR-NEW NEAR-MODE
				 "Select a mail file whose filter associations to edit"))
	 (OLD-FILTERS (LOOP FOR (FILTER . MF) IN *FILTER-MOVE-MAIL-FILE-ALIST*
			    WHEN (EQUAL MF MAIL-FILE)
			      COLLECT FILTER)))
    (MULTIPLE-VALUE-BIND (IGNORE NEW-FILTERS)
	(ZMAIL-MULTIPLE-MENU-CHOOSE *USER-FILTER-ALIST* OLD-FILTERS 'PROFILE-NEW-FILTER
				    NEAR-MODE
				    (FORMAT NIL "Filters associated with ~A:" MAIL-FILE))
      (WHEN (NOT (EQUAL OLD-FILTERS NEW-FILTERS))
	(LOOP FOR ITEM IN *USER-FILTER-ALIST*
	      AS FILTER = (TV:MENU-EXECUTE-NO-SIDE-EFFECTS ITEM)
	      IF (MEMQ FILTER NEW-FILTERS)
		DO (SET-MAIL-FILE-FILTER-ASSOCIATION FILTER MAIL-FILE)
	      ELSE IF (MEMQ FILTER OLD-FILTERS)
		DO (SET-MAIL-FILE-FILTER-ASSOCIATION FILTER NIL))
	(SETQ *VARIABLE-TICK* (TICK))))))

(DEFUN GET-UNIVERSE-FILTER-ASSOCIATIONS (NEAR-MODE)
  (MULTIPLE-VALUE-BIND (BUFFERS-ALIST IGNORE UNLOADED-FILES-ALIST)
      (GET-SEQUENCE-ALISTS T)
    (LET* ((ALL-MAIL-FILE-NAMES (SORTCAR `(,@BUFFERS-ALIST ,@UNLOADED-FILES-ALIST)
					 #'STRING-LESSP))
	   (UNIVERSE
	     (MENU-CHOOSE-WITH-NEW `(,@(TV:MAKE-MENU-ITEM-LIST *UNIVERSE-LIST*
							       "Use this universe.")
				     ,@(TV:MAKE-MENU-ITEM-LIST ALL-MAIL-FILE-NAMES
						       "Use this mail file as the universe."))
				   'PROFILE-NEW-UNIVERSE NEAR-MODE
				   "Select a universe whose filter associations to edit:"))
	   (UNIVERSE
	     (COND ((EQ UNIVERSE :NONE) (ABORT-CURRENT-COMMAND))
		   ((TYPEP UNIVERSE 'SEQUENCE) (SEND UNIVERSE :NAME))
		   ((TYPEP UNIVERSE 'FS:PATHNAME) (SEND UNIVERSE :STRING-FOR-PRINTING))
		   (T UNIVERSE)))
	   (OLD-FILTERS (LOOP FOR (FILTER . UV) IN *FILTER-REFERENCE-UNIVERSE-ALIST*
			      WHEN (EQUAL UV UNIVERSE)
				COLLECT FILTER)))
      (MULTIPLE-VALUE-BIND (IGNORE NEW-FILTERS)
	  (ZMAIL-MULTIPLE-MENU-CHOOSE *USER-FILTER-ALIST* OLD-FILTERS 'PROFILE-NEW-FILTER
				      NEAR-MODE
				      (FORMAT NIL "Filters associated with ~A:" UNIVERSE))
	(WHEN (NOT (EQUAL OLD-FILTERS NEW-FILTERS))
	  (LOOP FOR ITEM IN *USER-FILTER-ALIST*
		AS FILTER = (TV:MENU-EXECUTE-NO-SIDE-EFFECTS ITEM)
		IF (MEMQ FILTER NEW-FILTERS)
		  DO (SET-UNIVERSE-FILTER-ASSOCIATION FILTER UNIVERSE)
		ELSE IF (MEMQ FILTER OLD-FILTERS)
		  DO (SET-UNIVERSE-FILTER-ASSOCIATION FILTER NIL))
	  (SETQ *VARIABLE-TICK* (TICK)))))))

(DEFUN GET-KEYWORD-FILTER-ASSOCIATIONS (NEAR-MODE &AUX KEYWORD OLD-FILTERS NEW-FILTERS)
  (SETQ KEYWORD (MENU-CHOOSE-WITH-NEW *KEYWORD-ALIST* 'MULTIPLE-MENU-NEW-KEYWORD NEAR-MODE
				      "Select a keyword whose filter associations to edit"))
  (SETQ OLD-FILTERS (LOOP FOR (FILTER . KEYWORDS) IN *FILTER-KEYWORDS-ALIST*
			  WHEN (MEMQ KEYWORD KEYWORDS)
			  COLLECT FILTER))
  (MULTIPLE-VALUE (NIL NEW-FILTERS)
    (ZMAIL-MULTIPLE-MENU-CHOOSE *USER-FILTER-ALIST* OLD-FILTERS 'PROFILE-NEW-FILTER
				NEAR-MODE
				(FORMAT NIL "Filters associated with ~A:"
					(CAR (RASSQ KEYWORD *KEYWORD-ALIST*)))))
  (COND ((NOT (EQUAL OLD-FILTERS NEW-FILTERS))
	 (DOLIST (ELEM *USER-FILTER-ALIST*)
	   (LET* ((FILTER (TV:MENU-EXECUTE-NO-SIDE-EFFECTS ELEM))
		  (ITEM (ASSQ FILTER *FILTER-KEYWORDS-ALIST*)))
	     (IF (MEMQ FILTER NEW-FILTERS)
		 (IF ITEM (PUSH* KEYWORD (CDR ITEM))
		     (SETQ *FILTER-KEYWORDS-ALIST* (NCONC *FILTER-KEYWORDS-ALIST*
							  (NCONS (LIST FILTER KEYWORD)))))
		 (AND ITEM (SETF (CDR ITEM) (DELQ KEYWORD (CDR ITEM)))))))
	 (SETQ *VARIABLE-TICK* (TICK)))))

(DEFUN GET-FILTER-ASSOCIATIONS (NEAR-MODE)
  (LET ((FILTER (MENU-CHOOSE-WITH-NEW *USER-FILTER-ALIST* 'PROFILE-NEW-FILTER NEAR-MODE
				      "Select a filter whose associations to edit")))
    (SELECTQ (OR (TV:MENU-CHOOSE '(("Keywords" :VALUE :KEYWORDS :DOCUMENTATION
				    "Edit keywords associated with this filter.")
				   ("Mail files" :VALUE :MAIL-FILES :DOCUMENTATION
				    "Set mail file associated with this filter.")
				   ("Universes" :VALUE :UNIVERSES :DOCUMENTATION
				    "Set universe associated with this filter.")))
		 (ABORT-CURRENT-COMMAND))
      (:KEYWORDS
       (LET* ((ITEM (ASSQ FILTER *FILTER-KEYWORDS-ALIST*))
	      (OLD-KEYWORDS (CDR ITEM))
	      NEW-KEYWORDS)
	 (SETQ NEW-KEYWORDS (CHOOSE-KEYWORDS (FORMAT NIL "Keywords associated with ~A:"
						     FILTER)
					     OLD-KEYWORDS))
	 (COND ((NOT (EQUAL OLD-KEYWORDS NEW-KEYWORDS))
		(IF (NULL NEW-KEYWORDS)
		    (AND ITEM
			 (SETQ *FILTER-KEYWORDS-ALIST* (DELQ ITEM *FILTER-KEYWORDS-ALIST*)))
		    (IF ITEM (SETF (CDR ITEM) NEW-KEYWORDS)
			(SETQ *FILTER-KEYWORDS-ALIST*
			      (NCONC *FILTER-KEYWORDS-ALIST*
				     (NCONS (CONS FILTER NEW-KEYWORDS))))))
		(SETQ *VARIABLE-TICK* (TICK))))))
      (:MAIL-FILES
       (LET ((MAIL-FILE (GET-MAIL-FILE-OR-NEW NEAR-MODE
					      (FORMAT NIL "Mail file associated with ~A:"
						      FILTER)
					      T)))
	 (SET-MAIL-FILE-FILTER-ASSOCIATION FILTER MAIL-FILE)))
      (:UNIVERSES
       (MULTIPLE-VALUE-BIND (BUFFERS-ALIST IGNORE UNLOADED-FILES-ALIST)
	   (GET-SEQUENCE-ALISTS T)
	 (LET* ((ALL-MAIL-FILE-NAMES (SORTCAR `(,@BUFFERS-ALIST ,@UNLOADED-FILES-ALIST)
					      #'STRING-LESSP))
		(UNIVERSE
		  (MENU-CHOOSE-WITH-NEW `(("None" :VALUE :NONE
					   :STYLE (:DUTCH :ITALIC :NORMAL)
					   :DOCUMENTATION "Remove any association.")
					  ,@(TV:MAKE-MENU-ITEM-LIST ALL-MAIL-FILE-NAMES
							"Use this mail file as the universe.")
					  ,@(TV:MAKE-MENU-ITEM-LIST *UNIVERSE-LIST*
								    "Use this universe."))
					'PROFILE-NEW-UNIVERSE NEAR-MODE
					(FORMAT NIL "Universe associated with ~A:" FILTER)))
		(UNIVERSE
		  (COND ((EQ UNIVERSE :NONE) NIL)
			((TYPEP UNIVERSE 'SEQUENCE) (SEND UNIVERSE :NAME))
			((TYPEP UNIVERSE 'FS:PATHNAME) (SEND UNIVERSE :STRING-FOR-PRINTING))
			(T UNIVERSE))))
	   (SET-UNIVERSE-FILTER-ASSOCIATION FILTER UNIVERSE)))))))

(DEFUN GET-MAIL-FILE-OR-NEW (NEAR-MODE LABEL &OPTIONAL NONE-OK)
  (MULTIPLE-VALUE-BIND (BUFFERS-ALIST IGNORE UNLOADED-FILES-ALIST)
      (GET-SEQUENCE-ALISTS T)
    (LET* ((ALL-MAIL-FILE-NAMES (SORTCAR `(,@BUFFERS-ALIST ,@UNLOADED-FILES-ALIST)
					 #'STRING-LESSP))
	   (MAIL-FILE (MENU-CHOOSE-WITH-NEW
			`(,@(IF NONE-OK '(("None" :VALUE :NONE
						  :STYLE (:DUTCH :ITALIC :NORMAL)
						  :DOCUMENTATION "Remove any association.")))
			  ,@(TV:MAKE-MENU-ITEM-LIST ALL-MAIL-FILE-NAMES
						    "Use this mail file."))
			'PROFILE-NEW-MAIL-FILE-PATHNAME NEAR-MODE LABEL)))
      (COND ((NULL MAIL-FILE) (BARF "Invalid mail file specification."))
	    ((EQ MAIL-FILE :NONE) NIL)
	    ((TYPEP MAIL-FILE 'SEQUENCE) (SEND MAIL-FILE :NAME))
	    ((TYPEP MAIL-FILE 'FS:PATHNAME) (SEND MAIL-FILE :STRING-FOR-PRINTING))
	    (T (BARF "Invalid mail file specification."))))))

(DEFUN PROFILE-NEW-MAIL-FILE-PATHNAME (&REST ARGS)
  (LET ((ITEM (APPLY #'MULTIPLE-MENU-NEW-PATHNAME ARGS)))
    (AND ITEM (PUSH (SEND (CDR ITEM) :STRING-FOR-PRINTING) *OTHER-OTHER-MAIL-FILE-NAMES*))
    ITEM))

(DEFUN SET-MAIL-FILE-FILTER-ASSOCIATION (FILTER MAIL-FILE)
  (LET ((ITEM (ASSQ FILTER *FILTER-MOVE-MAIL-FILE-ALIST*)))
    (IF MAIL-FILE
	(IF ITEM
	    (SETF (CDR ITEM) MAIL-FILE)
	  (SETQ *FILTER-MOVE-MAIL-FILE-ALIST* (NCONC *FILTER-MOVE-MAIL-FILE-ALIST*
						     (NCONS (CONS FILTER MAIL-FILE)))))
      (SETQ *FILTER-MOVE-MAIL-FILE-ALIST* (DELQ ITEM *FILTER-MOVE-MAIL-FILE-ALIST*)))
    (SETQ *VARIABLE-TICK* (TICK))))

(DEFUN SET-UNIVERSE-FILTER-ASSOCIATION (FILTER UNIVERSE)
  (LET ((ITEM (ASSQ FILTER *FILTER-REFERENCE-UNIVERSE-ALIST*)))
    (IF UNIVERSE
	(IF ITEM
	    (SETF (CDR ITEM) UNIVERSE)
	  (SETQ *FILTER-REFERENCE-UNIVERSE-ALIST* (NCONC *FILTER-REFERENCE-UNIVERSE-ALIST*
							 (NCONS (CONS FILTER UNIVERSE)))))
      (SETQ *FILTER-REFERENCE-UNIVERSE-ALIST* (DELQ ITEM *FILTER-REFERENCE-UNIVERSE-ALIST*)))
    (SETQ *VARIABLE-TICK* (TICK))))

(DEFUN EDIT-EXISTING-FILTER (NEAR-MODE)
  (LET* ((FILTER (ZMAIL-MENU-CHOOSE NIL *USER-FILTER-ALIST* NEAR-MODE NIL
				    "Select a filter to edit"))
	 (EDITED-FILTER (DEFINE-NEW-FILTER FILTER)))
    (WHEN EDITED-FILTER
      (UPDATE-PROFILE-IF-ENTITY-CHANGED EDITED-FILTER
					'GET-FILTER-DEFINITION 'DEFINE-FILTER))))

(DEFUN EDIT-EXISTING-UNIVERSE (NEAR-MODE)
  (LET* ((UNIVERSE (ZMAIL-MENU-CHOOSE NIL *UNIVERSE-LIST* NEAR-MODE NIL
				      "Select a universe to edit"))
	 (EDITED-UNIVERSE (DEFINE-NEW-UNIVERSE UNIVERSE)))
    (WHEN EDITED-UNIVERSE
      (UPDATE-PROFILE-IF-ENTITY-CHANGED EDITED-UNIVERSE
					'GET-UNIVERSE-DEFINITION 'DEFINE-UNIVERSE))))

(DEFUN UPDATE-PROFILE-IF-ENTITY-CHANGED (ENTITY DEFINITION-ACCESSOR DEFINITION-TYPE)
  (CHECK-INTERVAL-SECTIONS *INTERVAL*)
  (LET ((SECTION (GET-SECTION-NODE-IN-BUFFER ENTITY DEFINITION-TYPE *INTERVAL* NIL NIL)))
    (WHEN SECTION
      (DELETE-INTERVAL
	(DEFINITION-INTERVAL (CREATE-BP (SECTION-NODE-DEFINITION-LINE SECTION) 0) 1 NIL T T))
      (LET ((BP (INTERVAL-LAST-BP *INTERVAL*)))
	(INSERT BP #\Return)
	(GRIND-INTO-BP BP (FUNCALL DEFINITION-ACCESSOR ENTITY))
	(INSERT BP #\Return))
      (MUST-REDISPLAY *WINDOW* DIS-TEXT)
      (SECTIONIZE-BUFFER *INTERVAL*))))

(DEFMETHOD (:GET-EXPR-DEFINITION ZMAIL-PROFILE-EDITOR) (SYMBOL DEFINITION-TYPE
							EXPR-PROPERTY COMPILED-PROPERTY)
  (SETUP-ZMAIL-PROFILE)
  (LET ((OLD-DEFINITION (GET SYMBOL COMPILED-PROPERTY))
	(SECTION (LOOP FOR (TYPE SECTION) IN (SI:FUNCTION-SPEC-GET SYMBOL 'ZMACS-BUFFERS)
		       WHEN (EQ TYPE DEFINITION-TYPE) RETURN SECTION))
	NEW-DEFINITION)
    (OR SECTION (BARF "Cannot find the source definition of ~A" SYMBOL))
    (LET ((SI:FDEFINE-FILE-PATHNAME (SEND (ZMAIL-PROFILE-PATHNAME) ':GENERIC-PATHNAME)))
      (EVAL (READ (OPEN-INTERVAL-STREAM SECTION))))
    (OR (SETQ NEW-DEFINITION (GET SYMBOL COMPILED-PROPERTY))
	(BARF "The definition form for ~A is messed up."))
    (PUTPROP SYMBOL OLD-DEFINITION COMPILED-PROPERTY)
    (PUTPROP SYMBOL NEW-DEFINITION EXPR-PROPERTY)
    NEW-DEFINITION))
