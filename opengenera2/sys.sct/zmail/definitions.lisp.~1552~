;;; -*- Syntax: Zetalisp; Mode: LISP; Package: ZWEI; Base: 8 -*-
;;; Lisp Machine mail reader
;;; Definitions for Zmail
;;;>
;;;> *****************************************************************************************
;;;> ** (c) Copyright 1998-1982 Symbolics, Inc.  All rights reserved.
;;;> ** Portions of font library Copyright (c) 1984 Bitstream, Inc.  All Rights Reserved.
;;;>
;;;>    The software, data, and information contained herein are proprietary to,
;;;> and comprise valuable trade secrets of, Symbolics, Inc., which intends 
;;;> to keep such software, data, and information confidential and to preserve them
;;;> as trade secrets.  They are given in confidence by Symbolics pursuant 
;;;> to a written license agreement, and may be used, copied, transmitted, and stored
;;;> only in accordance with the terms of such license.
;;;> 
;;;> Symbolics, Symbolics 3600, Symbolics 3675, Symbolics 3630, Symbolics 3640,
;;;> Symbolics 3645, Symbolics 3650, Symbolics 3653, Symbolics 3620, Symbolics 3610,
;;;> Zetalisp, Open Genera, Virtual Lisp Machine, VLM, Wheels, Dynamic Windows,
;;;> SmartStore, Semanticue, Frame-Up, Firewall, Document Examiner,
;;;> Delivery Document Examiner, "Your Next Step in Computing", Ivory, MacIvory,
;;;> MacIvory model 1, MacIvory model 2, MacIvory model 3, XL400, XL1200, XL1201,
;;;> Symbolics UX400S, Symbolics UX1200S, NXP1000, Symbolics C, Symbolics Pascal,
;;;> Symbolics Prolog, Symbolics Fortran, CLOE, CLOE Application Generator,
;;;> CLOE Developer, CLOE Runtime, Common Lisp Developer, Symbolics Concordia,
;;;> Joshua, Statice, and Minima are trademarks of Symbolics, Inc.
;;;> 
;;;> Symbolics 3670, Symbolics Common Lisp, Symbolics-Lisp, and Genera are registered
;;;> trademarks of Symbolics, Inc.
;;;>
;;;> GOVERNMENT PURPOSE RIGHTS LEGEND
;;;> 
;;;>      Contract No.: various
;;;>      Contractor Name: Symbolics, Inc.
;;;>      Contractor Address: c/o Ropes & Gray
;;;> 			 One International Place
;;;> 			 Boston, Massachusetts 02110-2624
;;;>      Expiration Date: 2/27/2018
;;;>      
;;;> The Government's rights to use, modify, reproduce, release, perform, display or
;;;> disclose this software are restricted by paragraph (b)(2) of the "Rights in
;;;> Noncommercial Computer Software and Noncommercial Computer Software Documentation"
;;;> contained in the above identified contracts.  No restrictions apply after the
;;;> expiration date shown above.  Any reproduction of the software or portions thereof
;;;> marked with this legend must also reproduce the markings.  Questions regarding
;;;> the Government's rights may be referred to the AS&T Contracts Office of the
;;;> National Reconnaissance Office, Chantilly, Virginia 20151-1715.
;;;> 
;;;>      Symbolics, Inc.
;;;>      c/o Ropes & Gray
;;;>      One International Place
;;;>      Boston, Massachusetts 02110-2624
;;;>      781-937-7655
;;;>
;;;> *****************************************************************************************
;;;>
;;;>

;;;Command tables for use by CP commands related to various Zmail-related features

(CP::DEFINE-COMMAND-SUBSET *COMMUNICATION-COMMAND-TABLE*
			  "Communication")

(CP::DEFINE-COMMAND-SUBSET *CONVERSATION-COMMAND-TABLE*
			  "Conversation" "Communication")

(CP::DEFINE-COMMAND-SUBSET *MAIL-READING//SENDING-COMMAND-TABLE*
			  "Mail Reading//Sending" "Communication")

(CP::DEFINE-COMMAND-SUBSET *MAILER-COMMAND-TABLE*
			  "Mailer" "Site Administration")

;;; Zmail system initializations are added to this list.
(DEFVAR *ZMAIL-SYSTEM-INITIALIZATIONS* NIL)

(DEFVAR *ZMAIL-WINDOW*)

;;; This is a separate flavor to distinguish the instance variables that should be global
;;; so that commands, etc. can access them (as opposed to window-system type variables).
(DEFFLAVOR BASIC-ZMAIL
       (*HEADER-WINDOW*				;Headers when sending
	*HEADER-INTERVAL*
	*REPLY-WINDOW*				;Text when sending
	*REPLY-INTERVAL*
	*MSG-WINDOW*				;Text of message
	*MSG-INTERVAL*
	*SUMMARY-WINDOW*			;Summary of messages
	*SUMMARY-WINDOW-PSEUDO-ZWEI-WINDOW*
	*FILTER-WINDOW*				;Hairy menu pane for filter mode
	*PROFILE-WINDOW*			;Frame for changing profile
	*PROFILE-EDITOR*			;Editor that goes with above and below
	*PROFILE-EDITOR-WINDOW*
	*COMMAND-MENU*				;The main command menu
	*KEYWORD-WINDOW*			;Menu for hacking keywords
	(*WINDOW-CONFIGURATION* NIL)		;The present configuration
	*CURRENT-MSG-NAME*			;The number of the current msg as a string
	*ZMAIL-INTERVAL-NAME*			;Name of interval in reply for mode line
	(*SEQUENCE* NIL)			;The mail file being hacked
	(*SEQUENCE-LIST* NIL)			;The list of ones known about
	(*DEFAULT-BUFFER* NIL)			;The one associated with default inbox
	*ZMAIL-SEQUENCE-NAME*			;Name of that file for the mode line
	(*MSG* NIL)				;The current message
	(*MSG-NO* -1)				;Numerical index of above
	(*MSG-POINT-PDL*)			;Saved positions
	*ZMAIL-BACKGROUND-PROCESS*		;Handles asynchronous tasks
	*ZMAIL-BACKGROUND-PROCESS-LOCK*		;Lock for synchronizing
	*ZMAIL-BACKGROUND-REQUEST-QUEUE*	;FIFO queue of requests for the background
	*ZMAIL-BACKGROUND-PRELOAD-QUEUE*	;LIFO queue of files to be preloaded
	*ZMAIL-BACKGROUND-MAIL-CHECK-QUEUE*	;Files to periodcally check for new mail
	*CURRENT-MSG-KEYWORDS-STRING*		;String of current messages keywords
	*DRAFT-MSG*				;Current message being sent
	(*DRAFT-LIST* NIL)			;List of drafts for continue
	(*DEFAULT-MOVE-SEQUENCE* NIL)		;When clicking left on move command
	*MOVE-SEQUENCE-MENU*			;Pop-up for choosing where
	*ZMAIL-MAP-COMMAND-MENU*		;Things you can do to all messages
	*SELECT-SEQUENCE-MENU*			;For select command
	*FILTER-SELECTION-FRAME*		;Frame for choosing a filter
	*UNIVERSE-SELECTION-MENU*		;Menu for choosing a universe for filter
	*UNIVERSE-WINDOW*			;Frame for defining a new universe
	*OVERLYING-WINDOW*			;For scrolling typeout of message texts
	*POP-UP-MINI-BUFFER-EDITOR*		;For asking temporary questions
	*CALENDAR-COMMAND-MENU*			;Command menu when in reminder mode
	*YEAR-WINDOW*				;Frame showing a calendar year
	*MONTH-WINDOW*				;Ditto for month
	*FOUR-WEEKS-WINDOW*			;Ditto for four weeks
	*WEEK-WINDOW*				;Ditto for week
	)
       ()
  (:REQUIRED-FLAVORS ZMAIL-FRAME-MIXIN)
  :SPECIAL-INSTANCE-VARIABLES
  (:SPECIAL-INSTANCE-VARIABLE-BINDING-METHODS :COMMAND-LOOP :EDIT :INIT
					      :MAKE-SEQUENCE NOTIFY-ZMAIL-OF-MSG-INSERTION
					      :NULL-STARTUP-SETUP
					      PRELOAD-CREATE-BUFFER-AND-LOAD-MAIL-FILE
					      :SET-ZMAIL-USER))
		    
(GLOBALLY-DECLARE-FLAVOR-INSTANCE-VARIABLES BASIC-ZMAIL)

(DEFFLAVOR ZMAIL-PROFILE-EDITOR
       ((*MODE-LINE-LIST* `("Zmail " (*EDITING-PROFILE* "Editing ") "Profile "
			    *ZMAIL-PROFILE-NAME* *ZMACS-BUFFER-VERSION-STRING*
			    *BUFFER-MODIFIED-P* *OPTIONS-MODIFIED-P*
			    (*EDITING-PROFILE* ,(FORMAT NIL "     ~:@C ends." #\END ))))
	(*MAJOR-MODE* (MODE-OF-FLAVOR 'LISP-MODE))
	(*VARIABLE-TICK*)
	(*EDITOR-VARIABLE-TICK*)
	(*PROFILE-COMPILE-TICK*)		;When last compiled
	(*COMTAB* *STANDALONE-COMTAB*)
	(*ZMACS-BUFFER-VERSION-STRING* NIL)
	(*OPTIONS-MODIFIED-P* NIL)
	)
       (TOP-LEVEL-EDITOR ZMAIL-COMMAND-LOOP-MIXIN)
  :SPECIAL-INSTANCE-VARIABLES
  (:SPECIAL-INSTANCE-VARIABLE-BINDING-METHODS :EDIT-PROFILE))

(GLOBALLY-DECLARE-FLAVOR-INSTANCE-VARIABLES ZMAIL-PROFILE-EDITOR)

(DEFVAR *ZMAIL-PROFILE-NAME* NIL)		D,#TD1PsT[Begin using 006 escapes](1 0 (NIL 0) (NIL :ITALIC NIL) "CPTFONTI");Can't be an I.V. of (2 0 (NIL 0) (NIL :BOLD NIL) "CPTFONTCB")zmail-profile-editor

0(DEFMACRO DEFINE-ZMAIL-TOP-LEVEL-COMMAND (NAME DOCUMENTATION OPTIONS &BODY BODY)
  (LET ((OPTION-FORMS (PROCESS-ZMAIL-TOP-LEVEL-COMMAND-OPTIONS OPTIONS)))
    `(LOCAL-DECLARE ((SYS:FUNCTION-PARENT ,NAME DEFINE-ZMAIL-TOP-LEVEL-COMMAND))
       (RECORD-SOURCE-FILE-NAME ',NAME 'DEFINE-ZMAIL-TOP-LEVEL-COMMAND)
       (ZMAIL-TOP-LEVEL-COMMAND-DEFINE ',NAME ',DOCUMENTATION ',OPTIONS)
       (DEFUN ,NAME ()
	 (LET ((*CURRENT-ZMAIL-TOP-LEVEL-COMMAND* ',NAME))
	   ,@OPTION-FORMS
	   ,@BODY)))))

(DEFPROP DEFINE-ZMAIL-TOP-LEVEL-COMMAND "Zmail top-level command" SI:DEFINITION-TYPE-NAME)

(DEFMACRO DEFINE-ZMAIL-TOP-LEVEL-COMMAND-SYNONYM (NAME COMMAND)
  `(LOCAL-DECLARE ((SYS:FUNCTION-PARENT ,NAME DEFINE-ZMAIL-TOP-LEVEL-COMMAND-SYNONYM))
     (RECORD-SOURCE-FILE-NAME ',NAME 'DEFINE-ZMAIL-TOP-LEVEL-COMMAND-SYNONYM)
     (DEFF ,NAME ',COMMAND)
     (DOLIST (PROPERTY '(COMMAND-NAME DOCUMENTATION))
       (PUTPROP ',NAME (GET ',COMMAND PROPERTY) PROPERTY))))

(DEFPROP DEFINE-ZMAIL-TOP-LEVEL-COMMAND-SYNONYM "Zmail top-level command synonym"
	 SI:DEFINITION-TYPE-NAME)

(DEFVAR *ZMAIL-TOP-LEVEL-COMMAND-NAME-ALIST* NIL)

(DEFVAR *CURRENT-ZMAIL-TOP-LEVEL-COMMAND* NIL)

(DEFUN ZMAIL-TOP-LEVEL-COMMAND-DEFINE (COMMAND DOC OPTIONS)
  (COND ((STRINGP DOC)
	 (PUTPROP COMMAND DOC 'DOCUMENTATION))
	((OR (SYMBOLP DOC)
	     (AND (NOT (ATOM DOC))
		  (EQ (CAR DOC) 'LAMBDA)))
	 (PUTPROP COMMAND DOC 'DOCUMENTATION-FUNCTION))
	(T
	 (FERROR NIL "The command ~S has invalid self-documentation ~S" COMMAND DOC)))
  (LET ((NAME (MAKE-ZMAIL-TOP-LEVEL-COMMAND-NAME COMMAND)))
    (PUTPROP COMMAND NAME 'COMMAND-NAME)
    (WHEN (MEMQ 'DANGEROUS OPTIONS)
      (REGISTER-DANGEROUS-ZMAIL-COMMAND COMMAND NAME))
    (SETQ *ZMAIL-TOP-LEVEL-COMMAND-NAME-ALIST* (CL:DELETE NAME
							  *ZMAIL-TOP-LEVEL-COMMAND-NAME-ALIST*
							  :KEY #'CAR :TEST #'STRING-EQUAL))
    (CL:PUSHNEW (CONS NAME COMMAND) *ZMAIL-TOP-LEVEL-COMMAND-NAME-ALIST* :KEY #'CDR :REPLACE T)
    ))

1;;; Register a "dangerous" Zmail command --
;;;    A dangerous command is one which takes a very long time to execute and/or causes
;;;    the iretrievable loss of information.  Such commands are expected to query the user
;;;    for permission before doing any work.  A set of profile options control whether any
;;;    queries are produced and, if so, which individual commands produce actually query.
;;;   
;;;    This function is here rather than in 0SYS:ZMAIL;COMMANDS1 as it must exit before any
;;;    Zmail top-level command is defined.
0(DEFUN REGISTER-DANGEROUS-ZMAIL-COMMAND (COMMAND NAME)
  (DECLARE (SPECIAL *ZMAIL-USER-OPTION-ALIST*
		    *SELECTED-DANGEROUS-ZMAIL-COMMANDS* *DANGEROUS-ZMAIL-COMMANDS-ALIST*))
  (LET ((NEWLY-DANGEROUS (NULL (RASSQ COMMAND *DANGEROUS-ZMAIL-COMMANDS-ALIST*)))
	(PROFILE-OPTION (ASSQ '*SELECTED-DANGEROUS-ZMAIL-COMMANDS* *ZMAIL-USER-OPTION-ALIST*)))
    (SETQ *DANGEROUS-ZMAIL-COMMANDS-ALIST* (CL:DELETE NAME *DANGEROUS-ZMAIL-COMMANDS-ALIST*
						      :KEY #'CAR :TEST #'STRING-EQUAL))
    (CL:PUSHNEW (CONS NAME COMMAND) *DANGEROUS-ZMAIL-COMMANDS-ALIST* :KEY #'CDR :REPLACE T)
    (SETQ *DANGEROUS-ZMAIL-COMMANDS-ALIST* (SORTCAR *DANGEROUS-ZMAIL-COMMANDS-ALIST*
						    #'STRING-LESSP))
    (PUTPROP '*SELECTED-DANGEROUS-ZMAIL-COMMANDS*
	     (LOOP FOR (NIL . COMMAND) IN *DANGEROUS-ZMAIL-COMMANDS-ALIST*
		   COLLECT COMMAND)
	     'TV:DEFAULT-VALUE)
    (SETQ *SELECTED-DANGEROUS-ZMAIL-COMMANDS*
	  (LOOP FOR (NIL . A-COMMAND) IN *DANGEROUS-ZMAIL-COMMANDS-ALIST*
		WHEN (OR (AND NEWLY-DANGEROUS (EQ COMMAND A-COMMAND))
			 (MEMQ A-COMMAND *SELECTED-DANGEROUS-ZMAIL-COMMANDS*))
		  COLLECT A-COMMAND))
    (WHEN PROFILE-OPTION
      (SETF (FOURTH PROFILE-OPTION) (COPYLIST *DANGEROUS-ZMAIL-COMMANDS-ALIST*))
      (WHEN (VARIABLE-BOUNDP *ZMAIL-WINDOW*)
	(RECONSTRUCT-PROFILE-CVV-WINDOW *ZMAIL-WINDOW*)))))

(DEFUN ADOPT-COMMAND-AS-ZMAIL-TOP-LEVEL-COMMAND (COMMAND &AUX NAME)
  (UNLESS (SETQ NAME (GET COMMAND 'COMMAND-NAME))
    (FERROR NIL "~S has not been defined as a Zwei command." COMMAND))
  (UNLESS (OR (GET COMMAND 'DOCUMENTATION)
	      (GET COMMAND 'DOCUMENTATION-FUNCTION))
    (FERROR NIL "The command ~S has no self-documentation." COMMAND))
  (OR (ASSOC NAME *ZMAIL-TOP-LEVEL-COMMAND-NAME-ALIST*)
	(PUSH (CONS NAME COMMAND) *ZMAIL-TOP-LEVEL-COMMAND-NAME-ALIST*)))

(DEFUN PROCESS-ZMAIL-TOP-LEVEL-COMMAND-OPTIONS (OPTIONS)
  (LET ((CONTEXT 'MUST-HAVE-MSG)
	(ARGUMENT 'NO-ARG))
    (DOLIST (OP OPTIONS)
      (SELECTQ OP
	((DANGEROUS))				1;Handled by 2zmail-top-level-command-define1.
0	((NO-SEQUENCE-OK NO-MSG-OK MUST-HAVE-MSG)
	 (SETQ CONTEXT OP))
	((NUMERIC-ARG-OK NO-ARG)
	 (SETQ ARGUMENT OP))
	(OTHERWISE
	 (FERROR NIL "~S is not a recognized option." OP))))
    `(,(SECOND (ASSQ CONTEXT '((MUST-HAVE-MSG
				 (UNLESS *MSG*
				   (BARF "There is no current message.")))
			       (NO-MSG-OK
				 (UNLESS *SEQUENCE*
				   (BARF "There is no current sequence.")))
			       (NO-SEQUENCE-OK))))
      ,(SECOND (ASSQ ARGUMENT '((NO-ARG
				  (WHEN *NUMERIC-ARG-P*
				    (BARF "This command does not accept a numeric argument.")))
				(NUMERIC-ARG-OK)))))
    ))

;;; Convert a command name string into human-readable form.  Remove
;;; leading COM-, COM-ZMAIL- or COM-MOUSE, or leading and trailing *'s.
;;; Unabbreviate MSG into MESSAGE (ditto for the plural).   Convert
;;; hyphens into spaces, and capitalize each word.  This is used both
;;; for command names and variable names.
(DEFUN MAKE-ZMAIL-TOP-LEVEL-COMMAND-NAME (COMMAND)
  (SETQ COMMAND (STRING COMMAND))
  (LET* ((CLEN (STRING-LENGTH COMMAND))
	 (STRING (SUBSTRING COMMAND
			    (COND ((STRING-EQUAL "*" COMMAND 0 0 1 1) 1)
				  (T 0))
			    (COND ((CHAR-EQUAL #/* (AREF COMMAND (1- CLEN))) (1- CLEN))
				  (T CLEN)))))
    (LOOP WITH STR = (SUBSTRING "" 0)
	  WITH WORDS = (LOOP WITH STR-LEN = (STRING-LENGTH STRING)
			     FOR START = 0 THEN (1+ END-WORD)
			     WHILE (< START STR-LEN)
			     FOR END-WORD = (OR (STRING-SEARCH "-" STRING START) STR-LEN)
			     COLLECT (SUBSTRING STRING START END-WORD))
	  FOR ADD-SPACE FIRST NIL THEN T
	  FOR WORD IN (PROGN
			(WHEN (STRING-EQUAL "COM" (FIRST WORDS))
			  (SETQ WORDS (CDR WORDS))
			  (WHEN (MEM #'STRING-EQUAL (FIRST WORDS) '("ZMAIL" "MOUSE"))
			    (SETQ WORDS (CDR WORDS))))
			WORDS)
	  WHEN (STRING-EQUAL WORD "MSG")
	    DO (SETQ WORD "Message")
	  WHEN (STRING-EQUAL WORD "MSGS")
	    DO (SETQ WORD "Messages")
	  DO (WHEN ADD-SPACE
	       (SETQ STR (STRING-APPEND STR #\SPACE)))
	     (SETQ STR (STRING-APPEND STR WORD))
	  FINALLY (RETURN (STRING-CAPITALIZE-WORDS STR)))))


1;;; Define0 Zwei1 commands for the exclusive use of 0Zmail1.
0(DEFVAR *ZMAIL-EDITOR-COMMAND-ALIST* NIL)

(DEFMACRO DEFCOM-FOR-ZMAIL (NAME DOCUMENTATION OPTIONS &BODY BODY)
  `(LOCAL-DECLARE ((SYS:FUNCTION-PARENT ,NAME DEFCOM-FOR-ZMAIL))
     (RECORD-SOURCE-FILE-NAME ',NAME 'DEFCOM-FOR-ZMAIL)
     (LETF ((*COMMAND-ALIST* *ZMAIL-EDITOR-COMMAND-ALIST*)
	    (#'SI:MAKE-COMMAND-NAME #'MAKE-ZMAIL-TOP-LEVEL-COMMAND-NAME))
       (COMMAND-DEFINE ',NAME ',DOCUMENTATION ',OPTIONS)
       (SETF *ZMAIL-EDITOR-COMMAND-ALIST* *COMMAND-ALIST*))
     (DEFUN ,NAME ()
       ,@(PROCESS-COMMAND-OPTIONS OPTIONS)
       ,@BODY)))

(DEFPROP DEFCOM-FOR-ZMAIL "Zmail draft editor command" SI:DEFINITION-TYPE-NAME)

;;; Top-level-commands
(DEFVAR *ZMAIL-COMMAND-ALIST* '(("Profile" . COM-ZMAIL-PROFILE)
				("Quit" . COM-ZMAIL-QUIT)
				("Delete" . COM-ZMAIL-DELETE)
				("Undelete" . COM-ZMAIL-UNDELETE)
				("Reply" . COM-ZMAIL-REPLY)
				("Configure" . COM-ZMAIL-CONFIGURE)
				("Save" . COM-ZMAIL-SAVE-ALL-MAIL-FILES)
				("Next" . COM-ZMAIL-NEXT)
				("Previous" . COM-ZMAIL-PREVIOUS)
				("Continue" . COM-ZMAIL-CONTINUE)
				("Survey" . COM-ZMAIL-SURVEY)
				("Get inbox" . COM-GET-NEW-MAIL-FROM-INBOX)
				("Jump" . COM-ZMAIL-GOTO)
				("Keywords" . COM-ZMAIL-KEYWORDS)
				("Mail" . COM-ZMAIL-MAIL)
				("Sort" . COM-ZMAIL-SORT)
				("Map over" . COM-ZMAIL-MAP-OVER)
				("Move" . COM-ZMAIL-MOVE)
				("Select" . COM-ZMAIL-SELECT-SEQUENCE)
				("Other" . COM-ZMAIL-OTHER-COMMANDS)))

(DEFVAR *ZMAIL-CALENDAR-COMMAND-ALIST* '(("Profile" . COM-ZMAIL-PROFILE)
					 ("Quit" . COM-ZMAIL-QUIT)
					 ("Delete" . COM-ZMAIL-DELETE)
					 ("Undelete" . COM-ZMAIL-UNDELETE)
					 ("" :NO-SELECT T)
					 ("Configure" . COM-ZMAIL-CONFIGURE)
					 ("Save" . COM-ZMAIL-SAVE-ALL-MAIL-FILES)
					 ("Next" . COM-ZMAIL-NEXT)
					 ("Previous" . COM-ZMAIL-PREVIOUS)
					 ("" :NO-SELECT T)
					 ("Survey" . COM-ZMAIL-SURVEY)
					 ("" :NO-SELECT T)
					 ("Jump" . COM-ZMAIL-GOTO)
					 ("Keywords" . COM-ZMAIL-KEYWORDS)
					 ("Compose" . COM-COMPOSE-REMINDER)
					 ("Sort" . COM-ZMAIL-SORT)
					 ("Map over" . COM-ZMAIL-MAP-OVER)
					 ("Move" . COM-ZMAIL-MOVE)
					 ("Select" . COM-ZMAIL-SELECT-SEQUENCE)
					 ("Other" . COM-ZMAIL-OTHER-COMMANDS)))

;;; Commands without message arguments
(DEFVAR *ZMAIL-NO-FILTER-COMMAND-ALIST* '(("Configure" . COM-ZMAIL-CONFIGURE)
					  ("Get inbox" . COM-GET-NEW-MAIL-FROM-INBOX)
					  ("Save" . COM-ZMAIL-SAVE-ALL-MAIL-FILES)
					  ("Sort" . COM-ZMAIL-SORT)
					  ("Profile" . COM-ZMAIL-PROFILE)
					  ("Quit" . COM-ZMAIL-QUIT)))

(DEFVAR *ZMAIL-FILTER-COMMAND-ALIST* '(("Concatenate" . COM-ZMAIL-CONCATENATE)
				       ("Survey" . COM-ZMAIL-SURVEY)
				       ("Delete" . COM-ZMAIL-DELETE)
				       ("Undelete" . COM-ZMAIL-UNDELETE)
				       ("Reply" . COM-ZMAIL-REPLY)
				       ("Other" . COM-ZMAIL-OTHER-COMMANDS)
				       ("Type" . COM-ZMAIL-TYPE)
				       ("Next" . COM-ZMAIL-NEXT)
				       ("Previous" . COM-ZMAIL-PREVIOUS)
				       ("Continue" . COM-ZMAIL-CONTINUE)
				       ("" :NO-SELECT T)
				       ("Select" . COM-ZMAIL-SELECT-SEQUENCE)
				       ("Keywords" . COM-ZMAIL-KEYWORDS)
				       ("Move" . COM-ZMAIL-MOVE)
				       ("Mail" . COM-ZMAIL-MAIL)))

(DEFVAR *OTHER-COMMAND-ALIST*)

(DEFVAR *MAIL-FILE-OPTION-ALIST* NIL)

(DEFVAR *DANGEROUS-ZMAIL-COMMANDS-ALIST* NIL)

;;; These are the values for the Priority: header field.
(DEFCONST *PRIORITY-NAMES*
	'((:LOW "Low")
	  (:STANDARD "Standard")
	  (:HIGH "High")
	  (:URGENT "Urgent")
	  (:FLASH "FLASH")
	  (:NORMAL "Normal")			;lots of mailers use this, even though
						;not in spec
))

(DEFMACRO DEFINE-SETTABLE-MAIL-FILE-OPTION (OPTION DEFAULT &OPTIONAL TYPE NAME &REST ARGS)
  `(PROGN 'COMPILE
     (RECORD-SOURCE-FILE-NAME ',OPTION 'MAIL-FILE-OPTION)
     (TV:DEFINE-USER-OPTION-1 ',OPTION '*MAIL-FILE-OPTION-ALIST* ,DEFAULT
			      ',(OR TYPE ':SEXP)
			      ',(OR NAME (SI:MAKE-COMMAND-NAME OPTION)) . ,ARGS)))

(DEFMACRO DEFINE-NOT-SETTABLE-MAIL-FILE-OPTION (OPTION)
  `(DEFINE-NOT-SETTABLE-MAIL-FILE-OPTION-1 ',OPTION))

(DEFUN DEFINE-NOT-SETTABLE-MAIL-FILE-OPTION-1 (OPTION)
  (RECORD-SOURCE-FILE-NAME OPTION 'MAIL-FILE-OPTION)
  (LET ((OLD-OPTION (ASSQ OPTION *MAIL-FILE-OPTION-ALIST*)))
    (WHEN OLD-OPTION
      (SETQ *MAIL-FILE-OPTION-ALIST* (DELQ OLD-OPTION *MAIL-FILE-OPTION-ALIST*))))
  (PUSH (NCONS OPTION) *MAIL-FILE-OPTION-ALIST*))


#||
(DEFVAR *ZMAIL-TYPEOUT-ITEM-ALIST* *ZWEI-TYPEOUT-COMMAND-ALIST*)
||#

(DEFVAR *ZMAIL-MSG-AREA* (MAKE-AREA :NAME '*ZMAIL-MSG-AREA*))
(DEFVAR *ZMAIL-MSG-LINE-AREA* (MAKE-AREA :NAME '*ZMAIL-MSG-LINE-AREA*))
(DEFVAR *ZMAIL-HEADER-AREA* (MAKE-AREA :NAME '*ZMAIL-HEADER-AREA*))
(DEFVAR *ZMAIL-SUMMARY-AREA* (MAKE-AREA :NAME '*ZMAIL-SUMMARY-AREA*))

(DEFVAR *PRESERVE-ADDRESS-INTERVALS* NIL
  "Non-NIL causes the parse to save :INTERVAL rather than :ORIGINAL-STRING properties.")

(DEFVAR *DEFAULT-HOST-WHEN-PARSING* NIL
  "Host object to use when parsing addresses without explicit @DOMAIN phrase if not null.")

(DEFVAR *HEADER-TYPE-ALIST* NIL :LOCALIZE T)
(DEFVAR *RECIPIENT-TYPE-HEADERS* NIL)

;;; See COMPUTE-COMMON-TAIL in the file HEADERS
(DEFVAR *LOCAL-COMMON-TAIL* NIL)

(DEFSTRUCT (HEADER-TYPE-ELEM :LIST :CONC-NAME)
  NAME						;A keyword symbol
  PRETTY-NAME					;A string
  PARSE-FUNCTION				;Used to parse a header of this type
  PRINT-FUNCTION				;Used to print same
  TYPES						;List of HEADER-TYPE-TYPEs
  )

(DEFVAR *HEADER-TYPE-TYPE-ALIST* NIL :LOCALIZE T)

(DEFSTRUCT (HEADER-TYPE-TYPE-ELEM :LIST :CONC-NAME)
  NAME						;Keyword symbol
  PARSE-FUNCTION				;These stored into HEADER-TYPEs
  PRINT-FUNCTION
  TYPES
  )


1;;; Properties of a message which are saved with the message.
0(DEFVAR *SAVED-INTERNAL-PROPERTIES-ALIST*
	'(("last" LAST)			;This is really treated differently
	  ("last undeleted" LAST-UNDELETED)	;this too
	  ("unseen" UNSEEN)
	  ("deleted" DELETED)
	  ("bad-header" LOSING-HEADERS T)	;Don't output into permanent storage
	  ("bad-header" UNPARSEABLE T)		;Same here
	  ("answered" ANSWERED)
	  ("forwarded" FORWARDED)
	  ("redistributed" REDISTRIBUTED)
	  ("redirected" REDIRECTED T)
	  ("filed" FILED)
	  ("sent" SENT)
	  ("recent" RECENT)))

1;;; These are properties which are not dependent on the text of the message --
;;;   Other properties which are gotten indirectly from the text and hence are not in the
;;;   keyword package are: 2losing-headers1, 2references1, 2msg-ids1, 2its-header-p1, and
;;;   2headers-end-bp1.  Data gotten from the text of the file outside of the text of the
;;;   message go here too.
0(DEFVAR *INTERNAL-TYPE-PROPERTIES*
	'(DELETED UNSEEN REFORMATTED ANSWERED FILED PROCESSED MARKED FORWARDED SENT
	  RECENT LENGTH KEYWORDS KEYWORDS-STRING DRAFT-MSG
	  ORIGINAL-HEADERS-INTERVAL FILE-ID REDIRECTED UNIX-FROM-HEADER RECEIVED-DATE
	  SCROLL-ITEM-DISPLAYER))

1;;; Same as above, but doesn't include 2reformatted1 --
;;;    If you generate new headers, use this and reformatting will happen too.
0(DEFVAR *INTERNAL-TYPE-PROPERTIES-WITHOUT-REFORMATTED*
	(CL:REMOVE 'REFORMATTED *INTERNAL-TYPE-PROPERTIES*))

1;;; Same as above but without any properties derived from the original header.  This
;;; variable should be used if you regenerate the text of a message and do not wish to
;;; preserve the prior original headers.
0(DEFVAR *INTERNAL-TYPE-PROPERTIES-WITHOUT-ORIGINAL-HEADERS*
	(CL:REMOVE-IF #'(LAMBDA (ITEM) (CL:MEMBER ITEM '(REFORMATTED ORIGINAL-HEADERS-INTERVAL
							 UNIX-FROM-HEADER RECEIVED-DATE)))
		      *INTERNAL-TYPE-PROPERTIES*))

1;;; These are the internal properties 2copy-msg 1does not take from the original.
0(DEFVAR *PROPERTIES-NOT-COPIED* '(DELETED FILED REFORMATTED ORIGINAL-HEADERS-INTERVAL
				  SCROLL-ITEM-DISPLAYER))

1;;; These are the internal properties that must be recomputed when a buffer's format is
;;; changed -- 2convert-buffer-format1 binds 2*properties-not-copied*1 to this list in order
;;; to "fake out" 2copy-msg1.
0(DEFVAR  *PROPERTIES-NOT-COPIED-DURING-CONVERSION*
	 (CL:REMOVE-IF #'(LAMBDA (ITEM) (CL:MEMBER ITEM *SAVED-INTERNAL-PROPERTIES-ALIST*
						   :KEY #'SECOND))
		       *PROPERTIES-NOT-COPIED*))

;;; These are the internal properties COPY-MSG must treat as BP's
(DEFVAR *BP-PROPERTIES* '((HEADERS-END-BP)))

;;; These are the properties M-X Delete Duplicate Msgs merges from the message it is
;;; deleting
(DEFVAR *INTERNAL-PROPERTIES-TO-INHERIT*
	'(ANSWERED FILED FORWARDED SENT KEYWORDS KEYWORDS-STRING REDIRECTED))

;;; Default character style used for messages which do not have a Default-Character-Style
;;; header field.  If the system default is changed in the future, it's unclear what
;;; should happen to this value to retain compatibility with old mail.
(DEFVAR *ZMAIL-DEFAULT-DEFAULT-CHARACTER-STYLE* (SI:PARSE-CHARACTER-STYLE
						  '(:FIX :ROMAN :NORMAL)))

;;; A sequence of messages -- The basic organizational unit in Zmail.
;;;    Mail files and simple collections are sequences.  Eventually, universes
;;;    will also be sequences and there will likely be some change in terminology.
(DEFFLAVOR SEQUENCE
	((LOCK NIL)
	 NAME					;Name of the sequence
	 (ARRAY (MAKE-ARRAY 100. :FILL-POINTER 0))	;Where actual messages live
	 (SAVED-CURRENT-MSG NIL)		;When switching back
	 (MODIFICATION-TICK *TICK*)
	 (EXPUNGE-TICK *TICK*)			;When last expunge completed
	 (SAVE-REQUIRING-MODIFICATION-TICK *TICK*)	;When "old" msgs last expugned
	 )
	(SI:PROPERTY-LIST-MIXIN)
  (:ORDERED-INSTANCE-VARIABLES LOCK)
  :WRITABLE-INSTANCE-VARIABLES
  (:SETTABLE-INSTANCE-VARIABLES LOCK NAME
				SAVED-CURRENT-MSG
				MODIFICATION-TICK EXPUNGE-TICK SAVE-REQUIRING-MODIFICATION-TICK
				)
  (:INIT-KEYWORDS :OPTIONS))

;;; Sequences which can be universes
(DEFFLAVOR UNIVERSE-SEQUENCE-MIXIN
	((REFERENCE-HASH-TABLE NIL)		;Hash table for finding references.
	 (REFERENCE-HASH-TABLE-TICK 0)		;Last time hash table was brought up to date
						;Set -1 to invalidate hash table.  Set to 0
						;when background parsing begun.
	 )
	()
  (:REQUIRED-FLAVORS SEQUENCE)
  (:WRITABLE-INSTANCE-VARIABLES (SEQUENCE-REFERENCE-HASH-TABLE REFERENCE-HASH-TABLE)
				(SEQUENCE-REFERENCE-HASH-TABLE-TICK REFERENCE-HASH-TABLE-TICK)
				)
  :SETTABLE-INSTANCE-VARIABLES)


;;; Simple collections of messages
(DEFFLAVOR COLLECTION (FULL-NAME) (UNIVERSE-SEQUENCE-MIXIN SEQUENCE)
  :WRITABLE-INSTANCE-VARIABLES
  :SETTABLE-INSTANCE-VARIABLES)

;;; Any sequence which corresponds to a file (mail file or inbox) --
;;;    Occasionally, the term 1message file0 will be used to refer to any file whether
;;;    a mail file or an inbox which holds one or more messages.  The generic term for
;;;    a message file's sequence is 1message buffer0.
(DEFFLAVOR MSG-BUFFER
	(HEADER-INTERVAL
	 PATHNAME
	 (ID T)
	 (TICK NIL)
	 MSG-UPDATE-TICK
	 (STATUS :IDLE)
	 (STREAM NIL)
	 (PROPERTY-LIST-HASH-TABLE (MAKE-INSTANCE 'OBJECT-COMPACTING-HASH-TABLE))
	 )
	(UNIVERSE-SEQUENCE-MIXIN SEQUENCE)
  :WRITABLE-INSTANCE-VARIABLES
  :SETTABLE-INSTANCE-VARIABLES
  (:FUNCTIONS CHECK-MSG-FILE-ELEMENT-TYPE CHECK-NOT-KBIN-MSG-FILE CHECK-NOT-BABYL-MSG-FILE))

;;; Mail files -- Files which hold mail for permanent storage.
;;;
;;;   The possible states of a mail file follow.  (See MAIL-FILES for more detailed
;;;   information including the allowed combinations of mail file and inbox states.)
;;;
;;;    :IDLE -- The mail file doesn't have any I/O operations underway at present.
;;;
;;;    :LOADING -- The contents of the mail file is being loaded from the file computer.
;;;
;;;    :LOADED -- A transient state which indicates that all messages have been loaded
;;;       from the file computer into the mail file's buffer.  This state only exists
;;;       during the delay between the background finishing loading and the foreground
;;;	  processing the notification of this fact.
;;;
;;;    :READING-NEW-MAIL -- New messages are being read into the mail file from one
;;;       or more inboxes.  Some of the messages may already be inserted into the mail
;;;       file's buffer but there are still unread inbox files.
;;;
;;;    :SAVING -- The contents of the mail file buffer is being written to the file computer.
;;;
;;;    :SAVED -- A transient state which indicates that all messages have been written
;;;       to the file computer.  It is analogous to :LOADED.
;;;
(DEFFLAVOR FILE-MAIL-BUFFER
	(ORIGINAL-OPTIONS
	 (INSERTED-INBOXES NIL)
	 (INBOXES-BEING-INSERTED NIL)
	 (FIRST-MSG-FROM-INBOXES NIL)
	 (TOTAL-MSGS-FROM-INBOXES NIL))
	(MSG-BUFFER)
  :WRITABLE-INSTANCE-VARIABLES
  (:INIT-KEYWORDS :DEFAULT-BUFFER))


1;;; For compatibility with code that hasn't been upgraded to use 2sequence-array1 yet.
0(DEFMETHOD (:ARRAY SEQUENCE) ()
  (SEQUENCE-ARRAY SELF))

(DEFGENERIC SEQUENCE-NMSGS (SEQUENCE)
  (:COMPATIBLE-MESSAGE :NMSGS)
  (:METHOD (SEQUENCE)
   (FILL-POINTER (SEQUENCE-ARRAY SELF))))

(DEFGENERIC (CL:SETF SEQUENCE-NMSGS) (SEQUENCE NEW-NMSGS)
  (:METHOD (SEQUENCE)
   (SETF (FILL-POINTER (SEQUENCE-ARRAY SELF)) NEW-NMSGS)))


;;; Lock a sequence.
(DEFMACRO LOCK-SEQUENCE ((SEQUENCE LOCK-TYPE) &BODY BODY)
  (CL:CHECK-TYPE LOCK-TYPE (CL:MEMBER :READ :WRITE))
  `(LOCK-SEQUENCE-INTERNAL ,SEQUENCE
			   ,LOCK-TYPE
			   (LAMBDA ()
			     (DECLARE (SYS:DOWNWARD-FUNCTION))
			     ,@BODY)))
  
;;; Lock a buffer and all of its inboxes -- Only write locking is supported.
(DEFMACRO LOCK-BUFFER-AND-INBOXES ((BUFFER LOCK-TYPE) &BODY BODY)
  (CL:CHECK-TYPE LOCK-TYPE (CL:MEMBER :WRITE))
  `(LOCK-BUFFER-AND-INBOXES-INTERNAL ,BUFFER
				     ,LOCK-TYPE
				     (LAMBDA ()
				       (DECLARE (SYS:DOWNWARD-FUNCTION))
				       ,@BODY)))

;;; Lock an inbox and its parent buffer -- Only write locking is supported.
(DEFMACRO LOCK-INBOX-AND-BUFFER ((INBOX LOCK-TYPE) &BODY BODY)
  (CL:CHECK-TYPE LOCK-TYPE (CL:MEMBER :WRITE))
  `(LOCK-INBOX-AND-BUFFER-INTERNAL ,INBOX
				   ,LOCK-TYPE
				   (LAMBDA ()
				     (DECLARE (SYS:DOWNWARD-FUNCTION))
				     ,@BODY)))

;;; Condition signaled on illegal headers
(DEFFLAVOR PARSE-ERROR () (ERROR)
  (:REQUIRED-METHODS :POSITION-AND-REPORT))

(DEFFLAVOR NULL-MSG () (PARSE-ERROR))

(DEFFLAVOR PARSE-GRAMMAR-ERROR (GRAMMAR TOKEN) (PARSE-ERROR)
  :INITABLE-INSTANCE-VARIABLES)

(DEFFLAVOR GARBAGE-IN-FSM (TYPE STRING INDEX) (PARSE-ERROR)
  :INITABLE-INSTANCE-VARIABLES)

(DEFFLAVOR EOF-AFTER-SLASH (STRING) (PARSE-ERROR)
  :INITABLE-INSTANCE-VARIABLES)

(DEFFLAVOR EOF-IN-MIDDLE-OF-SPECIAL-TOKEN (STRING START-INDEX) (PARSE-ERROR)
  (:REQUIRED-METHODS :TOKEN-NAME)
  :INITABLE-INSTANCE-VARIABLES)

(DEFFLAVOR EOF-IN-MIDDLE-OF-STRING () (EOF-IN-MIDDLE-OF-SPECIAL-TOKEN))

(DEFFLAVOR EOF-IN-MIDDLE-OF-COMMENT () (EOF-IN-MIDDLE-OF-SPECIAL-TOKEN))

(DEFSUBST SEQUENCE-BUFFER-P (SEQUENCE)
  (TYPEP SEQUENCE 'MSG-BUFFER))

(DEFSUBST SEQUENCE-APPEND-P (SEQUENCE)
  (SEND SEQUENCE :GET :APPEND))

(DEFMACRO DOMSGS ((MSG SEQUENCE) &BODY BODY)
  `(LET ((.ARRAY. (SEND ,SEQUENCE ':ARRAY)))
     (DO ((.I. 0 (1+ .I.))
	  (.NMSGS. (ARRAY-ACTIVE-LENGTH .ARRAY.))	
	  (,MSG))
	 (( .I. .NMSGS.))
       (SETQ ,MSG (AREF .ARRAY. .I.))
       . ,BODY)))

(DEFINE-LOOP-PATH MSGS MSG-PATH (IN))

(DEFUN MSG-PATH (PATH-NAME VARIABLE IGNORE PREP-PHRASES INCLUSIVE-P IGNORE IGNORE)
  (OR PREP-PHRASES
      (FERROR NIL "Missing IN between ~S and ~S" PATH-NAME VARIABLE))
  (AND INCLUSIVE-P
       (FERROR NIL "Inclusive not supported"))
  (LET ((ARRAY (SI:LOOP-NAMED-VARIABLE 'ARRAY))
	(SIZE (SI:LOOP-NAMED-VARIABLE 'SIZE))
	(INDEX (SI:LOOP-NAMED-VARIABLE 'INDEX)))
    (LIST `((,VARIABLE NIL)
	    (,ARRAY (SEND ,(CADAR PREP-PHRASES) ':ARRAY))
	    (,SIZE NIL)
	    (,INDEX 0))
	  `((SETQ ,SIZE (ARRAY-ACTIVE-LENGTH ,ARRAY)))
	  `( ,INDEX ,SIZE)
	  NIL
	  NIL
	  `(,VARIABLE (AREF ,ARRAY ,INDEX)
	    ,INDEX (1+ ,INDEX)))))

(DEFMACRO DO-UNIVERSE ((MSG-VAR UNIVERSE &REST OPTIONS) &BODY BODY)
  (DECLARE (ARGLIST . ((MSG-VAR UNIVERSE &KEY (START 0) END (FROM-END NIL)
					      (PARSING T) (NOTE-PROGRESS NIL)
					      (PROGRESS-NOTE NIL) (NO-PREPARE NIL))
		       &BODY BODY)))
  `(SEND ,UNIVERSE :MAP-OVER-MSGS
	 (LAMBDA (,MSG-VAR)
	   (DECLARE (SYS:DOWNWARD-FUNCTION))
	   . ,BODY)
	 . ,OPTIONS))

;;; Miscellany
TIME:
(DEFMACRO TIME:DATE-EXPRESSION-INVOKE (EXPR MESSAGE &REST ARGS)
  `(FUNCALL (GET (CAR ,EXPR) 'DATE-EXPRESSION-FUNCTION) ,MESSAGE ,EXPR . ,ARGS))

(DEFMACRO WITH-OVERLYING-WINDOW ((&OPTIONAL (STREAM 'STANDARD-OUTPUT)) &BODY BODY)
  `(WITH-OVERLYING-WINDOW-INTERNAL (LAMBDA (,STREAM) . ,BODY)))

(DEFMACRO WITH-MSG-REDISPLAY-DELAYED (&BODY BODY)
  `(WITH-MSG-REDISPLAY-DELAYED-INTERNAL
     #'(LAMBDA () (DECLARE (SYS:DOWNWARD-FUNCTION)) ,@BODY)))

(DEFMACRO WITH-SPECIAL-INSTANCE-VARS-BOUND-OUTSIDE-INSTANCE (BINDINGS &BODY BODY)
  `(SYS:%WITH-BINDING-STACK-LEVEL
     ,@(LOOP FOR (VAR VAL) IN BINDINGS
	     COLLECT `(SYS:%BIND-LOCATION (FOLLOW-CELL-FORWARDING (LOCF ,VAR) T) ,VAL))
     ,@BODY))

(DEFMACRO WITH-EDITOR-BINDINGS ((&KEY (MODE '*DEFAULT-MAIL-BUFFER-MAJOR-MODE*)
				      COMTAB MODE-LINE-LIST)
				&BODY BODY)
  `(WITH-EDITOR-BINDINGS-INTERNAL (LAMBDA ()
				    (DECLARE (SYS:DOWNWARD-FUNCTION))
				    ,@BODY)
				  ,MODE ,COMTAB ,MODE-LINE-LIST))

(DEFCONST *MAIL-BUFFER-MAJOR-MODES-ALIST*
 `(("Text" :VALUE :TEXT :DOCUMENTATION "Buffers will start in Text mode")
   ("Fundamental" :VALUE :FUNDAMENTAL :DOCUMENTATION "Buffers will start in Fundamental mode")
   ("LISP" :VALUE :LISP :DOCUMENTATION "Buffers will start in LISP mode")))

(DEFVAR *MARK-SURVEY-CURRENT-MSG* NIL)


;;; Messages
(DEFSTRUCT (MSG :ARRAY :NAMED :CONC-NAME
		(:MAKE-ARRAY (:AREA *ZMAIL-MSG-AREA*)))
  REAL-INTERVAL					;Where the message starts in the file itself
  INTERVAL					;Displayed portion of message
  TICK						;Last time something munged in some way
  BUFFER					;The buffer this lives in
  SUMMARY-LINE					;String displayed in summary window
  DISPLAYED-INDEX				;Number for when displayed in summary window
  STATUS					;Alist of keywords for message
  PARSED-P					;NIL, T, or :IN-PROGRESS
  INSERTION-TICK				;When it was first put in the buffer
  (FLAGS 0))

(DEFSELECT ((:PROPERTY MSG NAMED-STRUCTURE-INVOKE))
  (:PRINT-SELF (SELF STREAM IGNORE IGNORE)
   (SYS:PRINTING-RANDOM-OBJECT (SELF STREAM)
     (LET* ((BUFFER (MSG-BUFFER SELF))
	    (RAW-BUFFER-NAME (IF BUFFER
				 (SEND (MSG-BUFFER-PATHNAME BUFFER) :STRING-FOR-EDITOR)))
	    (BUFFER-NAME (IF RAW-BUFFER-NAME
			     (NSUBSTRING RAW-BUFFER-NAME
					 0 (STRING-SEARCH #\Space RAW-BUFFER-NAME))))
	    (RAW-POSITION (IF BUFFER
			      (LOCATE-MSG-IN-SEQUENCE SELF BUFFER NIL)))
	    (POSITION (IF RAW-POSITION (1+ RAW-POSITION))))
       (FORMAT STREAM "MSG~@[ ~D~]~@[ (~A)~]" POSITION BUFFER-NAME))))
  (:DESCRIBE (SELF)
   (FLAVOR::DESCRIBE-DEFSTRUCT-WITH-FLAGS SELF 'MSG '("Fattened"))))

(DEFMACRO MSG-REAL-START-BP (MSG)
  `(INTERVAL-FIRST-BP (MSG-REAL-INTERVAL ,MSG)))

(DEFMACRO MSG-REAL-END-BP (MSG)
  `(INTERVAL-LAST-BP (MSG-REAL-INTERVAL ,MSG)))

(DEFMACRO MSG-START-BP (MSG)
  `(INTERVAL-FIRST-BP (MSG-INTERVAL ,MSG)))

(DEFMACRO MSG-END-BP (MSG)
  `(INTERVAL-LAST-BP (MSG-INTERVAL ,MSG)))


;;; Contents of a message's FLAGS slot

(DEFSUBST MSG-FATTENED-P (MSG)
  (LDB-TEST (BYTE 1 0) (MSG-FLAGS MSG)))


;;; Get something off a message's "property list"
(DEFMACRO MSG-GET (MSG PROPNAME)
  `(GET (ASSURE-MSG-PARSED ,MSG) ,PROPNAME))

(DEFPROP MSG-GET ((MSG-GET MSG PROPNAME) . (MSG-PUT MSG SI:VAL PROPNAME)) SETF)

(DEFSUBST MSG-DRAFT-MSG-P (MSG)
  (NOT (NULL (MSG-GET MSG ':DRAFT-COMPOSITION-DATE))))


(DEFFLAVOR ZMAIL-INTERVAL () (NAMED-BUFFER))

(DEFMACRO ZMAIL-INTERVAL-P (INTERVAL)
  `(TYPEP ,INTERVAL 'ZMAIL-INTERVAL))

(DEFMETHOD (:DEFAULT-PATHNAME ZMAIL-INTERVAL) ()
  (DECLARE (SPECIAL *INSIDE-MAIL*))
  (COND ((AND (TYPEP SUPERIOR 'DRAFT-MSG) *INSIDE-MAIL*
	      (CL:FIND-IF #'CL:PATHNAMEP (GET-DRAFT-FILE-REFERENCES))))
	((AND *MSG* (CL:FIND-IF #'CL:PATHNAMEP (MSG-GET *MSG* :FILE-REFERENCES))))
	((AND *SEQUENCE* (SEQUENCE-BUFFER-P *SEQUENCE*))
	 (MSG-BUFFER-PATHNAME *SEQUENCE*))
	(*DEFAULT-BUFFER*
	 (MSG-BUFFER-PATHNAME *DEFAULT-BUFFER*))))

1;;; Kludgily figure out what Zmail window configuration we're in and return a buffer
;;; consistent with 2bp-buffer1 of 2point1 in the 0"0"1-window case.
0(DEFMETHOD (INTERVAL-BUFFER ZMAIL-INTERVAL) ()
  (DECLARE (SPECIAL *MSG-WINDOW-CONFIGURATIONS*))
  (IF (AND (VARIABLE-BOUNDP *WINDOW-CONFIGURATION*)	1;In Zmail, rather than mouse process.
0	   (MEMQ *WINDOW-CONFIGURATION* *MSG-WINDOW-CONFIGURATIONS*)
	   1;; These specials are unbound until you send some mail -- Sigh!
0	   (VARIABLE-BOUNDP *HEADER-INTERVAL*)
	   (VARIABLE-BOUNDP *REPLY-INTERVAL*)
	   (OR (EQ SELF *HEADER-INTERVAL*) (EQ SELF *REPLY-INTERVAL*)))
      *MSG-INTERVAL*
      SELF))

(DEFFLAVOR ZMAIL-PROFILE-INTERVAL ((SETUP-P NIL))
				  (FILE-BUFFER-MIXIN NAMED-BUFFER-WITH-SECTIONS)
  :SETTABLE-INSTANCE-VARIABLES)

;Build MSGs out of this instead of out of NODEs to get proper :INFERIOR-TO-NODE method
;Build DRAFTs out of this, too
;Anything that can get put into the message window with SET-MSG-INTERVAL
(DEFFLAVOR ZMAIL-MSG-NODE (MSG) (NODE)
  :SETTABLE-INSTANCE-VARIABLES)

;True if BUFFER is the #<ZMAIL-INTERVAL "Message"> and currently contains this MSG
(DEFMETHOD (:INFERIOR-TO-NODE ZMAIL-MSG-NODE) (BUFFER)
  (EQ (NODE-TOP-LEVEL-NODE SELF) (BP-BUFFER (INTERVAL-FIRST-BP BUFFER))))

;This makes Undo work while editing the current msg
(DEFWHOPPER (INTERVAL-HOME-BUFFER ZMAIL-MSG-NODE) (&OPTIONAL PREFERRED)
  (IF (AND (VARIABLE-BOUNDP *MSG-INTERVAL*)
	   (SEND SELF :INFERIOR-TO-NODE *MSG-INTERVAL*))
      *MSG-INTERVAL*
      (CONTINUE-WHOPPER PREFERRED)))

(DEFVAR *FONT-CONVERTED-HEADER-LINES* NIL)

(DEFSTRUCT (SUMMARY-LINE :ARRAY-LEADER :CONC-NAME
			 (:MAKE-ARRAY (:LENGTH 140 :TYPE 'ART-STRING
				       :AREA *ZMAIL-SUMMARY-AREA*))
			 (:SIZE-SYMBOL SUMMARY-LINE-LENGTH))
  (LENGTH 0)
  TEMPLATE)

(DEFSTRUCT (FAT-SUMMARY-LINE :ARRAY-LEADER :CONC-NAME
			     (:MAKE-ARRAY (:LENGTH 140 :TYPE 'ART-FAT-STRING
					   :AREA *ZMAIL-SUMMARY-AREA*))
			     (:SIZE-SYMBOL FAT-SUMMARY-LINE-LENGTH))
  (LENGTH 0)
  TEMPLATE)

(EVAL-WHEN (EVAL COMPILE LOAD)
  (UNLESS (= SUMMARY-LINE-LENGTH FAT-SUMMARY-LINE-LENGTH)
    ;; Maybe instead we could hack something up with :INCLUDE?
    (FERROR "SUMMARY-LINE and FAT-SUMMARY-LINE defstructs are inconsistent.")))

2;;; Error handling macros used by Zmail

0;;; Like CATCH-ERROR-RESTART but executes a form (ERROR-FORM) if the proceed option is taken.
(DEFMACRO CATCH-ERROR-RESTART-WITH-FORM ((CONDITIONS DESCRIPTION &REST ARGS)
					 ERROR-FORM &BODY BODY)
  (DECLARE (ARGLIST . (((CONDITIONS) DESCRIPTION &REST ARGS) ERROR-FORM &BODY BODY))
	   (ZWEI:INDENTATION 0 5 1 3 2 1))
  (LET ((CONDITIONS (DBG:VALIDATE-CONDITIONS CONDITIONS))
	(BLOCK-NAME (GENSYM)))
    `(BLOCK ,BLOCK-NAME
       (CATCH-ERROR-RESTART (,CONDITIONS ,DESCRIPTION ,@ARGS)
	 (RETURN-FROM ,BLOCK-NAME
	   (PROGN
	     ,@BODY)))
       ,ERROR-FORM)))

;;; Like CATCH-ERROR-RESTART-WITH-FORM but sets the restart handler conditionally.
(DEFMACRO CATCH-ERROR-RESTART-IF-WITH-FORM (TEST (CONDITIONS DESCRIPTION &REST ARGS)
					    ERROR-FORM &BODY BODY)
  (DECLARE (ARGLIST . (TEST ((CONDITIONS) DESCRIPTION &REST ARGS) ERROR-FORM &BODY BODY))
	   (ZWEI:INDENTATION 0 5 1 5 2 3 3 1))
  (LET ((CONDITIONS (DBG:VALIDATE-CONDITIONS CONDITIONS))
	(BLOCK-NAME (GENSYM)))
    `(BLOCK ,BLOCK-NAME
       (CATCH-ERROR-RESTART-IF ,TEST
			       (,CONDITIONS ,DESCRIPTION ,@ARGS)
	 (RETURN-FROM ,BLOCK-NAME
	   (PROGN
	     ,@BODY)))
       ,ERROR-FORM)))

;;; Like ERROR-RESTART but executes an additional form (ERROR-FORM) before retrying the body
;;; if the proceeed option is taken.
(DEFMACRO ERROR-RESTART-WITH-FORM ((CONDITIONS DESCRIPTION &REST ARGS) ERROR-FORM &BODY BODY)
  (DECLARE (ARGLIST . (((CONDITIONS) DESCRIPTION &REST ARGS) ERROR-FORM &BODY BODY))
	   (ZWEI:INDENTATION 0 5 1 3 2 1))
  (LET ((CONDITIONS (DBG:VALIDATE-CONDITIONS CONDITIONS))
	(BLOCK-NAME (GENSYM))
	(FIRST-TIME (GENSYM)))
    `(BLOCK ,BLOCK-NAME
       (LOOP FOR ,FIRST-TIME = T THEN NIL
	     DO (CATCH-ERROR-RESTART (,CONDITIONS ,DESCRIPTION ,@ARGS)
		  (UNLESS ,FIRST-TIME
		    ,ERROR-FORM)
		  (RETURN-FROM ,BLOCK-NAME
		    (PROGN
		      ,@BODY)))))))

;;; Like ERROR-RESTART-WITH-FORM but sets the restart handler conditionally.
(DEFMACRO ERROR-RESTART-IF-WITH-FORM (TEST (CONDITIONS DESCRIPTION &REST ARGS)
				      ERROR-FORM &BODY BODY)
  (DECLARE (ARGLIST . (TEST ((CONDITIONS) DESCRIPTION &REST ARGS) ERROR-FORM &BODY BODY))
	   (ZWEI:INDENTATION 0 5 1 5 2 3 3 1))
  (LET ((CONDITIONS (DBG:VALIDATE-CONDITIONS CONDITIONS))
	(BLOCK-NAME (GENSYM))
	(FIRST-TIME (GENSYM)))
    `(BLOCK ,BLOCK-NAME
       (LOOP FOR ,FIRST-TIME = T THEN NIL
	     DO (CATCH-ERROR-RESTART-IF ,TEST
					(,CONDITIONS ,DESCRIPTION ,@ARGS)
		  (UNLESS ,FIRST-TIME
		    ,ERROR-FORM)
		  (RETURN-FROM ,BLOCK-NAME
		    (PROGN
		      ,@BODY)))))))

;;; Sets two restart handlers for the conditions -- The outermost handler causes execution
;;; to be retried indefinitely until it suceeds; the innermost handler retries execution once.
(DEFMACRO ERROR-RESTART-ONCE-OR-FOREVER ((CONDITIONS
					   (ONCE-DESCRIPTION FOREVER-DESCRIPTION) &REST ARGS)
					 &BODY BODY)
  (DECLARE (ARGLIST . (((CONDITIONS) (ONCE-DESCRIPTION FOREVER-DESCRIPTION) &REST ARGS)
		       &BODY BODY)))
  (LET ((CONDITIONS (DBG:VALIDATE-CONDITIONS CONDITIONS))
	(BLOCK-NAME (GENSYM))
	(RETRYING-FOREVER (GENSYM)))
    (CL:CHECK-TYPE ONCE-DESCRIPTION STRING)
    (CL:CHECK-TYPE FOREVER-DESCRIPTION STRING)
    `(LOOP NAMED ,BLOCK-NAME
	   FOR ,RETRYING-FOREVER = NIL THEN T
	   DOING
       (CATCH-ERROR-RESTART (,CONDITIONS ,FOREVER-DESCRIPTION ,@ARGS)
	 (CONDITION-CASE-IF ,RETRYING-FOREVER ()
	      (ERROR-RESTART (,CONDITIONS ,ONCE-DESCRIPTION ,@ARGS)
		(RETURN-FROM ,BLOCK-NAME
		  (PROGN
		    ,@BODY)))
	    (,CONDITIONS NIL))))))

;;; A simple relative of CONDITION-CASE which only traps the conditions if the debugger would
;;; not display its pop up proceed menu for the signalled condition.
(DEFMACRO CATCH-IF-NOT-DEBUGGER-MENU-CONDITION (CONDITIONS (USERS-ERROR-OBJECT)
						ERROR-FORM &BODY BODY)
  (DECLARE (ARGLIST . ((CONDITIONS) (ERROR-OBJECT) ERROR-FORM &BODY BODY))
	   (ZWEI:INDENTATION 2 4 3 1))
  (LET ((CONDITIONS (DBG:VALIDATE-CONDITIONS CONDITIONS))
	(ERROR-OBJECT (PROGN
			(CL:CHECK-TYPE USERS-ERROR-OBJECT (OR NULL SYMBOL) "a symbol")
			(IF USERS-ERROR-OBJECT USERS-ERROR-OBJECT (GENSYM))))
	(BLOCK-NAME (GENSYM))
	(TAG (GENSYM)))
    `(BLOCK ,BLOCK-NAME
      (MULTIPLE-VALUE-BIND (,ERROR-OBJECT)
	  (CONDITION-BIND ((,CONDITIONS
			    #'(LAMBDA (.ERROR.)
				(WHEN (LOOP FOR CONDITION IN DBG:*MENU-PROCEED-CONDITIONS*
					    NEVER (TYPEP .ERROR. CONDITION))
				  (THROW ',TAG (VALUES .ERROR.)))
				NIL)))
	    (CATCH ',TAG
	      (RETURN-FROM ,BLOCK-NAME
		(PROGN
		  ,@BODY))))
	(IGNORE ,ERROR-OBJECT)
	,ERROR-FORM))))

(DEFMACRO WITHOUT-ABORTS-IF (CONDITION (&REST OPTIONS) &BODY BODY)
  (DECLARE (ARGLIST . (CONDITION ([OPTIONAL-IDENTIFIER] REASON &REST FORMAT-ARGS) &BODY BODY)))
  `(FLET ((BODY () ,@BODY))
     (IF ,CONDITION
	 (SYS:WITHOUT-ABORTS ,OPTIONS (BODY))
	 (BODY))))

(3 0 (NIL 0) (NIL :BOLD-ITALIC NIL) "CPTFONTBI");;; Background process interface definitions.

1;;; All background requests are built on this flavor.
0(DEFFLAVOR ZMAIL-BASIC-BACKGROUND-REQUEST ((SEQUENCE NIL) TIME) ()
  :INITABLE-INSTANCE-VARIABLES
  (:READABLE-INSTANCE-VARIABLES (ZMAIL-BACKGROUND-REQUEST-SEQUENCE SEQUENCE)
				(ZMAIL-BACKGROUND-REQUEST-TIME TIME))
  (:DEFAULT-INIT-PLIST :TIME (TIME:GET-UNIVERSAL-TIME)))

(DEFGENERIC USES-SEQUENCE (ZMAIL-BACKGROUND-REQUEST-OR-RESPONSE))

(DEFGENERIC EXECUTE-BACKGROUND-REQUEST (ZMAIL-BACKGROUND-REQUEST))

1;;; Provides a restart handler to abort the background request.
0(DEFWHOPPER (EXECUTE-BACKGROUND-REQUEST ZMAIL-BASIC-BACKGROUND-REQUEST) ()
  (CATCH-ERROR-RESTART-WITH-FORM ((ERROR) "Abort this background request.")
      (ZMAIL-BACKGROUND-REQUEST-COMPLETE)
    (CONTINUE-WHOPPER)))

(DEFGENERIC FLUSH-BACKGROUND-REQUEST (ZMAIL-BACKGROUND-REQUEST)
  (:METHOD (ZMAIL-BASIC-BACKGROUND-REQUEST)
    NIL))					1;No special cleanup when flushed.

;;; Define a background request -- Each background request is a flavor built on
;;;    2zmail-basic-background-request1.
;;;
;;;    2request-arguments1 is a 2lambda1 list which defines the reuqest's arguments that must be
;;;       given when the request is queued by the 2queue-zmail-background-request1 macro.  The
;;;       arguments so specified are available as instance variables of the request flavor
;;;       and may, therefore, be used as settable variables within the body of the request.
;;;
;;;    2:uses-sequence t1 indicates that this request is associated with a particular
;;;       sequence and, therefore, can be flushed by 2flush-zmail-background-requests1.
;;;       In addition, use of this option causes 2zwei:sequence1 to be the first argument
;;;       of the request in calls to 2queue-zmail-background-request1 in addition to the
;;;       above arguments.
;;;
;;;    2:init-form form1 is the form to be executed when this request is created by
;;;       2queue-zmail-background-request1.
;;;
;;;    2:flush-form form1 is the form to be executed if this request is flushed by
;;;       2flush-zmail-background-requests1.  It should perform any necessary cleanup
;;;       such as removing progress notes, etc.
;;;
;;;    Note that the 2:init-form1 and 2:flush-form1 forms are run in the process which
;;;    creates/flushes the request.  They are not run in the background and, therefore,
;;;    should not do any work which should properly only be done in the background.
;;;    However, as they are normally run from within a Zmail instance, they can reference
;;;    all of Zmail's special instance variables (e.g., 2*zmail-background-process*1).
;;;    If needed, these forms can test 2*zmail-background-p*1 to see if they're running in
;;;    the background or the foreground.
;;;
;;;    The value returned by the body of a request should be the value of either
;;;    2(zmail-background-request-complete)1 or 2(zmail-background-request-incomplete)
1;;;    depending on whether the request has completed or must remain in the queue for later
;;;    execution.
;;;
;;;    If errors are expected during execution of the request (e.g., broken network
;;;    connections while loading/saving), the request body should use the
;;;    2trap-background-errors1 macro defined below to send a proper notification to the
;;;    user and prevent the background from entering the debugger.
;;;
;;;    A background request can inform the foreground of its progress/results by using
;;;    the 2queue-zmail-background-response1 macro defined below.

0(DEFMACRO DEFINE-ZMAIL-BACKGROUND-REQUEST (TYPE REQUEST-ARGUMENTS (&KEY USES-SEQUENCE
									INIT-FORM
									FLUSH-FORM
									PRINT-FORMAT
									PRINT-FORMAT-ARGS)
					   &BODY BODY)
  (DECLARE (ARGLIST
	     . (TYPE (REQUEST-ARGUMENTS) (&KEY USES-SEQUENCE INIT-FORM FLUSH-FORM
					       PRINT-FORMAT PRINT-FORMAT-ARGS)
		     &BODY BODY))
	   (ZWEI:INDENTATION 1 4 2 4 3 1))
  (CL:CHECK-TYPE TYPE SYMBOL)
  (CL:CHECK-TYPE REQUEST-ARGUMENTS LIST)
  (CL:CHECK-TYPE PRINT-FORMAT (OR NULL STRING))
  (CL:CHECK-TYPE PRINT-FORMAT-ARGS LIST)
  (LET ((FLAVOR-NAME (INTERN (FORMAT NIL "ZMAIL-~A-BACKGROUND-REQUEST" TYPE)))
	(REQUEST-ARGLIST
	  (IF USES-SEQUENCE `(SEQUENCE ,@REQUEST-ARGUMENTS) REQUEST-ARGUMENTS))
	(INSTANCE-VARIABLES))
    (LT:MAP-OVER-LAMBDA-LIST REQUEST-ARGUMENTS
      #'(LAMBDA (X IGNORE)
	  (LET ((ARG (FIRST X)))
	    (SETQ INSTANCE-VARIABLES
		  (NCONC INSTANCE-VARIABLES (NCONS (IF (ATOM ARG) ARG
						     ;; Check for keyword syntax
						     (LET ((ARG (FIRST ARG)))
						       (IF (ATOM ARG)
							   ARG (SECOND ARG))))))))))
    `(LOCAL-DECLARE ((SYS:FUNCTION-PARENT ,TYPE DEFINE-ZMAIL-BACKGROUND-REQUEST))
       (RECORD-SOURCE-FILE-NAME ',TYPE 'DEFINE-ZMAIL-BACKGROUND-REQUEST)
       (DEFPROP ,TYPE ,FLAVOR-NAME ZMAIL-BACKGROUND-REQUEST-FLAVOR)
       (DEFPROP ,TYPE ,REQUEST-ARGLIST ZMAIL-BACKGROUND-REQUEST-REQUEST-ARGUMENTS)
       (DEFFLAVOR ,FLAVOR-NAME ,INSTANCE-VARIABLES (ZMAIL-BASIC-BACKGROUND-REQUEST)
	 :INITABLE-INSTANCE-VARIABLES :READABLE-INSTANCE-VARIABLES)
       (DEFMETHOD (SYS:PRINT-SELF ,FLAVOR-NAME) (STREAM &REST IGNORE)
	 (SI:PRINTING-RANDOM-OBJECT (SELF STREAM)
	   (FORMAT STREAM "Zmail Background Request ~A (~VQ)" ',TYPE
		   TIME #'TIME:PRINT-UNIVERSAL-TIME)
	   ,@(WHEN USES-SEQUENCE
	       `((FORMAT STREAM " ~A" SEQUENCE)))
	   ,@(WHEN PRINT-FORMAT
	       `((FORMAT STREAM " ~@?" ,PRINT-FORMAT ,@PRINT-FORMAT-ARGS)))))
       ,@(WHEN INIT-FORM
	   `((DEFMETHOD (MAKE-INSTANCE ,FLAVOR-NAME) (&REST IGNORE)
	       ,INIT-FORM)))
       (DEFMETHOD (USES-SEQUENCE ,FLAVOR-NAME) ()
	 ,USES-SEQUENCE)
       (DEFMETHOD (EXECUTE-BACKGROUND-REQUEST ,FLAVOR-NAME) ()
	 ,@BODY)
       ,@(WHEN FLUSH-FORM
	   `((DEFMETHOD (FLUSH-BACKGROUND-REQUEST ,FLAVOR-NAME) ()
	       ,FLUSH-FORM)))
       (COMPILE-FLAVOR-METHODS ,FLAVOR-NAME))))

(DEFPROP DEFINE-ZMAIL-BACKGROUND-REQUEST "Zmail background request" SI:DEFINITION-TYPE-NAME)
(PUSH '(DEFINE-ZMAIL-BACKGROUND-REQUEST 3) *INDENT-NOT-FUNCTION-SUPERIORS*)

;;; All background responses are built on this flavor
(DEFFLAVOR ZMAIL-BASIC-BACKGROUND-RESPONSE ((SEQUENCE NIL) TIME) ()
  :INITABLE-INSTANCE-VARIABLES
  (:READABLE-INSTANCE-VARIABLES (ZMAIL-BACKGROUND-RESPONSE-SEQUENCE SEQUENCE)
				(ZMAIL-BACKGROUND-RESPONSE-TIME TIME))
  (:DEFAULT-INIT-PLIST :TIME (TIME:GET-UNIVERSAL-TIME)))

(DEFGENERIC EXECUTE-BACKGROUND-RESPONSE (ZMAIL-BACKGROUND-RESPONSE))

1;;; Macro to define a response from the background -- Each background response is a
;;;    flavor built on 2zmail-basic-background-response1.
;;;
;;; The definition of a response includes the code which should be executed in the
;;; foreground when it receives such a response.
;;;
;;; 2response-arguments1 and 2:uses-sequence1 have the same semantics as for requests above.

0(DEFMACRO DEFINE-ZMAIL-BACKGROUND-RESPONSE (TYPE RESPONSE-ARGUMENTS (&KEY USES-SEQUENCE
									  PRINT-FORMAT
									  PRINT-FORMAT-ARGS)
					    &BODY BODY)
  (DECLARE (ARGLIST
	     . (TYPE (RESPONSE-ARGUMENTS) (&KEY USES-SEQUENCE PRINT-FORMAT PRINT-FORMAT-ARGS)
		     &BODY BODY))
	   (ZWEI:INDENTATION 1 4 2 4 3 1))
  (CL:CHECK-TYPE TYPE SYMBOL)
  (CL:CHECK-TYPE RESPONSE-ARGUMENTS LIST)
  (CL:CHECK-TYPE PRINT-FORMAT (OR NULL STRING))
  (CL:CHECK-TYPE PRINT-FORMAT-ARGS LIST)
  (LET ((FLAVOR-NAME (INTERN (FORMAT NIL "ZMAIL-~A-BACKGROUND-RESPONSE" TYPE)))
	(RESPONSE-ARGLIST
	  (IF USES-SEQUENCE `(ZWEI:SEQUENCE ,@RESPONSE-ARGUMENTS) RESPONSE-ARGUMENTS))
	(INSTANCE-VARIABLES))
    (LT:MAP-OVER-LAMBDA-LIST RESPONSE-ARGUMENTS
      #'(LAMBDA (X IGNORE)
	  (LET ((ARG (FIRST X)))
	    (SETQ INSTANCE-VARIABLES
		  (NCONC INSTANCE-VARIABLES (NCONS (IF (ATOM ARG) ARG
						     ;; Check for keyword syntax
						     (LET ((ARG (FIRST ARG)))
						       (IF (ATOM ARG)
							   ARG (SECOND ARG))))))))))
    `(LOCAL-DECLARE ((SYS:FUNCTION-PARENT ,TYPE DEFINE-ZMAIL-BACKGROUND-RESPONSE))
       (RECORD-SOURCE-FILE-NAME ',TYPE 'DEFINE-ZMAIL-BACKGROUND-RESPONSE)
       (DEFPROP ,TYPE ,FLAVOR-NAME ZMAIL-BACKGROUND-RESPONSE-FLAVOR)
       (DEFPROP ,TYPE ,RESPONSE-ARGLIST ZMAIL-BACKGROUND-RESPONSE-RESPONSE-ARGUMENTS)
       (DEFFLAVOR ,FLAVOR-NAME ,INSTANCE-VARIABLES (ZMAIL-BASIC-BACKGROUND-RESPONSE)
	 :INITABLE-INSTANCE-VARIABLES :READABLE-INSTANCE-VARIABLES)
       (DEFMETHOD (SYS:PRINT-SELF ,FLAVOR-NAME) (STREAM &REST IGNORE)
	 (SI:PRINTING-RANDOM-OBJECT (SELF STREAM)
	   (FORMAT STREAM "Zmail Background Response ~A (~VQ)" ',TYPE
		   TIME #'TIME:PRINT-UNIVERSAL-TIME)
	   ,@(WHEN USES-SEQUENCE
	       `((FORMAT STREAM " ~A" SEQUENCE)))
	   ,@(WHEN PRINT-FORMAT
	       `((FORMAT STREAM " ~@?" ,PRINT-FORMAT ,@PRINT-FORMAT-ARGS)))))
       (DEFMETHOD (ZWEI:USES-SEQUENCE ,FLAVOR-NAME) ()
	 ,USES-SEQUENCE)
       (DEFMETHOD (ZWEI:EXECUTE-BACKGROUND-RESPONSE ,FLAVOR-NAME) ()
	 ,@BODY)
       (COMPILE-FLAVOR-METHODS ,FLAVOR-NAME))))

(DEFPROP DEFINE-ZMAIL-BACKGROUND-RESPONSE "Zmail background response" SI:DEFINITION-TYPE-NAME)
(PUSH '(DEFINE-ZMAIL-BACKGROUND-RESPONSE 3) *INDENT-NOT-FUNCTION-SUPERIORS*)

;;; Queue a request for execution by the background
(DEFMACRO QUEUE-ZMAIL-BACKGROUND-REQUEST (TYPE &REST REQUEST-ARGUMENTS)
  (DECLARE (ARGLIST . (TYPE &REST ARGUMENTS)))
  (CL:CHECK-TYPE TYPE SYMBOL)
  `(QUEUE-ZMAIL-BACKGROUND-REQUEST-INTERNAL *ZMAIL-BACKGROUND-REQUEST-QUEUE*
					    ',TYPE ,@REQUEST-ARGUMENTS))

;;; Trap errors during a background request with appropriate notification to the user --
;;;    Code may also be supplied to be executed by the request to cleanup after the error
(DEFMACRO TRAP-BACKGROUND-ERRORS ((CONDITIONS DESCRIPTION &REST ARGS)
				  (&KEY SUPPRESS-NOTIFICATION (ERROR-OBJECT '.ERROR.))
				  ERROR-FORM &BODY BODY)
  (DECLARE (ARGLIST . (((CONDITIONS) DESCRIPTION &REST DESCRIPTION-ARGS)
		       (&KEY SUPPRESS-NOTIFICATION (ERROR-OBJECT .ERROR.))
		       ERROR-FORM &BODY BODY))
	   (ZWEI:INDENTATION 0 6 2 4 3 1))
  (LET ((CONDITIONS (DBG:VALIDATE-CONDITIONS CONDITIONS))
	(BLOCK-NAME (MAKE-SYMBOL "UNDER-HANDLERS")))
    `(CONDITION-CASE-IF (AND (EQ *ZMAIL-BACKGROUND-P* T)
			     (NOT *BACKGROUND-ERRORS-INVOKE-DEBUGGER*))
			(,ERROR-OBJECT)
	  (BLOCK ,BLOCK-NAME
	    ,@BODY)
	(,CONDITIONS
	  ,@(UNLESS SUPPRESS-NOTIFICATION
	      `((TV:NOTIFY NIL "~A:~%~4T~~A~"
			   (FORMAT NIL ',DESCRIPTION ,@ARGS) ,ERROR-OBJECT)))
	  ,ERROR-FORM))))

1;;; Indicate that a background request is completed.
0(DEFUN ZMAIL-BACKGROUND-REQUEST-COMPLETE ()
  :COMPLETE)

1;;; Indicate that a background request is not yet complete and must remain in the queue.
0(DEFUN ZMAIL-BACKGROUND-REQUEST-INCOMPLETE ()
  :INCOMPLETE)

;;; Queue a response from a background request to the foreground
(DEFMACRO QUEUE-ZMAIL-BACKGROUND-RESPONSE (TYPE &REST RESPONSE-ARGUMENTS)
  (DECLARE (ARGLIST . (TYPE &REST ARGUMENTS)))
  (CL:CHECK-TYPE TYPE SYMBOL)
  `(QUEUE-ZMAIL-BACKGROUND-RESPONSE-INTERNAL ',TYPE ,@RESPONSE-ARGUMENTS))


;;; Macros to be used by foreground code which expects to run without interference

(DEFMACRO WITH-BACKGROUND-PROCESS-LOCKED (&BODY BODY)
  `(LET ((.LOCKED-P. NIL))
     (UNWIND-PROTECT
	 (PROGN
	   (SETQ .LOCKED-P. (LOCK-BACKGROUND-PROCESS))
	   ,@BODY)
       (WHEN .LOCKED-P. (PROCESS-UNLOCK *ZMAIL-BACKGROUND-PROCESS-LOCK*)))))

(DEFMACRO WITH-BACKGROUND-PROCESS-SLEEPING (&BODY BODY)
  `(LET-GLOBALLY ((*ZMAIL-RUNNING-FOREGROUND-COMMAND* T))
     ,@BODY))


;;; Macro to override the effect of WITH-BACKGROUND-PROCESS-SLEEPING inside a Zmail command.
(DEFMACRO WITH-BACKGROUND-PROCESS-RUNNING (&BODY BODY)
  `(LET-GLOBALLY ((*ZMAIL-RUNNING-FOREGROUND-COMMAND* :REQUESTS-ALLOWED))
     ,@BODY))


;;; Miscellaneous variables related to the background

(DEFVAR-RESETTABLE *ZMAIL-BACKGROUND-P* NIL)	; T (not non-NIL) if within background process
(DEFVAR-RESETTABLE *ZMAIL-RUNNING-FOREGROUND-COMMAND* NIL)

(DEFVAR *FOREGROUND-WINDOW*)
(DEFVAR *HANG-BACKGROUND-PROCESS-WHEN-DEEXPOSED* NIL)

(DEFVAR *BACKGROUND-LOAD-QUANTUM* 20. "Number of messages to load before pausing.")
(DEFVAR *BACKGROUND-SAVE-QUANTUM* 10. "Number of messages to save before pausing.")
(DEFVAR *BACKGROUND-PARSE-QUANTUM* 10. "Number of messages to parse before pausing.")

2;;; Zmail file I/O errors

1;;; Base flavor for all Zmail specific file I/O errors.
0(DEFFLAVOR ZMAIL-FILE-ERROR () (FERROR)
  :ABSTRACT-FLAVOR)

1;;; Specifc error flavors.

0(DEFFLAVOR ZMAIL-BACKGROUND-FILE-ERROR (ERROR) (ZMAIL-FILE-ERROR)
  :INITABLE-INSTANCE-VARIABLES)

(DEFMETHOD (DBG:REPORT ZMAIL-BACKGROUND-FILE-ERROR) (STREAM)
  (DBG:REPORT ERROR STREAM))

(COMPILE-FLAVOR-METHODS ZMAIL-BACKGROUND-FILE-ERROR)

(DEFFLAVOR WRONG-MAIL-FILE-FORMAT
	((BUFFER NIL)
	 (APPARENT-FORMAT NIL)
	 DBG:FORMAT-STRING
	 DBG:FORMAT-ARGS)
	(ZMAIL-FILE-ERROR)
  (:READABLE-INSTANCE-VARIABLES BUFFER APPARENT-FORMAT DBG:FORMAT-STRING DBG:FORMAT-ARGS)
  :INITABLE-INSTANCE-VARIABLES)

(DEFMETHOD (DBG:REPORT WRONG-MAIL-FILE-FORMAT) (STREAM)
  (LET ((PATHNAME (MSG-BUFFER-PATHNAME BUFFER))
	(EXPECTED-FORMAT-NAME (SEND BUFFER :FORMAT-NAME))
	(APPARENT-FORMAT-NAME (IF APPARENT-FORMAT
				  (FLAVOR:FUNCALL-HANDLER APPARENT-FORMAT :FORMAT-NAME))))
    (FORMAT STREAM "~~A is not a ~A file~:[ but is apparently a ~A file~;~*~].~@[~%~?~]~"
	    PATHNAME EXPECTED-FORMAT-NAME (NULL APPARENT-FORMAT) APPARENT-FORMAT-NAME
	    DBG:FORMAT-STRING DBG:FORMAT-ARGS)))

(COMPILE-FLAVOR-METHODS WRONG-MAIL-FILE-FORMAT)

(DEFFLAVOR INBOX-REQUIRES-SAVE
	(BUFFER
	 FIRST-INBOX)
	(ZMAIL-FILE-ERROR)
  :READABLE-INSTANCE-VARIABLES
  :INITABLE-INSTANCE-VARIABLES)

(DEFMETHOD (DBG:REPORT INBOX-REQUIRES-SAVE) (STREAM)
  (FORMAT STREAM "Can't read~:[ any more~] new mail into the mail file ~A~@
		  until after its current contents have been saved~:[~;~@
		  but saving is currently disabled for this mail file~]."
	  FIRST-INBOX (SEQUENCE-NAME BUFFER) (SEND BUFFER :GET :DISABLE-SAVES)))

(DEFMETHOD (DBG:PROCEED-TYPES INBOX-REQUIRES-SAVE) ()
  (IF (SEND BUFFER :GET :DISABLE-SAVES)
      '(:STOP-READING-NEW-MAIL)
      '(:SAVE-AND-CONTINUE-READING-NEW-MAIL :STOP-READING-NEW-MAIL)))

(DEFMETHOD (SYS:PROCEED INBOX-REQUIRES-SAVE :SAVE-AND-CONTINUE-READING-NEW-MAIL)
	   (&OPTIONAL SILENTLY)
  (UNLESS SILENTLY
    (BEEP)
    (TYPEIN-LINE-DURABLE "Saving mail file ~A (without expunging) ~
			  in order to ~:[continue reading~;read~] new mail."
			 (SEQUENCE-NAME BUFFER) FIRST-INBOX))
  :SAVE-AND-CONTINUE-READING-NEW-MAIL)

(DEFMETHOD (DBG:DOCUMENT-PROCEED-TYPE INBOX-REQUIRES-SAVE :SAVE-AND-CONTINUE-READING-NEW-MAIL)
	   (STREAM)
  (FORMAT STREAM "Save mail file ~A (without expunging it first) ~
		  and then ~:[continue reading~;read~] new mail."
	  (SEQUENCE-NAME BUFFER) FIRST-INBOX))

(DEFMETHOD (SYS:PROCEED INBOX-REQUIRES-SAVE :STOP-READING-NEW-MAIL) (&OPTIONAL SILENTLY)
  (UNLESS SILENTLY
    (BEEP)
    (TYPEIN-LINE-DURABLE "~A" SELF))
  :STOP-READING-NEW-MAIL)

(DEFMETHOD (DBG:DOCUMENT-PROCEED-TYPE INBOX-REQUIRES-SAVE :STOP-READING-NEW-MAIL) (STREAM)
  (FORMAT STREAM "Skip reading~:[ any more~] new mail for the mail file ~A."
	  FIRST-INBOX (SEQUENCE-NAME BUFFER)))

(COMPILE-FLAVOR-METHODS INBOX-REQUIRES-SAVE)

1;;; "Simple" Zmail file I/O errors -- (I.e., errors without any special handling.)

0(DEFFLAVOR PRELOAD-FILE-CONFLICT () (ZMAIL-FILE-ERROR))

(DEFFLAVOR GMSGS-FILE-ERROR () (ZMAIL-FILE-ERROR))

(DEFFLAVOR INBOX-RENAME-ERROR () (ZMAIL-FILE-ERROR))

(DEFFLAVOR BAD-MSG-CHARACTER-TYPE-MAPPINGS () (ZMAIL-FILE-ERROR))

(COMPILE-FLAVOR-METHODS PRELOAD-FILE-CONFLICT GMSGS-FILE-ERROR
			INBOX-RENAME-ERROR BAD-MSG-CHARACTER-TYPE-MAPPINGS)

(DEFVAR *WINDOW-CONFIGURATION-ALIST* '(("Summary only" :VALUE :SUMMARY
					:DOCUMENTATION "Just the summary window.")
				       ("Both" :VALUE :BOTH
					:DOCUMENTATION
				       "Summary window at the top and message at the bottom.")
				       ("Message only" :VALUE :MSG
					:DOCUMENTATION "Just display current message.")
				       ("Filtering commands" :VALUE :FILTERING-COMMANDS
					:DOCUMENTATION "Every command takes a filter.")
				       ("Summary//Message only" :VALUE :SUMMARY-OR-MSG
					:DOCUMENTATION
 "Alternate between summary only and message only configurations starting with summary only.")
				       ("Send" :VALUE :SEND
					:DOCUMENTATION "Headers and Reply windows.")
				       ("Message only" :VALUE :MSG-NO-MENU
					:DOCUMENTATION "Just the text of the message.")
				       ("Calendar" :VALUE :CALENDAR
					:DOCUMENTATION
					"Like Both, but with calendar commands")
				       ("Month" :VALUE :MONTH
					:DOCUMENTATION 
  "Display a calendar for a given month: L: This month, M: Next month, R: Ask.")
				       ("Four weeks" :VALUE :FOUR-WEEKS
					:DOCUMENTATION 
  "Display a calendar for given four weeks: L: Start this week, M: End this week, R: Ask.")
				       ("Week" :VALUE :WEEK
					:DOCUMENTATION 
  "Display a calendar for a given week: L: This week, M: Next week, R: Ask.")
				       ("Year" :VALUE :YEAR
					:DOCUMENTATION 
  "Display a calendar for a given year: L: This year, M: Next year, R: Ask.")
				       ))

(DEFVAR *CALENDAR-WINDOW-CONFIGURATIONS*
  '(:CALENDAR :MONTH :FOUR-WEEKS :WEEK :YEAR))

(DEFUN SOME-CONFIGURATIONS (CONFIGURATIONS)
  (LOOP FOR ELEM IN *WINDOW-CONFIGURATION-ALIST*
	WHEN (MEMQ (TV:MENU-EXECUTE-NO-SIDE-EFFECTS ELEM) CONFIGURATIONS)
	COLLECT ELEM))

(DEFVAR *MAIN-WINDOW-CONFIGURATION-ALIST* (SOME-CONFIGURATIONS '(:SUMMARY :BOTH :MSG
								 :FILTERING-COMMANDS)))

(DEFVAR *MAIL-WINDOW-CONFIGURATION-ALIST* (SOME-CONFIGURATIONS '(:SEND :BOTH :MSG-NO-MENU
								 :FILTERING-COMMANDS)))

(DEFVAR *COM-CONFIGURE-CONFIGURATION-ALIST* (SOME-CONFIGURATIONS '(:SUMMARY :BOTH :MSG
								   :FILTERING-COMMANDS
								   :SUMMARY-OR-MSG
								   :CALENDAR :MONTH
								   :FOUR-WEEKS :WEEK :YEAR)))

(DEFVAR *DELETE-DIRECTION-ALIST* '(("Backward" :VALUE :BACKWARD :DOCUMENTATION
				    "Move backward after deleting this message.")
				   ("Forward" :VALUE :FORWARD :DOCUMENTATION
				    "Move forward after deleting this message.")
				   ("Remove" :VALUE :REMOVE :DOCUMENTATION
				    "Actually remove this message from this collection.")
				   ("No" :VALUE :NO :DOCUMENTATION
				    "Do not move after the deletion.")
				   ("Forward//Remove" :VALUE :FORWARD-OR-REMOVE
				    :DOCUMENTATION "Forward if buffer, else Remove.")
				   ("Backward//Remove" :VALUE :BACKWARD-OR-REMOVE
				    :DOCUMENTATION "Backward if buffer, else Remove.")
				   ))

(DEFVAR *DRAFT-EDITOR-END-KEY-TREATMENT-ALIST*
  '(("Send" :VALUE :SEND-MSG
	    :DOCUMENTATION " sends the message; c- adds more text.")
    ("Both send" :VALUE :BOTH-SEND-MSG
		 :DOCUMENTATION " and c- both send the message.")
    ("Add text" :VALUE :ADD-MORE-TEXT
		:DOCUMENTATION " adds more text; c- sends the message.")
    ("Both add text" :VALUE :BOTH-ADD-MORE-TEXT
		     :DOCUMENTATION " and c- both add more text to the message.")))

(DEFVAR *REPLY-MODES-ALIST*
  '((("All" :VALUE :ALL
	    :DOCUMENTATION "To field: Sender and original To, Cc field: original Cc.")
     ("All-Cc" :VALUE :ALL-CC
	       :DOCUMENTATION "To field: Sender, Cc field: original To and Cc.")
     ("Cc-All" :VALUE :CC-ALL
	       :DOCUMENTATION "To field: original To, Cc field: Sender and original Cc.")
     ("To" :VALUE :TO :DOCUMENTATION "To field: Sender and original To.")
     ("To-Cc" :VALUE :TO-CC :DOCUMENTATION "To field: Sender, Cc field: original To.")
     ("Cc-To" :VALUE :CC-TO :DOCUMENTATION "To field: original To, Cc field: Sender.")
     ("Sender" :VALUE :SENDER :DOCUMENTATION "To field: Sender."))
    (("Two-windows" :VALUE :TWO-WINDOWS
		    :DOCUMENTATION "Message being replied to on top and reply below.")
     ("One-window" :VALUE :ONE-WINDOW :DOCUMENTATION "Just text of reply.")
     ("Yank" :VALUE :YANK
	     :DOCUMENTATION "Just text of reply with message being replied to yanked in."))
    (("Prune" :VALUE :PRUNE :DOCUMENTATION "Prune headers of yanked messages.")
     ("Don't prune" :VALUE :DONT-PRUNE
		    :DOCUMENTATION "Don't prune headers of yanked messages."))))

(DEFVAR *YES-NO-ASK-ALIST*
	'(("Yes" :VALUE T) ("No" :VALUE NIL) ("Ask" . :ASK)))

(DEFVAR *HEADER-FORCE-ALIST* '(("None" :VALUE :NONE
				:DOCUMENTATION "No special header force, mailer chooses.")
			       ("RFC733" :VALUE :RFC733
				:DOCUMENTATION "RFC733 standard headers.")
			       ("Network" :VALUE :NETWORK
				:DOCUMENTATION "Network standard headers.")
			       ("ITS" :VALUE :ITS
				:DOCUMENTATION "Single line ITS headers.")))

(DEFVAR *HEADER-FORMAT-ALIST* '(("Short" :VALUE :SHORT :DOCUMENTATION
  "Use /"@/" to separate user and host, no personal names.")
				("Long" :VALUE :LONG :DOCUMENTATION
  "Use /" at /" to separate user and host, no personal names.")
				("Include personal" :VALUE :INCLUDE-PERSONAL :DOCUMENTATION
  "Include the user's personal name if any.")
				("Use original" :VALUE :USE-ORIGINAL :DOCUMENTATION
  "Use the exact text of the address from the original.")))

(DEFVAR *BUG-DOCUMENTATION* (MAKE-EMPTY-STRING 95.))
(DEFVAR *LOCAL-MAIL-DOCUMENTATION* (MAKE-EMPTY-STRING 95.))

(DEFVAR *ZMAIL-MAIL-MENU-ALIST*
	`(("Bug" :VALUE :BUG
	   :DOCUMENTATION ,*BUG-DOCUMENTATION*)
	  ("Mail" :VALUE :MAIL :DOCUMENTATION "Normal mail.  R: Menu of templates")
	  ("Forward" :VALUE :FORWARD :DOCUMENTATION 
  "Forward this message.  Starts sending a message with this as its text.  R: Menu of templates.")
	  ("Redistribute" :VALUE :REDISTRIBUTE :DOCUMENTATION 
  "Redistribute this message.  Sends a message with the original headers plus ReSent.")
	  ("Local" :VALUE :LOCAL
	   :DOCUMENTATION ,*LOCAL-MAIL-DOCUMENTATION*)))

(DEFVAR *MOVE-TO-NEXT-MENU-ALIST*
	'(("Next undeleted" :VALUE :NEXT-UNDELETED :DOCUMENTATION
	   "Move to next undeleted message.")
	  ("Next" :VALUE :NEXT :DOCUMENTATION
	   "Move to next message, even if deleted.")
	  ("Next unseen" :VALUE :NEXT-UNSEEN :DOCUMENTATION
	   "Move to next unseen undeleted message.")
	  ("Next recent" :VALUE :NEXT-RECENT :DOCUMENTATION
	   "Move to next recent undeleted message.")
	  ("Last undeleted" :VALUE :LAST-UNDELETED :DOCUMENTATION
	   "Move to last undeleted message in the file.")
	  ("Last" :VALUE :LAST :DOCUMENTATION
	   "Move to last message in file, even if deleted")
	  ("Last unseen" :VALUE :LAST-UNSEEN :DOCUMENTATION
	   "Move to last unseen undeleted message in the file.")
	  ("Last recent" :VALUE :LAST-RECENT :DOCUMENTATION
	   "Move to last recent undeleted message in the file.")
	  ))

(DEFVAR *MOVE-TO-PREVIOUS-MENU-ALIST*
	'(("Previous undeleted" :VALUE :PREVIOUS-UNDELETED :DOCUMENTATION
	   "Move to previous undeleted message.")
	  ("Previous" :VALUE :PREVIOUS :DOCUMENTATION
	   "Move to previous message, even if deleted.")
	  ("Previous unseen" :VALUE :PREVIOUS-UNSEEN :DOCUMENTATION
	   "Move to previous unseen undeleted message.")
	  ("Previous recent" :VALUE :PREVIOUS-RECENT :DOCUMENTATION
	   "Move to previous recent undeleted message.")
	  ("First undeleted" :VALUE :FIRST-UNDELETED :DOCUMENTATION
	   "Move to first undeleted message in the file.")
	  ("First" :VALUE :FIRST :DOCUMENTATION
	   "Move to first message in file, even if deleted")
	  ("First unseen" :VALUE :FIRST-UNSEEN :DOCUMENTATION
	   "Move to first unseen undeleted message in the file.")
	  ("First recent" :VALUE :FIRST-RECENT :DOCUMENTATION
	   "Move to first recent undeleted message in the file.")
	  ))

(DEFVAR *ZMAIL-MAP-COMMAND-ALIST*
	'(("Delete" . COM-ZMAIL-DELETE-ALL)
	  ("Undelete" . COM-ZMAIL-UNDELETE-ALL)
	  ("Type" . COM-ZMAIL-TYPE-ALL)
	  ("Find string" . COM-ZMAIL-OCCUR)
	  ("Keywords" . COM-ZMAIL-KEYWORDS-ALL)
	  ("Unkeywords" . COM-ZMAIL-UNKEYWORDS-ALL)
	  ("Move" . COM-ZMAIL-MOVE-ALL-TO-FILE)
	  ("Hardcopy" . COM-ZMAIL-HARDCOPY-ALL)
	  ("Forward" . COM-ZMAIL-FORWARD-ALL)
	  ("Redistribute" . COM-ZMAIL-REDISTRIBUTE-ALL)
	  ("Reply" . COM-ZMAIL-REPLY-ALL)
	  ("Concatenate" . COM-ZMAIL-CONCATENATE-ALL)
	  ("Reformat" . COM-ZMAIL-REFORMAT-ALL)
	  ("Unreformat" . COM-ZMAIL-UNREFORMAT-ALL)
	  ("Select Conversation" . COM-ZMAIL-SELECT-ALL-CONVERSATIONS-BY-REFERENCES)
	  ("Undigestify" . COM-ZMAIL-UNDIGESTIFY-ALL-MSGS)))

(DEFVAR *SUMMARY-REPLY-DOCUMENTATION* (MAKE-EMPTY-STRING 95.))
(DEFVAR *EDIT-MSG-DOCUMENTATION* (MAKE-EMPTY-STRING 95.))

(DEFVAR *UNIVERSE-BUTTON-DOCUMENTATION* (MAKE-EMPTY-STRING 95.))
(DEFVAR *FILTER-BUTTON-DOCUMENTATION* (MAKE-EMPTY-STRING 95.))

;;; If you change this list, look at ZMAIL-SUMMARY-MOUSE, which knows the order of the
;;; elements
(DEFVAR *SUMMARY-MOUSE-MENU-ALIST*
	`(("Continue" :VALUE :REPLY :DOCUMENTATION "Continue sending this draft message."
		      :FILTER MSG-DRAFT-MSG-P)
	  ("Keywords" :VALUE :KEYWORDS
		      :DOCUMENTATION ,(MAKE-EMPTY-STRING 95.)
		      :DOCUMENTATION-UPDATER UPDATE-KEYWORDS-WHO-LINE-DOCUMENTATION)
	  ("Delete" :VALUE :DELETE
		    :DOCUMENTATION "Delete this message."
		    :FILTER (MSG-DOES-NOT-HAVE-ATTRIBUTE-P DELETED))
	  ("Undelete" :VALUE :UNDELETE
		      :DOCUMENTATION "Undelete this message."
		      :FILTER (MSG-HAS-ATTRIBUTE-P DELETED))
	  ("Remove" :VALUE :REMOVE
		    :DOCUMENTATION "Remove this message from this temporary mail file."
		    :FILTER SEQUENCE-NOT-BUFFER-P)
	  ("Reply" :VALUE :REPLY :DOCUMENTATION ,*SUMMARY-REPLY-DOCUMENTATION*
		   :FILTER MSG-NOT-DRAFT-MSG-P)
	  ("Move" :VALUE :MOVE :DOCUMENTATION ,(MAKE-EMPTY-STRING 95.)
		  :DOCUMENTATION-UPDATER UPDATE-SUMMARY-MOVE-TO-FILE-WHO-LINE-DOCUMENTATION)
	  ("Concatenate" :VALUE :APPEND :DOCUMENTATION
  "Append this message to the end of another:  L: current message; R: specify from summary.")
	  ("Filter" :VALUE :FILTER
		    :DOCUMENTATION "Filter according to some attribute of this message.")
	  ("Forward" :VALUE :FORWARD
		     :DOCUMENTATION "Forward this message.")
	  ("Redistribute" :VALUE :REDISTRIBUTE
			  :DOCUMENTATION "Redistribute this message.")
	  ("Survey conversation" :VALUE :SURVEY
		    :DOCUMENTATION "Survey the conversation containing this message.")
	  ("Select conversation" :VALUE :CONVERSATION
			  :DOCUMENTATION "Select the conversation containing this message.")
	  ))

(DEFVAR *SUMMARY-MOUSE-MIDDLE-MENU-ALIST*
	`(("Delete//Undelete" :VALUE :DELETE-OR-UNDELETE :DOCUMENTATION
	   "Delete if not deleted, else undelete.")
	  ("Delete//Undelete//Remove" :VALUE :DELETE-OR-REMOVE :DOCUMENTATION
	   "Undelete if deleted, else delete if from buffer, else remove.")
	  . ,(CDR *SUMMARY-MOUSE-MENU-ALIST*)))

(DEFVAR *REQUIRE-SUBJECTS-ALIST*
	'(("Yes" :VALUE T)
	  ("No" :VALUE NIL)
	  ("On bug reports" :VALUE :BUG)
	  ("Initial but not required" :VALUE :INIT)))

(DEFVAR *REFORMAT-HEADERS-P-ALIST*
  '(("Yes" :VALUE T
	   :DOCUMENTATION "Display reformatted headers but save the original headers.")
    ("No" :VALUE NIL
	  :DOCUMENTATION "Display and save the original headers.")))

;;; Used only while reading/saving BABYL options to allow compatibility
(DEFVAR *BABYL-REFORMAT-HEADERS-P-PARSE-ALIST*
  '(("Yes" :VALUE T) ("No" :VALUE NIL) ("Save Both" :VALUE :SAVE-BOTH)))

(DEFVAR *KEYWORD-ALIST-SORT-PREDICATE-ALIST*
  '(("Alphabetic" :VALUE (FUNCTION STRING-LESSP))
    ("Reverse alphabetic" :VALUE (FUNCTION STRING-GREATERP))
    ("None" :VALUE NIL :DOCUMENTATION "Don't sort the keywords.")
    ))

(DEFVAR *SUMMARY-WINDOW-FORMAT-ALIST*
	`(("Standard" :VALUE T
		      :DOCUMENTATION
	  "Standard summary format:  No. Lines  Date FromTo                 Subject or Text")
	  ("No Date" :VALUE NIL
		     :DOCUMENTATION
	    "Summary format without date:  No. Lines FromTo                 Subject or Text")
	  ("Reminder" :VALUE :REMINDER
		      :DOCUMENTATION
		        "Reminder summary format:  No.  Date Time  Subject or Text")))

(DEFVAR *BABYL-SUMMARY-WINDOW-FORMAT-ALIST*
	`(("Use Default" :VALUE :DEFAULT
			 :DOCUMENTATION "Use the default format specified in your profile.")
	  ,@*SUMMARY-WINDOW-FORMAT-ALIST*))

;;; Used only while reading/saving BABYL options to allow compatibility
(DEFVAR *BABYL-SUMMARY-WINDOW-FORMAT-PARSE-ALIST*
	`(("T" :VALUE T) ("NIL" :VALUE NIL) (":REMINDER" :VALUE :REMINDER)
	  ,@*BABYL-SUMMARY-WINDOW-FORMAT-ALIST*))

;;; Translates from the above user visible setting to usable definitions.
(DEFVAR *SUMMARY-TEMPLATE-ABBREVIATIONS*
  '((T . (:SIZE 5 :DATE :DATE :RECIPIENTS 23. :KEYWORDS T :SUBJECT T))
    (NIL . (:SIZE 5 :RECIPIENTS 23. :KEYWORDS T :SUBJECT T))
    (:REMINDER . (:REMINDER-DATE-AND-TIME T :KEYWORDS T :SUBJECT T))))

;;; Define a new summary window format template.
(DEFMACRO DEFINE-SUMMARY-FORMAT-TEMPLATE (NAME TEMPLATE
					  &OPTIONAL MENU-NAME DOCUMENTATION-PREFIX)
  (CL:CHECK-TYPE NAME SYMBOL)
  (CL:CHECK-TYPE TEMPLATE LIST)
  (CL:CHECK-TYPE MENU-NAME (OR STRING NULL) "a string")
  (CL:CHECK-TYPE DOCUMENTATION-PREFIX (OR STRING NULL) "a string")
  (UNLESS MENU-NAME
    (SETQ MENU-NAME (MAKE-ZMAIL-TOP-LEVEL-COMMAND-NAME NAME)))
  (UNLESS DOCUMENTATION-PREFIX
    (SETQ DOCUMENTATION-PREFIX (FORMAT NIL "~A summary format" MENU-NAME)))
  `(LOCAL-DECLARE ((SYS:FUNCTION-PARENT ,NAME DEFINE-SUMMARY-FORMAT-TEMPLATE))
     (DEFINE-SUMMARY-FORMAT-TEMPLATE-WORKER ',NAME ',TEMPLATE
					    ,MENU-NAME ,DOCUMENTATION-PREFIX)))

(DEFPROP DEFINE-SUMMARY-FORMAT-TEMPLATE "Zmail summary format template"
	 SI:DEFINITION-TYPE-NAME)

;;; This is for defining things that should be reset when the user changes
(DEFVAR *ZMAIL-GLOBAL-INITIALIZATION-LIST* NIL :LOCALIZE T)

(DEFMACRO DEFINE-ZMAIL-GLOBAL (VAR &OPTIONAL (INITIAL-VALUE NIL IVP))
  `(PROGN 'COMPILE
	  (DEFVAR ,VAR)
	  ,(WHEN IVP
	     `(LET ((INIT (ASSQ ',VAR *ZMAIL-GLOBAL-INITIALIZATION-LIST*)))
		(IF INIT
		    (SETF (CDR INIT) ,INITIAL-VALUE)
		    (PUSH (CONS ',VAR ,INITIAL-VALUE) *ZMAIL-GLOBAL-INITIALIZATION-LIST*))))))

(DEFPROP DEFINE-ZMAIL-GLOBAL DEFVAR ZWEI:DEFINITION-FUNCTION-SPEC-TYPE)

(DEFVAR *ZMAIL-INIT-INITIALIZATION-LIST* NIL)

(DEFMACRO DEFINE-ZMAIL-INIT (VAR &OPTIONAL (INITIAL-VALUE NIL IVP))
  `(PROGN 'COMPILE
	  (DEFVAR ,VAR)
	  ,(WHEN IVP
	     `(LET ((INIT (ASSQ ',VAR *ZMAIL-INIT-INITIALIZATION-LIST*)))
		(IF INIT
		    (SETF (CDR INIT) ,INITIAL-VALUE)
		    (PUSH (CONS ',VAR ,INITIAL-VALUE) *ZMAIL-INIT-INITIALIZATION-LIST*))))))

(DEFPROP DEFINE-ZMAIL-INIT DEFVAR ZWEI:DEFINITION-FUNCTION-SPEC-TYPE)

(DEFVAR *ZMAIL-WHO-LINE-DOCUMENTATION-SYMBOLS* NIL)

(DEFMACRO DEFINE-COMMAND-WHO-LINE-DOCUMENTATION-UPDATER (COMMAND ARGLIST &BODY BODY)
  `(LOCAL-DECLARE
         ((SYS:FUNCTION-PARENT ,COMMAND DEFINE-COMMAND-WHO-LINE-DOCUMENTATION-UPDATER))
     (RECORD-SOURCE-FILE-NAME ',COMMAND 'DEFINE-COMMAND-WHO-LINE-DOCUMENTATION-UPDATER)
     (PUSH* ',COMMAND *ZMAIL-WHO-LINE-DOCUMENTATION-SYMBOLS*)
     (DEFUN (,COMMAND WHO-LINE-DOCUMENTATION-UPDATER) ,ARGLIST
       . ,BODY)))

(DEFPROP DEFINE-COMMAND-WHO-LINE-DOCUMENTATION-UPDATER "Who line documentation update function"
	 SI:DEFINITION-TYPE-NAME)

(DEFMACRO DEFINE-COMMAND-WHO-LINE-DOCUMENTATION (COMMAND STRING)
  `(PUTPROP ',COMMAND ,STRING ':WHO-LINE-DOCUMENTATION))

(DEFVAR *OPTIONS-NOT-IN-ALIST* NIL)

(DEFMACRO ASSOCIATE-OPTION-WITH-COMMAND-DOCUMENTATION (OPTION COMMAND)
  `(PROGN 'COMPILE
     (PUSH ',COMMAND (GET ',OPTION 'DOCUMENTATION-ASSOCIATED-COMMANDS))
     (UNLESS (ASSQ ',OPTION *ZMAIL-USER-OPTION-ALIST*)
       (PUSH* ',OPTION *OPTIONS-NOT-IN-ALIST*))))

(DEFMACRO ASSOCIATE-TEMPLATE-WITH-COMMAND-DOCUMENTATION (TEMPLATE COMMAND)
  `(PROGN 'COMPILE
     (PUSH ',COMMAND (GET ',TEMPLATE 'DOCUMENTATION-ASSOCIATED-COMMANDS))))

(DEFMACRO DEFINE-COMMAND-MAP-OVER-DOCUMENTATION-UPDATER (COMMAND ARGLIST &BODY BODY)
  `(LOCAL-DECLARE
         ((SYS:FUNCTION-PARENT ,COMMAND DEFINE-COMMAND-MAP-OVER-DOCUMENTATION-UPDATER))
     (RECORD-SOURCE-FILE-NAME ',COMMAND 'DEFINE-COMMAND-MAP-OVER-DOCUMENTATION-UPDATER)
     (DEFUN (:PROPERTY ,COMMAND MAP-OVER-DOCUMENTATION-UPDATER) ,ARGLIST
       . ,BODY)))

(DEFPROP DEFINE-COMMAND-MAP-OVER-DOCUMENTATION-UPDATER "Map Over documentation update function"
	 SI:DEFINITION-TYPE-NAME)

(DEFMACRO HEADER-TYPE-TYPECASE (TYPE &BODY BODY &ENVIRONMENT ENV)
  (SI:TYPECASE-DEFINER 'HEADER-TYPE-TYPEP TYPE BODY ENV))

(DEFUN HEADER-TYPE-TYPEP (TYPE SUPERTYPE)
  (OR (AND (EQ TYPE SUPERTYPE)
	   (CL:ASSOC SUPERTYPE *HEADER-TYPE-ALIST*)
	   T)
      (AND (CL:MEMBER SUPERTYPE (GET TYPE 'SUPERTYPES))
	   'T)))

(DEFUN HEADER-TYPE-NAME (TYPE &AUX ELEM)
  (IF (SETQ ELEM (ASSQ TYPE *HEADER-TYPE-ALIST*))
      (HEADER-TYPE-ELEM-PRETTY-NAME ELEM)
      (STRING TYPE)))

;;; Random variables
(DEFVAR *EDITING-PROFILE* NIL)			;non-NIL while in the profile editor frame
(DEFVAR *ZMAIL-PATHNAME-DEFAULTS*)		;For pathname parsing
(DEFVAR *ZMAIL-COMTAB*)				;Main keyboard comtab
(DEFVAR *ZMAIL-CONTROL-X-COMTAB*)		1;Top-level 0c-X1 comtab.
0(DEFVAR *MSG-COMTAB*)				;COMTAB in the message window
(DEFVAR *MSG-CONTROL-X-COMTAB*)			;C-X comtab in message window
(DEFVAR *REPLY-COMTAB*)				;COMTAB in the sending window
(DEFVAR *REPLY-CONTROL-X-COMTAB*)		;ditto
(DEFVAR *ZMAIL-COMMAND-BUTTON*)			;Extended commands
(DEFVAR *MY-ADDRESS*)				;String of network address
(DEFVAR *REFERENCE-MODIFICATION-TICK* *TICK*)	;When references might have been changed
(DEFVAR *BUFFER-EXPUNGE-TICK* *TICK*)		;When a buffer may have been changed
;(DEFINE-ZMAIL-GLOBAL *KEYWORD-ALIST* NIL)	;Currently defined keywords
(DEFVAR *KEYWORD-ALIST* NIL)	;(clearing on logout loses when buffer doesn't go away).
(DEFINE-ZMAIL-GLOBAL *USER-FILTER-ALIST* NIL)	;Currently defined user filters
(DEFINE-ZMAIL-GLOBAL *OTHER-OTHER-MAIL-FILE-NAMES* NIL)
(DEFINE-ZMAIL-GLOBAL *BACKGROUND-ERRORS-INVOKE-DEBUGGER* NIL)

(DEFVAR *SUMMARY-WINDOW-LABEL* (MAKE-SUMMARY-LINE))
(DEFVAR *TEMPLATES* NIL
  :DOCUMENTATION "A list of all defined templates."
  :LOCALIZE T)
(DEFVAR *MAIL-BUFFER-FLAVOR-ALIST* NIL)
(DEFVAR *SPACES* (MAKE-ARRAY 120. :TYPE 'ART-STRING :INITIAL-VALUE #\SPACE))

(DEFINE-ZMAIL-GLOBAL *UNIVERSE-LIST* NIL)	;User defined mapping for universe
(DEFVAR *REFERENCE-DEFAULT-UNIVERSE* NIL)
(DEFINE-ZMAIL-INIT *LOADED-FILES-INDIRECT-UNIVERSE* '(MAKE-INSTANCE 'LOADED-UNIVERSE))
(DEFINE-ZMAIL-INIT *CURRENT-INDIRECT-UNIVERSE* '(MAKE-INSTANCE 'CURRENT-UNIVERSE))
(DEFINE-ZMAIL-INIT *REFERENCED-BUFFERS-INDIRECT-UNIVERSE*
		   `(MAKE-INSTANCE 'REFERENCED-BUFFERS-OF-CURRENT-SEQUENCE-UNIVERSE))
(DEFINE-ZMAIL-INIT *DEFAULT-INDIRECT-UNIVERSE* '(MAKE-INSTANCE 'DEFAULT-BUFFER-UNIVERSE))
(DEFINE-ZMAIL-INIT *ALL-INDIRECT-UNIVERSE* '(MAKE-INSTANCE 'ALL-MAIL-FILE-UNIVERSE))

(DEFVAR *MSGS-BEING-REPLIED-TO-INTERVAL*)
(DEFVAR *PREVIOUS-WINDOW-CONFIGURATION* NIL)
(DEFVAR *EXPLICIT-OPTION-UPDATE* NIL)
(DEFVAR *RESET-OPTIONS-FROM-PROFILE-EDITOR* NIL)

;;; Maybe make this a user options.  Allows L and O commands to not propmt with minibuffer
;;; but act like click middle instead.
(DEFINE-ZMAIL-GLOBAL *KBD-SAME-AS-MIDDLE* NIL)

;;; Two lists -- First is the list of sort predicates for the sort command;
;;;		 Second is the list of sorting directions for the sort command
(DEFVAR *MSG-SORT-KEY-ALIST*
  `((("Position" :VALUE MSG-POSITION-LESSP
      :DOCUMENTATION "Numerically by position in associated disk mail file."))
    (("Forward" :VALUE :FORWARD
		:DOCUMENTATION "Perform sort forwards (least first).")
     ("Backward" :VALUE :BACKWARD
		 :DOCUMENTATION "Perform sort backwards (greatest first)."))))

;;; List of sort predicates defined for mail buffers (files)
(DEFVAR *MAIL-BUFFER-SORT-ALIST* '(("None" :VALUE NIL)))

;;; List of all normal sort predicates -- Used to complete definition of above two variables
(DEFVAR *SORT-KEY-ALIST-1* NIL)

(DEFINE-ZMAIL-GLOBAL *ZMAIL-FIND-DEFAULT* NIL)
(DEFVAR *ZMAIL-FIND-STRING-SEARCH-DEFAULT*)
(DEFVAR *ZMAIL-FIND-SEARCH-DEFAULT*)

(DEFVAR *CURRENT-UNDO* NIL)

(DEFINE-ZMAIL-GLOBAL *UNDO-HISTORY* NIL)
(DEFINE-ZMAIL-GLOBAL *REDO-HISTORY* NIL)

(DEFMACRO WITH-MULTIPLE-UNDO ((FLAVOR . INIT-OPTIONS) &BODY BODY)
  `(LET ((*CURRENT-UNDO* (MAKE-INSTANCE ',FLAVOR . ,INIT-OPTIONS)))
     (ZMAIL-UNDO-SAVE *CURRENT-UNDO*)
     . ,BODY))

(DEFINE-ZMAIL-INIT *ADDRESS-HISTORY* '(MAKE-INSTANCE 'HISTORY ':NAME "Address"))

;;; This next is (SPECIAL ...) in ZWEI;DEFS
(DEFINE-ZMAIL-GLOBAL *DUMMY-DRAFT-LIST* NIL)

;;; If this is NIL, a namespace server will not be contacted to lookup a host name.
;;; Now defaulted to NIL; since replying binds it to T (the only case where it
;;;  has to be on), only those who specifically want this should have it foisted upon 
;;;  them.  --dodds 10/2/84
(DEFINE-ZMAIL-GLOBAL *ALLOW-NAMESPACE-SERVER-PARSING-HOST* NIL)

(DEFMACRO PARSING-HOST-OBJECT (&BODY BODY)
  `(LET-IF (NOT *ALLOW-NAMESPACE-SERVER-PARSING-HOST*)
	   ((NETI:*INHIBIT-VALIDITY-CHECKING* T))
     . ,BODY))

;;; Perform BODY, or return LOSING-HEADERS and any error.
(DEFMACRO PARSING-HEADERS (ERROR-TYPES &BODY BODY)
  `(CONDITION-CASE (.ERROR.)
       (PROGN . ,BODY)
     (,ERROR-TYPES `(LOSING-HEADERS (, .ERROR.)))))

;;; Batch together host parsing
(DEFMACRO PARSING-HOSTS (&BODY BODY)
  `(LET ((NETI:*INHIBIT-OBSOLETE-INFORMATION-WARNING* T))
     (NET:KEEPING-NAMESPACE-SERVER
       . ,BODY)))

(DEFINE-ZMAIL-GLOBAL *ZMAIL-JUNK-MINI-BUFFER-HISTORY*
		     (MAKE-INSTANCE 'MINI-BUFFER-HISTORY ':NAME "Zmail Dross"))

;;; User options
(DEFINE-USER-OPTION-ALIST *ZMAIL-USER-OPTION-ALIST* DEFINE-ZMAIL-USER-OPTION)

;;; These are user options, in that they are automatically written into the file,
;;; but they are modified by special means
(DEFINE-ZMAIL-USER-OPTION *OTHER-MAIL-FILE-NAMES* NIL :PATHNAME-LIST)
(TV:RESTRICT-USER-OPTION *OTHER-MAIL-FILE-NAMES* :NEVER)
(DEFINE-ZMAIL-USER-OPTION *FILTER-KEYWORDS-ALIST* NIL :SEXP)
(TV:RESTRICT-USER-OPTION *FILTER-KEYWORDS-ALIST* :NEVER)
(DEFINE-ZMAIL-USER-OPTION *FILTER-MOVE-MAIL-FILE-ALIST* NIL :SEXP)
(TV:RESTRICT-USER-OPTION *FILTER-MOVE-MAIL-FILE-ALIST* :NEVER)
(DEFINE-ZMAIL-USER-OPTION *FILTER-REFERENCE-UNIVERSE-ALIST* NIL :SEXP)
(TV:RESTRICT-USER-OPTION *FILTER-REFERENCE-UNIVERSE-ALIST* :NEVER)

;;; Real user options
(DEFINE-ZMAIL-USER-OPTION *DELETE-EXPIRED-MSGS* ':PER-FILE :MENU-ALIST
			  "Automatically delete expired messages"
			  `(,@*YES-NO-ASK-ALIST*
			    ("Per file" . :PER-FILE)))
(DEFINE-ZMAIL-USER-OPTION *SHOW-REMINDERS-IN-YEAR-MODE* NIL :BOOLEAN
			  "Dates with reminders are highlighted in full year calendars")
(DEFINE-ZMAIL-USER-OPTION *CALENDAR-MODE-WEEK-STARTS-ON-MONDAY* T :BOOLEAN
			  "The week starts on Monday rather than Sunday in calendar mode")
(DEFINE-ZMAIL-USER-OPTION *CONFIGURE-MIDDLE-MODE* ':BOTH :MENU-ALIST
			  "Middle button on Configure" *COM-CONFIGURE-CONFIGURATION-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *PRESERVE-MSG-REFERENCES-ACROSS-EXPUNGE* NIL :BOOLEAN
			  "Add header fields to other msgs when expunging msg")
(DEFINE-ZMAIL-USER-OPTION *QUERY-BEFORE-SELECTING-EMPTY-SEQUENCE* NIL :BOOLEAN
			  "Confirmation is required to select an empty sequence")
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-MAIL-BUFFER-GENERATION-RETENTION-COUNT* NIL :NUMBER-OR-NIL
			  "Generation retention count set on newly created mail files")
(DEFINE-ZMAIL-USER-OPTION *DELETE-AFTER-MOVE-TO-BUFFER* T :BOOLEAN
			  "Delete message when moved into buffer")
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-MOVE-MAIL-FILE-NAME* NIL :PATHNAME-OR-NIL
			  "Default file for moving to a new file")
(DEFINE-ZMAIL-USER-OPTION *TEXT-MAIL-FILE-SEPARATOR* "" :STRING
			  "Line between messages in text mail file")
(DEFINE-ZMAIL-USER-OPTION *FILTER-ALIST-SORT-PREDICATE* '(FUNCTION STRING-LESSP)
  :MENU-ALIST "Ordering of user-defined filters in the filter selection and creation menus"
  '(("Alphabetically" :VALUE (FUNCTION STRING-LESSP))
    ("Chronologically" :VALUE NIL
		       :DOCUMENTATION "Filters appear in the order in which they were defined."
		       )))
(DEFINE-ZMAIL-USER-OPTION *KEYWORD-ALIST-SORT-PREDICATE* '(FUNCTION STRING-LESSP) :MENU-ALIST
			  "Predicate for sorting keywords in keyword menu"
			  *KEYWORD-ALIST-SORT-PREDICATE-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *SUMMARY-MOUSE-MIDDLE-MODE* ':DELETE-OR-UNDELETE :MENU-ALIST
			  "Middle button on summary window"
			  *SUMMARY-MOUSE-MIDDLE-MENU-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *MAP-MIDDLE-MODE* NIL :ASSOC
			  "Middle button on Map command"
			  `(,@*ZMAIL-MAP-COMMAND-ALIST*
			    ("Undefined" . NIL)))
(DEFINE-ZMAIL-USER-OPTION *PREVIOUS-MIDDLE-MODE* ':FIRST-UNDELETED :MENU-ALIST
			  "Middle button on Previous command"
			  *MOVE-TO-PREVIOUS-MENU-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *NEXT-MIDDLE-MODE* ':LAST-UNDELETED :MENU-ALIST
			  "Middle button on Next command"
			  *MOVE-TO-NEXT-MENU-ALIST*)
(DEFINE-ZMAIL-USER-OPTION  *NEXT-AFTER-DELETE* ':FORWARD :MENU-ALIST
			   "Direction to move after delete"
			   *DELETE-DIRECTION-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *DELETE-MIDDLE-MODE* ':BACKWARD :MENU-ALIST
			  "Direction to move for click middle on delete"
			  *DELETE-DIRECTION-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *INDENT-FORWARDED-MSGS* NIL :BOOLEAN
			  "Indent text of forwarded messages")
(DEFINE-ZMAIL-USER-OPTION *REFORMAT-FORWARDED-MSGS* T :MENU-ALIST
			  "Reformat headers of forwarded messages"
			  *REFORMAT-HEADERS-P-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *FORWARDED-ADD-SUBJECT* T :BOOLEAN
			  "Forwarded messages are supplied with a subject")
(DEFINE-ZMAIL-USER-OPTION *FORWARDED-MESSAGE-END* "" :STRING
			  "Format line after forwarded messages")
(DEFINE-ZMAIL-USER-OPTION *FORWARDED-MESSAGE-SEPARATOR* "" :STRING
			  "Format line between forwarded messages")
(DEFINE-ZMAIL-USER-OPTION *FORWARDED-MESSAGE-BEGIN* "" :STRING
			  "Format line before forwarded messages")
(DEFINE-ZMAIL-USER-OPTION *PRUNE-HEADERS-AFTER-YANKING* T :BOOLEAN
			  "Prune headers of yanked messages")
(DEFINE-ZMAIL-USER-OPTION *ONE-WINDOW-AFTER-YANK* T :BOOLEAN
			  "Just show headers and text after yanking in message")

;;; The *DONT-REPLY-TO* user option
;;;
;;;      This option is actually rather unusual in that its default value is specified by
;;;      the site.  However, DEFINE-SITE-USER-OPTION is not the proper technology for this
;;;	 option as, when you edit the option, only the differences between your setting and
;;;	 the site's default should be stored in your INIT file.  (I.e., all that should be
;;;	 recorded is which additional addresses you don't want to reply to and which of the
;;;	 site's list you do want to reply to.)  However, the present option defining
;;;	 system doesn't allow us to store only the differences, so we actually store the
;;;	 merged value in *DONT-REPLY-TO* and compute the differences explicitly in the
;;;	 *ADD-TO-SITE-DONT-REPLY-TO-LIST* and *DELETE-FROM-SITE-DONT-REPLY-TO-LIST* options
;;;	 which are also stored in the INIT.
;;;
;;;      In the future, we should change the profile editor to show the current site
;;;      setting for *DONT-REPLY-TO* and allow the user to edit the list of additions and
;;;      deletions separately.  Any general profile mechanism would also have to support
;;;      this "user modifiable list, site default" type of option.
;;;
;;;      To further complicate matters, if the site setting is changed, we may asynchronously
;;;      run the SITE initialization list which will attempt to recompute the setting of
;;;      *DONT-REPLY-TO*.  Therefore, we have to surround the updating code with a lock.

(DEFINE-ZMAIL-USER-OPTION *DONT-REPLY-TO* NIL :STRING-LIST "People not to reply to")
(DEFINE-ZMAIL-USER-OPTION *ADD-TO-SITE-DONT-REPLY-TO-LIST* NIL :STRING-LIST)
(DEFINE-ZMAIL-USER-OPTION *DELETE-FROM-SITE-DONT-REPLY-TO-LIST* NIL :STRING-LIST)

(TV:RESTRICT-USER-OPTION *ADD-TO-SITE-DONT-REPLY-TO-LIST* :NEVER)
(TV:RESTRICT-USER-OPTION *DELETE-FROM-SITE-DONT-REPLY-TO-LIST* :NEVER)

(DEFVAR *DONT-REPLY-TO-UPDATE-LOCK* NIL)

(DEFUN RESET-DONT-REPLY-TO-DEFAULT ()
  (TV:RESET-USER-OPTION '*DONT-REPLY-TO* (SI:GET-SITE-OPTION ':DONT-REPLY-TO-MAILING-LISTS))
  (COMPUTE-DONT-REPLY-TO-OPTION))

(DEFUN COMPUTE-DONT-REPLY-TO-OPTION ()
  (SI:WITH-LOCK-HELD (*DONT-REPLY-TO-UPDATE-LOCK* :WHOSTATE "Compute Dont-Reply-To")
    (WHEN (OR *ADD-TO-SITE-DONT-REPLY-TO-LIST* *DELETE-FROM-SITE-DONT-REPLY-TO-LIST*)
      (SETQ *DONT-REPLY-TO* (DEL-IF #'(LAMBDA (SITE-STRING)
					(MEMBER SITE-STRING *DELETE-FROM-SITE-DONT-REPLY-TO-LIST*))
				    (COPYLIST (GET '*DONT-REPLY-TO* 'TV:DEFAULT-VALUE)))
	    *DONT-REPLY-TO* (NCONC *DONT-REPLY-TO*
				   (LOOP FOR USER-STRING IN *ADD-TO-SITE-DONT-REPLY-TO-LIST*
					 UNLESS (MEMBER USER-STRING *DONT-REPLY-TO*)
					   COLLECT USER-STRING))))))

(DEFUN COMPUTE-DONT-REPLY-TO-DIFFERENCES ()
  (SI:WITH-LOCK-HELD (*DONT-REPLY-TO-UPDATE-LOCK* :WHOSTATE "Compute Dont-Reply-To")
    (LET ((SITE-DONT-REPLY-TO (GET '*DONT-REPLY-TO* 'TV:DEFAULT-VALUE)))
      (SETQ *ADD-TO-SITE-DONT-REPLY-TO-LIST* (LOOP FOR STRING IN *DONT-REPLY-TO*
						   UNLESS (MEMBER STRING SITE-DONT-REPLY-TO)
						     COLLECT STRING)
	    *DELETE-FROM-SITE-DONT-REPLY-TO-LIST* (LOOP FOR STRING IN SITE-DONT-REPLY-TO
							UNLESS (MEMBER STRING *DONT-REPLY-TO*)
							  COLLECT STRING)))))

(ADD-INITIALIZATION "SITE:*DONT-REPLY-TO*" '(RESET-DONT-REPLY-TO-DEFAULT) '(:SITE))

(DEFINE-ZMAIL-USER-OPTION *GENERATE-IN-REPLY-TO-FIELD* T :BOOLEAN
			  "Automatically generate In-reply-to fields")
(DEFINE-ZMAIL-USER-OPTION *REPLY-HEADER-FORMAT* ':SHORT :MENU-ALIST
			  "Format of headers inserted for reply"
			  *HEADER-FORMAT-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *MIDDLE-REPLY-WINDOW-MODE* ':TWO-WINDOWS :MENU-ALIST
			  "Default reply window setup for middle button"
			  (CADR *REPLY-MODES-ALIST*)) 
(DEFINE-ZMAIL-USER-OPTION *REPLY-WINDOW-MODE* ':TWO-WINDOWS :MENU-ALIST
			  "Default reply window setup"
			  (CADR *REPLY-MODES-ALIST*))
(DEFINE-ZMAIL-USER-OPTION *MIDDLE-REPLY-MODE* ':SENDER :MENU-ALIST
			  "Default reply to for middle button"
		          (CAR *REPLY-MODES-ALIST*))
(DEFINE-ZMAIL-USER-OPTION *1R-REPLY-MODE* ':SENDER :MENU-ALIST
			  "Default reply with argument of 1 to"
			  (CAR *REPLY-MODES-ALIST*))
(DEFINE-ZMAIL-USER-OPTION *REPLY-MODE* ':ALL :MENU-ALIST
			  "Default reply to"
		          (CAR *REPLY-MODES-ALIST*))
(DEFINE-ZMAIL-USER-OPTION *MAIL-FILE-FOR-DRAFTS* NIL :PATHNAME-OR-NIL
			  "Mail file to store drafts in")
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-DRAFT-FILE-NAME* NIL :PATHNAME-OR-NIL
			   "Default file for saving draft")
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-MAIL-BUFFER-MAJOR-MODE* :TEXT :MENU-ALIST
			  "Default major mode when composing messages"
			  *MAIL-BUFFER-MAJOR-MODES-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *ADD-SUPERSEDES-AND-COMMENTS-WHEN-RETRANSMITTING* :ASK
  :MENU-ALIST "Add Supersedes and Comments fields when retransmitting a message"
  '(("No" :VALUE :NEVER
	  :DOCUMENTATION "Never add Supersedes or Comments fields.")
    ("Ask" :VALUE :ASK
	   :DOCUMENTATION "Ask for permission to add each field separately.")
    ("Supersedes only" :VALUE :SUPERSEDES-ONLY
		       :DOCUMENTATION
		         "Always add a Supersedes field but never add a Comments field.")
    ("Supersedes then ask" :VALUE :SUPERSEDES-THEN-ASK
			   :DOCUMENTATION
			 "Always add a Supersedes field and then ask to ask a Comments field.")
    ("Yes" :VALUE :ALWAYS :DOCUMENTATION "Always add Supersedes and Comments fields.")))
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-BFCC-LIST* NIL :PATHNAME-LIST
			  "Default initial BFcc list")
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-FCC-LIST* NIL :PATHNAME-LIST
			  "Default initial Fcc list")
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-BCC-LIST* NIL :ADDRESS-LIST
			   "Default initial Bcc list")
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-CC-LIST* NIL :ADDRESS-LIST
			  "Default initial Cc list")
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-REPLY-TO-LIST* NIL :ADDRESS-LIST
			  "Default initial Reply-To list")
(DEFINE-ZMAIL-USER-OPTION *LOCAL-MAIL-INCLUDE-SUBJECT* T :BOOLEAN
			  "Local mail starts out with a subject")
(DEFINE-ZMAIL-USER-OPTION *LOCAL-MAIL-HEADER-FORCE* ':ITS :MENU-ALIST
			  "Header force for local messages" *HEADER-FORCE-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *SEND-HEADER-FORMAT* ':INCLUDE-PERSONAL :MENU-ALIST
			  "Format of headers sent" *HEADER-FORMAT-ALIST*)
;;; Note: this next is (SPECIAL ...) in zwei;defs. 
(DEFINE-ZMAIL-USER-OPTION *REQUIRE-SUBJECTS* T :MENU-ALIST
			  "Require subjects on outgoing messages"
			  *REQUIRE-SUBJECTS-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *PROMPT-FOR-MISSING-HEADERS* T :BOOLEAN
			  "Use the mini-buffer to read missing headers")
(DEFINE-ZMAIL-USER-OPTION *HEADER-WINDOW-NLINES* 3 :NUMBER
			  "Number of lines (or fraction) occupied by headers in mail mode")
(DEFINE-ZMAIL-USER-OPTION *DRAFT-EDITOR-END-KEY-TREATMENT* :ADD-MORE-TEXT
  :MENU-ALIST "Effect of  key in 1Headers0 window" *DRAFT-EDITOR-END-KEY-TREATMENT-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-MAIL-WINDOW-CONFIGURATION* ':SEND :MENU-ALIST
			  "Default window configuration when mailing"
			  *MAIL-WINDOW-CONFIGURATION-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *MAIL-MIDDLE-MODE* ':BUG :MENU-ALIST
			  "Middle button on Mail command"
			  *ZMAIL-MAIL-MENU-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *INHIBIT-BACKGROUND-SAVES* NIL :INVERTED-BOOLEAN
			  "Automatically save buffer after reading inbox")
(DEFINE-ZMAIL-USER-OPTION *QUERY-BEFORE-EXPUNGE* NIL :BOOLEAN
			  "Show headers and ask before expunging deleted messages")
(DEFINE-ZMAIL-USER-OPTION *GMSGS-OTHER-SWITCHES* "//Z" :STRING
			  "Other switches to supply to GMSGS server")
;(TV:RESTRICT-USER-OPTION *GMSGS-OTHER-SWITCHES* :IF :GMSGS)

(DEFINE-ZMAIL-USER-OPTION *RUN-GMSGS-P* ':NO :ASSOC
			  "Run GMSGS before getting new mail"
			  '(("Yes" . :YES) ("No" . :NO) ("Once only" . :ONCE-ONLY)))
;(TV:RESTRICT-USER-OPTION *RUN-GMSGS-P* :IF :GMSGS)

(DEFINE-ZMAIL-USER-OPTION *REFORMAT-HEADERS-P* T :MENU-ALIST
			  "Reformat headers in non-BABYL files"
			  *REFORMAT-HEADERS-P-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *BABYL-REFORMATTING-CONTROLLED-BY-FILE* NIL :BOOLEAN
			  "Reformatting of babyl files is enabled by normal babyl options")
(DEFINE-ZMAIL-USER-OPTION *ALWAYS-SELECT-SAVED-CURRENT-MSG* NIL :BOOLEAN
		      "Reselect previous current message even if current message in sequence")
(DEFINE-ZMAIL-USER-OPTION *ALWAYS-JUMP-AFTER-GET-NEW-MAIL-FROM-INBOX* NIL :BOOLEAN
			  "Move to first message even when no new mail in inbox")
(DEFINE-ZMAIL-USER-OPTION *INHIBIT-BACKGROUND-MAIL-CHECKS* NIL :INVERTED-BOOLEAN
			  "Periodically check for new mail in the background")
(DEFINE-ZMAIL-USER-OPTION *AUTOSAVE-IF-INBOX-REQUIRES-SAVE* :ASK :MENU-ALIST
  "Automatically save the mail file if needed to read new mail"
  *YES-NO-ASK-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *COMPLETE-GET-INBOX-IN-BACKGROUND* T :BOOLEAN
  "Read in inbox in the background")
(DEFINE-ZMAIL-USER-OPTION *NEW-MAIL-FILE-APPEND-P* ':STICKY :MENU-ALIST
			  "Appending of inboxes to new mail files"
			  '(("Append" :VALUE :APPEND
			     :DOCUMENTATION "New mail files append messages.")
			    ("Prepend" :VALUE :PREPEND
			     :DOCUMENTATION "New mail files prepend messages.")
			    ("Sticky" :VALUE :STICKY :DOCUMENTATION
  "New mail files inherit whether they append messages from the current buffer.")
			    ("Ask" :VALUE :ASK :DOCUMENTATION
  "User is always queried when creating a new mail file as to whether it appends messages.")))

(DEFINE-ZMAIL-USER-OPTION *ZMAIL-STARTUP-FILE-NAME* NIL :PATHNAME-OR-NIL
			  "Default file for initial Get Inbox or Select")
(DEFINE-ZMAIL-USER-OPTION *FILTER-SUMMARY-WINDOW-FRACTION* NIL :NUMBER-OR-NIL
			  "Fraction of the frame occupied by the summary in filter mode")
(DEFINE-ZMAIL-USER-OPTION *SUMMARY-SCROLL-FRACTION* 0.2s0 :NUMBER
			  "Amount by which to glitch summary window")
(DEFINE-ZMAIL-USER-OPTION *SUMMARY-SUBJECT-TRIM-SPACES* T :BOOLEAN
			  "Spaces are trimmed from the left of the subject in summary")
(DEFINE-ZMAIL-USER-OPTION *SUMMARY-WINDOW-FRACTION* 0.45s0 :NUMBER
			  "Fraction of the frame occupied by the summary")
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-SUMMARY-TEMPLATE* T :MENU-ALIST
			  "Default summary window format" *SUMMARY-WINDOW-FORMAT-ALIST*)
;;; Old name which may be in some init files
(ADD-INITIALIZATION "*SUMMARY-INCLUDE-DATE*" 
		    '(FORWARD-VALUE-CELL '*SUMMARY-INCLUDE-DATE* '*DEFAULT-SUMMARY-TEMPLATE*)
		    '(:ONCE))
(DEFINE-ZMAIL-USER-OPTION *DEFAULT-INITIAL-WINDOW-CONFIGURATION* ':BOTH :MENU-ALIST
			  "Default startup window setup"
			  *MAIN-WINDOW-CONFIGURATION-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *TOO-MANY-MSGS-QUERY-THRESHOLD* 20. :INTEGER
  "    Maximum number of messages which may be mapped over without asking permission")
(DEFINE-ZMAIL-USER-OPTION *SELECTED-DANGEROUS-ZMAIL-COMMANDS* NIL :CHOOSE-MULTIPLE
  "  Commands which will ask permission"
  *DANGEROUS-ZMAIL-COMMANDS-ALIST*)
(DEFINE-ZMAIL-USER-OPTION *ASK-BEFORE-EXECUTING-DANGEROUS-ZMAIL-COMMANDS* :ALL :MENU-ALIST
  "Ask permission before executing time consuming and//or destructive commands"
  '(("All" :VALUE :ALL :DOCUMENTATION "Ask permission for all of these commands.")
    ("Selective" :VALUE :SELECTIVE
		 :DOCUMENTATION "Ask permission only for the indicated commands.")
    ("None" :VALUE :NONE :DOCUMENTATION "Ask permission for none of these commands.")))

;;; Hardcopy definitions and options --
;;; 2   If you add a new hardcopy option, be sure to update the0 2HARDCOPY-OPTIONS flavor,
0;;; 2   USING-HARDCOPY-OPTIONS macro, the methods defined in0 2SYS:ZMAIL;MFILES, and
0;;; 2   the *ZMAIL-PROFILE-HARDCOPY-OPTIONS* and *ZMAIL-SEQUENCE-HARDCOPY-OPTIONS* constants.

0(DEFINE-USER-OPTION-ALIST *ZMAIL-HARDCOPY-OPTION-ALIST* DEFINE-ZMAIL-HARDCOPY-OPTION)

(DEFFLAVOR HARDCOPY-OPTIONS
	((DEVICE :DEFAULT)
	 PAGE-HEADER-P SUMMARY-P SEPARATE-PAGES SEPARATOR-LINE NUMBER-OF-COPIES ORIENTATION
	 REFORMAT-TEMPLATE)
	()
  (:CONC-NAME HARDCOPY-)
  (:READABLE-INSTANCE-VARIABLES PAGE-HEADER-P SUMMARY-P SEPARATE-PAGES SEPARATOR-LINE
				NUMBER-OF-COPIES ORIENTATION REFORMAT-TEMPLATE)
  (:WRITABLE-INSTANCE-VARIABLES PAGE-HEADER-P SUMMARY-P SEPARATE-PAGES SEPARATOR-LINE
				NUMBER-OF-COPIES ORIENTATION REFORMAT-TEMPLATE)
  :INITABLE-INSTANCE-VARIABLES)

(DEFMACRO USING-HARDCOPY-OPTIONS ((HARDCOPY-OPTIONS &KEY UPDATE-OPTIONS) &BODY BODY)
  `(LET ((*HARDCOPY-DEVICE* (HARDCOPY-DEVICE ,HARDCOPY-OPTIONS))
	 (*HARDCOPY-PAGE-HEADER-P* (HARDCOPY-PAGE-HEADER-P ,HARDCOPY-OPTIONS))
	 (*HARDCOPY-SUMMARY-P* (HARDCOPY-SUMMARY-P ,HARDCOPY-OPTIONS))
	 (*HARDCOPY-SEPARATE-PAGES* (HARDCOPY-SEPARATE-PAGES ,HARDCOPY-OPTIONS))
	 (*HARDCOPY-SEPARATOR-LINE* (HARDCOPY-SEPARATOR-LINE ,HARDCOPY-OPTIONS))
	 (*HARDCOPY-NUMBER-OF-COPIES* (HARDCOPY-NUMBER-OF-COPIES ,HARDCOPY-OPTIONS))
	 (*HARDCOPY-ORIENTATION* (HARDCOPY-ORIENTATION ,HARDCOPY-OPTIONS))
	 (*HARDCOPY-REFORMAT-TEMPLATE* (HARDCOPY-REFORMAT-TEMPLATE ,HARDCOPY-OPTIONS)))
     ,@BODY
     ,@(WHEN UPDATE-OPTIONS
	 `((SETF (HARDCOPY-DEVICE ,HARDCOPY-OPTIONS) *HARDCOPY-DEVICE*)
	   (SETF (HARDCOPY-PAGE-HEADER-P ,HARDCOPY-OPTIONS) *HARDCOPY-PAGE-HEADER-P*)
	   (SETF (HARDCOPY-SUMMARY-P ,HARDCOPY-OPTIONS) *HARDCOPY-SUMMARY-P*)
	   (SETF (HARDCOPY-SEPARATE-PAGES ,HARDCOPY-OPTIONS) *HARDCOPY-SEPARATE-PAGES*)
	   (SETF (HARDCOPY-SEPARATOR-LINE ,HARDCOPY-OPTIONS) *HARDCOPY-SEPARATOR-LINE*)
	   (SETF (HARDCOPY-NUMBER-OF-COPIES ,HARDCOPY-OPTIONS) *HARDCOPY-NUMBER-OF-COPIES*)
	   (SETF (HARDCOPY-ORIENTATION ,HARDCOPY-OPTIONS) *HARDCOPY-ORIENTATION*)
	   (SETF (HARDCOPY-REFORMAT-TEMPLATE ,HARDCOPY-OPTIONS) *HARDCOPY-REFORMAT-TEMPLATE*))
	 )))

(DEFVAR *DEFAULT-HARDCOPY-OPTIONS* (MAKE-INSTANCE 'HARDCOPY-OPTIONS))
(DEFVAR *LAST-HARDCOPY-OPTIONS* (MAKE-INSTANCE 'HARDCOPY-OPTIONS))

(DEFGENERIC HARDCOPY-DEVICE (HARDCOPY-OPTIONS))
(DEFGENERIC (CL:SETF HARDCOPY-DEVICE) (HARDCOPY-OPTIONS NEW-DEVICE))
(DEFGENERIC COMPLETE-HARDCOPY-OPTIONS (HARDCOPY-OPTIONS &OPTIONAL FORCE-P))
(DEFGENERIC HARDCOPY-OPTIONS-WHO-LINE-STRING (HARDCOPY-OPTIONS DEFAULT-HARDCOPY-OPTIONS
							       STRING SEQUENCE-P))
(DEFGENERIC HARDCOPY-DESCRIBE-OPTIONS (HARDCOPY-OPTIONS DEFAULT-HARDCOPY-OPTIONS SEQUENCE-P))

(DEFVAR *INCLUDE-SUMMARY-ALIST*
	'(("Yes" :VALUE T :DOCUMENTATION "Print summary and messages.")
	  ("No" :VALUE NIL :DOCUMENTATION "Do not print a summary.")
	  ("Just summary" :VALUE :JUST-SUMMARY
	   :DOCUMENTATION "Print summary but not messages themselves.")))

(DEFVAR *HARDCOPY-ORIENTATION-ALIST*
	'(("Portrait" :VALUE :PORTRAIT
		      :DOCUMENTATION "8.5/" wide by 11/" high (or similar proportions)")
	  ("Landscape" :VALUE :LANDSCAPE
		       :DOCUMENTATION "11/" wide by 8.5/" high (or similar proportions")))

(DEFINE-ZMAIL-GLOBAL *HARDCOPY-REFORMAT-TEMPLATE* 'DEFAULT-REFORMAT-TEMPLATE)
(DEFINE-ZMAIL-HARDCOPY-OPTION *HARDCOPY-SUMMARY-P* T :MENU-ALIST
			      "Include a summary of the messages" *INCLUDE-SUMMARY-ALIST*)
(DEFINE-ZMAIL-HARDCOPY-OPTION *HARDCOPY-SEPARATE-PAGES* NIL :BOOLEAN
			      "Print each message on a separate page")
(DEFINE-ZMAIL-HARDCOPY-OPTION *HARDCOPY-SEPARATOR-LINE* NIL :STRING-OR-NIL
			      "Line between messages (when not on separate pages)")
(DEFINE-ZMAIL-HARDCOPY-OPTION *HARDCOPY-ORIENTATION* :PORTRAIT :MENU-ALIST
			      "Page orientation." *HARDCOPY-ORIENTATION-ALIST*)
(DEFINE-ZMAIL-HARDCOPY-OPTION *HARDCOPY-NUMBER-OF-COPIES* 1 :NUMBER
			      "Number of copies")
(DEFINE-ZMAIL-HARDCOPY-OPTION *HARDCOPY-PAGE-HEADER-P* T :BOOLEAN
			      "Print a header on each page of output")
(DEFINE-ZMAIL-HARDCOPY-OPTION *HARDCOPY-DEVICE* NIL :ASSOC NIL "Output device")

(DEFCONST *ZMAIL-PROFILE-HARDCOPY-OPTIONS* '(*HARDCOPY-PAGE-HEADER-P*
					     *HARDCOPY-NUMBER-OF-COPIES*
					     *HARDCOPY-ORIENTATION*
					     *HARDCOPY-SEPARATOR-LINE*
					     *HARDCOPY-SEPARATE-PAGES*
					     *HARDCOPY-SUMMARY-P*))

(DEFCONST *ZMAIL-SEQUENCE-HARDCOPY-OPTIONS* '(*HARDCOPY-SUMMARY-P*
					      *HARDCOPY-SEPARATE-PAGES*
					      *HARDCOPY-SEPARATOR-LINE*))
