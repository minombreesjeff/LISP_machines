;;; -*- Mode: Lisp; Package: File-System; Base: 8 -*-
;;; Error conditions for file systems.
;;;>
;;;> *****************************************************************************************
;;;> ** (c) Copyright 1998-1982 Symbolics, Inc.  All rights reserved.
;;;> ** Portions of font library Copyright (c) 1984 Bitstream, Inc.  All Rights Reserved.
;;;>
;;;>    The software, data, and information contained herein are proprietary to,
;;;> and comprise valuable trade secrets of, Symbolics, Inc., which intends 
;;;> to keep such software, data, and information confidential and to preserve them
;;;> as trade secrets.  They are given in confidence by Symbolics pursuant 
;;;> to a written license agreement, and may be used, copied, transmitted, and stored
;;;> only in accordance with the terms of such license.
;;;> 
;;;> Symbolics, Symbolics 3600, Symbolics 3675, Symbolics 3630, Symbolics 3640,
;;;> Symbolics 3645, Symbolics 3650, Symbolics 3653, Symbolics 3620, Symbolics 3610,
;;;> Zetalisp, Open Genera, Virtual Lisp Machine, VLM, Wheels, Dynamic Windows,
;;;> SmartStore, Semanticue, Frame-Up, Firewall, Document Examiner,
;;;> Delivery Document Examiner, "Your Next Step in Computing", Ivory, MacIvory,
;;;> MacIvory model 1, MacIvory model 2, MacIvory model 3, XL400, XL1200, XL1201,
;;;> Symbolics UX400S, Symbolics UX1200S, NXP1000, Symbolics C, Symbolics Pascal,
;;;> Symbolics Prolog, Symbolics Fortran, CLOE, CLOE Application Generator,
;;;> CLOE Developer, CLOE Runtime, Common Lisp Developer, Symbolics Concordia,
;;;> Joshua, Statice, and Minima are trademarks of Symbolics, Inc.
;;;> 
;;;> Symbolics 3670, Symbolics Common Lisp, Symbolics-Lisp, and Genera are registered
;;;> trademarks of Symbolics, Inc.
;;;>
;;;> GOVERNMENT PURPOSE RIGHTS LEGEND
;;;> 
;;;>      Contract No.: various
;;;>      Contractor Name: Symbolics, Inc.
;;;>      Contractor Address: c/o Ropes & Gray
;;;> 			 One International Place
;;;> 			 Boston, Massachusetts 02110-2624
;;;>      Expiration Date: 2/27/2018
;;;>      
;;;> The Government's rights to use, modify, reproduce, release, perform, display or
;;;> disclose this software are restricted by paragraph (b)(2) of the "Rights in
;;;> Noncommercial Computer Software and Noncommercial Computer Software Documentation"
;;;> contained in the above identified contracts.  No restrictions apply after the
;;;> expiration date shown above.  Any reproduction of the software or portions thereof
;;;> marked with this legend must also reproduce the markings.  Questions regarding
;;;> the Government's rights may be referred to the AS&T Contracts Office of the
;;;> National Reconnaissance Office, Chantilly, Virginia 20151-1715.
;;;> 
;;;>      Symbolics, Inc.
;;;>      c/o Ropes & Gray
;;;>      One International Place
;;;>      Boston, Massachusetts 02110-2624
;;;>      781-937-7655
;;;>
;;;> *****************************************************************************************
;;;>

;;; This file is independent of what network is used to access the file systems.

(DEFGENERIC CONDITIONS:FILE-ERROR-PATHNAME (CONDITIONS:FILE-ERROR))

(DEFFLAVOR CONDITIONS:FILE-ERROR ((PATHNAME NIL)) (ERROR)
  :ABSTRACT-FLAVOR
  :INITABLE-INSTANCE-VARIABLES
  (:READABLE-INSTANCE-VARIABLES
    (CONDITIONS:FILE-ERROR-PATHNAME PATHNAME)))

(DEFFLAVOR FILE-ERROR
	((PATHNAME NIL))
	(CONDITIONS:FILE-ERROR)
  :ABSTRACT-FLAVOR
  :INITABLE-INSTANCE-VARIABLES
  :GETTABLE-INSTANCE-VARIABLES
  (:REQUIRED-METHODS :REPORT-WITHOUT-PATHNAME))

(DEFMETHOD (DBG:ERROR-CLASSIFICATION FS:FILE-ERROR) () "file")

(DEFMETHOD (:REPORT FILE-ERROR) (STREAM)
  (SEND SELF ':REPORT-WITHOUT-PATHNAME STREAM)
  (AND PATHNAME (FORMAT STREAM "~&For ~A" PATHNAME)))

(DEFMETHOD (:PROCEED FILE-ERROR :RETRY-FILE-ERROR) ()
  "Retry this file system operation."
  ':RETRY-FILE-ERROR)

(COMPILE-FLAVOR-METHODS FILE-ERROR)

(DEFFLAVOR FILE-REQUEST-FAILURE
	((OPERATION NIL))
	(FILE-ERROR)
  :ABSTRACT-FLAVOR
  :INITABLE-INSTANCE-VARIABLES
  :GETTABLE-INSTANCE-VARIABLES)

(DEFFLAVOR FILE-OPERATION-FAILURE
	((OPERATION NIL))
	(FILE-ERROR)
  :ABSTRACT-FLAVOR
  :INITABLE-INSTANCE-VARIABLES
  :GETTABLE-INSTANCE-VARIABLES)

;; Mixins required for flavors below.
(DEFFLAVOR DIRED-MIGHT-FIX-MIXIN () (DBG:SPECIAL-COMMANDS-MIXIN)
  (:REQUIRED-FLAVORS FILE-OPERATION-FAILURE))

(DEFMETHOD (:SPECIAL-COMMAND DIRED-MIGHT-FIX-MIXIN :RUN-DIRED) (&REST IGNORE)
  (DIRED (SEND PATHNAME ':NEW-PATHNAME ':NAME ':WILD ':TYPE ':WILD ':VERSION ':WILD))
  ;; Back to the debugger
  NIL)

(DEFMETHOD (:DOCUMENT-SPECIAL-COMMAND DIRED-MIGHT-FIX-MIXIN :RUN-DIRED) (STREAM)
  (FORMAT STREAM "Run DIRED on ~A" (SEND PATHNAME ':NEW-PATHNAME :NAME ':WILD
								 :TYPE ':WILD
								 :VERSION ':WILD)))

(DEFMETHOD (:SPECIAL-COMMAND DIRED-MIGHT-FIX-MIXIN :REAP-FILE) (&REST IGNORE)
  (ZWEI:REAP-FILE (SEND PATHNAME ':NEW-PATHNAME ':VERSION ':WILD))
  ;; Back to the debugger
  NIL)

(DEFMETHOD (:DOCUMENT-SPECIAL-COMMAND DIRED-MIGHT-FIX-MIXIN :REAP-FILE) (STREAM)
  (FORMAT STREAM "Offer to delete excess versions of ~A"
	  (SEND PATHNAME ':NEW-PATHNAME ':VERSION NIL)))

(DEFMETHOD (:SPECIAL-COMMAND DIRED-MIGHT-FIX-MIXIN :EXPUNGE) (&REST IGNORE)
  (FORMAT T "~&~D page~:P freed.~%" (EXPUNGE-DIRECTORY PATHNAME))
  ;; Back to the debugger
  NIL)

(DEFMETHOD (:DOCUMENT-SPECIAL-COMMAND DIRED-MIGHT-FIX-MIXIN :EXPUNGE) (STREAM)
  (FORMAT STREAM "Expunge the directory ~A:~A" (SEND (SEND PATHNAME ':HOST)
						     ':NAME-AS-FILE-COMPUTER)
	  (SEND PATHNAME ':STRING-FOR-DIRECTORY)))

(DEFFLAVOR DELETE-MIGHT-FIX-MIXIN () (DBG:SPECIAL-COMMANDS-MIXIN)
  (:REQUIRED-FLAVORS FILE-OPERATION-FAILURE))

(DEFMETHOD (:FILE-TO-DELETE DELETE-MIGHT-FIX-MIXIN) () PATHNAME)

(DEFMETHOD (:SPECIAL-COMMAND DELETE-MIGHT-FIX-MIXIN :DELETE-FILE) (&REST IGNORE)
  (LET ((FILE (SEND SELF ':FILE-TO-DELETE)))
    (DELETEF FILE)
    (FORMAT QUERY-IO "~&File deleted.")
    (WHEN (FQUERY NIL "Expunge ~A:~A ? " (SEND FILE :HOST) (SEND FILE :STRING-FOR-DIRECTORY))
      (EXPUNGE-DIRECTORY FILE)
      (FORMAT QUERY-IO "~&Directory expunged.")))
  NIL)

(DEFMETHOD (:DOCUMENT-SPECIAL-COMMAND DELETE-MIGHT-FIX-MIXIN :DELETE-FILE) (STREAM)
  (FORMAT STREAM "Delete ~A, and optionally expunge directory." (SEND SELF ':FILE-TO-DELETE)))

(DEFFLAVOR CREATE-DIRECTORY-MIGHT-FIX-MIXIN () (DBG:SPECIAL-COMMANDS-MIXIN)
  (:REQUIRED-FLAVORS FILE-OPERATION-FAILURE))

(DEFMETHOD (MAKE-INSTANCE CREATE-DIRECTORY-MIGHT-FIX-MIXIN :AFTER) (&REST IGNORE)
  (WHEN (EQ ':READ (SEND SELF ':SEND-IF-HANDLES ':MODE))
    ;; If we are opening a file for :READ, and the directory isn't found, don't
    ;; offer to create the directory.
    (SETQ DBG:SPECIAL-COMMANDS (REMQ ':CREATE-DIRECTORY DBG:SPECIAL-COMMANDS))
    (SETQ DBG:SPECIAL-COMMANDS (REMQ ':CREATE-DIRECTORIES-RECURSIVELY DBG:SPECIAL-COMMANDS)))
  (SETQ DBG:SPECIAL-COMMANDS
	(REMQ
	  (IF (TYPEP PATHNAME 'HIERARCHICAL-DIRECTORY-MIXIN)
	      ':CREATE-DIRECTORY
	      ':CREATE-DIRECTORIES-RECURSIVELY)
	  DBG:SPECIAL-COMMANDS)))

(DEFMETHOD (:SPECIAL-COMMAND CREATE-DIRECTORY-MIGHT-FIX-MIXIN :CREATE-DIRECTORY)
	   (&REST IGNORE)
  (CONDITION-CASE (ERROR)
      (SEND PATHNAME ':CREATE-DIRECTORY)
    (FILE-OPERATION-FAILURE
      (FORMAT T "~&Can't create ~A:  ~A" (SEND PATHNAME ':STRING-FOR-DIRECTORY) ERROR))
    (:NO-ERROR (FORMAT T "Directory ~A created." (SEND PATHNAME ':STRING-FOR-DIRECTORY)))))

(DEFMETHOD (:DOCUMENT-SPECIAL-COMMAND CREATE-DIRECTORY-MIGHT-FIX-MIXIN :CREATE-DIRECTORY)
	   (STREAM)
  (FORMAT STREAM "Create directory ~A" (SEND PATHNAME ':STRING-FOR-DIRECTORY)))

(DEFMETHOD (:SPECIAL-COMMAND CREATE-DIRECTORY-MIGHT-FIX-MIXIN :CREATE-DIRECTORIES-RECURSIVELY)
	   (&REST IGNORE)
  (CONDITION-CASE (ERROR)
      (CREATE-DIRECTORIES-RECURSIVELY PATHNAME)
    (FILE-OPERATION-FAILURE
      (FORMAT ERROR-OUTPUT "~&Can't create ~A:  ~A" (SEND PATHNAME ':STRING-FOR-DIRECTORY)
	      ERROR)))
  NIL)

(DEFMETHOD (:DOCUMENT-SPECIAL-COMMAND CREATE-DIRECTORY-MIGHT-FIX-MIXIN
				      :CREATE-DIRECTORIES-RECURSIVELY)
	   (STREAM)
  (FORMAT STREAM "Create directory ~A and all missing superiors"
	  (SEND PATHNAME ':STRING-FOR-DIRECTORY)))


;; System-wide request failures

(DEFFLAVOR FILE-SYSTEM-BUG () (FILE-REQUEST-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR DATA-ERROR () (FILE-REQUEST-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR HOST-NOT-AVAILABLE () (FILE-REQUEST-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR NO-FILE-SYSTEM () (FILE-REQUEST-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR NETWORK-LOSSAGE () (FILE-REQUEST-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR NOT-ENOUGH-RESOURCES () (FILE-REQUEST-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR UNKNOWN-OPERATION () (FILE-REQUEST-FAILURE)
  :INITABLE-INSTANCE-VARIABLES
  :GETTABLE-INSTANCE-VARIABLES)

(DEFMETHOD (:REPORT-WITHOUT-PATHNAME UNKNOWN-OPERATION :DEFAULT) (STREAM)
  (FORMAT STREAM "The :~A operation is not supported." OPERATION))

(DEFFLAVOR LOGIN-PROBLEMS () (FILE-REQUEST-FAILURE) :ABSTRACT-FLAVOR)

;; These are handled specially by QFILE by trying again with a new user-id and password,
;; first obtained from its database and if that fails obtained from the user.
;; Do not handle this flavor yourself--the condition you normally want to handle
;; is LOGIN-REQUIRED, which is signalled if the login problem cannot be handled
;; automatically and interaction is required.
(DEFFLAVOR CORRECTABLE-LOGIN-PROBLEMS () (LOGIN-PROBLEMS) :ABSTRACT-FLAVOR)

(DEFFLAVOR UNKNOWN-USER ((USER-NAME NIL)) (CORRECTABLE-LOGIN-PROBLEMS)
  :INITABLE-INSTANCE-VARIABLES
  :GETTABLE-INSTANCE-VARIABLES
  :ABSTRACT-FLAVOR)

;; No, the password is not an instance variable here.
(DEFFLAVOR INVALID-PASSWORD () (CORRECTABLE-LOGIN-PROBLEMS) :ABSTRACT-FLAVOR)

(DEFFLAVOR NOT-LOGGED-IN () (CORRECTABLE-LOGIN-PROBLEMS) :ABSTRACT-FLAVOR)

(DEFMETHOD (:REPORT FILE-SYSTEM-BUG :BEFORE) (STREAM)
  (WHEN PATHNAME
    (FORMAT STREAM "File system bug on host ~A:~%"
	    (SEND (SEND PATHNAME ':TRANSLATED-PATHNAME) ':HOST))))

;; Sort of similar, but NOT built on correctable-login-problems!!!
;; Don't want QFILE or anyone like him to trap these.

(DEFFLAVOR UNHANDLED-CAPABILITY ((CAPABILITY NIL))
	   (FILE-OPERATION-FAILURE)		;the SETTING op failed.
  (:INITABLE-INSTANCE-VARIABLES)
  :ABSTRACT-FLAVOR)

(DEFFLAVOR INVALID-CAPABILITY-PASSWORD ((CAPABILITY NIL))
	   (FILE-OPERATION-FAILURE)
  (:INITABLE-INSTANCE-VARIABLES)
  :ABSTRACT-FLAVOR)


;; System-wide operation failures

;; Each operation does not have a corresponding mumble-FAILURE flavor,
;; because different operations can signal the same error.

(DEFFLAVOR FILE-LOOKUP-ERROR () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR FILE-NOT-FOUND () (FILE-LOOKUP-ERROR) :ABSTRACT-FLAVOR)
(DEFFLAVOR DIRECTORY-NOT-FOUND
	   ((MODE NIL)
	    (DIRECTORY-PATHNAME NIL))		;dirpath of actual dir that wasn't found
						;-- some systems can hack this..
	   (CREATE-DIRECTORY-MIGHT-FIX-MIXIN FILE-LOOKUP-ERROR)
  :INITABLE-INSTANCE-VARIABLES
  (:GETTABLE-INSTANCE-VARIABLES MODE)
  :ABSTRACT-FLAVOR)

(DEFMETHOD (:DIRECTORY-PATHNAME DIRECTORY-NOT-FOUND) ()
  (OR DIRECTORY-PATHNAME PATHNAME))

(DEFFLAVOR DEVICE-NOT-FOUND () (FILE-LOOKUP-ERROR) :ABSTRACT-FLAVOR)
(DEFFLAVOR LINK-TARGET-NOT-FOUND () (FILE-LOOKUP-ERROR) :ABSTRACT-FLAVOR)



(DEFFLAVOR ACCESS-ERROR 
	()
	(FILE-OPERATION-FAILURE DBG:SPECIAL-COMMANDS-MIXIN)
  :ABSTRACT-FLAVOR)

(DEFMETHOD (MAKE-INSTANCE ACCESS-ERROR :AFTER) (&REST IGNORE)
  (LET ((F-A-P (PATHNAME-FILE-ACCESS-PATH PATHNAME OPERATION)))
    (UNLESS
      (file-access-path-add-capability-improves-access F-A-P)
      (SETQ DBG:SPECIAL-COMMANDS
	    (CL:DELETE 'ACCESS-ERROR-ADD-CAPABILITIES DBG:SPECIAL-COMMANDS)))
    (UNLESS
      (FILE-ACCESS-PATH-LOGIN-IMPROVES-ACCESS F-A-P)
      (SETQ DBG:SPECIAL-COMMANDS
	    (CL:DELETE 'ACCESS-ERROR-LOGIN DBG:SPECIAL-COMMANDS)))))

(DEFMETHOD (DBG:SPECIAL-COMMAND ACCESS-ERROR ACCESS-ERROR-ADD-CAPABILITIES) (&REST IGNORE)
  "Enable a capability"
  (LET ((CAPABILITIES
	  (SCL:ACCEPT '((SCL:SEQUENCE CAPABILITY))
		      :DEFAULT (SEND (SEND PATHNAME :HOST) :DEFAULT-ENABLE-CAPABILITIES))))
    (CL:APPLY #'ENABLE-CAPABILITIES (SEND PATHNAME :HOST) CAPABILITIES)
    NIL))

(DEFMETHOD (DBG:SPECIAL-COMMAND ACCESS-ERROR ACCESS-ERROR-LOGIN) (&REST IGNORE)
  "Login"
  (FILE-ACCESS-PATH-LOGIN
    (PATHNAME-FILE-ACCESS-PATH PATHNAME ':LOGIN)
    T
    :FORCE-PASSWORD (EQ (FILE-ACCESS-PATH-LOGIN-IMPROVES-ACCESS
			  (PATHNAME-FILE-ACCESS-PATH PATHNAME ':LOGIN))
			':PASSWORD)))
						
(DEFFLAVOR INCORRECT-ACCESS-TO-FILE () (ACCESS-ERROR) :ABSTRACT-FLAVOR)
(DEFFLAVOR INCORRECT-ACCESS-TO-DIRECTORY () (ACCESS-ERROR) :ABSTRACT-FLAVOR)

(DEFFLAVOR FILE-LOCKED () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR INVALID-PATHNAME-SYNTAX () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR INVALID-WILDCARD () (INVALID-PATHNAME-SYNTAX) :ABSTRACT-FLAVOR)
(DEFFLAVOR WILDCARD-NOT-ALLOWED () (INVALID-PATHNAME-SYNTAX) :ABSTRACT-FLAVOR);In this context

(DEFFLAVOR CIRCULAR-LINK () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)

;; An option given to an operation isn't implemented on this system.
(DEFFLAVOR UNIMPLEMENTED-OPTION () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR INCONSISTENT-OPTIONS () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR INVALID-BYTE-SIZE () (UNIMPLEMENTED-OPTION) :ABSTRACT-FLAVOR)

(DEFFLAVOR WRONG-KIND-OF-FILE () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR INVALID-OPERATION-FOR-LINK () (WRONG-KIND-OF-FILE) :ABSTRACT-FLAVOR)
(DEFFLAVOR INVALID-OPERATION-FOR-DIRECTORY () (WRONG-KIND-OF-FILE) :ABSTRACT-FLAVOR)

(DEFFLAVOR NO-MORE-ROOM () (FILE-OPERATION-FAILURE DIRED-MIGHT-FIX-MIXIN) :ABSTRACT-FLAVOR)
(DEFFLAVOR FILE-TOO-BIG () (FILE-REQUEST-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR FILEPOS-OUT-OF-RANGE () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR FILE-OPEN-FOR-OUTPUT () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR CREATION-FAILURE () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR FILE-ALREADY-EXISTS () (CREATION-FAILURE DELETE-MIGHT-FIX-MIXIN) :ABSTRACT-FLAVOR)
(DEFFLAVOR CREATE-DIRECTORY-FAILURE () (CREATION-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR DIRECTORY-ALREADY-EXISTS () (CREATE-DIRECTORY-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR CANNOT-CREATE-DIRECTORY () (CREATE-DIRECTORY-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR CREATE-LINK-FAILURE () (CREATION-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR CANNOT-CREATE-LINK () (CREATE-LINK-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR RENAME-FAILURE ((NEW-PATHNAME NIL)) (FILE-OPERATION-FAILURE)
  :INITABLE-INSTANCE-VARIABLES
  :GETTABLE-INSTANCE-VARIABLES
  :ABSTRACT-FLAVOR)
(DEFFLAVOR RENAME-TO-EXISTING-FILE () (RENAME-FAILURE DELETE-MIGHT-FIX-MIXIN)
  (:REQUIRED-INIT-KEYWORDS :NEW-PATHNAME)
  :ABSTRACT-FLAVOR)
(DEFMETHOD (:FILE-TO-DELETE RENAME-TO-EXISTING-FILE) () NEW-PATHNAME)

(DEFFLAVOR RENAME-ACROSS-DIRECTORIES () (RENAME-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR CHANGE-PROPERTY-FAILURE () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR UNKNOWN-PROPERTY () (CHANGE-PROPERTY-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR INVALID-PROPERTY-VALUE () (CHANGE-PROPERTY-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR DELETE-FAILURE () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR CANNOT-DELETE-FILE () (DELETE-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR DIRECTORY-NOT-EMPTY () (DELETE-FAILURE) :ABSTRACT-FLAVOR)
(DEFFLAVOR DONT-DELETE-FLAG-SET () (DELETE-FAILURE) :ABSTRACT-FLAVOR)

;;; A Non-aborting CLOSE, FILEPOS,etc. couldn't be performed because
;;; an error wasn't dealt with.
;;; This is more general than QFILE.
(DEFFLAVOR ERROR-PENDING-ON-CHANNEL (OPERATION)
	   (FILE-OPERATION-FAILURE)
  (:INITABLE-INSTANCE-VARIABLES) :ABSTRACT-FLAVOR)

(DEFFLAVOR MISC-PROBLEMS () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)

(DEFFLAVOR NOT-AVAILABLE () (FILE-OPERATION-FAILURE) :ABSTRACT-FLAVOR)

;;;For :PROPERTIES, condemned to use :DIRECTORY-LIST, which will not err on FNF..
(DEFFLAVOR FILE-NOT-FOUND-FOR-PROPERTIES ()
	   (FILE-NOT-FOUND))

(DEFMETHOD (:REPORT-WITHOUT-PATHNAME FILE-NOT-FOUND-FOR-PROPERTIES) (STREAM)
  (SEND STREAM ':STRING-OUT "The file was not found."))

(COMPILE-FLAVOR-METHODS FILE-NOT-FOUND-FOR-PROPERTIES)

;;; Condition signalled by WITH-OPEN-FILE-SEARCH when it gets FILE-NOT-FOUND for all files
(DEFFLAVOR MULTIPLE-FILE-NOT-FOUND (OPERATION PATHNAME PATHNAMES) (FILE-NOT-FOUND)
  :INITABLE-INSTANCE-VARIABLES
  :GETTABLE-INSTANCE-VARIABLES)

;Shadow the method inherited from FILE-ERROR, because we don't really want
;to print the original pathname in addition to the pathnames actually tried.
(DEFMETHOD (:REPORT MULTIPLE-FILE-NOT-FOUND) (STREAM)
  (SEND SELF ':REPORT-WITHOUT-PATHNAME STREAM))

(DEFMETHOD (:REPORT-WITHOUT-PATHNAME MULTIPLE-FILE-NOT-FOUND) (STREAM)
  (PRINC (IF (CDR PATHNAMES) "Unable to find any of the files " "Unable to find the file ")
	 STREAM)
  (FORMAT:PRINT-LIST STREAM "~A" PATHNAMES))

(DEFMETHOD (:PROCEED MULTIPLE-FILE-NOT-FOUND :NEW-PATHNAME) (&OPTIONAL NEW-PATHNAME)
  "Supply a different pathname"
  (VALUES ':NEW-PATHNAME
	  (OR NEW-PATHNAME
	      (PROMPT-FOR-NEW-PATHNAME PATHNAME SELF OPERATION))))

(COMPILE-FLAVOR-METHODS MULTIPLE-FILE-NOT-FOUND UNKNOWN-OPERATION)


;;; Condition signalled by RENAMEF.
(DEFFLAVOR RENAME-ACROSS-HOSTS () (RENAME-FAILURE))

(DEFFLAVOR LINK-ACROSS-HOSTS () (CREATE-LINK-FAILURE))


(DEFMETHOD (:REPORT-WITHOUT-PATHNAME RENAME-ACROSS-HOSTS) (STREAM)
  (FORMAT STREAM "Cross-host renaming is not supported."))

(DEFMETHOD (:REPORT-WITHOUT-PATHNAME LINK-ACROSS-HOSTS) (STREAM)
  (FORMAT STREAM "Cross-host linking is not supported by host ~A."
	  (SEND (SEND SELF ':PATHNAME) ':HOST)))

(COMPILE-FLAVOR-METHODS RENAME-ACROSS-HOSTS LINK-ACROSS-HOSTS)
