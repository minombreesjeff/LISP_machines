;;; -*- Mode:Lisp; Syntax:Zetalisp; Package:system; Base:8 -*-
;;;>
;;;> *****************************************************************************************
;;;> ** (c) Copyright 1998-1982 Symbolics, Inc.  All rights reserved.
;;;> ** Portions of font library Copyright (c) 1984 Bitstream, Inc.  All Rights Reserved.
;;;>
;;;>    The software, data, and information contained herein are proprietary to,
;;;> and comprise valuable trade secrets of, Symbolics, Inc., which intends 
;;;> to keep such software, data, and information confidential and to preserve them
;;;> as trade secrets.  They are given in confidence by Symbolics pursuant 
;;;> to a written license agreement, and may be used, copied, transmitted, and stored
;;;> only in accordance with the terms of such license.
;;;> 
;;;> Symbolics, Symbolics 3600, Symbolics 3675, Symbolics 3630, Symbolics 3640,
;;;> Symbolics 3645, Symbolics 3650, Symbolics 3653, Symbolics 3620, Symbolics 3610,
;;;> Zetalisp, Open Genera, Virtual Lisp Machine, VLM, Wheels, Dynamic Windows,
;;;> SmartStore, Semanticue, Frame-Up, Firewall, Document Examiner,
;;;> Delivery Document Examiner, "Your Next Step in Computing", Ivory, MacIvory,
;;;> MacIvory model 1, MacIvory model 2, MacIvory model 3, XL400, XL1200, XL1201,
;;;> Symbolics UX400S, Symbolics UX1200S, NXP1000, Symbolics C, Symbolics Pascal,
;;;> Symbolics Prolog, Symbolics Fortran, CLOE, CLOE Application Generator,
;;;> CLOE Developer, CLOE Runtime, Common Lisp Developer, Symbolics Concordia,
;;;> Joshua, Statice, and Minima are trademarks of Symbolics, Inc.
;;;> 
;;;> Symbolics 3670, Symbolics Common Lisp, Symbolics-Lisp, and Genera are registered
;;;> trademarks of Symbolics, Inc.
;;;>
;;;> GOVERNMENT PURPOSE RIGHTS LEGEND
;;;> 
;;;>      Contract No.: various
;;;>      Contractor Name: Symbolics, Inc.
;;;>      Contractor Address: c/o Ropes & Gray
;;;> 			 One International Place
;;;> 			 Boston, Massachusetts 02110-2624
;;;>      Expiration Date: 2/27/2018
;;;>      
;;;> The Government's rights to use, modify, reproduce, release, perform, display or
;;;> disclose this software are restricted by paragraph (b)(2) of the "Rights in
;;;> Noncommercial Computer Software and Noncommercial Computer Software Documentation"
;;;> contained in the above identified contracts.  No restrictions apply after the
;;;> expiration date shown above.  Any reproduction of the software or portions thereof
;;;> marked with this legend must also reproduce the markings.  Questions regarding
;;;> the Government's rights may be referred to the AS&T Contracts Office of the
;;;> National Reconnaissance Office, Chantilly, Virginia 20151-1715.
;;;> 
;;;>      Symbolics, Inc.
;;;>      c/o Ropes & Gray
;;;>      One International Place
;;;>      Boston, Massachusetts 02110-2624
;;;>      781-937-7655
;;;>
;;;> *****************************************************************************************
;;;>

;;; This file (as opposed to SYSDEF) contains the definitions that
;;; create structure in the cold-load generator, as opposed to the
;;; ones that are purely declarative.

;;; Note that the information from this file, including absolute locations
;;; of variables, is compiled into the microcode, the FEP, the console
;;; program, and the cold load.  Thus one should be very careful about
;;; incompatible changes, such as adding or removing elements in the
;;; middle of a block.

;;; The following forms are used in this file:
;;;
;;; (define-magic-locations (block-name option value option value...)
;;;	variable variable...)
;;;   defines some variables whose value cells are forwarded to consecutive
;;;   locations in a block of memory.  The loader should probably link
;;;   directly to these locations, so that the symbols can be paged out.
;;;   In most cases these variables are initialized by sys:sys;ldata.
;;;
;;;  block-name -- the name of the block, perhaps only for documentation.
;;;  options --
;;;     PHYSICAL-ADDRESS n -- put the block here.
;;;	VIRTUAL-ADDRESS n -- put the block there.
;;;	AREA name -- allocate the block somewhere in specified area
;;;	  Exactly one of the above options must be specified
;;;	SIZE n - number of locations reserved
;;;  variable --
;;;	a symbol -- the symbol's value cell is forwarded to here
;;;		The symbol is effectively DEFVAR'ed.
;;;	(FUNCTION symbol) -- to capture the function cell instead of the value cell
;;;	(QUOTE obj) -- nothing is forwarded here, but obj is stored by the
;;;			cold-load generator
;;;


;;;; Physical memory layout.

;;; From the beginning of vma=pma space, there is 256K allocated to the FEP
;;; (storage-initialize may negotiate with the FEP to snarf some of the
;;; unused portion for paging use).  Then there is 4K for trap vectors, 512
;;; words for communication areas, and T and NIL.  The FEP space will be
;;; hands-off as far as Lisp is concerned, the remainder will be part of
;;; sys:wired-control-tables, and will be scavenged.
;;; 
;;;   0000000..1000000        FEP code, data, and stacks
;;;   1000000..1010000        Trap vector
;;;   1010000..1010400        FEP communication area
;;;   1010400..1011000        System communication area
;;;   1011000..1011005        NIL
;;;   1011010..1011015        T
;;; 
;;; From the high end of vma=pma space, there is 64K allocated for
;;; configuration slot windows (a 1K window for each of 64 physical slots),
;;; and 64K for the first-level boot prom.  There are several entrypoints
;;; into this prom: one for the init pc, one for reset, and one for the
;;; FEP-mode trap handler.  [I don't believe this trap-handler would be any
;;; more than a dummy, though; the real one would want to be in the larger
;;; prom.]

(DEFSYSCONSTANT %TRAP-VECTOR-BASE (VMA=PMA 1000000))
(DEFSYSCONSTANT %TRAP-VECTOR-LENGTH 10000)

(DEFSYSCONSTANT %ARITHMETIC-INSTRUCTION-EXCEPTION-VECTOR 0)
(DEFSYSCONSTANT %INSTRUCTION-EXCEPTION-VECTOR 4000)
(DEFSYSCONSTANT %INTERPRETER-FUNCTION-VECTOR 4400)
(DEFSYSCONSTANT %GENERIC-DISPATCH-VECTOR 5000)

(DEFSYSCONSTANT %ERROR-TRAP-VECTOR 5100)
(DEFSYSCONSTANT %RESET-TRAP-VECTOR 5101)
(DEFSYSCONSTANT %PULL-APPLY-ARGS-TRAP-VECTOR 5102)
(DEFSYSCONSTANT %STACK-OVERFLOW-TRAP-VECTOR 5103)
(DEFSYSCONSTANT %TRACE-TRAP-VECTOR 5104)
(DEFSYSCONSTANT %PREEMPT-REQUEST-TRAP-VECTOR 5105)
(DEFSYSCONSTANT %TRANSPORT-TRAP-VECTOR 5106)
(DEFSYSCONSTANT %FEP-MODE-TRAP-VECTOR 5107)

(DEFSYSCONSTANT %LOW-PRIORITY-SEQUENCE-BREAK-TRAP-VECTOR 5110)
(DEFSYSCONSTANT %HIGH-PRIORITY-SEQUENCE-BREAK-TRAP-VECTOR 5111)
(DEFSYSCONSTANT %MONITOR-TRAP-VECTOR 5112)
;;; 5113 reserved for future use
(DEFSYSCONSTANT %GENERIC-DISPATCH-TRAP-VECTOR 5114)
;;; 5115 reserved for a fence word
(DEFSYSCONSTANT %MESSAGE-DISPATCH-TRAP-VECTOR 5116)
;;; 5117 reserved for a fence word

(DEFSYSCONSTANT %PAGE-NOT-RESIDENT-TRAP-VECTOR 5120)
(DEFSYSCONSTANT %PAGE-FAULT-REQUEST-TRAP-VECTOR 5121)
(DEFSYSCONSTANT %PAGE-WRITE-FAULT-TRAP-VECTOR 5122)
(DEFSYSCONSTANT %UNCORRECTABLE-MEMORY-ERROR-TRAP-VECTOR 5123)
(DEFSYSCONSTANT %MEMORY-BUS-ERROR-TRAP-VECTOR 5124)
(DEFSYSCONSTANT %DB-CACHE-MISS-TRAP-VECTOR 5125)
(DEFSYSCONSTANT %DB-UNWIND-FRAME-TRAP-VECTOR 5126)
(DEFSYSCONSTANT %DB-UNWIND-CATCH-TRAP-VECTOR 5127)
;;; 5130 through 5177 reserved for future use

(DEFSYSCONSTANT NIL-ADDRESS (VMA=PMA 1011000))
(DEFSYSCONSTANT T-ADDRESS (VMA=PMA 1011010))	;rev1 value

(DEFSYSCONSTANT %INIT-PC (VMA=PMA #o777400100))	;dtp-even-pc
(DEFSYSCONSTANT %INIT-SP (VMA=PMA 10000))

(DEFSYSCONSTANT %FEP-PHYSICAL-ADDRESS-LOW 0)
(DEFSYSCONSTANT %WIRED-PHYSICAL-ADDRESS-LOW 1_18.)
(DEFSYSCONSTANT %WIRED-VIRTUAL-ADDRESS-LOW (VMA=PMA 1_18.))

(DEFSYSCONSTANT %SPY-BLOCK-BASE (VMA=PMA 1004500))

;;;; Boot Communication Area

;;; This block is initialized by either the Boot ROM (in standalone
;;; systems) or by a combination of the host and Pseudo-boot ROM (in
;;; embedded systems) to communicate several system parameters to the
;;; FEP (which it then tells Lisp about).  This in intended to be
;;; read-only, so keep your fingers off!
(DEFINE-MAGIC-LOCATIONS (BOOT-COMMUNICATION-AREA :PHYSICAL-ADDRESS 777400000 :SIZE 100)
  *BOOT-EMB-COMMUNICATION-AREA*
  *BOOT-SYSTEM-TYPE*
  *BOOT-STACK-BASE*
  *BOOT-STACK-SIZE*
  *BOOT-SPY-PC*
  *BOOT-SPY-COMMAND-ADDRESS*			;obsolete
  *BOOT-SPY-STATUS-ADDRESS*			;obsolete
  *BOOT-SPY-BLOCK-ADDRESS*			;should be *BOOT-DATA-ADDRESS*
  *BOOT-CRASH-ADDRESS*				;obsolete
  *BOOT-CRASH-ACTION-ADDRESS*			;obsolete
  *BOOT-PROM-VERSION*
  )

;;; This block is set aside by the Boot ROM for its global vars and
;;; communicating with the FEP.  It is based at
;;; *BOOT-SPY-BLOCK-ADDRESS*.  Many other *BOOT-...-ADDRESS* comvars
;;; point into here (and are hence redundant).  The Boot ROM dumps the
;;; stack cache starting at *BOOT-SPY-BLOCK-ADDRESS*+#o100, so don't let
;;; this grow beyond there!!!
(DEFSTORAGE (BOOT-DATA-AREA :DEFAULT-POINTER *BOOT-SPY-BLOCK-ADDRESS*	;s/b -DATA-ADDRESS*
			    :REFERENCE-OFFSET 56	;from someone's ass
			    :FORWARDABLE NIL :STRUCTURE NIL :PRESERVE-CDR-CODES NIL)
  ;; 56 is room for all the *spy-block-registers* plus padding in case we add any
  BOOT-SPY-COMMAND
  BOOT-SPY-STATUS
  CRASH-ACTION					;one of *CRASH-ACTIONS*
  CRASH-TYPE					;one of *CRASH-STATES*
  ((CRASH-FATAL-PC) (CRASH-TRAP-NUMBER))	;meaning depends on crash-type
  ((CRASH-FATAL-VMA) (CRASH-TRAP-PC))		;"
  ((CRASH-FATAL-FEP-VECTOR) (CRASH-TRAP-ARGS))	;"
  BOOT-FEP-KERNEL-DPN				;where kernel was loaded from
  BOOT-DEVICE-PROM-VERSION			;saved by Boot ROM
  BOOT-COLOR-STARTUP-FILE-DPN			;where Device PROM found color startup file
  BOOT-SELECTED-CONSOLE-TYPE			;console Device PROM settled on
  )

;;; Registers saved and restored by a spy halt.
(DEFSTORAGE (SAVED-LISP-REGISTERS :DEFAULT-POINTER *SAVED-LISP-REGISTERS*
				  :FORWARDABLE NIL :STRUCTURE NIL :PRESERVE-CDR-CODES NIL)
; SAVED-REGISTER-BAR-0
  SAVED-REGISTER-BAR-1				;must be first
  SAVED-REGISTER-BAR-2
  SAVED-REGISTER-BAR-3
; SAVED-REGISTER-TOS
  SAVED-REGISTER-EVENT-COUNT
  SAVED-REGISTER-BINDING-STACK-POINTER
  SAVED-REGISTER-CATCH-BLOCK-LIST
  SAVED-REGISTER-CONTROL-STACK-LIMIT
  SAVED-REGISTER-CONTROL-STACK-EXTRA-LIMIT
  SAVED-REGISTER-BINDING-STACK-LIMIT
  SAVED-REGISTER-PHT-BASE
  SAVED-REGISTER-PHT-MASK
  SAVED-REGISTER-COUNT-MAP-RELOADS
  SAVED-REGISTER-LIST-CACHE-AREA
  SAVED-REGISTER-LIST-CACHE-ADDRESS
  SAVED-REGISTER-LIST-CACHE-LENGTH
  SAVED-REGISTER-STRUCTURE-CACHE-AREA
  SAVED-REGISTER-STRUCTURE-CACHE-ADDRESS
  SAVED-REGISTER-STRUCTURE-CACHE-LENGTH
  SAVED-REGISTER-STACK-FRAME-MAXIMUM-SIZE
  SAVED-REGISTER-STACK-CACHE-DUMP-QUANTUM
; SAVED-REGISTER-CONSTANT-NIL
; SAVED-REGISTER-CONSTANT-T
; SAVED-REGISTER-EA
  SAVED-REGISTER-FP
  SAVED-REGISTER-LP
; SAVED-REGISTER-E.SP
; SAVED-REGISTER-C.MACRO-SP
  SAVED-REGISTER-STACK-CACHE-LOWER-BOUND
; SAVED-REGISTER-PHT-HASH-0
; SAVED-REGISTER-PHT-HASH-1
; SAVED-REGISTER-PHT-HASH-2
; SAVED-REGISTER-PHT-HASH-3
; SAVED-REGISTER-E.PC
; SAVED-REGISTER-D.PC
; SAVED-REGISTER-I.PC
  SAVED-REGISTER-CONTINUATION
  SAVED-REGISTER-ALU-AND-ROTATE-CONTROL
  SAVED-REGISTER-CONTROL-REGISTER
; SAVED-REGISTER-CR.ARGUMENT-SIZE
  SAVED-REGISTER-EPHEMERAL-OLDSPACE-REGISTER
  SAVED-REGISTER-ZONE-OLDSPACE-REGISTER
; SAVED-REGISTER-CHIP-REVISION
  SAVED-REGISTER-FP-COPROCESSOR-PRESENT
; SAVED-REGISTER-MICROCODE-RETURN-ADDRESS
  SAVED-REGISTER-PREEMPT-REGISTER
  SAVED-REGISTER-ICACHE-CONTROL
  SAVED-REGISTER-PREFETCHER-CONTROL
  SAVED-REGISTER-MAP-CACHE-CONTROL
  SAVED-REGISTER-MEMORY-CONTROL
; SAVED-REGISTER-ECC-LOG				;clears on read
; SAVED-REGISTER-ECC-LOG-ADDRESS			;clears on read
  SAVED-REGISTER-STACK-CACHE-OVERFLOW-LIMIT
; SAVED-REGISTER-UCODE-ROM-CONTENTS
; SAVED-REGISTER-ENTRY-MAXIMUM-ARGUMENTS
; SAVED-REGISTER-LEXICAL-VARIABLE
; SAVED-REGISTER-INSTRUCTION
; SAVED-REGISTER-MEMORY-DATA
; SAVED-REGISTER-DATA-PINS
; SAVED-REGISTER-EXTENSION-REGISTER
; SAVED-REGISTER-ARRAY-HEADER-LENGTH
  )


;;;; FEP Communication Area

;;; This block is initialized by the FEP during the booting process but it is first
;;; initialized from the booted virtual memory image.  See the function
;;; si:initialize-fep-communication-area in l-sys;disk-save.  If you add new locations to
;;; this communication area that need to be initialized to other than "unbound" when
;;; booting, you need to modify that function or the FEP.

(DEFINE-MAGIC-LOCATIONS (FEP-COMMUNICATION-AREA :PHYSICAL-ADDRESS 1010000 :SIZE 400)

  FEP-VERSION-NUMBER
  *SYSTEM-TYPE*

  (FUNCTION FEP-STARTUP)
  *SPY-COMMAND*					;Obsolete
  *SPY-STATUS*					;Obsolete
  *SPY-PC*					;Obsolete

  LOAD-MAP-SIZE				;Number of entries in load map
  LOAD-MAP-VMA-ADDRESS			;Physical address of load map starting VMAs
  LOAD-MAP-OPCODE-ADDRESS		;Physical address of load map opcode/words word
  LOAD-MAP-OPERAND-ADDRESS		;Physical address of load map opcode-specific info
  SWAP-MAP-SIZE				;Number of entries in swap map
  SWAP-MAP-ADDRESS			;Physical address of #pages table
  SWAP-MAP-DPN-ADDRESS			;Physical address of dpn table, parallel to above
  MAIN-MEMORY-MAP-SIZE			;Number of entries in memory map
  MAIN-MEMORY-MAP-ADDRESS		;Physical address of size,start-ppn memory map
  BAD-MEMORY-PAGES-SIZE			;Number of entries in bad memory table
  BAD-MEMORY-PAGES-ADDRESS		;Physical address of size,start-ppn of bad mem tab

  %FEP-PHYSICAL-ADDRESS-HIGH		;Highest address of FEP, always < 256K

  %UNWIRED-VIRTUAL-ADDRESS-LOW		;Lowest unwired disk-restore addr preloaded, else 0
  %UNWIRED-VIRTUAL-ADDRESS-HIGH		;Highest unwired disk-restore addr preloaded
  %UNWIRED-PHYSICAL-ADDRESS-LOW		;Physical address corrosponding to virtual addr low
  %UNWIRED-PHYSICAL-ADDRESS-HIGH	;Highest address preloaded into

  ;; Some IFEP versions of NFEP functionality
  *REQUESTING-LISP-TO-STOP*			;IFEP does t/nil

  ;; A string with fill-pointer, which is set by the
  ;; FEP that contains the list of current overlay pathnames, separated
  ;; by commas.  (This in is SYSCOM on 3600, since the string is
  ;; allocated by the cold-load-generator; on the I-machine, the FEP
  ;; allocates the string itself.)
  *CURRENT-FEP-OVERLAYS*

  ;; In an embedded system, this is the address of the embedding communication
  ;; area set up by the host system, with dtp-physical-address
  ;; This is unbound in a standalone system (so any attempt to use it will bomb)
  *EMB-COMMUNICATION-AREA*
  
  LOADED-BAND-NAME

  *NETBOOT-CONTROL-STRING*

  %SOFTWARE-CONFIGURATION

  NET-ADDRESS-1				;First 4 octets of the Ethernet address
  NET-ADDRESS-2				;Second 2 octets of the Ethernet address
  ;; A string with this machine's primary level-3 network address.
  ;; For example, "CHAOS|24476" or "INTERNET|192.10.41.62".
  PRIMARY-NETWORK-ADDRESS

  (FUNCTION FEP-COMMAND-STRING)			;(function (string &optional string) string)
  (FUNCTION FEP-CRASH-DATA-REQUEST)			;(function (string) string)

  ;; IFEP Functions for cold-load I/O
  (FUNCTION COLD-LOAD-STREAM-READ-CHARACTER)
  (FUNCTION COLD-LOAD-STREAM-LISTEN)
  (FUNCTION COLD-LOAD-STREAM-READ-HARDWARE-CHARACTER)
  (FUNCTION COLD-LOAD-STREAM-DRAW-CHARACTER)
  (FUNCTION COLD-LOAD-STREAM-DISPLAY-LOZENGED-STRING)
  (FUNCTION COLD-LOAD-STREAM-SELECT)
  (FUNCTION COLD-LOAD-STREAM-BEEP)
  (FUNCTION COLD-LOAD-STREAM-FINISH)
  (FUNCTION COLD-LOAD-STREAM-INSIDE-SIZE)
  (FUNCTION COLD-LOAD-STREAM-SET-CURSORPOS)
  (FUNCTION COLD-LOAD-STREAM-READ-CURSORPOS)
  (FUNCTION COLD-LOAD-STREAM-COMPUTE-MOTION)
  (FUNCTION COLD-LOAD-STREAM-CLEAR-BETWEEN-CURSORPOSES)
  (FUNCTION COLD-LOAD-STREAM-SET-EDGES)		;lets Lisp move the c-l-s window
  (FUNCTION MAIN-SCREEN-PARAMETERS)		;replaces the SCREEN-* variables
  (FUNCTION WIRED-FORMAT)

  ;; Points to entry of kernel, filled by boot prom when it loads the kernel
  (FUNCTION FEP-SEQUENCE-BREAK)			;obsolete, c-l-s-r-h-c instead
  
  ;; Out of order things that got left out
  *LISP-STOPPED-CLEANLY*
  *LOAD-PAGES-TO-SWAP-AREA-P*
  (FUNCTION REMOTE-DEBUG-LOOP)
  ;; These can be set by Lisp or FEP to make FEP look smart or tell Lisp
  ;; about standalone sites
  *TIMEZONE-OFFSET-MINUTES*			;fixnum
  *TIMEZONE-NAME*				;A fill-pointered string built by FEP
  *NAMESPACE-DESCRIPTOR-FILE*			;A pathname string set by FEP
  *SITE-NAME*					;A string set by FEP
  
  ;; When Lisp halts and the FEP catches it (i.e., non-fatal error) the
  ;; FEP saves the state here and sets the flag so warm boot can
  ;; properly reset the crashed process.
  *SAVED-LISP-REGISTERS*			;*spy-block-registers* saved by FEP
  *LISP-STATE-SAVED*				;Success
  
  *ENABLE-FPA-P*				;So user can turn it off from FEP

  ;; Formerly KLUDGE for transition from SCSI to ESDI on Merlin
  ;; Now array of information about disk units.
  *DISK-UNIT-TABLE*

  ;; By Merlin-II, the ECO register is completely useless unless you
  ;; already know what boards are there.  Let the FEP figure it out.
  %HARDWARE-CONFIGURATION

  *SLAVE-BUFFER-BASE-ADDRESS*			;For users who move Merlin VME address jumpers
  *KERNEL-COMPRESSED-STRING-ARRAY*		;For Device-PROM DDT

  ;; State of communications between Ivory and the 8032 on a Domino main board.
  ;; This state must be shared between Lisp and the FEP to permit cold load input.
  *DOMINO-8032-STATE*
  )


;;; System Communication Area.
;;;
;;; This block comes from the booted virtual memory image.  It is used
;;; to communicate between the pageable Lisp system, the wired-down Lisp
;;; system, and the debugging console.
(DEFINE-MAGIC-LOCATIONS (SYSTEM-COMMUNICATION-AREA :PHYSICAL-ADDRESS 1010400 :SIZE 400)
  SYSCOM-MAJOR-VERSION-NUMBER		;Major version of System system
  SYSCOM-MINOR-VERSION-NUMBER		;Minor version of System system
  
  (FUNCTION SYSTEM-STARTUP)
  
  ;; Address space map
  *ADDRESS-SPACE-MAP-ADDRESS*		;Maps quanta to regions.  See STORAGE for format info.
  *OBLAST-FREE-SIZE*			;Contiguous free quanta in each oblast.
  
  ;; Per-area tables.  These are arrays.  They are here for the console program.
  *AREA-NAME*				;A symbol
  *AREA-MAXIMUM-QUANTUM-SIZE*		;Maximum number of quanta to allocate to area
  *AREA-REGION-QUANTUM-SIZE*		;Number of quanta desired per region
  *AREA-REGION-LIST*			;Number of first region
  *AREA-REGION-BITS*			;Initial value for REGION-BITS
  
  ;; Per-region tables.  These are arrays.  They are here for the console program.
  *REGION-QUANTUM-ORIGIN*		;First quantum in region
  *REGION-QUANTUM-LENGTH*		;Number of quanta allocated to region
  *REGION-FREE-POINTER*			;Number of words actually used
  *REGION-GC-POINTER*			;Number of words scanned by (long-term) gc
  *REGION-BITS*				;Fixnum of random fields (see %%REGION- bytes)
  *REGION-LIST-THREAD*			;Number of next region in this area, -1 terminates
  *REGION-AREA*				;Area to which region belongs
  *REGION-CREATED-PAGES*		;Lowest nonexistent address (relative to origin)
  *REGION-FREE-POINTER-BEFORE-FLIP*

  %REGION-CONS-ALARM			;Counts down whenever a region is made
  %PAGE-CONS-ALARM			;Counts down whenever consing crosses a page boundary

  %STRUCTURE-CACHE-REGION
  %LIST-CACHE-REGION
  *DEFAULT-CONS-AREA*			;Default cons area
  
  ;; Pointers to critical storage-system tables (these are displaced arrays)
  *PHT*					;Page hash table
  *MMPT-Y*				;Main Memory Y subscript table
  *MMPT*				;Main Memory page table
  *SMPT*				;Secondary Memory page table
  *LOAD-BITMAPS*			;Array of bitmaps, t if in load map
  ;; The following are red herrings for functionality that is really in FEPCOM.
  ;; Presumably they leaked in from L-world during the IMach project.
  ;;                    - Office 229 (PTW/Kaufman), 23 July 1990
  *LOAD-MAP*				;Red herring; NOT Load map 
  *LOAD-MAP-DPN*			;Red herring; NOT Parallel to *load-map* containing dpn
  *SWAP-MAP*				;Red herring; NOT Swap map
  *SWAP-MAP-DPN*			;Red herring; NOT Parallel to *swap-map* containing dpn
  *SYSOUT-BITMAPS*			;Array of bitmaps, t if was in load
					;but has been modified. 
  ;; Dynamic storage array, 4 bits per PHT bucket.
  *PHT-COLLISION-COUNTS*
  *MMPT1*				;secondary MMPT

  *STORAGE-COLD-BOOT*			;Access frobs this before saving world
  *FLUSHABLE-QUEUE-HEAD*		; MMPT index of first frame in flushable queue
  *FLUSHABLE-QUEUE-TAIL*		; MMPT index of last frame in flushable queue
  *FLUSHABLE-QUEUE-MODIFIED*		; MMPT index of flushable queue background scan

  %WIRED-PHYSICAL-ADDRESS-HIGH		;Highest address of wired system
  %WIRED-VIRTUAL-ADDRESS-HIGH

  *ENABLE-SYSOUT-AT-COLD-BOOT*		;Initially NIL, the FEP sets
					; this to T to enable the SYSOUT mechanism.
  *SYSOUT-GENERATION-NUMBER*
  *SYSOUT-TIMESTAMP-1*			;Timestamps which identify this world
  *SYSOUT-TIMESTAMP-2*			; probably universal-time (as fixnum) and
					; microsecond clock at some convenient time
					; of disk-save/sysout.
  *SYSOUT-PARENT-TIMESTAMP-1*		;Timestamps of the parent world.  Copied from
  *SYSOUT-PARENT-TIMESTAMP-2*		; above timestamps before above timestamps updated. 

  %INITIAL-STACK-GROUP
  %CURRENT-STACK-GROUP
  %STACK-GROUP-LOCK			;NIL or status of incomplete stack-group switch
  %CURRENT-STACK-GROUP-STATUS-BITS	;Fixnum of various bits
  INHIBIT-SCHEDULING-FLAG		;Needed by stack overflow microcode
  %CONTROL-STACK-LOW			;Base address of stack
  %BINDING-STACK-LOW			;Base address of binding stack (vestigial)

  ;Floating-point control registers
  FLOAT-OPERATING-MODE
  FLOAT-OPERATION-STATUS

  *PACKAGE-NAME-TABLE*			;For console package hacking.
  *LISP-RELEASE-STRING*			;Tells the FEP the Lisp version
  *BUS-MODE*				;So FEP can restore it after bashing it
  )


;;;; Internal register definitions (Ivory revision 4).

;;; There are 2000 internal register addresses, which are partitioned (for the convenience
;;; of the hardware) as follows:
;;; 
;;;     9           0
;;;     1 --- --- ---  scratchpad locations
;;;     0 BB- --- ---  external-bus registers
;;; 
;;; BB is the BAR select, which is only applicable to the following external bus
;;; registers:
;;; 
;;;   BAR (read and write)  
;;;     access BAR[BB] contents
;;;   BAR-hash-box (read only)  
;;;     read vpn-hash(BAR[BB])
;;;   BAR-map-entry-invalidate (write only)
;;;     invalidate entry for BAR[BB] if present
;;;   BAR-write-map (write only)
;;;     for testing, write contents of BAR[BB] into map[replacement-entry]
;;;
;;; Note: a given external-bus register address doesn't necessarily mean the same thing for
;;; both reads and writes.  However, the final layout will at least assign the same address
;;; for both reads and writes of a readable/writable register.

(DEFINE-INTERNAL-REGISTERS
  (:SCRATCHPAD-REGISTERS
    %REGISTER-TOS
    %REGISTER-EVENT-COUNT
    %REGISTER-BINDING-STACK-POINTER
    %REGISTER-CATCH-BLOCK-LIST
    %REGISTER-CONTROL-STACK-LIMIT
    %REGISTER-CONTROL-STACK-EXTRA-LIMIT
    %REGISTER-BINDING-STACK-LIMIT
    %REGISTER-PHT-BASE
    %REGISTER-PHT-MASK
    %REGISTER-COUNT-MAP-RELOADS
    %REGISTER-LIST-CACHE-AREA
    %REGISTER-LIST-CACHE-ADDRESS
    %REGISTER-LIST-CACHE-LENGTH
    %REGISTER-STRUCTURE-CACHE-AREA
    %REGISTER-STRUCTURE-CACHE-ADDRESS
    %REGISTER-STRUCTURE-CACHE-LENGTH
    %REGISTER-DYNAMIC-BINDING-CACHE-BASE
    %REGISTER-DYNAMIC-BINDING-CACHE-MASK
    %REGISTER-CHOICE-POINTER
    %REGISTER-STRUCTURE-STACK-CHOICE-POINTER
    %REGISTER-FEP-MODE-TRAP-VECTOR-ADDRESS
    NIL
    %REGISTER-MAPPING-TABLE-CACHE
    %REGISTER-MAPPING-TABLE-LENGTH
    %REGISTER-STACK-FRAME-MAXIMUM-SIZE
    %REGISTER-STACK-CACHE-DUMP-QUANTUM
    NIL NIL
    NIL NIL NIL NIL
    %REGISTER-CONSTANT-NIL
    %REGISTER-CONSTANT-T
    )
  (:READABLE-EXTERNAL-REGISTERS
    %REGISTER-EA
    %REGISTER-FP
    %REGISTER-LP
    %REGISTER-E.SP
    %REGISTER-C.MACRO-SP
    %REGISTER-STACK-CACHE-LOWER-BOUND
    (%REGISTER-BAR-0 %REGISTER-BAR-1 %REGISTER-BAR-2 %REGISTER-BAR-3)
    (%REGISTER-PHT-HASH-0 %REGISTER-PHT-HASH-1 %REGISTER-PHT-HASH-2 %REGISTER-PHT-HASH-3)
    %REGISTER-E.PC
    %REGISTER-D.PC
    %REGISTER-CONTINUATION
    %REGISTER-ALU-AND-ROTATE-CONTROL
    %REGISTER-CONTROL-REGISTER
    %REGISTER-CR.ARGUMENT-SIZE
    %REGISTER-EPHEMERAL-OLDSPACE-REGISTER
    %REGISTER-ZONE-OLDSPACE-REGISTER
    %REGISTER-CHIP-REVISION
    %REGISTER-FP-COPROCESSOR-PRESENT
    %REGISTER-MICROCODE-RETURN-ADDRESS
    %REGISTER-PREEMPT-REGISTER
    %REGISTER-ICACHE-CONTROL
    %REGISTER-PREFETCHER-CONTROL
    %REGISTER-MAP-CACHE-CONTROL
    %REGISTER-MEMORY-CONTROL
    %REGISTER-ECC-LOG
    %REGISTER-ECC-LOG-ADDRESS
    ()
    ()
    %REGISTER-STACK-CACHE-OVERFLOW-LIMIT
    %REGISTER-UCODE-ROM-CONTENTS
    ()
    %REGISTER-ADDRESS-MASK			;Rev4
    %REGISTER-ENTRY-MAXIMUM-ARGUMENTS
    %REGISTER-LEXICAL-VARIABLE
    %REGISTER-INSTRUCTION
    ()
    %REGISTER-MEMORY-DATA
    %REGISTER-DATA-PINS
    %REGISTER-EXTENSION-REGISTER
    %REGISTER-MICROSECOND-CLOCK			;Rev4
    %REGISTER-ARRAY-HEADER-LENGTH
    ()
    ())
  (:WRITABLE-EXTERNAL-REGISTERS
    %REGISTER-EA-REG
    %REGISTER-FP
    %REGISTER-LP
    %REGISTER-D.SP
    ()
    %REGISTER-STACK-CACHE-LOWER-BOUND
    (%REGISTER-BAR-0 %REGISTER-BAR-1 %REGISTER-BAR-2 %REGISTER-BAR-3)
    ()
    %REGISTER-I.PC
    ()
    %REGISTER-CONTINUATION
    %REGISTER-ALU-AND-ROTATE-CONTROL
    %REGISTER-CONTROL-REGISTER
    ()
    %REGISTER-EPHEMERAL-OLDSPACE-REGISTER
    %REGISTER-ZONE-OLDSPACE-REGISTER
    ()
    %REGISTER-FP-COPROCESSOR-PRESENT
    ()
    %REGISTER-PREEMPT-REGISTER
    %REGISTER-ICACHE-CONTROL
    %REGISTER-PREFETCHER-CONTROL
    %REGISTER-MAP-CACHE-CONTROL
    %REGISTER-MEMORY-CONTROL
    ()
    ()
    (%REGISTER-INVALIDATE-MAP-0 %REGISTER-INVALIDATE-MAP-1
     %REGISTER-INVALIDATE-MAP-2 %REGISTER-INVALIDATE-MAP-3)
    (%REGISTER-LOAD-MAP-0 %REGISTER-LOAD-MAP-1 %REGISTER-LOAD-MAP-2 %REGISTER-LOAD-MAP-3)
    %REGISTER-STACK-CACHE-OVERFLOW-LIMIT
    ()
    %REGISTER-LOOP-COUNTER
    %REGISTER-ADDRESS-MASK			;Rev4
    ()
    ()
    ()
    %REGISTER-IMMEDIATE
    ()
    %REGISTER-DATA-PINS
    %REGISTER-EXTENSION-REGISTER
    %REGISTER-MICROSECOND-CLOCK			;Rev4
    ()
    ()
    (%REGISTER-LOAD-MATCHING-MAP-0 %REGISTER-LOAD-MATCHING-MAP-1
     %REGISTER-LOAD-MATCHING-MAP-2 %REGISTER-LOAD-MATCHING-MAP-3)
    ))


;;;; Coprocessor register definitions (Ivory revision 5).

(DEFSYSCONSTANT %COPROCESSOR-REGISTER-MICROSECOND-CLOCK #o1002)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-HOST-INTERRUPT #o1010)

;;; VM register definitions are in SYS:STORAGE;I-STORAGE-DEFS

(DEFSYSCONSTANT %COPROCESSOR-REGISTER-STACK-SWITCH #o1200)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-FLUSH-STACK-CACHE #o1201)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-FLUSH-ID-CACHES #o1202)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-CALENDAR-CLOCK #o1203)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-FLUSH-CACHES-FOR-VMA #o1204)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-FLIP-TO-STACK #o1205)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-UNWIND-STACK-FOR-RESTART-OR-APPLY #o1206)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-SAVE-WORLD #o1207)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-CONSOLE-INPUT-AVAILABLE-P #o1210)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-WAIT-FOR-EVENT #o1211)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-FLUSH-HIDDEN-ARRAY-REGISTERS #o1212)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-CONSOLE-IO #o1213)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-ATTACH-DISK-CHANNEL #o1214)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-GROW-DISK-PARTITION #o1215)
(DEFSYSCONSTANT %COPROCESSOR-REGISTER-DETACH-DISK-CHANNEL #o1216)

;;; Value returned by reading the calendar clock coprocessor register
(DEFSTORAGE (COPROCESSOR-CALENDAR-CLOCK :FORWARDABLE NIL
					:STRUCTURE NIL
					:PRESERVE-CDR-CODES NIL
					:FIXNUM-ONLY T
					:PHYSICAL T)
  ((COPROCESSOR-CALENDAR-CLOCK)
   (COPROCESSOR-CALENDAR-CLOCK-SECOND 6. 0.)
   (COPROCESSOR-CALENDAR-CLOCK-MINUTE 6. 6.)
   (COPROCESSOR-CALENDAR-CLOCK-HOUR 5. 12.)
   (COPROCESSOR-CALENDAR-CLOCK-DATE 5. 17.)
   (COPROCESSOR-CALENDAR-CLOCK-MONTH 4. 22.)
   (COPROCESSOR-CALENDAR-CLOCK-YEAR 6. 26.)))

(DEFSYSCONSTANT %COPROCESSOR-CALENDAR-CLOCK-BASE-YEAR 1990.)

;;; The save world coprocessor register expects a DTP-LOCATIVE to this structure
(DEFSTORAGE (COPROCESSOR-SAVE-WORLD :FORWARDABLE NIL
				    :STRUCTURE NIL
				    :PRESERVE-CDR-CODES NIL
				    :FIXNUM-ONLY NIL
				    :PHYSICAL T)
  COPROCESSOR-SAVE-WORLD-FILENAME		;The filename for the save (a DTP-STRING)
  COPROCESSOR-SAVE-WORLD-MAP-SIZE		;Number of map entries that immediately follow
  COPROCESSOR-SAVE-WORLD-MAP-ENTRIES)		;The map entries are allocated here

(DEFSTORAGE (COPROCESSOR-SAVE-WORLD-MAP-ENTRY :FORWARDABLE NIL
					      :STRUCTURE NIL
					      :PRESERVE-CDR-CODES NIL
					      :FIXNUM-ONLY NIL
					      :PHYSICAL T)
  COPROCESSOR-SAVE-WORLD-MAP-ENTRY-VMA		;Starting VMA of this entry
  COPROCESSOR-SAVE-WORLD-MAP-ENTRY-EXTENT)	;Number of words in this entry

;;; The attach disk channel coprocessor register expects a DTP-LOCATIVE to this structure
(DEFSTORAGE (COPROCESSOR-ATTACH-DISK-CHANNEL :FORWARDABLE NIL
					     :STRUCTURE NIL
					     :PRESERVE-CDR-CODES NIL
					     :FIXNUM-ONLY NIL
					     :PHYSICAL T)
  COPROCESSOR-ATTACH-DISK-CHANNEL-CHANNEL	;Embedded pointer to disk channel structure
  COPROCESSOR-ATTACH-DISK-CHANNEL-FILENAME	;Name of file to attach to channel (DTP-STRING)
  COPROCESSOR-ATTACH-DISK-CHANNEL-IF-NOT-FOUND-ACTION	;What to do if file doesn't exist
  COPROCESSOR-ATTACH-DISK-CHANNEL-MINIMUM-LENGTH	;File must be at least this many bytes
  COPROCESSOR-ATTACH-DISK-CHANNEL-RESULT	;Set to zero if attached, non-zero if error
  COPROCESSOR-ATTACH-DISK-CHANNEL-ERROR-MSG)	;Set to embedded pointer of an error message

(DEFENUMERATED *COPROCESSOR-ATTACH-DISK-CHANNEL-IF-NOT-FOUND-ACTION*
  (%COPROCESSOR-ATTACH-DISK-CHANNEL-IF-NOT-FOUND-CREATE
   %COPROCESSOR-ATTACH-DISK-CHANNEL-IF-NOT-FOUND-ERROR))

;;; The grow disk partition coprocessor register expects a DTP-LOCATIVE to this structure
(DEFSTORAGE (COPROCESSOR-GROW-DISK-PARTITION :FORWARDABLE NIL
					     :STRUCTURE NIL
					     :PRESERVE-CDR-CODES NIL
					     :FIXNUM-ONLY NIL
					     :PHYSICAL T)
  COPROCESSOR-GROW-DISK-PARTITION-CHANNEL	;Embedded pointer to disk channel structure
  COPROCESSOR-GROW-DISK-PARTITION-NEW-LENGTH	;File must be at least this many bytes
  COPROCESSOR-GROW-DISK-PARTITION-RESULT	;Set non-zero if error
  COPROCESSOR-GROW-DISK-PARTITION-ERROR-MSG)	;Set to embedded pointer of an error message

;;;; Embedding Communication Area
(DEFSTORAGE (EMB-COMMUNICATION-AREA :DEFAULT-POINTER *EMB-COMMUNICATION-AREA*
				    :FORWARDABLE NIL :STRUCTURE NIL
				    :PRESERVE-CDR-CODES NIL :FIXNUM-ONLY T
				    :PHYSICAL T)
  ;;
  ;; Overall Information on the Embedding Communication Area
  ;;
  EMB-IDENTIFIER				; expected to be 'EMBD' in ascii
  EMB-VERSION					; embedding architecture version 1
  EMB-SYSTEM-TYPE				; joint identification of host & guest systems
  EMB-NUMBER-OF-SLOTS				; n words visible to Ivory in this structure
  EMB-COMM-MEMORY-SIZE				; n words total in comm area
  ;;
  ;; Version Numbers of Various Software Entities
  ;;
  ((EMB-HOST-VERSION-0)
   (MACIVORY-LIFE-SUPPORT-VERSION)		; MacIvory: Life support version in Mac format 
   (SOLSTICE-KERNEL-BRANCH-MINOR 8. 0.)		; Solstice: kernel life-support version
   (SOLSTICE-KERNEL-BRANCH-MAJOR 8. 8.)
   (SOLSTICE-KERNEL-TRUNK-MINOR 8. 16.)
   (SOLSTICE-KERNEL-TRUNK-MAJOR 8. 24.)
   (VLM-GENERA-MAJOR-VERSION 16. 16.)		; VLM: Version number of the emulator
   (VLM-GENERA-MINOR-VERSION 16. 0.))
  ((EMB-HOST-VERSION-1)
   (MACIVORY-SUPPORT-LIBRARY-VERSION)		; MacIvory: Support code version in Mac format
   (SOLSTICE-LIFE-BRANCH-MINOR 8. 0.)		; Solstice: ivory-life program version
   (SOLSTICE-LIFE-BRANCH-MAJOR 8. 8.)
   (SOLSTICE-LIFE-TRUNK-MINOR 8. 16.)
   (SOLSTICE-LIFE-TRUNK-MAJOR 8. 24.)
   (VLM-AXP-OSF-TEST-VERSION-P 1. 31.)		; VLM: Version number of DEC OSF/1
   (VLM-AXP-OSF-MAJOR-RELEASE 7. 24.)
   (VLM-AXP-OSF-MINOR-RELEASE 8. 16.)
   (VLM-AXP-OSF-MAJOR-REVISION 8. 8.)
   (VLM-AXP-OSF-MINOR-REVISION 8. 0.))
  EMB-GUEST-MAJOR-VERSION			;
  EMB-GUEST-MINOR-VERSION			;
  EMB-FEP-MAJOR-VERSION				;
  EMB-FEP-MINOR-VERSION				;
  ;;
  ;; Memory Allocation
  ;;
  EMB-GUEST-BUFFER-START			; emb ptr (offset) of mem allocated by guest
  EMB-GUEST-BUFFER-SIZE				;  n words         "   "      "      "    "
  EMB-HOST-BUFFER-START				; emb ptr mem allocated by host
  EMB-HOST-BUFFER-SIZE				;  n words ...
  EMB-FEP-BUFFER-START				; emb ptr mem alloc'ed (by host) for FEP/RDBG
  EMB-FEP-BUFFER-SIZE				;  n words ...
  ;;
  ;; the next 4 words are bit masks for signalling purposes.  The actual signal
  ;; bits are dynamically allocated.
  ;;
  EMB-GUEST-TO-HOST-SIGNALS			; signal bits, outgoing
  EMB-LIVE-GUEST-TO-HOST-SIGNALS		; which ones are in use now
  EMB-HOST-TO-GUEST-SIGNALS			; signal bits, incoming
  EMB-LIVE-HOST-TO-GUEST-SIGNALS		; which ones are in use now
  ;;
  ;; Channels
  ;;
  EMB-CHANNEL-TABLE				; head of threaded list of all channels
  ((EMB-BOOT-DISK-CHANNEL)			; disk channel for IFEP boot disk
   (VLM-CONSOLE-CHANNEL))			; VLM: Channel for main console (using CLX)
  EMB-COLD-LOAD-CHANNEL				; cold load stream
  EMB-COMMAND-CHANNEL				; Master RPC channel
  ;;
  ;; Memory Configuration
  ;;
  ((EMB-MAIN-MEMORY-MAP)			; MacIvory: Pointer to main memory map
   (VLM-VIRTUAL-MEMORY-SIZE))			; VLM: Size of emulator virtual memory in words
  ((EMB-MAIN-MEMORY-MAP-SIZE)			; MacIvory: Number of 64-bit entries in the map
   (VLM-WORLD-IMAGE-SIZE))			; VLM: Size of world load in words
  EMB-BAD-MEMORY-MAP				; emb ptr to map of holes in memory
  EMB-BAD-MEMORY-MAP-SIZE			;  ...
  ;;
  ;; Interval Timer
  ;;
  EMB-CLOCK-SIGNAL				; bit num of clock pseudo-interrupt
  EMB-CLOCK-INTERVAL				; usec between clock tics
  ;;
  ;; Stuff that was added later and isn't really in the right place
  ;;
  EMB-RUN-LIGHTS				; Right-justified bit mask of run lights
  EMB-RESET-REQUEST				; Set by guest to req reset, cleared by host
  EMB-BOARD-SERIAL-NUMBER			; Guest board serial number
  EMB-BOARD-MAJOR-VERSION			; Guest board major revision level
  EMB-BOARD-MINOR-VERSION			; Guest board minor revision level
  EMB-SPY-COMMAND				; Debugging
  EMB-SPY-STATUS				; Debugging
  EMB-STOP-REQUEST				; Set to force guest to halt
  ((EMB-FEP-STATUS-WORD)			; The whole, for back-compatibility
   (EMB-FEP-CURSOR 1 8.)			; Flips when cold-load-stream cursor would
   (EMB-FEP-BUSY 1 9.)				; Set when not at command prompt
   (EMB-FEP-ERROR 1 10.)			; Set when a command errs
   (EMB-FEP-LISP-IS-LOADED 1 11.)		; Set if the FEP thinks Lisp will work
   (EMB-FEP-STATUS 8. 0))			; Set to the guest's status by its FEP
  EMB-RESTART-APPLICATIONS			; Set by guest to req host restart applications
  ((EMB-SIGNAL-INTERRUPT-VECTOR)		; -1 means don't interrupt host
   (EMB-SIGNAL-INTERRUPT-VECTOR-STATUS 8. 0)	;   On Solstice, VMEbus interrupt status-byte
   (EMB-SIGNAL-INTERRUPT-VECTOR-LEVEL 3 8.)	;      and VMEbus interrupt level
   )						;   Unused on MacIvory.
  EMB-BASE-REGISTER				; MacIvory base register
  ;;
  ;; Version numbers of critical non-RPC life-support components
  ;;
  ((EMB-HOST-VERSION-2)
   (MACIVORY-MACOS-VERSION)			; MacIvory: Macintosh OS version in Mac format
   (SOLSTICE-HOST-OS-PATCH-VERSION 8 8.)	; Solstice: UNIX operating system 
   (SOLSTICE-HOST-OS-MINOR-VERSION 8 16.)	;  version numbers
   (SOLSTICE-HOST-OS-MAJOR-VERSION 8 24.))
  ((EMB-HOST-VERSION-3)
   (MACIVORY-SYMBOLICS-KEYBOARD-VERSION)	; MacIvory: Symbolics keyboard support software
						;  version in Macintosh format
   (SOLSTICE-BOOT-VERSION)			; Solstice: version of genera program that 
   (SOLSTICE-BOOT-BRANCH-MINOR 8. 0.)		;  booted Ivory
   (SOLSTICE-BOOT-BRANCH-MAJOR 8. 8.)
   (SOLSTICE-BOOT-TRUNK-MINOR 8. 16.)
   (SOLSTICE-BOOT-TRUNK-MAJOR 8. 24.))
  ;
  ((EMB-MACIVORY-NVRAM-SETTINGS 16. 0.)		; NVRAM maintained by host for MacIvory
   (EMB-MACIVORY-NVRAM-FEP-PRINT-ERRORS 1 0))
  ;
  VLM-WORLD-PATHNAME				; Pathname of world loaded by the VLM command
  ;
  EMB-UNIX-LOGIN-NAME				; Login name of Unix user running Genera ...
  EMB-UNIX-UID					; ... User ID ...
  EMB-UNIX-GID					; ... Group ID
  )

(DEFENUMERATED *EMB-RESET-REQUEST-TYPES*
	       (%EMB-RESET-REQUEST-READ-NVRAM	; Read NVRAM maintained by host
		%EMB-RESET-REQUEST-WRITE-NVRAM	; Write NVRAM maintained by host
		%EMB-RESET-REQUEST-ARE-YOU-THERE	; NOOP to see if host is alive
		%EMB-RESET-REQUEST-BOOT		; Reset request by Boot ROM; Initializes
						; Device PROM loading through FEP-Buffer
		%EMB-RESET-REQUEST-DEVICE-PROM	; Requests FEP-Buffer-Size words
		%EMB-RESET-REQUEST-FEP		; Reset request by FEP doesn't clear everything
		%EMB-RESET-REQUEST-NONE		; No reset request pending
		%EMB-RESET-REQUEST-LISP)	; Reset request by Lisp does clear everything
  -6)

(DEFENUMERATED *EMB-FEP-STATUS-CODES*
	       (%EMB-FEP-STATUS-HALTED		; FEP stopped running and return to the SPY
		%EMB-FEP-STATUS-RUNNING		; FEP is running
		%EMB-FEP-STATUS-IDLE)		; FEP is alive but idle (i.e., Lisp is running)
  -1)

;;; Strings stored in the communications area by Life Support are stored using this format
(DEFSTORAGE (EMB-STRING :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
			:PHYSICAL T)
   EMB-STRING-LENGTH				;Size of string in bytes
   EMB-STRING-STRING)				;String starts here and is stored in host order

;;; Data transmission queue
;;; Queues are FIFO, with indices doing the obvious wrap at end of queue.
(DEFSTORAGE (EMB-QUEUE :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL :PHYSICAL T)
  EMB-QUEUE-ELEMENT-SIZE			; nbytes per queue elt
  EMB-QUEUE-QUEUE-SIZE				; n total elts in queue
  EMB-QUEUE-PUT-INDEX				; next elt to put
  EMB-QUEUE-TAKE-INDEX				; next elt to take
  EMB-QUEUE-SIGNAL				; signal number to indicate queue needs
						;  attention, or -1 if don't care
  )

;;;; Buffers

;;;
;;; defs for pool descriptors
;;;
(DEFSTORAGE (EMB-POOL :STRUCTURE NIL :FORWARDABLE NIL :PHYSICAL T)
  EMB-POOL-BUFFER-SIZE				; fixnum, size in words of bufs in this pool
  EMB-POOL-BUFFER-COUNT				; fixnum, n bufs in this pool
  EMB-POOL-ALL-BUFFERS				; VMA of buf, threaded list of all bufs in
						;  this pool.  may go away later...
  EMB-POOL-FREE-BUFFERS				; VMA of buf, threaded list of all free bufs
						;  in this pool
  )

;;;
;;; defs for buffer handles
;;;
(DEFSTORAGE (EMB-BUF-HANDLE :STRUCTURE NIL :FORWARDABLE NIL :PHYSICAL T)
  EMB-BUF-SIZE					; size in words this buf
  EMB-BUF-POOL					; pointer to containing pool
  EMB-BUF-NEXT					; vma of buf handle, next one in pool.  
						;  may go away later...
  EMB-BUF-NEXT-FREE				; vma next free buf this pool
  EMB-BUF-ALLOCATED				; q; flag indicating this buf allocated
  EMB-BUF-PMA					; pma (in comm area) of first word of buf
  )

;;;
;;; Channels
;;;

(DEFENUMERATED *EMB-CHANNEL-TYPES*
	       (%EMB-CHANNEL-TYPE-DISK		; Disk drive/partition
		%EMB-CHANNEL-TYPE-CONSOLE	; Display, keyboard, mouse (Unused)
		%EMB-CHANNEL-TYPE-NETWORK	; Ethernet
		%EMB-CHANNEL-TYPE-RPC		; All RPC channels
		%EMB-CHANNEL-TYPE-SCSI		; IFEP SCSI I/O
		%EMB-CHANNEL-TYPE-COLD-LOAD	; Cold load stream
		%EMB-CHANNEL-TYPE-HOST-FILE
		%EMB-CHANNEL-TYPE-MESSAGE	; General purpose stream
		)
  1)

(DEFSTORAGE (EMB-COLD-LOAD-CHANNEL :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
				   :PHYSICAL T)
  EMB-COLD-TYPE					; EmbColdLoadChannelType
  EMB-COLD-UNIT					; 0 (not used)
  EMB-COLD-NEXT					; EmbPtr to next channel
  EMB-COLD-KEYBOARD-INPUT-QUEUE			; EmbPtr to keyboard input queue
  EMB-COLD-DISPLAY-OUTPUT-QUEUE			; EmbPtr to display output queue
  EMB-COLD-DISPLAY-WIDTH			; width in pixels of window
  EMB-COLD-DISPLAY-HEIGHT			; height in pixels of window
  EMB-COLD-CHAR-WIDTH				; width in pixels of a character
  EMB-COLD-LINE-HEIGHT				; height in pixels of a line
  EMB-COLD-PROGRESS-NUMERATOR			; as in real progress notes
  EMB-COLD-PROGRESS-DENOMINATOR			; "
  EMB-COLD-PROGRESS-STRING-TOTAL-SIZE		; max length of string in string-char's
  EMB-COLD-PROGRESS-STRING-LENGTH		; when non-zero, displays a note
  EMB-COLD-PROGRESS-STRING			; First word of the host string-char string
  )


(DEFSTORAGE (EMB-CONSOLE-CHANNEL :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
				 :PHYSICAL T)
  EMB-CONSOLE-TYPE				; %EMB-CHANNEL-TYPE-CONSOLE
  EMB-CONSOLE-UNIT				; Not used
  EMB-CONSOLE-NEXT				; Link to next channel
  EMB-CONSOLE-OUTPUT-REQUEST-QUEUE		; Commands and data are placed in this queue
  EMB-CONSOLE-OUTPUT-REPLY-QUEUE		; Response to those commands appear here
  EMB-CONSOLE-INPUT-REQUEST-QUEUE		; Requests to read data are place in this queue
  EMB-CONSOLE-INPUT-REPLY-QUEUE			; The data appears in this queue
  EMB-CONSOLE-HOST-ADDRESS			; IP address of host where console will appear
  EMB-CONSOLE-DISPLAY-NUMBER			; Display number on the host or -1 for default
  EMB-CONSOLE-SCREEN-NUMBER			; Screen number on the host or -1 for default
  EMB-CONSOLE-INITIAL-STATE			; Console's initial state (see below)
  EMB-CONSOLE-GEOMETRY				; String specifying console's geometry
  EMB-CONSOLE-FOREGROUND-COLOR			; String naming the foreground color
  EMB-CONSOLE-BACKGROUND-COLOR			; String naming the background color
  EMB-CONSOLE-BORDER-COLOR			; String naming the border color
  EMB-CONSOLE-BORDER-WIDTH			; Width of border in pixel is greater than zero
  EMB-CONSOLE-INPUT-AVAILABLE-P)		; Non-zero whenever input is available

(DEFENUMERATED *EMB-CONSOLE-INITIAL-STATES*
	       (%EMB-CONSOLE-INITIAL-STATE-ICONIC
		%EMB-CONSOLE-INITIAL-STATE-UNSPECIFIED
		%EMB-CONSOLE-INITIAL-STATE-NORMAL)
  -1)

(DEFENUMERATED *EMB-CONSOLE-COMMANDS*
	       (%EMB-CONSOLE-COMMAND-OPEN-DISPLAY
	        %EMB-CONSOLE-COMMAND-CLOSE-DISPLAY
		%EMB-CONSOLE-COMMAND-NOOP
		%EMB-CONSOLE-COMMAND-WRITE
		%EMB-CONSOLE-COMMAND-READ
		%EMB-CONSOLE-COMMAND-INPUT-WAIT
		%EMB-CONSOLE-COMMAND-ENABLE-RUN-LIGHTS
		%EMB-CONSOLE-COMMAND-DISABLE-RUN-LIGHTS)
  1)

(DEFSTORAGE (EMB-CONSOLE-COMMAND :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
				 :PHYSICAL T)
  EMB-CONSOLE-COMMAND-OPCODE			; See above
  EMB-CONSOLE-COMMAND-ID			; Unique ID for this command
  EMB-CONSOLE-COMMAND-RESULT)			; Standard Unix error code

(DEFSTORAGE (EMB-CONSOLE-OPEN-DISPLAY :STRUCTURE NIL :FORWARDABLE NIL
				      :PRESERVE-CDR-CODES NIL :PHYSICAL T
				      :INCLUDE EMB-CONSOLE-COMMAND)
  EMB-CONSOLE-OPEN-DISPLAY-LAST-REQUEST-NUMBER)	; Last request number used to open the display

(DEFSTORAGE (EMB-CONSOLE-DATA-TRANSFER :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
				       :PHYSICAL T :INCLUDE EMB-CONSOLE-COMMAND)
  EMB-CONSOLE-DATA-TRANSFER-ADDRESS		; Address of the data buffer
  EMB-CONSOLE-DATA-TRANSFER-OFFSET		; Index in buffer of first byte to transfer
  EMB-CONSOLE-DATA-TRANSFER-N-BYTES)		; Number of bytes to transfer

(DEFSTORAGE (EMB-CONSOLE-ENABLE-RUN-LIGHTS :STRUCTURE NIL :FORWARDABLE NIL
					   :PRESERVE-CDR-CODES NIL :PHYSICAL T
					   :INCLUDE EMB-CONSOLE-COMMAND)
  EMB-CONSOLE-RUN-LIGHTS-WINDOW-ID		; Identifies window where lights will appear
  EMB-CONSOLE-RUN-LIGHTS-N-LIGHTS		; Number of run lights to be drawn
  EMB-CONSOLE-RUN-LIGHTS-WIDTH			; Width in pixels of an individual run light
  EMB-CONSOLE-RUN-LIGHTS-HEIGHT			; Height in pixels ...
  EMB-CONSOLE-RUN-LIGHTS-FIRST-X		; Horizontal position of first light in window
  EMB-CONSOLE-RUN-LIGHTS-FIRST-Y		; Vertical position ...
  EMB-CONSOLE-RUN-LIGHTS-X-SPACING		; Horizontal spacing between lights in pixels
  EMB-CONSOLE-RUN-LIGHTS-Y-SPACING		; Vertical spacing ...
  EMB-CONSOLE-RUN-LIGHTS-FOREGROUND		; Foreground color used to draw lights
  EMB-CONSOLE-RUN-LIGHTS-BACKGROUND		; Background color ...
  EMB-CONSOLE-RUN-LIGHTS-PLANE-MASK)		; Plane mask ...

(DEFSTORAGE (EMB-CONSOLE-INPUT-WAIT :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
				    :PHYSICAL T :INCLUDE EMB-CONSOLE-COMMAND)
  EMB-CONSOLE-INPUT-WAIT-TIMEOUT		; Time to wait for input in milliseconds
  EMB-CONSOLE-INPUT-WAIT-AVAILABLE-P)		; Non-zero if input available, zero if timeout


(DEFSTORAGE (EMB-DISK-CHANNEL :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
			      :PHYSICAL T)
   EMB-DISK-TYPE
   EMB-DISK-UNIT
   EMB-DISK-NEXT
   EMB-DISK-NUMBER-OF-PAGES
   EMB-DISK-COMMAND-QUEUE
   EMB-DISK-STATUS-QUEUE
   ((EMB-DISK-FLAGS)
    (EMB-DISK-HOST-BYTE-ORDER-P 1 0)		;TRUE => byte swap data for this unit if needed
    (EMB-DISK-READ-ONLY-P 1 1))			;TRUE => this unit is read only
   EMB-DISK-HOST-STATE-0			;Reserved for use by the host ...
   EMB-DISK-HOST-STATE-1			;...
   )

(DEFSTORAGE (EMB-DISK-QUEUE-ELEMENT :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
				    :PHYSICAL T)
   EMB-DISK-QUEUE-ELEMENT-ID
   EMB-DISK-QUEUE-ELEMENT-SYNC
   EMB-DISK-QUEUE-ELEMENT-OP
   EMB-DISK-QUEUE-ELEMENT-PAGE
   EMB-DISK-QUEUE-ELEMENT-COUNT
   EMB-DISK-QUEUE-ELEMENT-N-ADDRESSES
   EMB-DISK-QUEUE-ELEMENT-STATUS
   EMB-DISK-QUEUE-ELEMENT-ERROR-CODE
   ;;This is followed by pairs of pointers and word counts.
   )

(DEFENUMERATED *EMB-DISK-REQUEST-OPCODES*
	       (%EMB-DISK-READ
		%EMB-DISK-WRITE
		%EMB-DISK-RESET
		%EMB-DISK-INITIALIZE)
  1)

(DEFSYSBYTE %%EMB-DISK-OPCODE-OPCODE 3 0)
(DEFSYSBYTE %%EMB-DISK-OPCODE-TAGGED 1 3)
(DEFSYSBYTE %%EMB-DISK-OPCODE-BUFFERED 1 4)
(DEFSYSBYTE %%EMB-DISK-OPCODE-SUPPRESS-ERROR-RECOVERY-P 1 8.)

(DEFENUMERATED *EMB-DISK-STATUS-CODES*
	       (%EMB-DISK-WON
		%EMB-DISK-LOST
		%EMB-DISK-ABORTED
		%EMB-DISK-BUSY)
  1)

(DEFSTORAGE (EMB-DISK-QUEUE-ELEMENT-ADDRESSES :INCLUDE EMB-DISK-QUEUE-ELEMENT
					      :STRUCTURE NIL
					      :FORWARDABLE NIL
					      :PRESERVE-CDR-CODES NIL
					      :PHYSICAL T)
  EMB-DISK-QUEUE-ELEMENT-ADDRESSES)


(DEFSTORAGE (EMB-NETWORK-CHANNEL :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
			     :PHYSICAL T)
  EMB-NET-CHANNEL-TYPE				; 3 (%EMB-CHANNEL-TYPE-NETWORK)
  EMB-NET-CHANNEL-UNIT				; unit number
  EMB-NET-CHANNEL-NEXT				; emb-pointer to next channel
  EMB-NET-CHANNEL-STATUS
  EMB-NET-CHANNEL-XMIT-GUEST-TO-HOST-QUEUE
  EMB-NET-CHANNEL-XMIT-HOST-TO-GUEST-QUEUE
  EMB-NET-CHANNEL-RECV-GUEST-TO-HOST-QUEUE
  EMB-NET-CHANNEL-RECV-HOST-TO-GUEST-QUEUE
  EMB-NET-CHANNEL-NAME-0			; First part of interface name
  EMB-NET-CHANNEL-NAME-1			; Second part of interface name
  EMB-NET-CHANNEL-HARDWARE-ADDRESS-HIGH		; Hardware address for this interface
  EMB-NET-CHANNEL-HARDWARE-ADDRESS-LOW		;  ...
  EMB-NET-CHANNEL-HOST-PRIMARY-PROTOCOL		; Ethernet type no of host address protocol
  EMB-NET-CHANNEL-HOST-PRIMARY-ADDRESS		; Host's address on this interface
  EMB-NET-CHANNEL-GUEST-PRIMARY-PROTOCOL	; Ethernet type no of guest address protocol
  EMB-NET-CHANNEL-GUEST-PRIMARY-ADDRESS		; Guest's address on this interface
  ((EMB-NET-CHANNEL-METER-0)
   (MACIVORY-NET-CHANNEL-RECV-BUFFER-OVERWRITES)
   (SOLSTICE-NET-CHANNEL-INPUT-ERRORS)
   (VLM-NET-CHANNEL-TRANSMIT-FAILURES))
  ((EMB-NET-CHANNEL-METER-1)
   (MACIVORY-NET-CHANNEL-XMIT-TIMEOUTS)
   (SOLSTICE-NET-CHANNEL-OUTPUT-ERRORS)
   (VLM-NET-CHANNEL-RECEIVE-FAILURES))
  ((EMB-NET-CHANNEL-METER-2)
   (MACIVORY-NET-CHANNEL-RECV-ADDRESS-ERRORS)
   (SOLSTICE-NET-CHANNEL-COLLISIONS)
   (VLM-NET-CHANNEL-FALSE-RECEIVER-WAKEUPS))
  ((EMB-NET-CHANNEL-METER-3)
   (MACIVORY-NET-CHANNEL-OTHER-RECEIVE-ERRORS)
   (VLM-NET-CHANNEL-PACKETS-LOST))
  EMB-NET-CHANNEL-METER-4
  EMB-NET-CHANNEL-METER-5
  EMB-NET-CHANNEL-METER-6
  EMB-NET-CHANNEL-METER-7
  EMB-NET-CHANNEL-ADDRESS-STRING) 

(DEFSTORAGE (EMB-NET-BUFFER  :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
			     :PHYSICAL T)
   EMB-NET-BUFFER-NBYTES			; n data + header bytes this packet
   EMB-NET-BUFFER-HEADER)			; first word of header


(DEFSTORAGE (EMB-RPC-CHANNEL :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
			     :PHYSICAL T)
   EMB-RPC-TYPE					;4
   EMB-RPC-UNIT					;unit number
   EMB-RPC-NEXT					;emb-pointer to next channel
   EMB-RPC-GUEST-TO-HOST-QUEUE			;emb-pointer
   EMB-RPC-HOST-TO-GUEST-FREE-QUEUE		;emb-pointer
   EMB-RPC-HOST-TO-GUEST-QUEUE			;emb-pointer
   EMB-RPC-GUEST-TO-HOST-FREE-QUEUE		;emb-pointer
   EMB-RPC-LISTENING				;boolean
   NIL NIL NIL NIL NIL NIL)			;space for host use

;; Number of elements in embedded RPC queues.
(DEFSYSCONSTANT RPC-GUEST-TO-HOST-QUEUE-SIZE 30.)		;Guest calls/Host values
(DEFSYSCONSTANT RPC-HOST-TO-GUEST-QUEUE-SIZE 15.)		;Host calls/Guest values

(DEFSTORAGE (EMB-SCSI-CHANNEL :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
			      :PHYSICAL T)
  EMB-SCSI-TYPE					; %EMB-CHANNEL-TYPE-SCSI (5)
  EMB-SCSI-UNIT					; SCSI unit number for commands
  EMB-SCSI-NEXT					; EmbPtr to next channel
  EMB-SCSI-COMMAND-QUEUE			; EmbPtr to queue of commands from guest
  EMB-SCSI-REPLY-QUEUE)				; EmbPtr to queue of replies from host

;; Common structure of both SCSI commands and their replies.
(DEFSTORAGE (EMB-SCSI-COMMAND :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
			      :PHYSICAL T)
  EMB-SCSI-COMMAND-OPCODE			; Type of operation (see below)
  EMB-SCSI-COMMAND-UID				; Unique ID for consistency checks
  EMB-SCSI-COMMAND-BUFFER-ID			; Host ID of buffer for I/O
  EMB-SCSI-COMMAND-BUFFER-ADDRESS		; Host address of buffer for I/O
  EMB-SCSI-COMMAND-BUFFER-SIZE			; Size of buffer in bytes
  EMB-SCSI-COMMAND-ERROR-CODE			; Host specific error code if non-zero
  EMB-SCSI-COMMAND-ERROR-DATA			; Host dependent additional info about error
  EMB-SCSI-COMMAND-STATUS			; SCSI status returned by operation
  EMB-SCSI-COMMAND-MESSAGE			; SCSI message returned by operation
  EMB-SCSI-COMMAND-COMMAND-WORD-1		; First word of actual SCSI command ...
  EMB-SCSI-COMMAND-COMMAND-WORD-2		; ... 2nd word ...
  EMB-SCSI-COMMAND-COMMAND-WORD-3		; ... 3rd word
  ) 

(DEFENUMERATED *EMB-SCSI-COMMAND-OPCODES*
	       (%EMB-SCSI-COMMAND-NOOP		; Synchronize
		%EMB-SCSI-COMMAND-STARTUP	; Setup for SCSI operations
		%EMB-SCSI-COMMAND-SHUTDOWN	; Cleanup after SCSI operations
		%EMB-SCSI-COMMAND-MAXIMUM-BUFFER-SIZE	; Return maximum size of host buffer
		%EMB-SCSI-COMMAND-ALLOCATE-BUFFER	; Allocate a buffer in host memory
		%EMB-SCSI-COMMAND-DEALLOCATE-BUFFER	; Release said buffer
		%EMB-SCSI-COMMAND-ISSUE-CONTROL-COMMAND	; Execute a SCSI control class command
		%EMB-SCSI-COMMAND-ISSUE-READ-COMMAND	; Execute a SCSI read class command
		%EMB-SCSI-COMMAND-ISSUE-WRITE-COMMAND	; Execute a SCSI write class command
		%EMB-SCSI-COMMAND-RESET-SCSI-BUS))	; Reset the SCSI bus

;; Macintosh specific SCSI error codes.
(DEFENUMERATED *MACIVORY-SCSI-ERROR-CODES*
	       (%MACIVORY-SCSI-COMMAND-ERROR
		%MACIVORY-SCSI-ARBITRATION-ERROR
		%MACIVORY-SCSI-BAD-PARAMETERS-ERROR
		%MACIVORY-SCSI-PHASE-ERROR
		%MACIVORY-SCSI-COMPARE-ERROR
		%MACIVORY-SCSI-BUSY-ERROR
		%MACIVORY-SCSI-SEQUENCE-ERROR
		%MACIVORY-SCSI-BUS-TIMEOUT-ERROR
		%MACIVORY-SCSI-COMPLETION-ERROR)
  2)

;; Macintosh supplies the phase of the SCSI operation where the error
;; occured as its additional data (i.e., in EMB-SCSI-COMMAND-ERROR-DATA).
(DEFENUMERATED *MACIVORY-SCSI-ERROR-PHASES*
	       (%MACIVORY-SCSI-FREE-PHASE
		%MACIVORY-SCSI-ARBITRATION-PHASE
		%MACIVORY-SCSI-SELECTION-PHASE
		%MACIVORY-SCSI-RESELECTION-PHASE
		%MACIVORY-SCSI-COMMAND-PHASE
		%MACIVORY-SCSI-DATA-PHASE
		%MACIVORY-SCSI-STATUS-PHASE
		%MACIVORY-SCSI-MESSAGE-PHASE))

;; IFEP access to host file system.
(DEFSTORAGE (EMB-HOST-FILE-CHANNEL :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
				   :PHYSICAL T)
  EMB-HOST-FILE-TYPE				; %EMB-CHANNEL-TYPE-HOST-FILE (7)
  EMB-HOST-FILE-UNIT				; Unused
  EMB-HOST-FILE-NEXT				; EmbPtr to next channel
  EMB-HOST-FILE-COMMAND-QUEUE			; EmbPtr to queue of commands from guest
  EMB-HOST-FILE-REPLY-QUEUE)			; EmbPtr to queue of replies from host

;; Common structure of both host file access commands and their replies.
(DEFSTORAGE (EMB-HOST-FILE-COMMAND :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
				   :PHYSICAL T)
  EMB-HOST-FILE-COMMAND-OPCODE			; Type of operation (see below)
  EMB-HOST-FILE-COMMAND-UID			; Unique ID for consistency checks
  EMB-HOST-FILE-COMMAND-HOST-REFERENCE		; Host's reference for target opening
  EMB-HOST-FILE-COMMAND-ERROR-CODE		; Host independent error code if non-zero
  EMB-HOST-FILE-COMMAND-HOST-ERROR-CODE		; Host dependent error code
  ) 

(DEFENUMERATED *EMB-HOST-FILE-COMMAND-OPCODES*
	       (%EMB-HOST-FILE-COMMAND-NOOP	; Synchronize
		%EMB-HOST-FILE-COMMAND-STARTUP	; Setup for host file operations
		%EMB-HOST-FILE-COMMAND-SHUTDOWN	; Cleanup after host file operations
		%EMB-HOST-FILE-OPEN		; Open a file/directory
		%EMB-HOST-FILE-CLOSE		; Close the file/directory
		%EMB-HOST-FILE-READ-DATA	; Read data
		%EMB-HOST-FILE-WRITE-DATA	; Write data
		%EMB-HOST-FILE-READ-DIRECTORY	; Read directory
		))

(DEFENUMERATED *EMB-HOST-FILE-ERROR-CODES*
	       (%EMB-HOST-FILE-NO-ERROR
		%EMB-HOST-FILE-UNKNOWN-OPCODE
		%EMB-HOST-FILE-UNKNOWN-OPEN-MODE
		%EMB-HOST-FILE-UNKNOWN-CLOSE-MODE
		%EMB-HOST-FILE-BAD-REFERENCE	; IFEP supplied an invalid file reference
		%EMB-HOST-FILE-NOT-A-FILE	; Attempt to do a file operation on a directory
		%EMB-HOST-FILE-NOT-A-DIRECTORY	; Attempt to do a directory operation on a file
		%EMB-HOST-FILE-WRONG-DIRECTION	; Attempt to read from output or vice-versa
		%EMB-HOST-FILE-OUT-OF-BOUNDS	; Attempt to read outside file or directory
		%EMB-HOST-FILE-FILE-NOT-FOUND
		%EMB-HOST-FILE-EOF
		%EMB-HOST-FILE-IO-ERROR		; Catch all for other I/O errors
		))

(DEFSTORAGE (EMB-HOST-FILE-OPEN-COMMAND :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL
					:PHYSICAL T :INCLUDE EMB-HOST-FILE-COMMAND)
  EMB-HOST-FILE-OPEN-DIRECTION
  EMB-HOST-FILE-OPEN-PATHNAME-LENGTH		; Length in bytes of following pathname
  EMB-HOST-FILE-OPEN-PATHNAME			; First word of the pathname
  )

(DEFENUMERATED *EMB-HOST-FILE-OPEN-DIRECTIONS*
	       (%EMB-HOST-FILE-OPEN-INPUT
		%EMB-HOST-FILE-OPEN-OUTPUT
		%EMB-HOST-FILE-OPEN-DIRECTORY	; Directory listing (implicitly input).
		))

(DEFSTORAGE (EMB-HOST-FILE-CLOSE-COMMAND :STRUCTURE NIL :FORWARDABLE NIL
					 :PRESERVE-CDR-CODES NIL :PHYSICAL T
					 :INCLUDE EMB-HOST-FILE-COMMAND)
  EMB-HOST-FILE-CLOSE-MODE
  EMB-HOST-FILE-CLOSE-OPEN-DIRECTION
  )

(DEFENUMERATED *EMB-HOST-FILE-CLOSE-MODES*
	       (%EMB-HOST-FILE-CLOSE-NORMAL
		%EMB-HOST-FILE-CLOSE-ABORT
		))

(DEFSTORAGE (EMB-HOST-FILE-TRANSFER-COMMAND :STRUCTURE NIL :FORWARDABLE NIL
					    :PRESERVE-CDR-CODES NIL :PHYSICAL T
					    :INCLUDE EMB-HOST-FILE-COMMAND)
  EMB-HOST-FILE-TRANSFER-POSITION		; Byte offset in file or -1 for current offset
  EMB-HOST-FILE-TRANSFER-LENGTH			; Length in bytes of requested transfer
						; For read, overwritten with actual count
  EMB-HOST-FILE-TRANSFER-DATA			; First word of the buffer
  )

(DEFSTORAGE (EMB-HOST-FILE-DIRECTORY-ENTRY :STRUCTURE NIL :FORWARDABLE NIL
					   :PRESERVE-CDR-CODES NIL :PHYSICAL T
					   :INCLUDE EMB-HOST-FILE-COMMAND)
  EMB-HOST-FILE-DIRECTORY-ENTRY-INDEX		; Which file in directory is desired
  EMB-HOST-FILE-DIRECTORY-ENTRY-LENGTH		; Length in bytes of requested transfer,
						;   overwritten with actual count
  EMB-HOST-FILE-DIRECTORY-ENTRY-FILE-SIZE-IN-BLOCKS	; Host dependent size
  EMB-HOST-FILE-DIRECTORY-ENTRY-FILE-LENGTH-IN-BYTES	; 8-bit bytes, that is
  ((EMB-HOST-FILE-DIRECTORY-ENTRY-FLAGS)
   (EMB-HOST-FILE-DIRECTORY-ENTRY-DIRECTORY? 1 0)	; 1 if "file" is directory
   (EMB-HOST-FILE-DIRECTORY-ENTRY-DELETED? 1 1)		; 1 if file is deleted
   (EMB-HOST-FILE-DIRECTORY-ENTRY-FIXED-PAGES? 1 2)	; 1 if fixed-pages (??)
   (EMB-HOST-FILE-DIRECTORY-ENTRY-READ-ONLY? 1 3)	; 1 if read-only
   (EMB-HOST-FILE-DIRECTORY-ENTRY-LINK? 1 4)		; 1 if link
   )
  EMB-HOST-FILE-DIRECTORY-ENTRY-CREATION-DATE	; Universal time (host must convert)
  EMB-HOST-FILE-DIRECTORY-ENTRY-NAME-LENGTH	; Length of name,type,version string
  EMB-HOST-FILE-DIRECTORY-ENTRY-COMMENT-LENGTH	; Length of comment string (or link target)
  EMB-HOST-FILE-DIRECTORY-ENTRY-AUTHOR-LENGTH	; Length of author string
  EMB-HOST-FILE-DIRECTORY-ENTRY-TEXT		; First word of name, comment, author
						;   concatenated data
  )


;;;
;;; general purpose message channel.  for now, used only by serial,
;;; perhaps later consoles as well.
;;;
(DEFSTORAGE (EMB-MESSAGE-CHANNEL
	      :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL)
  EMB-MESSAGE-CHANNEL-TYPE
  EMB-MESSAGE-CHANNEL-UNIT
  EMB-MESSAGE-CHANNEL-NEXT
  EMB-MESSAGE-CHANNEL-SUBTYPE
  EMB-MESSAGE-CHANNEL-GUEST-TO-HOST-QUEUE
  EMB-MESSAGE-CHANNEL-GUEST-TO-HOST-RETURN-QUEUE
  EMB-MESSAGE-CHANNEL-GUEST-TO-HOST-IMPULSE
  EMB-MESSAGE-CHANNEL-HOST-TO-GUEST-QUEUE
  EMB-MESSAGE-CHANNEL-HOST-TO-GUEST-SUPPLY-QUEUE
  EMB-MESSAGE-CHANNEL-HOST-TO-GUEST-IMPULSE
  EMB-MESSAGE-CHANNEL-HOST-STATE-0
  EMB-MESSAGE-CHANNEL-HOST-STATE-1)

(DEFENUMERATED *EMB-MESSAGE-CHANNEL-SUBTYPES*
	       (%EMB-MESSAGE-CHANNEL-SERIAL-SUBTYPE
	       )
  1)

;;; 
;;; the first word of a message buffer.  24 bits of length (bytes?), one
;;; byte of opcode
;;;
(DEFSTORAGE (EMB-MESSAGE-HEADER :STRUCTURE NIL :FORWARDABLE NIL :PRESERVE-CDR-CODES NIL :FIXNUM-ONLY T)
  ((EMB-MESSAGE-HEADER)
   (EMB-MESSAGE-LENGTH 24. 0)
   (EMB-MESSAGE-OPCODE 8. 24.)))

