;;; -*- Mode:Lisp; Base:8 -*-
;;; [Note: Don't casually add other attributes to this file.]
;;;>
;;;> *****************************************************************************************
;;;> ** (c) Copyright 1998-1982 Symbolics, Inc.  All rights reserved.
;;;> ** Portions of font library Copyright (c) 1984 Bitstream, Inc.  All Rights Reserved.
;;;>
;;;>    The software, data, and information contained herein are proprietary to,
;;;> and comprise valuable trade secrets of, Symbolics, Inc., which intends 
;;;> to keep such software, data, and information confidential and to preserve them
;;;> as trade secrets.  They are given in confidence by Symbolics pursuant 
;;;> to a written license agreement, and may be used, copied, transmitted, and stored
;;;> only in accordance with the terms of such license.
;;;> 
;;;> Symbolics, Symbolics 3600, Symbolics 3675, Symbolics 3630, Symbolics 3640,
;;;> Symbolics 3645, Symbolics 3650, Symbolics 3653, Symbolics 3620, Symbolics 3610,
;;;> Zetalisp, Open Genera, Virtual Lisp Machine, VLM, Wheels, Dynamic Windows,
;;;> SmartStore, Semanticue, Frame-Up, Firewall, Document Examiner,
;;;> Delivery Document Examiner, "Your Next Step in Computing", Ivory, MacIvory,
;;;> MacIvory model 1, MacIvory model 2, MacIvory model 3, XL400, XL1200, XL1201,
;;;> Symbolics UX400S, Symbolics UX1200S, NXP1000, Symbolics C, Symbolics Pascal,
;;;> Symbolics Prolog, Symbolics Fortran, CLOE, CLOE Application Generator,
;;;> CLOE Developer, CLOE Runtime, Common Lisp Developer, Symbolics Concordia,
;;;> Joshua, Statice, and Minima are trademarks of Symbolics, Inc.
;;;> 
;;;> Symbolics 3670, Symbolics Common Lisp, Symbolics-Lisp, and Genera are registered
;;;> trademarks of Symbolics, Inc.
;;;>
;;;> GOVERNMENT PURPOSE RIGHTS LEGEND
;;;> 
;;;>      Contract No.: various
;;;>      Contractor Name: Symbolics, Inc.
;;;>      Contractor Address: c/o Ropes & Gray
;;;> 			 One International Place
;;;> 			 Boston, Massachusetts 02110-2624
;;;>      Expiration Date: 2/27/2018
;;;>      
;;;> The Government's rights to use, modify, reproduce, release, perform, display or
;;;> disclose this software are restricted by paragraph (b)(2) of the "Rights in
;;;> Noncommercial Computer Software and Noncommercial Computer Software Documentation"
;;;> contained in the above identified contracts.  No restrictions apply after the
;;;> expiration date shown above.  Any reproduction of the software or portions thereof
;;;> marked with this legend must also reproduce the markings.  Questions regarding
;;;> the Government's rights may be referred to the AS&T Contracts Office of the
;;;> National Reconnaissance Office, Chantilly, Virginia 20151-1715.
;;;> 
;;;>      Symbolics, Inc.
;;;>      c/o Ropes & Gray
;;;>      One International Place
;;;>      Boston, Massachusetts 02110-2624
;;;>      781-937-7655
;;;>
;;;> *****************************************************************************************
;;;>

;;; I-Machine system data representation definitions.

;;; Where the I-Machine architecture specification disagrees with this file, the spec
;;; is probably more correct.

;;; These get compiled into microcode and compiled Lisp (when subprimitives are used), so
;;; don't change them frivolously.  Also some of these are known about by hardware.

;;; Defining forms used in this file
;;;
;;; (defsysconstant name value)
;;; (defsysbyte name number-of-bits right-hand-bit-number)
;;; (defenumerated list-name (names...) [starting-value] [increment] [endingvalue])
;;;	starting-value defaults 0, increment to 1
;;;	If endingvalue is supplied, it is error-checked
;;;
;;; DEFSTORAGE ((structure-name &key (structure t)
;;; 			             (forwardable t)
;;; 				     (backwards nil)
;;; 				     (reference-offset 0)
;;; 				     (default-pointer nil)
;;; 				     (preserve-cdr-codes t))
;;; 	    &body fields)
;;; 
;;; Each field is either of the form 
;;;   field-name
;;; which defines a word-wide (object) field, or
;;;   (field-name &optional byte-size byte-position)
;;; which also defines a word-wide (object) field unless the byte parameters
;;; are supplied, or
;;;   (field-name
;;;    (field-name &optional byte-size byte-position)
;;;    (field-name &optional byte-size byte-position)
;;;    ...)
;;; which defines multiple accessors for the same word.
;;; 
;;; The DEFSTORAGE options are:
;;; 
;;; :STRUCTURE T means the object reference points to a header, so
;;; memory references to that address will use %memory-header for a
;;; little extra error checking.
;;; 
;;; :FORWARDABLE T means that the object is structure forwardable, so the
;;; computation of slot offsets will follow any forwarding of the header,
;;; and offset from that.
;;; 
;;; :BACKWARDS T means the offsets count down from zero instead of up.
;;; 
;;; :REFERENCE-OFFSET n is the offset of the first slot from the object
;;; reference.
;;; 
;;; :DEFAULT-POINTER is like the defstruct option of that name.
;;; 
;;; :PRESERVE-CDR-CODES NIL allows the SETF method for word-wide fields
;;; to cheat and not read/merge cdr codes (i.e. use %memory-write instead
;;; of %p-store-contents), which saves a memory reference.
;;;
;;; :FIXNUM-ONLY T means assume that only fixnums will appear in the slot (i.e.
;;; %P-LDB can be used), :CHECK means to check for a fixnum when reading.
;;;
;;; :PHYSICAL T means that the structures are in physical space.

(DEFSYSBYTE %%DEFSTORAGE-SIZE 6. 0)
(DEFSYSBYTE %%DEFSTORAGE-POSITION 6. 6.)
(DEFSYSBYTE %%DEFSTORAGE-OFFSET 14. 12.)
(DEFSYSBYTE %%DEFSTORAGE-FORWARDABLE 1. 26.)
(DEFSYSBYTE %%DEFSTORAGE-PHYSICAL 1. 27.)
(DEFSYSBYTE %%DEFSTORAGE-CHECK-FIXNUM-ONLY 1. 28.)
(DEFSYSBYTE %%DEFSTORAGE-FIXNUM-ONLY 1. 29.)
(DEFSYSBYTE %%DEFSTORAGE-PRESERVE-CDR-CODES 1. 30.)
(DEFSYSBYTE %%DEFSTORAGE-STRUCTURE 1. 31.)

;;; Word formats

;;; Byte fields in the 40-bit word
;;; Names same as in A, L machines (what other reason for these names would there be?)

(DEFSYSBYTE %%Q-POINTER 32. 0)			;Address field in words that point.
;; --- I think we should merge these (and the other immediate fields) into %%Q-IMMEDIATE,
;;     unless someone envisions a machine in which they're different.
(DEFSYSBYTE %%Q-FIXNUM 32. 0)		  ;Immediate fixnum field
(DEFSYSBYTE %%Q-FLONUM 32. 0)		  ;Immediate flonum, subfields defined below
(DEFSYSBYTE %%Q-TYPED-POINTER 38. 0)	  ;Data-type and address or immediate field
(DEFSYSBYTE %%Q-DATA-TYPE 6 32.)
(DEFSYSBYTE %%Q-CDR-CODE 2 38.)
;; --- (defsysbyte %%Q-TAG 8 32.)	  ;--- same as -all-but-pointer
(DEFSYSBYTE %%Q-POINTER-WITHIN-PAGE 8 0)  ;256 words per page
(DEFSYSBYTE %%Q-TAG 8. 32.)
(DEFSYSBYTE %%Q-CDR-CODE-WITHIN-TAG 2 6)
(DEFSYSBYTE %%Q-TYPE-WITHIN-TAG 6 0)

;Are these negative ones needed?
(DEFSYSBYTE %%Q-ALL-BUT-TYPED-POINTER 2 38.)
(DEFSYSBYTE %%Q-ALL-BUT-POINTER 8 32.)
(DEFSYSBYTE %%Q-ALL-BUT-CDR-CODE 38. 0)

;; --- most of the below is L-specific
;; To add a new data type, update the following (at least):
;;	*DATA-TYPES* and *POINTER-DATA-TYPES* in this file
;;	Patch *DATA-TYPE-NAME*, set up by from *DATA-TYPES* by the cold-load generator
;;	type-map-for-transport, transporter-type-map-alist in sys: l-ucode; uu.lisp
;;	*storing-type-map* in sys: l-ucode; uux.lisp and reload that whole file
;;	It is important that the form near the end of that file that sets up the
;;	no-trap type-map be executed before any other type maps are assigned.
;;	simulate-transporter in sys: l-ucode; simx.lisp
;;	and recompile the whole microcode to get the type-maps updated
;;	typep-alist and related stuff in sys: sys; lcons.lisp
;;	dbg:*good-data-types* if it is indeed a good data type
;;	Send a message to the maintainer of the FEP-resident debugger.

(DEFENUMERATED *DATA-TYPES* (
   ;; Headers, special markers, and forwarding pointers.
   DTP-NULL				  ;00 Unbound variable/function, uninitialized storage
   DTP-MONITOR-FORWARD			  ;01 This cell being monitored
   DTP-HEADER-P				  ;02 Structure header, with pointer field
   DTP-HEADER-I				  ;03 Structure header, with immediate bits
   DTP-EXTERNAL-VALUE-CELL-POINTER	  ;04 Invisible except for binding
   DTP-ONE-Q-FORWARD			  ;05 Invisible pointer (forwards one cell)
   DTP-HEADER-FORWARD			  ;06 Invisible pointer (forwards whole structure)
   DTP-ELEMENT-FORWARD			  ;07 Invisible pointer in element of structure
   ;; Numeric data types.
   DTP-FIXNUM				  ;10 Small integer
   DTP-SMALL-RATIO			  ;11 Ratio with small numerator and denominator
   DTP-SINGLE-FLOAT			  ;12 Single-precision floating point
   DTP-DOUBLE-FLOAT			  ;13 Double-precision floating point
   DTP-BIGNUM				  ;14 Big integer
   DTP-BIG-RATIO			  ;15 Ratio with big numerator or denominator
   DTP-COMPLEX				  ;16 Complex number
   DTP-SPARE-NUMBER			  ;17 A number to the hardware trap mechanism
   ;; Instance data types.
   DTP-INSTANCE				  ;20 Ordinary instance
   DTP-LIST-INSTANCE			  ;21 Instance that masquerades as a cons
   DTP-ARRAY-INSTANCE			  ;22 Instance that masquerades as an array
   DTP-STRING-INSTANCE			  ;23 Instance that masquerades as a string
   ;; Primitive data types.
   DTP-NIL				  ;24 The symbol NIL
   DTP-LIST				  ;25 A cons
   DTP-ARRAY				  ;26 An array that is not a string
   DTP-STRING				  ;27 A string
   DTP-SYMBOL				  ;30 A symbol other than NIL
   DTP-LOCATIVE				  ;31 Locative pointer
   DTP-LEXICAL-CLOSURE			  ;32 Lexical closure of a function
   DTP-DYNAMIC-CLOSURE			  ;33 Dynamic closure of a function
   DTP-COMPILED-FUNCTION		  ;34 Compiled code
   DTP-GENERIC-FUNCTION			  ;35 Generic function (see later section)
   DTP-SPARE-POINTER-1			  ;36 Spare
   DTP-SPARE-POINTER-2			  ;37 Spare
   DTP-PHYSICAL-ADDRESS			  ;40 Physical address
   DTP-SPARE-IMMEDIATE-1		  ;41 Spare
   DTP-BOUND-LOCATION			  ;42 Deep bound marker
   DTP-CHARACTER			  ;43 Common Lisp character object
   DTP-LOGIC-VARIABLE			  ;44 Unbound logic variable marker
   DTP-GC-FORWARD			  ;45 Object-moved flag for garbage collector
   DTP-EVEN-PC				  ;46 PC at first instruction in word
   DTP-ODD-PC				  ;47 PC at second instruction in word
   ;; Full-word instructions.
   DTP-CALL-COMPILED-EVEN		  ;50 Start call, address is compiled function
   DTP-CALL-COMPILED-ODD		  ;51 Start call, address is compiled function
   DTP-CALL-INDIRECT			  ;52 Start call, address is function cell
   DTP-CALL-GENERIC			  ;53 Start call, address is generic function
   DTP-CALL-COMPILED-EVEN-PREFETCH	  ;54 Like above, but prefetching is desireable
   DTP-CALL-COMPILED-ODD-PREFETCH	  ;55 Like above, but prefetching is desireable
   DTP-CALL-INDIRECT-PREFETCH		  ;56 Like above, but prefetching is desireable
   DTP-CALL-GENERIC-PREFETCH		  ;57 Like above, but prefetching is desireable
   ;; Half-word (packed) instructions consume 4 bits of data type field (opcodes 60..77).
   DTP-PACKED-INSTRUCTION-60 DTP-PACKED-INSTRUCTION-61 DTP-PACKED-INSTRUCTION-62
   DTP-PACKED-INSTRUCTION-63 DTP-PACKED-INSTRUCTION-64 DTP-PACKED-INSTRUCTION-65
   DTP-PACKED-INSTRUCTION-66 DTP-PACKED-INSTRUCTION-67 DTP-PACKED-INSTRUCTION-70
   DTP-PACKED-INSTRUCTION-71 DTP-PACKED-INSTRUCTION-72 DTP-PACKED-INSTRUCTION-73
   DTP-PACKED-INSTRUCTION-74 DTP-PACKED-INSTRUCTION-75 DTP-PACKED-INSTRUCTION-76
   DTP-PACKED-INSTRUCTION-77
   )
  0 1 100)

(DEFSYSCONSTANT *GOOD-DATA-TYPES* '(
   ;; Numeric data types.
   DTP-FIXNUM				  ;10 Small integer
   DTP-SMALL-RATIO			  ;11 Ratio with small numerator and denominator
   DTP-SINGLE-FLOAT			  ;12 Single-precision floating point
   DTP-DOUBLE-FLOAT			  ;13 Double-precision floating point
   DTP-BIGNUM				  ;14 Big integer
   DTP-BIG-RATIO			  ;15 Ratio with big numerator or denominator
   DTP-COMPLEX				  ;16 Complex number
   DTP-SPARE-NUMBER		          ;17 A number to the hardware trap mechanism
   ;; Instance data types.
   DTP-INSTANCE				  ;20 Ordinary instance
   DTP-LIST-INSTANCE			  ;21 Instance that masquerades as a cons
   DTP-ARRAY-INSTANCE			  ;22 Instance that masquerades as an array
   DTP-STRING-INSTANCE			  ;23 Instance that masquerades as a string
   ;; Primitive data types.
   DTP-NIL				  ;24 The symbol NIL
   DTP-LIST				  ;25 A cons
   DTP-ARRAY				  ;26 An array that is not a string
   DTP-STRING				  ;27 A string
   DTP-SYMBOL				  ;30 A symbol other than NIL
   DTP-LOCATIVE				  ;31 Locative pointer
   DTP-LEXICAL-CLOSURE			  ;32 Lexical closure of a function
   DTP-DYNAMIC-CLOSURE			  ;33 Dynamic closure of a function
   DTP-COMPILED-FUNCTION		  ;34 Compiled code
   DTP-GENERIC-FUNCTION			  ;35 Generic function (see later section)
   DTP-SPARE-POINTER-1		          ;36 Spare
   DTP-SPARE-POINTER-2		          ;37 Spare
   DTP-PHYSICAL-ADDRESS			  ;40 Physical address
   DTP-SPARE-IMMEDIATE-1	          ;41 Spare
   DTP-CHARACTER			  ;43 Common Lisp character object
   DTP-EVEN-PC				  ;46 PC at first instruction in word
   DTP-ODD-PC				  ;47 PC at second instruction in word
   ))

(DEFSYSCONSTANT *POINTER-DATA-TYPES* '(
   ;; Headers, special markers, and forwarding pointers.
   DTP-NULL				  ;00 Unbound variable/function, uninitialized storage
   DTP-MONITOR-FORWARD			  ;01 This cell being monitored
   DTP-HEADER-P				  ;02 Structure header, with pointer field
   DTP-EXTERNAL-VALUE-CELL-POINTER	  ;04 Invisible except for binding
   DTP-ONE-Q-FORWARD			  ;05 Invisible pointer (forwards one cell)
   DTP-HEADER-FORWARD			  ;06 Invisible pointer (forwards whole structure)
   DTP-ELEMENT-FORWARD			  ;07 Invisible pointer in element of structure
   ;; Numeric data types.
   DTP-DOUBLE-FLOAT			  ;13 Double-precision floating point
   DTP-BIGNUM				  ;14 Big integer
   DTP-BIG-RATIO			  ;15 Ratio with big numerator or denominator
   DTP-COMPLEX				  ;16 Complex number
   DTP-SPARE-NUMBER		          ;17 A number to the hardware trap mechanism
   ;; Instance data types.
   DTP-INSTANCE				  ;20 Ordinary instance
   DTP-LIST-INSTANCE			  ;21 Instance that masquerades as a cons
   DTP-ARRAY-INSTANCE			  ;22 Instance that masquerades as an array
   DTP-STRING-INSTANCE			  ;23 Instance that masquerades as a string
   ;; Primitive data types.
   DTP-NIL				  ;24 The symbol NIL
   DTP-LIST				  ;25 A cons
   DTP-ARRAY				  ;26 An array that is not a string
   DTP-STRING				  ;27 A string
   DTP-SYMBOL				  ;30 A symbol other than NIL
   DTP-LOCATIVE				  ;31 Locative pointer
   DTP-LEXICAL-CLOSURE			  ;32 Lexical closure of a function
   DTP-DYNAMIC-CLOSURE			  ;33 Dynamic closure of a function
   DTP-COMPILED-FUNCTION		  ;34 Compiled code
   DTP-GENERIC-FUNCTION			  ;35 Generic function (see later section)
   DTP-SPARE-POINTER-1		          ;36 Spare
   DTP-SPARE-POINTER-2		          ;37 Spare
   DTP-BOUND-LOCATION			  ;42 Deep bound marker
   DTP-LOGIC-VARIABLE		          ;44 Unbound logic variable marker
   DTP-GC-FORWARD			  ;45 Object-moved flag for garbage collector
   DTP-EVEN-PC				  ;46 PC at first instruction in word
   DTP-ODD-PC				  ;47 PC at second instruction in word
   ;; Full-word instructions.
   DTP-CALL-COMPILED-EVEN		  ;50 Start call, address is compiled function
   DTP-CALL-COMPILED-ODD		  ;51 Start call, address is compiled function
   DTP-CALL-INDIRECT			  ;52 Start call, address is function cell
   DTP-CALL-GENERIC			  ;53 Start call, address is generic function
   DTP-CALL-COMPILED-EVEN-PREFETCH	  ;54 Like above, but prefetching is desireable
   DTP-CALL-COMPILED-ODD-PREFETCH	  ;55 Like above, but prefetching is desireable
   DTP-CALL-INDIRECT-PREFETCH		  ;56 Like above, but prefetching is desireable
   DTP-CALL-GENERIC-PREFETCH		  ;57 Like above, but prefetching is desireable
   ))

(DEFSYSCONSTANT *IMMEDIATE-DATA-TYPES* '(
   ;; Headers, special markers, and forwarding pointers.
   DTP-HEADER-I				  ;03 Structure header, with immediate bits
   ;; Numeric data types.
   DTP-FIXNUM				  ;10 Small integer
   DTP-SMALL-RATIO			  ;11 Ratio with small numerator and denominator
   DTP-SINGLE-FLOAT			  ;12 Single-precision floating point
   ;; Spares
   DTP-PHYSICAL-ADDRESS			  ;40 Physical address
   DTP-SPARE-IMMEDIATE-1	          ;41 Spare
   ;; Primitive data types.
   DTP-CHARACTER			  ;43 Common Lisp character object
   ;; Half-word (packed) instructions consume 4 bits of data type field (opcodes 60..77).
   DTP-PACKED-INSTRUCTION-60 DTP-PACKED-INSTRUCTION-61 DTP-PACKED-INSTRUCTION-62
   DTP-PACKED-INSTRUCTION-63 DTP-PACKED-INSTRUCTION-64 DTP-PACKED-INSTRUCTION-65
   DTP-PACKED-INSTRUCTION-66 DTP-PACKED-INSTRUCTION-67 DTP-PACKED-INSTRUCTION-70
   DTP-PACKED-INSTRUCTION-71 DTP-PACKED-INSTRUCTION-72 DTP-PACKED-INSTRUCTION-73
   DTP-PACKED-INSTRUCTION-74 DTP-PACKED-INSTRUCTION-75 DTP-PACKED-INSTRUCTION-76
   DTP-PACKED-INSTRUCTION-77
   ))

;; Structure headers.
(DEFSYSBYTE %%HEADER-TYPE-FIELD 2 38.)	  ;Overlapped with cdr code
(DEFSYSBYTE %%HEADER-TYPE-FIELD-WITHIN-TAG 2 6) ;ditto

;; Headers tagged with DTP-HEADER-P.
(DEFENUMERATED *HEADER-P-TYPES* (
   %HEADER-TYPE-SYMBOL			  ;Address of pname string
   %HEADER-TYPE-INSTANCE		  ;Address of instance-descriptor array
   %HEADER-TYPE-LEADER			  ;Address of owning array
   ))					  ;and 1 spare

;; Headers tagged with DTP-HEADER-I.
(DEFENUMERATED *HEADER-I-TYPES* (
   %HEADER-TYPE-COMPILED-FUNCTION
   %HEADER-TYPE-ARRAY
   %HEADER-TYPE-NUMBER
   ;; In Ivory revision 0, the named structure bit in arrays has been moved to
   ;; this field because of a bug in array registers.
   %HEADER-TYPE-NAMED-STRUCTURE
   ))

;Subtype field if %HEADER-TYPE-NUMBER
(DEFSYSBYTE %%HEADER-SUBTYPE-FIELD 4 28.)

(DEFENUMERATED *HEADER-NUMBER-SUBTYPES*		;--- L- is *HEADER-NUMBER-TYPES*
	(%HEADER-SUBTYPE-BIGNUM			;--- L- is %HEADER-TYPE-BIGNUM
	 ))					;and 15 spares

;Fields in a byte specifier (size field will become wider later
; when we don't have user programs that know these fields by number)
(DEFSYSBYTE %%BYTE-SPEC-SIZE 6 0)		;Byte width in bits
(DEFSYSBYTE %%BYTE-SPEC-POSITION 25. 6)		;Number of bits to right of byte


;;; Numbers

(DEFSYSBYTE %%FIXNUM-SIGN 1 31.)

;; DTP-SMALL-RATIO object is an immediate with 16-bit numerator, 16-bit denominator.
;; Set data type to dtp-fixnum allow %LOGLDB/%LOGDPB to be used.
(DEFSYSBYTE %%SMALL-RATIO-SIGN 1 31.)	       ;(or convert to fixnum and use fixnum test)
(DEFSYSBYTE %%SMALL-RATIO-NUMERATOR 16. 16.)   ;2s complement numerator (use LSH), 0 illegal
(DEFSYSBYTE %%SMALL-RATIO-DENOMINATOR 16. 0)   ;unsigned denominator, 0 and 1 illegal

;; DTP-SINGLE-FLOAT			;12 Single precision floating point

;DTP-SINGLE-FLOAT and a 32-bit immediate containing the following fields
;Set data type to dtp-fixnum allow %LOGLDB/%LOGDPB to be used

(DEFSYSBYTE %%SINGLE-SIGN 1 31.)		;0 positive, 1 negative
(DEFSYSBYTE %%SINGLE-EXPONENT 8 23.)		;Excess-127. exponent
(DEFSYSBYTE %%SINGLE-FRACTION 23. 0)		;Positive fraction, with hidden 1 on left
(DEFSYSBYTE %%SINGLE-EXCEPT-SIGN 31. 0)
(DEFSYSBYTE %%SINGLE-N-BIT 1 23.)		;the hidden 1 bit, when not hidden
(DEFSYSCONSTANT %SINGLE-EXPONENT-MAX (LDB %%SINGLE-EXPONENT -1))
(DEFSYSCONSTANT %SINGLE-EXPONENT-BIAS 127.)	;The exponent of 1.0 (which is normalized)

;If the %%FLOAT-EXPONENT field is all 0's or all 1's, the number is an exception.
;	S	E	F		Number
;	Œ	0	0		Zero (positive or negative)
;	Œ	0	frac		Denormalized (frac times 2e-126)
;	Œ	377	0		Infinity (positive or negative)
;	0	377	error-code	Not a Number (due to computational error)
;	1	377	bullshit	Not a Number (data-type extension)

;The value of a floating-point number is:
;   Denormalized (exponent = 0, no hidden bit):
;       2^(1 - %single-exponent-bias) * (0.fraction)
;   Normalized (0 < exponent < %single-exponent-max, hidden bit = 1):
;       2^(exponent - %single-exponent-bias) * (1.fraction)

;; DTP-DOUBLE-FLOAT reference points to cons cell, stored big-endian.
(DEFSTORAGE (DOUBLE-FLOAT :STRUCTURE NIL :FORWARDABLE NIL)
  (DOUBLE-HIGH)
  (DOUBLE-LOW))

;; Fields similar to single float.
(DEFSYSBYTE %%DOUBLE-SIGN 1 31.)		;0 positive, 1 negative
(DEFSYSBYTE %%DOUBLE-EXPONENT 11. 20.)		;Excess 1023. exponent
(DEFSYSBYTE %%DOUBLE-FRACTION-HIGH 20. 0)	;Top 20 bits of fraction in first word
(DEFSYSBYTE %%DOUBLE-EXCEPT-SIGN-HIGH 31. 0)
(DEFSYSBYTE %%DOUBLE-N-BIT-HIGH 1 20.)		;The hidden bit, when not hidden
(DEFSYSCONSTANT %DOUBLE-EXPONENT-MAX (LDB %%DOUBLE-EXPONENT -1))
(DEFSYSCONSTANT %DOUBLE-EXPONENT-BIAS 1023.)	;The exponent of 1.0 (which is normalized)

;; DTP-BIGNUM				;14 Big integer
;; Fields in the low 28 bits of a bignum header.
(DEFSYSBYTE %%BIGNUM-SIGN 1 27.)	;0 positive, 1 negative
(DEFSYSBYTE %%BIGNUM-LENGTH 27. 0)	;Count of the words following
			;the header that contain the data.  They are all
			;positive fixnums and are stored least
			;significant first.
(DEFSTORAGE (BIGNUM :STRUCTURE T :FORWARDABLE NIL)
	    ((BIGNUM-SUBTYPE-FIELD 4 28.)
	     (BIGNUM-SIGN-FIELD 1 27.)
	     (BIGNUM-LENGTH-FIELD 27. 0)))

;; DTP-BIG-RATIO reference points to cons of numerator and denominator, both integers.
(DEFSTORAGE (BIG-RATIO :STRUCTURE NIL :FORWARDABLE NIL)
  (BIG-RATIO-NUMERATOR)
  (BIG-RATIO-DENOMINATOR))

;; DTP-COMPLEX reference points to cons of real and imaginary parts, both arbitrary numbers.
(DEFSTORAGE (COMPLEX :STRUCTURE NIL :FORWARDABLE NIL)
  (COMPLEX-REALPART)
  (COMPLEX-IMAGPART))


;;; Floating point bits, etc.

;;; FLOAT-OPERATING-MODE bits
(DEFSYSBYTE %%FLOAT-ROUNDING-MODE 2 1)		;The rounding mode

(DEFSYSBYTE %%FLOAT-TRAP-ENABLES 8. 24.)
(DEFSYSBYTE %%FLOAT-TRAP-ENABLE-NAN 1. 31.)
(DEFSYSBYTE %%FLOAT-TRAP-ENABLE-INVALID-OPERATION 1. 30.)
(DEFSYSBYTE %%FLOAT-TRAP-ENABLE-DIVISION-BY-ZERO 1. 29.)
(DEFSYSBYTE %%FLOAT-TRAP-ENABLE-DENORMALIZED-OPERAND 1. 28.)
(DEFSYSBYTE %%FLOAT-TRAP-ENABLE-OVERFLOW 1. 27.)
(DEFSYSBYTE %%FLOAT-TRAP-ENABLE-UNDERFLOW 1. 26.)
(DEFSYSBYTE %%FLOAT-TRAP-ENABLE-INEXACT-RESULT 1. 25.)
(DEFSYSBYTE %%FLOAT-TRAP-ENABLE-INTEGER-OVERFLOW 1. 24.)

(DEFENUMERATED *FLOAT-ROUNDING-MODES*
	       (%FLOAT-ROUNDING-MODE-NEAREST
		 %FLOAT-ROUNDING-MODE-ZERO
		 %FLOAT-ROUNDING-MODE-PLUS
		 %FLOAT-ROUNDING-MODE-MINUS))

(DEFSYSCONSTANT *DEFAULT-FLOAT-OPERATING-MODE*
		(%LOGDPBS 1 %%FLOAT-TRAP-ENABLE-DIVISION-BY-ZERO
			  1 %%FLOAT-TRAP-ENABLE-UNDERFLOW
			  1 %%FLOAT-TRAP-ENABLE-OVERFLOW
			  1 %%FLOAT-TRAP-ENABLE-INVALID-OPERATION
			  %FLOAT-ROUNDING-MODE-NEAREST %%FLOAT-ROUNDING-MODE
			  0))

;; Spare 10. 0
(DEFSYSBYTE %%FLOAT-FLAG-BITS 8. 24.)
(DEFSYSBYTE %%FLOAT-FLAG-NAN 1. 31.)
(DEFSYSBYTE %%FLOAT-FLAG-INVALID-OPERATION 1. 30.)
(DEFSYSBYTE %%FLOAT-FLAG-DIVISION-BY-ZERO 1. 29.)
(DEFSYSBYTE %%FLOAT-FLAG-DENORMALIZED-OPERAND 1. 28.)
(DEFSYSBYTE %%FLOAT-FLAG-OVERFLOW 1. 27.)
(DEFSYSBYTE %%FLOAT-FLAG-UNDERFLOW 1. 26.)
(DEFSYSBYTE %%FLOAT-FLAG-INEXACT-RESULT 1. 25.)
(DEFSYSBYTE %%FLOAT-FLAG-INTEGER-OVERFLOW 1. 24.)

(DEFSYSBYTE %%FLOAT-SIGNAL-BITS 8. 16.)
(DEFSYSBYTE %%FLOAT-SIGNAL-NAN 1. 23.)
(DEFSYSBYTE %%FLOAT-SIGNAL-INVALID-OPERATION 1. 22.)
(DEFSYSBYTE %%FLOAT-SIGNAL-DIVISION-BY-ZERO 1. 21.)
(DEFSYSBYTE %%FLOAT-SIGNAL-DENORMALIZED-OPERAND 1. 20.)
(DEFSYSBYTE %%FLOAT-SIGNAL-OVERFLOW 1. 19.)
(DEFSYSBYTE %%FLOAT-SIGNAL-UNDERFLOW 1. 18.)
(DEFSYSBYTE %%FLOAT-SIGNAL-INEXACT-RESULT 1. 17.)
(DEFSYSBYTE %%FLOAT-SIGNAL-INTEGER-OVERFLOW 1. 16.)

(DEFENUMERATED *DOUBLE-FLOAT-OPS*
	       (%DOUBLE-FLOAT-OP-ADD
		%DOUBLE-FLOAT-OP-SUB
		%DOUBLE-FLOAT-OP-MULTIPLY
		%DOUBLE-FLOAT-OP-DIVIDE)
  0 1 4)


;; DTP-NIL				;24 NIL
; NIL is a symbol with a separate data-type.  It lives at an address
; known about by the hardware.  T is a normal symbol with data-type of
; dtp-symbol that also lives at a known address.

;; DTP-LIST				;25 Cons pair

;Cdr-code names for lists.
;(Cdr-code field used for other things in other places).
;cdr-nil is used in the second cell of a cdr-normal pair
;If the type is dtp-header-forward, the cdr code is ignored (it will be zero)
; and the forwarding pointer points to a cdr-normal pair.
(DEFENUMERATED *CDR-CODES* 
	       (CDR-NEXT			;Cdr is following cell
		CDR-NIL				;Cdr is NIL
		CDR-NORMAL))			;Cdr is stored in following cell


;; DTP-ARRAY				;26 Array that is not a string
;; DTP-STRING				;27 Array that is a string
;; Considerably simpler than 3600.

;; An array is represented as a prefix, usually of one word but sometimes of several,
;; optionally >preceded< by a leader, followed by the data (which is missing if the
;; array is displaced or indirect).

;; The header structure of an array.
(DEFSTORAGE (ARRAY :STRUCTURE T :FORWARDABLE T)
  ;; First word (the only word for most types)
  ((ARRAY-TYPE-FIELD 6 26.)			;Type code (see below)
   ;; next three overlap type field
    (ARRAY-ELEMENT-TYPE-FIELD 2 30.)		;one of fixnum, character, boolean, object
    (ARRAY-BYTE-PACKING 3 27.)			;base 2 log (0 to 5) number of elements/word
    (ARRAY-LIST-BIT     1 26.)			;1 if ART-Q-LIST, 0 otherwise
    (ARRAY-NAMED-STRUCTURE-BIT 1 25.)		;1 if this is a named-structure
   (ARRAY-SPARE-1 1 24.)			;(spare for software use)
   (ARRAY-LEADER-LENGTH-AND-LONG-PREFIX-FIELD 9. 15.)
   (ARRAY-LONG-PREFIX-BIT 1 23.)		;1 if more than one prefix word
   (ARRAY-LEADER-LENGTH-FIELD 8 15.)		;number of elements in leader
   ;; if not long prefix format, remaining bits are length
   (ARRAY-SHORT-LENGTH-FIELD 15. 0)		;length of the array
   (ARRAY-DISPLACED-BIT 1. 14.)			;Long prefix only
   (ARRAY-DISCONTIGUOUS-BIT 1. 13.)		;1 for conformal array
   ;; if long prefix format, remaining bits are misc data followed by more stuff
   (ARRAY-LONG-SPARE 10. 3)			;(spare bits)
   (ARRAY-LONG-DIMENSIONS-FIELD 3 0)		;number of dimensions (0 to 7)
   )
  ;; Following words only if long-prefix
  ;; second word is length
  (ARRAY-LONG-LENGTH-FIELD)			;fixnum bound of linear access
  ;; Third word is index offset, which always present
  (ARRAY-INDEX-OFFSET-FIELD)			;fixnum, added to subscript
  ;; Fourth word is address of data.
  ((ARRAY-INDIRECT-POINTER))			;Locative, fixnum, or array
  ;; Dimension information follows.  There are two words per dimensions.
  ;; The first is the length of the dimension, and the second is the
  ;; multiplier for the subscript.
  )

;Values in the array-type-field
;Same lousy names as on the A-machine, since users know these names
;This will be fixed by Common Lisp
(DEFENUMERATED *ARRAY-TYPE-CODES* (
  ;; Fixna (odd ones have ARRAY-LIST-BIT set)
  ART-FIXNUM           %ARRAY-TYPE-1
  ART-16B	       %ARRAY-TYPE-3
  ART-8B	       %ARRAY-TYPE-5
  ART-4B	       %ARRAY-TYPE-7
  ART-2B	       %ARRAY-TYPE-11
  ART-1B	       %ARRAY-TYPE-13
  %ARRAY-TYPE-14       %ARRAY-TYPE-15
  %ARRAY-TYPE-16       %ARRAY-TYPE-17
  ;; Characters
  ART-FAT-STRING       %ARRAY-TYPE-21
  %ARRAY-TYPE-22       %ARRAY-TYPE-23
  ART-STRING           %ARRAY-TYPE-25
  %ARRAY-TYPE-26       %ARRAY-TYPE-27
  %ARRAY-TYPE-30       %ARRAY-TYPE-31
  %ARRAY-TYPE-32       %ARRAY-TYPE-33
  %ARRAY-TYPE-34       %ARRAY-TYPE-35
  %ARRAY-TYPE-36       %ARRAY-TYPE-37
  ;; Boolean
  %ARRAY-TYPE-40       %ARRAY-TYPE-41
  %ARRAY-TYPE-42       %ARRAY-TYPE-43
  %ARRAY-TYPE-44       %ARRAY-TYPE-45
  %ARRAY-TYPE-46       %ARRAY-TYPE-47
  %ARRAY-TYPE-50       %ARRAY-TYPE-51
  ART-BOOLEAN	       %ARRAY-TYPE-53
  %ARRAY-TYPE-54       %ARRAY-TYPE-55
  %ARRAY-TYPE-56       %ARRAY-TYPE-57
  ;; Objects
  ART-Q	 	       ART-Q-LIST
  %ARRAY-TYPE-62       %ARRAY-TYPE-63
  %ARRAY-TYPE-64       %ARRAY-TYPE-65
  %ARRAY-TYPE-66       %ARRAY-TYPE-67
  %ARRAY-TYPE-70       %ARRAY-TYPE-71
  %ARRAY-TYPE-72       %ARRAY-TYPE-73
  %ARRAY-TYPE-74       %ARRAY-TYPE-75
  %ARRAY-TYPE-76       %ARRAY-TYPE-77)
  0 1 100)

;; This list enumerates the legal combinations of array byte-packing, element-type,
;; and list-bit.  MAKE-ARRAY refuses to create arrays with other combinations.  This
;; list is turned into the boolean vector *VALID-ARRAY-TYPE-CODES* by the cold-load builder.
(DEFSYSCONSTANT VALID-ARRAY-TYPE-CODES '(
  ART-FIXNUM
  ART-16B
  ART-8B
  ART-4B
  ART-2B
  ART-1B
  ART-FAT-STRING
  ART-STRING
  ART-BOOLEAN
  ART-Q
  ART-Q-LIST))

(DEFSYSBYTE %%ARRAY-TYPE-ART-Q-LIST 1. 0.)
(DEFSYSBYTE %%ARRAY-TYPE-BYTE-PACKING 3. 1.)
(DEFSYSBYTE %%ARRAY-TYPE-ELEMENT-TYPE 2. 4.)

(DEFENUMERATED *ARRAY-ELEMENT-DATA-TYPES* (
  ARRAY-ELEMENT-TYPE-FIXNUM
  ARRAY-ELEMENT-TYPE-CHARACTER
  ARRAY-ELEMENT-TYPE-BOOLEAN
  ARRAY-ELEMENT-TYPE-OBJECT
  ))

;These A-lists are sent over by the cold-load generator, and also
;turned into arrays and stored in the array with *s around the name.
(DEFSYSCONSTANT ARRAY-ELEMENTS-PER-Q '(
  (ART-1B . 32.) (ART-2B . 16.) (ART-4B . 8) (ART-8B . 4) (ART-16B . 2)
  (ART-Q . 1) (ART-Q-LIST . 1) (ART-BOOLEAN . 32.)
  (ART-STRING . 4) (ART-FAT-STRING . 1)
  (ART-FIXNUM . 1)))

(DEFSYSCONSTANT ARRAY-BITS-PER-ELEMENT '(
  (ART-1B . 1) (ART-2B . 2) (ART-4B . 4) (ART-8B . 8) (ART-16B . 16.)
  (ART-Q . NIL) (ART-Q-LIST . NIL) (ART-BOOLEAN . 1)
  (ART-STRING . 8) (ART-FAT-STRING . NIL)
  ;; This tries to look like a numeric array.  Putting NIL here
  ;; would blur the distinction and also allow LOCF, which
  ;; would give the user an arbitrary handle to the cell.
  ;; --- no it wouldn't, that's now controlled by the array-element-type bits in the type
  (ART-FIXNUM . 32.)))

;; This list gets transformed into the art-q array *ARRAY-NULL-ELEMENT*
(DEFSYSCONSTANT ARRAY-NULL-ELEMENT '(
  (ART-1B . 0) (ART-2B . 0) (ART-4B . 0) (ART-8B . 0) (ART-16B . 0) (ART-FIXNUM . 0)
  (ART-Q . NIL) (ART-Q-LIST . NIL)
  (ART-BOOLEAN . NIL)				;Each word has 32 NILs.
  (ART-STRING . #\ )				;Each word has 4 #\ s.
  (ART-FAT-STRING . #\ )
  ))

;; This list gets transformed into the art-q array *ARRAY-NULL-WORD*
(DEFSYSCONSTANT ARRAY-NULL-WORD '(
  (ART-1B . 0) (ART-2B . 0) (ART-4B . 0) (ART-8B . 0) (ART-16B . 0) (ART-FIXNUM . 0)
  (ART-Q . NIL) (ART-Q-LIST . NIL)
  (ART-BOOLEAN . 0)				;Each word has 32 NILs.
  (ART-STRING . 0)				;Each word has 4 #\ s.
  (ART-FAT-STRING . 0)
  ))

;; Array registers (encached form of an array).
(DEFSTORAGE (ARRAY-REGISTER :STRUCTURE NIL :FORWARDABLE NIL)
  ((ARRAY-REGISTER-ARRAY))
  ((ARRAY-REGISTER-CONTROL-WORD)
   (ARRAY-REGISTER-ELEMENT-TYPE 2 30.)	  ;one of fixnum, character, boolean, object
   (ARRAY-REGISTER-BYTE-PACKING 3 27.)	  ;base 2 log (0 to 5) number of elements/word
   (ARRAY-REGISTER-EVENT-COUNT-AND-BYTE-OFFSET 27. 0.)
   (ARRAY-REGISTER-BYTE-OFFSET 5 22.)	  ;Offset within word in array element units
   (ARRAY-REGISTER-EVENT-COUNT 22. 0))
  ((ARRAY-REGISTER-BASE-ADDRESS))
  ((ARRAY-REGISTER-ARRAY-LENGTH)))



;; DTP-SYMBOL				;30 Other symbols

(DEFSTORAGE (SYMBOL :STRUCTURE T :FORWARDABLE NIL)
	(SYMBOL-PNAME-CELL)		;DTP-HEADER-P, %HEADER-TYPE-SYMBOL, addr of pname
	(SYMBOL-VALUE-CELL)
	(SYMBOL-FUNCTION-CELL)
	(SYMBOL-PROPERTY-CELL)
	(SYMBOL-PACKAGE-CELL))

(DEFENUMERATED *LEXICAL-CLOSURE-SUBTYPES*
	       (LEXICAL-CLOSURE-SUBTYPE-FUNCALLABLE-INSTANCE
		LEXICAL-CLOSURE-SUBTYPE-1
		LEXICAL-CLOSURE-SUBTYPE-LEXICAL-CLOSURE
		LEXICAL-CLOSURE-SUBTYPE-3))

;; DTP-LEXICAL-CLOSURE			;32 Lexical closure
;;; Note:  The LEXICAL-CLOSURE-SUBTYPE must correspond to CDR-NEXT or CDR-NORMAL
;;; since lexical closures are in list-space.
(DEFSTORAGE (LEXICAL-CLOSURE :STRUCTURE NIL :FORWARDABLE NIL)
  ((LEXICAL-CLOSURE-ENVIRONMENT)
   (LEXICAL-CLOSURE-SUBTYPE 2. 38.))
  (LEXICAL-CLOSURE-FUNCTION))

;; DTP-COMPILED-FUNCTION		;34 Compiled code

;;; Compiled code

;; The DTP-compiled-function contains the address of the first word of
;; the instruction part of the structure, which is not the leader.  The
;; even instruction is usually an entry instruction that accepts the
;; arguments.  There is a 2 word leader, described below, followed by
;; instructions followed by a suffix.  There is no external reference
;; table; constants are in the instruction stream.  Instructions are
;; sequenced by cdr-code.  There is a suffix after the instructions.
;; The first word of the suffix is 'extra-info'.  The car is the name of
;; the instruction; the cdr is the 'debugging-info'.  The rest of the
;; suffix is used for other software purposes.

;; The structure looks like:
;; 	Header (2 words)
;; 	...Instructions...
;;	(<function name> . <debugging-info>) ; beginning of suffix
;;      ... rest of suffix ...

;Note that this is addressed relative to the header, not the pointer, which
;points into the middle of the structure.  Use %FIND-STRUCTURE-LEADER to
;get from the pointer to the address of the header.
(DEFSTORAGE (COMPILED-FUNCTION :STRUCTURE T :FORWARDABLE NIL)
  ;; The header word, with DTP-HEADER-I, %HEADER-TYPE-COMPILED-FUNCTION
  ((CCA-SUFFIX-SIZE 14. 18.)			;number of words in suffix
   (CCA-TOTAL-SIZE 18. 0))			;total size of structure
  (CCA-FUNCTION-CELL))

(DEFSYSCONSTANT %%COMPILED-FUNCTION-NUMBER-OF-LANGUAGES 1_4.)

;A "Numeric Argument Description" is what %ARGS-INFO and ARGS-INFO return.
;This appears in the COMPILED-FUNCTION-ARGS-INFO field of the header on the L-machine,
;but on the I-machine ARGS-INFO generates it from the entry instruction.
(DEFSYSBYTE %%ARG-DESC-MAX-ARGS 8 18.)		;Maximum number of arguments (except &REST)
(DEFSYSBYTE %%ARG-DESC-MIN-ARGS 8 0.)		;Minimum number of arguments
(DEFSYSBYTE %%ARG-DESC-REST-ARG 1 10.)		;Has an &REST argument
(DEFSYSBYTE %%ARG-DESC-INTERPRETED 1 17.)	;Not a compiled function
   ;%%ARG-DESC-INTERPRETED isn't stored in compiled-functions.  It is returned by
   ;%ARGS-INFO when given a function that it doesn't understand, i.e. one such
   ;as a LAMBDA that doesn't store a numeric argument description internally.
(DEFSYSBYTE %%ARG-DESC-QUOTED 1 16.)

(DEFSYSCONSTANT %ARG-DESC-INTERPRETED 1_17.)

(DEFSYSBYTE %%Q-EVEN-INSTRUCTION 18. 0)
(DEFSYSBYTE %%Q-ODD-INSTRUCTION 18. 18.)
(DEFSYSBYTE %%Q-ODD-INSTRUCTION-WITHIN-TAG 4. 0.)
(DEFSYSBYTE %%Q-ODD-INSTRUCTION-WITHIN-POINTER 14. 18.)
(DEFSYSBYTE %%ODD-INSTRUCTION-TAG-COMPONENT 4. 14.)
(DEFSYSBYTE %%ODD-INSTRUCTION-DATA-COMPONENT 14. 0.)

(DEFSYSBYTE %%Q-INSTRUCTION-SEQUENCING 2. 38.)

(DEFENUMERATED *INSTRUCTION-SEQUENCE-CODES*
 (SEQUENCING-PC+1
  SEQUENCING-FENCE
  SEQUENCING-PC-1
  SEQUENCING-PC-EVEN+2-ODD+3))

(DEFSYSBYTE %%PACKED-INSTRUCTION-OPCODE 8. 10.)
(DEFSYSBYTE %%PACKED-INSTRUCTION-12-BIT-OPERAND 12. 0.)
(DEFSYSBYTE %%PACKED-INSTRUCTION-10-BIT-OPERAND 10. 0.)
(DEFSYSBYTE %%PACKED-INSTRUCTION-8-BIT-OPERAND 8. 0.)
(DEFSYSBYTE %%PACKED-INSTRUCTION-ADDRESSING-MODE 2. 8.)
(DEFSYSBYTE %%PACKED-INSTRUCTION-VALUE-DISPOSITION 2. 8.)

(DEFENUMERATED *STACK-ADDRESSING-MODES*
 (STACK-ADDRESSING-MODE-FRAME-POINTER
  STACK-ADDRESSING-MODE-LOCAL-POINTER
  STACK-ADDRESSING-MODE-STACK-POINTER
  STACK-ADDRESSING-MODE-IMMEDIATE))

(DEFSYSBYTE %%PACKED-INSTRUCTION-BYTE-ROTATION 5. 0.)
(DEFSYSBYTE %%PACKED-INSTRUCTION-BYTE-SIZE-1 5. 5.)

(DEFSYSBYTE %%PACKED-INSTRUCTION-TYPE-MEMBER-N 4. 8.)
(DEFSYSBYTE %%PACKED-INSTRUCTION-TYPE-MEMBER-BACKGROUND 8. 0.)

(DEFSYSBYTE %%PACKED-INSTRUCTION-LEXICAL-VAR-N 3. 10.)

(DEFSYSBYTE %%ENTRY-INSTRUCTION-MIN 8. 0.)
(DEFSYSBYTE %%ENTRY-INSTRUCTION-MAX 8. 18.)
(DEFSYSBYTE %%ENTRY-INSTRUCTION-REST-NOT-ACCEPTED 1. 10.)

;; The following bits are "spare" in the entry instruction, and used for
;; various purposes by software.

;; If set, it is illegal to create linked references to this function.
(DEFSYSBYTE %%ENTRY-INSTRUCTION-INHIBIT-LINKED-REFERENCES 1 26.)

;; If set, this is an internal function.
(DEFSYSBYTE %%ENTRY-INSTRUCTION-INTERNAL-FUNCTION-P 1 27.)

;; This bit is sometimes used to cache whether this function is current.
(DEFSYSBYTE %%ENTRY-INSTRUCTION-CURRENT-DEFINITION-P 1 28.)

;; If set, this bit indicates that a linked reference may exist to this function.
(DEFSYSBYTE %%ENTRY-INSTRUCTION-LINKED-REFERENCES-EXIST-P 1 29.)

;; If set, this bit indicates that the function may be named by a different function spec
;; than its name.
(DEFSYSBYTE %%ENTRY-INSTRUCTION-NAMED-BY-OTHER-FSPECS 1 30.)

;; This is used by the linker to indicate that any of a number of exceptional kinds of external
;; references from the compiled function exist.
(DEFSYSBYTE %%ENTRY-INSTRUCTION-COMPLEX-EXTERNAL-REFERENCES-P 1 31.)

(DEFSYSBYTE %%ENTRY-INSTRUCTION-LANGUAGE-INDEX 4. 32.)

(DEFSYSBYTE %%ENTRY-INSTRUCTION-LANGUAGE-INDEX-WITHIN-TAG 4. 0)


;; DTP-GENERIC-FUNCTION			;35 Flavor generic function

;;; Generic Functions

;Note: for best hashing performance, the size should not be a power of 2
(DEFSTORAGE (GENERIC-FUNCTION :STRUCTURE NIL :FORWARDABLE NIL)	;Referenced by DTP-GENERIC-FUNCTION
  (GENERIC-FUNCTION-NAME)		;A symbol, or a list that names a derived function
  (GENERIC-FUNCTION-ARGLIST)		;A lambda-list (first argument is dispatched upon)
  (GENERIC-FUNCTION-DEBUGGING-INFO)	;Alist similar to debugging-info of compiled-function
  (GENERIC-FUNCTION-METHOD-COMBINATION)	;Type of method-combination to be used
					;List of method-combination type symbol and parameters
					;NIL if not specified by the generic function, in
					;which case the flavor can specify it or the
					;default can be taken
  (GENERIC-FUNCTION-FLAGS)		;Fixnum full of useful bits (not defined here)
  (GENERIC-FUNCTION-FLAVORS)		;List of names of all flavors with methods for this
					;Combined methods & inherited methods don't count
  ;; This could be removed if we ever get rid of message-passing (ha ha)
  (GENERIC-FUNCTION-SELECTOR)		;Selector in flavors' handler tables: this object
					;or a message symbol
  )


;; DTP-CHARACTER			;43 Common Lisp Character object

;Real characters
;Primitive fields
(DEFSYSBYTE %%CHAR-BITS 4 28.)			;Control modifiers
(DEFSYSBYTE %%CHAR-STYLE 12. 16.)		;"font"
(DEFSYSBYTE %%CHAR-CHAR-SET 8 8)		;Character set, 0 = ascii
(DEFSYSBYTE %%CHAR-SUBINDEX 8 0)		;Index within this character set
;Combinations
(DEFSYSBYTE %%CHAR-DEVICE-FONT 20. 8)		;Style and char set, used by windows, etc.
(DEFSYSBYTE %%CHAR-ALL-BUT-SUBINDEX 24. 8)	;For checking for ascii char (i.e. bits are
						; zero, font is zero, char set is zero)
(DEFSYSBYTE %%CHAR-CODE 16. 0)			;Char set and index therein
(DEFSYSBYTE %%CHAR-STYLE-AND-BITS 16. 16.)	;Used in optimization of MAKE-CHARACTER
(DEFSYSBYTE %%CHAR-ALL 32. 0)


;;; Flavors

;This is the structure whose address is in the DTP-HEADER-P at the front of an instance.
;This must agree with the defstruct in the flavor software.

(DEFSTORAGE (FLAVOR :STRUCTURE T :FORWARDABLE T)
	(%FLAVOR-HEADER)			;The array header.
	(%FLAVOR-NAMED-STRUCTURE-SYMBOL)	;The symbol FLAVOR:FLAVOR.
	(%FLAVOR-INSTANCE-SIZE)			;The size of the instance; this is one more
						;than the number of instance-variable slots.
						;This is looked at by the garbage collector.
	(%FLAVOR-HASH-MASK)			;Loganded with the selector.
	(%FLAVOR-HASH-ADDRESS)			;Address of first entry in handler table.
	(%FLAVOR-TYPENAME)			;A symbol which is returned by TYPEP.
	)

;;; CLOS

(DEFSTORAGE (CLASS-INSTANCE-INFORMATION :STRUCTURE T :FORWARDABLE NIL)
  ;; Array header
  (%CLASS-INSTANCE-INFORMATION-HEADER)
  ;; Symbol CLOS-INTERNALS:CLASS-INSTANCE-INFORMATION
  (%CLASS-INSTANCE-INFORMATION-NAMED-STRUCTURE-SYMBOL)
  ;; Size of the instance (including its header).  This is looked at by the garbage
  ;; collector.
  (%CLASS-INSTANCE-INFORMATION-INSTANCE-SIZE)
  ;; Loganded with the selector.
  (%CLASS-INSTANCE-INFORMATION-DISPATCH-MASK)
  ;; Address of first entry in handler table.
  (%CLASS-INSTANCE-INFORMATION-DISPATCH-ADDRESS)
  ;; Class object
  (%CLASS-INSTANCE-INFORMATION-CLASS)
  ;; Dispatch table
  (%CLASS-INSTANCE-INFORMATION-DISPATCH-TABLE)
  ;; Class name
  (%CLASS-INSTANCE-INFORMATION-CLASS-NAME)
  )



;;; Stack frames.

(DEFSTORAGE (STACK-FRAME :STRUCTURE NIL :FORWARDABLE NIL)
  (FRAME-CALLER-CONTINUATION)			;Caller's continuation at start-call
  (FRAME-CALLER-CONTROL-REGISTER))		;Caller's control-register at start-call

;;; Control register.

(DEFSYSBYTE %%CR.ARGUMENT-SIZE 8. 0)	  ;Number of spread arguments supplied by caller
(DEFSYSBYTE %%CR.APPLY 1 17.)		  ;1 If caller used APPLY, 0 otherwise
(DEFSYSBYTE %%CR.VALUE-DISPOSITION 2 18.) ;The value of this function
(DEFSYSBYTE %%CR.CLEANUP-BITS 3 24.)	  ;All the cleanup bits
(DEFSYSBYTE %%CR.CLEANUP-CATCH 1 26.)	  ;There are active catch blocks in the current frame
(DEFSYSBYTE %%CR.CLEANUP-BINDINGS 1 25.)  ;There are active bindings in the current frame
(DEFSYSBYTE %%CR.TRAP-ON-EXIT-BIT 1 24.)  ;Software trap before exiting this frame
(DEFSYSBYTE %%CR.TRAP-MODE 2 30.)	  ;1 If we are executing on the "extra stack"
					  ;Extra stack inhibits sequence breaks and preemption
					  ;It also allows the "overflow" part of the stack to
					  ;be used without traps.
(DEFSYSBYTE %%CR.EXTRA-ARGUMENT 1 8.)	  ;The call instruction supplied an "extra" argument
(DEFSYSBYTE %%CR.CALLER-FRAME-SIZE 8 9.)  ;The frame size of the Caller
(DEFSYSBYTE %%CR.CALL-STARTED 1 22.)	  ;Between start-call and finish-call.
(DEFSYSBYTE %%CR.CLEANUP-IN-PROGRESS 1 23.)
(DEFSYSBYTE %%CR.INSTRUCTION-TRACE 1 29.)
(DEFSYSBYTE %%CR.CALL-TRACE 1 28.)
(DEFSYSBYTE %%CR.TRACE-PENDING 1 27.)
(DEFSYSBYTE %%CR.TRACE-BITS 3 27.)

(DEFSYSBYTE %%CR.CLEANUP-AND-TRACE-BITS 6 24.)

(DEFENUMERATED *VALUE-DISPOSITIONS* (
  VALUE-DISPOSITION-EFFECT		  ;The callers wants no return values
  VALUE-DISPOSITION-VALUE		  ;The caller wants a single return value
  VALUE-DISPOSITION-RETURN		  ;The caller wants to return whatever values are
					  ;returned by this function
  VALUE-DISPOSITION-MULTIPLE		  ;The callers wants multiple values
  ))

(DEFENUMERATED *TRAP-MODES* (
  TRAP-MODE-EMULATOR
  TRAP-MODE-EXTRA-STACK
  TRAP-MODE-IO
  TRAP-MODE-FEP))

;; Preempt Register
(DEFSYSBYTE %%PREEMPT.PENDING 1. 0.)
(DEFSYSBYTE %%PREEMPT.REQUEST 1. 1.)
(DEFSYSBYTE %%PREEMPT.CLEAR-PENDING 2 0)

;;; Binding stack

;Format of an entry in the binding stack (always 2 words)
(DEFSTORAGE (BINDING-STACK-ENTRY :BACKWARDS T :STRUCTURE NIL :FORWARDABLE NIL)
	((BINDING-STACK-CONTENTS)		;Saved contents of bound cell
	 (BINDING-STACK-SPARE-BITS 2 38.))	;2 spare bits
	((BINDING-STACK-CELL)			;Locative to the bound cell
	 (BINDING-STACK-CHAIN-BIT 1 38.)))	;1 => previous 2 words for same frame

;;; Catch blocks

;Each stack-group has a threaded list of catch blocks in its control stack.
;These blocks are used for unwind-protect also.

(DEFSTORAGE (CATCH-BLOCK :REFERENCE-OFFSET -1 :STRUCTURE NIL :FORWARDABLE NIL)
	((CATCH-BLOCK-TAG)		;The tag being caught
	 (CATCH-BLOCK-INVALID 1 38.))	;This block is now invalid
	(CATCH-BLOCK-PC)		;PC of end of catch body, or of cleanup handler
	((CATCH-BLOCK-BINDING-STACK-POINTER)	;To unwind special-variable bindings
	 (CATCH-BLOCK-UNWIND-PROTECT 1 38.))	;1 If this is an unwind protect, 0 otherwise
	((CATCH-BLOCK-PREVIOUS)		;NIL or locative to previous block in this sg
	 (CATCH-BLOCK-EXTRA-ARGUMENT 1 39.)	;Saved CR.EXTRA-ARGUMENT
	 (CATCH-BLOCK-CLEANUP-CATCH 1 38.))	;Saved CR.CLEANUP-CATCH
	((CATCH-BLOCK-CONTINUATION)	;Saved CONTINUATION register
	 ;The value disposition is used only when the catch is thrown to,
	 ;not when the body is exited normally.  Thus the microcode doesn't
	 ;process it, only the THROW function does. (The internal function
	 ;that implements the THROW special form.)
	 (CATCH-BLOCK-VALUE-DISPOSITION 2 38.))	 ;Same as FRAME-VALUE-DISPOSITION
	;The value disposition is used only when the catch is thrown to,
	;not when the body is exited normally.  Thus the microcode doesn't
	;process it, only the THROW function does. (The internal function
	;that implements the THROW special form.)
	)



;;; Stack Groups


;;;
;;;This is how much space to leave for stack-overflow processing
(DEFSYSCONSTANT CONTROL-STACK-OVERFLOW-MARGIN 400)

;;; The page fault handler wants at least this much stack to process a hard fault.
(DEFSYSCONSTANT %PAGE-FAULT-EXTRA-STACK-SIZE 300)

;This is the maximum size of a frame plus the overhead for stack-dump,
;page-fault, etc.
(DEFSYSCONSTANT CONTROL-STACK-MAX-FRAME-SIZE 112.)

;;;
;;;
;;;
;;; With the exception of stack groups in the middle of a stack group
;;; switch, the information about the control stack's state is
;;; represented with respect to the top frame on the stack (i.e. the one
;;; that execution will continue with when %STACK-GROUP-SWITCH returns)
;;; the slots SG-STACK-POINTER, SG-FRAME-POINTER, SG-NEXT-PC,
;;; SG-CONTINUATION, and SG-CONTROL-REGISTER.
(DEFSTORAGE (STACK-GROUP :STRUCTURE T :FORWARDABLE T)
  ()				     ;The array header.
  ()				     ;The named-structure-symbol (SYS:STACK-GROUP).
  (SG-NAME)			     ;Name (a string).
  (SG-LOCK)			     ;Lock for munging this stack group
  (SG-FOOTHOLD-DATA)		     ;For use by error handler and debugger.
  (SG-PREVIOUS-STACK-GROUP)	     ;Resumer (when called as a function).
  (SG-DATA-STACK-LOW)		     ;NIL if no data stack, else locative to first word.
  (SG-DATA-STACK-LIMIT)		     ;Highest address at which a frame may be created.
  (SG-ABSOLUTE-DATA-STACK-LIMIT)     ;Don't automatically grow past here
  (SG-DATA-STACK-POINTER)	     ;Locative to highest valid word.
  ;; %STACK-GROUP-SWITCH starts restoring here
  (SG-WIRED-CONTROL-STACK-LIMIT)     ;Locative to first unwired word in stack (or NIL).
				
  ;; %STACK-GROUP-SWITCH starts dumping here
  (SG-STACK-POINTER)		     ;Locative to highest valid word (SP in top frame)
  (SG-FRAME-POINTER)		     ;Frame pointer of the top frame
  (SG-NEXT-PC)			     ;Next PC for top frame
  (SG-CONTINUATION)		     ;Continuation register for top frame
  (SG-CONTROL-REGISTER)              ;Control register
  ((SG-STATUS-BITS)		     ;Fixnum full of bits as follows:
   (SG-ARG-STATUS 3 0)		     ;Call/return status: %SG-ARG-xxx symbols
   (SG-NONRESUMABILITY 6 3)	     ;Resumable if all these bits are zero.
   (SG-ACTIVE-BIT 1 3)		     ;1 if wired and loaded into a stack buffer.
   (SG-EXHAUSTED-BIT 1 4)	     ;1 if initial function returned.
   (SG-PROCESSING-ERROR-FLAG 1 5)    ;1 if in initial error processing.
   (SG-UNINITIALIZED-BIT 1 6)	     ;1 if never been preset.
				     ;2 spare nonresumability bits.
   (SG-SAFE 1 9)		     ;Call and return must match; resume is free though.

   (SG-STACK-LOAD-STARTED 1 10.)     ;STACK-LOAD/DUMP instruction in progress
   				     ;This is like FIRST-PART-DONE but not associated with
	        		     ;a particular frame.
				     ;It is not safe to trap with this bit on, because
				     ; a possible recursive stack-dump would be confused.
   (SG-HALT-ON-ERROR 1 11.)	     ;Set when in processing of trapping out for error
   				     ; to catch recursive errors
   (SG-NONTRAPPABILITY 2 10.)	     ;Two reasons to halt if error
   (SG-TRACE-FLAGS 2 12.)
   (SG-METER-ENABLE 1 12.)	     ;Set to enable function entry/exit metering
   (SG-PROLOG-METER-ENABLE 1 13.)    ;Set to enable Prolog execution tracing, etc.
   )				     ;add more flags here later
  (SG-CATCH-BLOCK-LIST)
  (SG-FPA-0)
  (SG-FPA-1)
  (SG-FPA-2)
  (SG-FPA-3)
  (SG-FPA-4)
  (SG-FLOAT-OPERATING-MODE)	     ;Value of FLOAT-OPERATING-MODE
  (SG-FLOAT-OPERATION-STATUS)        ;Value of FLOAT-OPERATION-STATUS
  (SG-ALU-ROTATE-AND-CONTROL)
  (SG-ROTATE-LATCH)		     ;rotate latch
  (SG-BAR-1)
  (SG-BAR-2)
  (SG-BAR-3)
  (SG-BINDING-STACK-POINTER)
  ;; %STACK-GROUP-SWITCH restores these values, but does not dump them
  (SG-BINDING-STACK-LIMIT)	     ;Highest legal value of SG-BINDING-STACK-POINTER.
  (SG-CONTROL-STACK-LOW)	     ;Locative to first word in stack.

  ;; Hardware-specific state which needs to be saved
  ;; Depending on the system type, these may be dumped or restored.
  (SG-HARDWARE-STATUS-0)	     ;MacIvory: bit shuffling mode
  (SG-HARDWARE-STATUS-1)
  (SG-HARDWARE-STATUS-2)
  (SG-HARDWARE-STATUS-3)
  (SG-HARDWARE-STATUS-4)
  (SG-HARDWARE-STATUS-5)
  (SG-HARDWARE-STATUS-6)
  (SG-HARDWARE-STATUS-7)
  (SG-HARDWARE-STATUS-8)
  (SG-HARDWARE-STATUS-9)
  (SG-HARDWARE-STATUS-10)
  (SG-HARDWARE-STATUS-11)
  (SG-HARDWARE-STATUS-12)
  (SG-HARDWARE-STATUS-13)
  (SG-HARDWARE-STATUS-14)

  ;; End of slots which are saved and restored.

  ;; %STACK-GROUP-SWITCH does not do anything with these values
  (SG-ERROR-TRAP-LEVEL)		     ;Recursion level of the ERROR-TRAP handler.
  (SG-WIRED-CONTROL-STACK-LOW)	     ;Locative to first wired word in stack (or NIL).
  (SG-CONTROL-STACK-LIMIT)	     ;Highest address at which a frame may be created.
  (SG-WIRED-STACK-GC-GENERATION)     ;%GC-GENERATION when wired portion was last scavenged.
  (SG-BINDING-STACK-LOW)	     ;Locative to first word in binding stack.
  (SG-ABSOLUTE-CONTROL-STACK-LIMIT)  ;Don't automatically grow past here
  (SG-ABSOLUTE-BINDING-STACK-LIMIT)  ;Don't automatically grow past here
  ((SG-WIRED-FRAME-DESCRIPTOR)
   (SG-WIRED-FRAME-OFFSET 8 0)	     ;Offset of first frame above wired-control-stack-low
   (SG-TRAP-ON-EXIT-OVERLOAD 1 8)    ;Set if the above frame has trap-on-exit set for
				     ;reasons other than wired-stack underflow
   )				     ;--More fields could be added, but check callers first.

  (SG-THREAD-NEXT)		     ;SG Threads are used to keep track of what SGs
  (SG-THREAD-PREV)		     ;have portions of their control stacks wired.

  ;; Stacks for the Logic Programming languages.
  ;; NIL or a locative to the first word in the trail stack.
  (SG-TRAIL-STACK-LOW)
  ;; NIL or a locative to the first unusable word of the trail stack.  That word
  ;; will be at the beginning of a page which, if referenced, will cause the storage
  ;; system to call SYS:TRAIL-STACK-OVERFLOW.
  (SG-TRAIL-STACK-LIMIT)
  ;; Note that there is no way to determine the trail stack pointer for a stack group.
  ;; NIL or a locative to the first word in the structure stack.
  (SG-STRUCTURE-STACK-LOW)
  ;; NIL or a locative to the first unusable word of the structure stack.  That word
  ;; will be at the beginning of a page which, if referenced, will cause the storage
  ;; system to call SYS:STRUCTURE-STACK-OVERFLOW.
  (SG-STRUCTURE-STACK-LIMIT)
  ;; Block register 3 is normally the structure stack pointer.  When that register is
  ;; used for other purposes the structure stack pointer is saved in the SSP haven below.
  ;; See WITH-BLOCK-REGISTERS and SG-STRUCTURE-STACK-POINTER for details.
  (SG-STRUCTURE-STACK-POINTER-COUNT)
  ;; The structure stack pointer, or NIL if it's in SG-BAR-3, above.  Note that this
  ;; must immediately follow SG-STRUCTURE-STACK-POINTER-COUNT.
  (SG-STRUCTURE-STACK-POINTER-HAVEN)
  )

(DEFENUMERATED *SG-ARG-STATUS-CODES*
	(%SG-ARG-NONE			;Preset or whatever, no argument desired
	 %SG-ARG-BREAK			;Interrupted or trapped, no argument desired
	 %SG-ARG-RESUME			;Exited via STACK-GROUP-RESUME, arg wanted
	 %SG-ARG-CALL			;Exited by calling an SG, arg wanted
	 %SG-ARG-RETURN))		;Exited via STACK-GROUP-RETURN, arg wanted

;Note that names for the bits in SG-NONRESUMABILITY are defined in LDATA
(DEFSYSBYTE %%SG-HALT-ON-ERROR 1 11.)

(DEFSYSCONSTANT *SB-WAKEUP-QUEUE-SIZE* 10.)


;;;; Memory layout

;; This generates the following kinds of variables:
;;   %NUMBER-OF-WIDGETS		 The total number of a kind of division.
;;   %ADDRESS-SPACE-WIDGET-SIZE  The size of one of the widgets.
;;   %FROBOZZ-SIZE-IN-WIDGETS	 This is the number of FROBOZZes which fit into a widget.
;;   %%VMA-WIDGET-NUM		 The byte field within a word which a WIDGET occupies.
;;				 Note that the "-NUM" is left off for multiple-word fields.
;;   %%WIDGET-FROBOZZ-NUM	 The byte field within a FROBOZZ which a WIDGET occupies.
;;				 Note that the "-NUM" is left off for multiple-word fields.
;;   %%WIDGET-WITHIN-FROBOZZ	 The byte field which is the offset in WIDGETs from the
;;				 beginning of a FROBOZZ.  Use this on WIDGETs, not words.
;; For more information, type c-sh-M.
(DEFINE-ADDRESS-SPACE
  ;; Byte, names, containing-name, options
  ((24.  8.) ("PAGE" "PAGES") "VPN")
  #-VLM
  ((22. 10.) ("CHUNK" "CHUNKS") "CHUNK")
  #+VLM
  ;; In the VLM, "chunks" are the host-machine page size and hence
  ;; define the granularity of memory allocation/protection operations
  ((19. 13.) ("CHUNK" "CHUNKS") "CHUNK")
  ((16. 16.) ("QUANTUM" "QUANTA") "QUANTUM")
  ((11. 21.) ("OBLAST" "OBLASTYI") "OBLAST")
  (( 5. 27.) ("ZONE" "ZONES") "ZONE")
  (( 6. 21.) ("DEMILEVEL" "DEMILEVELS") "DEMILEVEL")
  ((11. 21.) ("ZONE-AND-DEMILEVEL") NIL :NO-SIZE :NO-WITHIN)
  (( 2. 25.) ("SUBZONE") NIL)
  (( 7. 25.) ("ZONE-AND-SUBZONE") NIL :NO-SIZE :NO-WITHIN)
  (( 1. 26.) ("EPHEMERAL-HALF") NIL :NO-SIZE)
  (( 2. 24.) ("EPHEMERAL-GROUP" "EPHEMERAL-GROUPS") NIL :NO-SIZE)
  (( 3. 24.) ("EPHEMERAL-HALF-AND-GROUP") NIL :NO-SIZE :NO-WITHIN))

;; This doesn't really fit in with the above scheme...
(DEFSYSBYTE %%SUBZONE-ZONE-NUM 5 2)

;; Common idioms for the standard names defined above.
(DEFSYSCONSTANT PAGE-SIZE %ADDRESS-SPACE-PAGE-SIZE)
(DEFSYSBYTE-SYNONYM %%VMA-WORD-OFFSET %%WORD-WITHIN-PAGE)

;; PMA stuff

;; If -1 then VMA<27:0> is physical address.
(DEFSYSBYTE-SYNONYM %%VMA-EQUALS-PMA %%VMA-ZONE-NUM)
(DEFSYSBYTE-SYNONYM %%VPN-EQUALS-PPN %%VPN-ZONE-NUM)
(DEFSYSCONSTANT %VMA-EQUALS-PMA (DEFSYSBYTE-ONES %%VMA-EQUALS-PMA))
(DEFSYSBYTE-SYNONYM %%VMA-PMA %%WORD-WITHIN-ZONE)

(DEFSYSBYTE-SYNONYM %%PMA-PAGE-NUM %%VMA-PAGE-NUM)
(DEFSYSBYTE-SYNONYM %%PMA-WORD-OFFSET %%VMA-WORD-OFFSET)
(DEFSYSCONSTANT %PPN-MAX (DEFSYSBYTE-ONES %%PMA-PAGE-NUM))

;; These variables describe how much virtual memory is available.
(DEFSYSCONSTANT %NUMBER-OF-VIRTUAL-PAGES    (DPB %VMA-EQUALS-PMA %%VPN-ZONE-NUM 0))
(DEFSYSCONSTANT %NUMBER-OF-VIRTUAL-QUANTA   (DPB %VMA-EQUALS-PMA %%QUANTUM-ZONE-NUM 0))
(DEFSYSCONSTANT %NUMBER-OF-VIRTUAL-OBLASTYI (DPB %VMA-EQUALS-PMA %%OBLAST-ZONE-NUM 0))

;; Address Space Map
(DEFSYSBYTE %%QUANTUM-ADDRESS-SPACE-MAP-HIGH  10 10)
(DEFSYSBYTE %%QUANTUM-ADDRESS-SPACE-MAP-LOW    7  1)
(DEFSYSBYTE %%QUANTUM-ADDRESS-SPACE-MAP-OFFSET 1  0)
(DEFSYSBYTE %%VMA-ADDRESS-SPACE-MAP-HIGH      10 30)
(DEFSYSBYTE %%VMA-ADDRESS-SPACE-MAP-LOW        7 21)
(DEFSYSBYTE %%VMA-ADDRESS-SPACE-MAP-OFFSET     1 20)

;;; Allocation Support.

(DEFSYSCONSTANT %EPHEMERAL-ZONE 0)
(DEFSYSCONSTANT %FIRST-DYNAMIC-ZONE 1)
(DEFSYSCONSTANT %BOUNDARY-ZONE 15.)
(DEFSYSCONSTANT %LAST-DYNAMIC-ZONE 29.)
(DEFSYSCONSTANT %SAFEGUARDED-ZONE 30.)
(DEFSYSCONSTANT %WIRED-ZONE 31.)

;; %SAFEGUARDED-ZONE is divided into four subzones to enforce various constraints on
;; address space allocation.
(DEFSYSCONSTANT %SAFEGUARDED-SUBZONE-MISC 0)
(DEFSYSCONSTANT %SAFEGUARDED-SUBZONE-BINDING-STACK 1)
(DEFSYSCONSTANT %SAFEGUARDED-SUBZONE-STRUCTURE-STACK 2)
(DEFSYSCONSTANT %SAFEGUARDED-SUBZONE-CONTROL-STACK 3)

;; The level types, in increasing order of volatility
(DEFENUMERATED *LEVEL-TYPES*
  (%LEVEL-TYPE-UNALLOCATED
   %LEVEL-TYPE-WIRED
   %LEVEL-TYPE-SAFEGUARDED
   %LEVEL-TYPE-STATIC
   %LEVEL-TYPE-DYNAMIC
   %LEVEL-TYPE-EPHEMERAL))

;; There are 64 levels numbers.  The low 32 levels are ephemeral, and the
;; high 32 levels are nonephemeral.
(DEFSYSCONSTANT %NUMBER-OF-LEVELS 64.)
(DEFSYSCONSTANT %NUMBER-OF-EPHEMERAL-LEVELS 32.)

(DEFENUMERATED *PREALLOCATED-LEVELS*
  (%WIRED-LEVEL			; The only wired level
   %SAFEGUARDED-LEVEL		; The only safeguarded level
   %STATIC-LEVEL		; The default static level (more may be allocated)
   %DYNAMIC-LEVEL)		; The default dynamic level (more may be allocated)
  32.)


;;;; Area and Region Tables

;;; Sizes to which the arrays are to be set up
(DEFSYSCONSTANT NUMBER-OF-AREAS 200)
(DEFSYSCONSTANT NUMBER-OF-REGIONS 2000)
(DEFSYSCONSTANT NUMBER-OF-STACKS 400)

;Tables indexed by area number:
;	AREA-NAME		Symbol
;	AREA-MAXIMUM-SIZE	32-bit unsigned fixnum
;	AREA-REGION-SIZE	Fixnum
;	AREA-REGION-LIST	Number of first region
;	AREA-REGION-BITS	Initial value of REGION-BITS for this area

;Tables indexed by region number:
;	REGION-QUANTUM-ORIGIN	Address of start, in quanta (16b)
;	REGION-QUANTUM-LENGTH	Number of quanta of address space allocated to it (16b)
;	REGION-FREE-POINTER	Number of words actually used
;	REGION-GC-POINTER	Number of words scanned by garbage collector
;				In oldspace, has desired copyspace level number
;	REGION-FREE-POINTER-BEFORE-FLIP	Copy of REGION-FREE-POINTER made by GC
;	REGION-CREATED-PAGES	Number of words with extant pages
;	REGION-BITS		Fixnum of random fields
;	REGION-LIST-THREAD	Next region in this area, all 1's at end (16b)
;	REGION-AREA		Number of area containing this region (8b)



;ADDRESS-SPACE-MAP and REGION-BITS are wired, since the paging system needs
;to be able to translate from address to region number and from region-number
;bits for write-protect, paging-algorithm controls, and GC hook in page-write-out routine.
;REGION-QUANTUM-ORIGIN, REGION-QUANTUM-LENGTH, and REGION-FREE-POINTER are wired
;because the paging system uses them sometimes, e.g. to avoid prefetching across
;region boundaries.

;;; Entries in REGION-BITS

(DEFSYSBYTE %%REGION-REPRESENTATION-TYPE 2 0)	;Type of data
(DEFENUMERATED *REGION-REPRESENTATION-TYPES*
	  (%REGION-REPRESENTATION-TYPE-LIST
	   %REGION-REPRESENTATION-TYPE-STRUCTURE))

(DEFSYSBYTE %%REGION-SPACE-TYPE 4 2)		;GC-related
(DEFENUMERATED *REGION-SPACE-TYPES*
	(;; Nonstack regions
	 %REGION-SPACE-FREE		;free region slot  (must be zero)
	 %REGION-SPACE-OLD		;oldspace region of dynamic area
	 %REGION-SPACE-NEW		;newspace region of dynamic area
	 %REGION-SPACE-COPY		;stuff copied from oldspace goes
	 %REGION-SPACE-WEAK		;contains weak pointers, scavenged specially
	 %REGION-SPACE-5		;unused
	 %REGION-SPACE-6		;unused
	 %REGION-SPACE-7		;unused

	 ;; Stack regions
	 %REGION-SPACE-STACK		;stacks other than structure, control, or binding
	 %REGION-SPACE-STRUCTURE-STACK	;structure stacks
	 %REGION-SPACE-CONTROL-STACK	;control stacks
	 %REGION-SPACE-BINDING-STACK	;binding stacks
	 ))

;; This is a subfield of %%REGION-SPACE-TYPE, above.
(DEFSYSBYTE %%REGION-STACK 1 5)		;within region bits
(DEFSYSBYTE %%SPACE-TYPE-STACK 1 3)	;within region space type

(DEFSYSBYTE %%REGION-SCAVENGE-ENABLE 1 6)	;If 1, scavenger touches this region
(DEFSYSBYTE %%REGION-READ-ONLY 1 7)	;If 1, hardware write-protect
(DEFSYSBYTE %%REGION-SWAPIN-QUANTUM 5 8)	;Number of pages at a time to read
(DEFSYSBYTE %%REGION-TEMPORARY 1 13.)	;OK to reset this region
(DEFSYSBYTE %%REGION-PAGING-TYPE 2 14.)	;Different paging styles

(DEFENUMERATED *PAGING-TYPES*
	(%PAGING-TYPE-NORMAL		;Demand fetch with region-swapin-quantum prefetch
	 %PAGING-TYPE-SEQUENTIAL	;Same as normal, except near last prefetch is marked
	 ))				;2-3 unused

(DEFSYSBYTE %%REGION-LEVEL 6 18.)	;Level

(DEFSYSBYTE %%REGION-NO-CONS 1 24.)	;1 if region not available for allocation

(DEFSYSBYTE %%REGION-ADJUSTABLE-SIZE 1 25.)	;1 if region can be shrunk if address
						;space is getting tight.  0 in free regions.


;; The GC-POINTER field is the scavenger scan pointer in non-oldspace regions.
;; In Oldspace regions, it indicates where objects transported from this region
;; should go.

(DEFSYSBYTE %%GC-POINTER-COPYSPACE-LEVEL 8. 0)		;Objects go to this level
(DEFSYSBYTE %%GC-POINTER-COPYSPACE-REGION 16. 8.)	;Cached region to transport into.
(DEFSYSBYTE %%GC-POINTER-REORDERING-LEVEL 8. 24.)	;Temporary field used by reordering.

;;;; Storage definitions

;;;; Page Hash Table.

;;; 0 means keep searching, 1 indicates the end of a collision chain.
(DEFSYSBYTE %%PHT0-CHAIN 1 46)
;;; Virtual page described by this entry, or -1 if the entry is invalid.
(DEFSYSBYTE-SYNONYM %%PHT0-VPN %%VMA-PAGE-NUM)
(DEFSYSBYTE-SYNONYM %%PHT0-ZONE-NUM %%VMA-ZONE-NUM)
(DEFSYSCONSTANT %PHT0-INVALID-VPN (DEFSYSBYTE-ONES %%PHT0-VPN))
;;; 1 forces a fault upon any attempt to load this entry into the map.
(DEFSYSBYTE %%PHT0-FAULT-REQUEST 1 7)
;;; 1 while page is being swapped in.
(DEFSYSBYTE %%PHT0-PENDING 1 6)
;;; <5:4> spare
;;; Forced to zero whenever this entry is loaded into the map.
(DEFSYSBYTE %%PHT0-AGE 4 0)
;;; NewSpeak
(DEFSYSBYTE %%PHT0-REFERENCE-BITS 4 0)

;;; Physical page described by this entry.
(DEFSYSBYTE-SYNONYM %%PHT1-PPN %%VMA-PAGE-NUM)
;;; If 1, this page has been written and probably differs from its disk representation.
(DEFSYSBYTE %%PHT1-MODIFIED 1 7)
;;; If 1, this page cannot be written.
(DEFSYSBYTE %%PHT1-WRITE-PROTECT 1 6)
;;; If 1, locations in this page are not cached in the data cache (if any).
(DEFSYSBYTE %%PHT1-CACHE-INHIBIT 1 5)
;;; If 1, transport-traps are enabled for locations in this page.  This also forces
;;; a transport trap if an instruction from this page is executed.
(DEFSYSBYTE %%PHT1-TRANSPORT-TRAP 1 4)
;;; A bitmask with 0 for each group known not to be referenced by this page.
(DEFSYSBYTE %%PHT1-EPHEMERAL-REFERENCE 4 0)

;;; A couple probably-useful aggregate fields.
(DEFSYSBYTE %%PHT1-MAP-BITS 40 0)
(DEFSYSBYTE %%PHT1-ACCESS-BITS 10 0)

(DEFSYSCONSTANT %PHT-COLLISION-COUNT-MAX 17)


;;;; Main Memory Page Table.

;;; The MMPT contains the description for every main memory page frame.  It may be
;;; thought of as a two dimensional table with the lower %MMPT-X-BITS of PPN being
;;; the X subscript, and the upper bits an index into the MMPT-Y table which
;;; yields the Y subscript.  For the I-machine, each MMPT Y quantum describes
;;; 64K words, and the table is dynamically allocated with the required size.

(DEFSYSCONSTANT %MMPT-X-BITS  8.)
(DEFSYSCONSTANT %MMPT-Y-BITS 16.)
(DEFSYSCONSTANT %MMPT-X-SIZE (LSH 1 %MMPT-X-BITS))
(DEFSYSCONSTANT %MMPT-Y-SIZE (LSH 1 %MMPT-Y-BITS))

(DEFSYSBYTE %%PPN-MMPT-X %MMPT-X-BITS 0)
(DEFSYSBYTE %%PPN-MMPT-Y %MMPT-Y-BITS %MMPT-X-BITS)
(DEFSYSBYTE %%PMA-MMPT-X %MMPT-X-BITS 8.)
(DEFSYSBYTE %%PMA-MMPT-Y %MMPT-Y-BITS (+ %MMPT-X-BITS 8.))

(DEFSYSBYTE %%MMPT-VPN 24. 0)			;VPN of page in frame
(DEFSYSBYTE %%MMPT-STATUS 4 24.)		;Status code, see below
(DEFSYSBYTE %%MMPT-WRITE-LOCK 1 28.)		;1 = background write in progress
(DEFSYSBYTE %%MMPT-INVALID-VPN 1 29.)		;1 = VPN is invalid
(DEFSYSBYTE %%MMPT-FLUSHING 1 30.)		;1 = flush-write in progress

(DEFSYSBYTE %%MMPT1-THREAD 24. 0)		;MMPT-INDEX of next frame in queue
(DEFSYSBYTE %%MMPT1-WIRED-COUNT 3 24.)		;Number of times wired

(DEFSYSCONSTANT %MAXIMUM-WIRED-COUNT (DEFSYSBYTE-ONES %%MMPT1-WIRED-COUNT))

(DEFENUMERATED *MMPT-STATUS-CODES*		;Status codes for mmpt-status field
   (%MMPT-STATUS-NORMAL				;Normal page - VPN should be valid
    %MMPT-STATUS-FLUSHABLE			;Frame may be reused
    %MMPT-STATUS-PREFETCHED			;Prefetched and not yet referenced
    %MMPT-STATUS-PREFETCHED-MARK		;Prefetched, and on reference prefetch more
    %MMPT-STATUS-WIRED				;Wired page, otherwise normal
    %MMPT-STATUS-WRITING			;Disk write in progress
    %MMPT-STATUS-READING			;Disk read in progress
    %MMPT-STATUS-DATA-ERROR			;Frame ok, but bad page (e.g. disk error)
    %MMPT-STATUS-FRAME-ERROR			;Frame bad, never reuse (e.g. nxm, mmpe)
    %MMPT-STATUS-PREPARING			;Active in PREPARE-FRAME
    ;;12-17 undefined
    ))

(DEFSYSCONSTANT *FLUSHABLE-STATUS* (LOGIOR (EXPT 2 %MMPT-STATUS-FLUSHABLE)
					   (EXPT 2 %MMPT-STATUS-PREFETCHED)
					   (EXPT 2 %MMPT-STATUS-PREFETCHED-MARK)))

(DEFSYSCONSTANT *NORMALIZABLE-STATUS* (LOGIOR (EXPT 2 %MMPT-STATUS-NORMAL)
					      (EXPT 2 %MMPT-STATUS-FLUSHABLE)
					      (EXPT 2 %MMPT-STATUS-PREFETCHED)
					      (EXPT 2 %MMPT-STATUS-PREFETCHED-MARK)))


;;;; The SMPT is a B* tree with a guaranteed minimum density of 66%. (75% if 4way split)

;;; Header
(DEFSTORAGE (SMPT-NODE :STRUCTURE NIL :FORWARDABLE NIL)
  ((SMPT-TYPE 2 38.)
   (SMPT-COUNT))
  (SMPT-ASCENDENT))

(DEFENUMERATED *SMPT-NODE-TYPES*
  (%SMPT-BRANCH-NODE
   %SMPT-LEAF-NODE))

(DEFSYSCONSTANT %SMPT-QUANTUM 64.)		; Normal minimum disk blocking factor

(DEFSYSCONSTANT %SMPT-BRANCH-MAX 126.)		; Requires n*2+1 in addition to header
(DEFSYSCONSTANT %SMPT-LEAF-MAX 127.)		; Requires n*2 in addition to header

(DEFSYSCONSTANT %SMPT-BRANCH-SIZE (+ (DEFSTORAGE-SIZE SMPT-NODE) (* 2 %SMPT-BRANCH-MAX) 2))
(DEFSYSCONSTANT %SMPT-LEAF-SIZE (+ (DEFSTORAGE-SIZE SMPT-NODE) (* 2 %SMPT-LEAF-MAX)))

(DEFSYSBYTE %%SMPT-LEAF-VPN 30 0)
(DEFSYSBYTE %%SMPT-LEAF-N-PAGES 10 30)


;;;; Load and sysout bitmaps.

;;; *LOAD-BITMAPS* and *SYSOUT-BITMAPS* are two dimensional tables with 1 possible bit per
;;; virtual page.  Both are currently organized as 4K possible bitmaps of 4K bits each.
;;; *LOAD-BITMAPS* has a 1 for each vpn that is currently in the load file,
;;; *SYSOUT-BITMAPS* has a 1 for each vpn that started out in the load file but was moved
;;; to the swap file because it was modified.

(DEFSYSCONSTANT %NUMBER-OF-BITMAPS (EXPT 2 12.))
(DEFSYSBYTE %%VPN-BITMAP-NUM 12. 12.)
(DEFSYSBYTE %%VPN-BITMAP-INDEX 12. 0)


;;;; Miscellaneous storage defs

;;; Highest possible MMPT index is used as the end marker for the flushable queue.
(DEFSYSCONSTANT %FLUSHABLE-QUEUE-END (1- 1_24.))

(DEFSYSCONSTANT %PREFETCH-SIZE 64.)	;Blocking factor for prefetch write/read alternation

;;; While read-only errors are inhibited, pages we've un-write-protected are
;;; remembered in a table this size.  When the errors are enabled again, those
;;; pages are re-write-protected.  If the table overflows, those pages aren't
;;; write-protected until their map entries are rederived.
(DEFSYSCONSTANT %READ-ONLY-WRITTEN-PAGES-SIZE 8.)

(DEFSYSCONSTANT %PENDING-SIZE 123)		; Good hash size for flush-write pending vpns
(DEFSYSCONSTANT %BACKGROUND-SIZE 64.)		; Number of pages in background disk queue
(DEFSYSCONSTANT %SWAP-MAP-EXTENSION-SIZE 128.)	; Number of words to extend the swap map by

;;; Argument to page-fault.
(DEFENUMERATED *PAGE-FAULT-TYPES*
   (%PAGE-WRITE-FAULT				; Write access with pht-write-protect set
    %PAGE-FAULT-REQUESTED			; PHT-FAULT-REQUEST set
    %PAGE-PHT-MISS))				; Page not found in PHT (or PHTC)

;;; The main memory map (set up by the FEP) describes the portions of the physical address
;;; space that we should use as main memory.  Each entry is a (quantum,n-quanta) pair that
;;; corresponds to a contiguous portion of physical address space.  A quantum is 256
;;; pages, or 64K words, which is the granularity of the PPN<->MMPT mapping (MMPT-Y).
(DEFSYSCONSTANT %MAIN-MEMORY-MAP-QUANTUM-SIZE 200000)
(DEFSYSCONSTANT %%MAIN-MEMORY-MAP-N-QUANTA (BYTE 8 24.))  ;actually 1- the number of quanta
(DEFSYSCONSTANT %%MAIN-MEMORY-MAP-QUANTUM (BYTE 24. 0))


;;;; World load format.

;;; An I-machine world is a long sequence of 40-bit words arranged into a header, a sequence
;;; of commands describing the wired (or initial) system, a sequence of commands describing
;;; the unwired system, and some pages of data, each containing 256 40-bit words.

;;; The first four words of the world header have data-types dtp-fixnum (#o10),
;;; dtp-small-ratio (#o11), dtp-single-float (#o12), and dtp-character (#o43), respectively,
;;; and cdr-codes all cdr-nil (1).  When packed into the 32-bit representation, this choice
;;; of tags means the first 32-bit word in a world file will always have this value.
(DEFSYSCONSTANT %WORLD-HEADER-COOKIE #o14322444510)

;;; The first word in the world header contains a format code and a target architecture code.
(DEFSYSCONSTANT %%WORLD-HEADER-FORMAT-VERSION (BYTE 16. 0))
(DEFSYSCONSTANT %%WORLD-HEADER-TARGET-ARCHITECTURE (BYTE 16. 16.))

(DEFSYSCONSTANT %CURRENT-WORLD-FORMAT-VERSION 100)

(DEFSYSCONSTANT %WORLD-TARGET-ARCHITECTURE-IVORY-0 100)
(DEFSYSCONSTANT %WORLD-TARGET-ARCHITECTURE-IVORY-1 101)

;;; The second word in the world header is the number of commands in the sequence describing
;;; the wired system, and the third word is the number of commands in the sequence describing
;;; the unwired system.  The fourth word is a spare.  The fifth, sixth, seventh and eight
;;; word are checksums of the command sequences, the wired system's data pages, the unwired
;;; system's data pages, and the header, respectively.

;;; The wired and unwired systems are described by sequences of commands, each of which
;;; consists of 3 40-bit words that describe a portion of virtual address space.  Within
;;; each of the wired and unwired command sequences, the commands are sorted in order of
;;; increasing virtual address (using unsigned comparisons).
;;;
;;; The first word of a command is the starting virtual address described by the command,
;;; tagged with I-machine dtp-fixnum.  The second word of a command contains an opcode and
;;; the number of contiguous words of virtual address space described by the command.  The
;;; last word in a command is interpreted differently depending on the command opcode.
(DEFSYSCONSTANT %%WORLD-COMMAND-WORDS (BYTE 24. 0))
(DEFSYSCONSTANT %%WORLD-COMMAND-OPCODE (BYTE 8 24.))

(DEFENUMERATED *WORLD-LOAD-OPCODES* (
  ;; The affected virtual addresses should contain the contents of the data pages starting
  ;; at the FPN in the third word.  Both the starting address and the word count must be
  ;; page-aligned.  The FPN indicates the data page starting from the beginning of the
  ;; world file, in units of 256 40-bit words or 1280 bytes.
  %WORLD-OPCODE-DATA-PAGES
  ;; The affected virtual addresses should contain the 40-bit constant in the third word.
  %WORLD-OPCODE-CONSTANT
  ;; The affected virtual addresses should contain the 40-bit constant in the third word,
  ;; with the pointer field post-incremented for each address.
  %WORLD-OPCODE-CONSTANT-INCREMENTED
  ;; The affected virtual addresses should contain a copy of the virtual addresses starting
  ;; by the third word.  Forward references to addresses not yet described are not allowed.
  %WORLD-OPCODE-COPY))


;;;; Disk driver

;;; DPN - Disk Page Number
(DEFSYSBYTE %%DPN-PAGE-NUM 27. 0)		; Relative to the first page of the unit
(DEFSYSBYTE %%DPN-UNIT 5 27.)

;;; Disk Unit Table

;;; The Disk Unit Table is a 32-element array that defines the meanings of disk unit numbers.
;;; Entries are either fixnums encoded as below or arrays.
;;; Array entries have element 0 encoded as below.

(DEFSYSBYTE %%DISK-UNIT-TYPE 4 28.)

(DEFENUMERATED *DISK-UNIT-TYPES* (
   %DISK-UNIT-TYPE-NONE
   %DISK-UNIT-TYPE-EMBEDDED
   %DISK-UNIT-TYPE-ESDI
   %DISK-UNIT-TYPE-SCSI
   ))

(DEFSYSBYTE %%DISK-UNIT-EMBEDDED-CHANNEL 28. 0)

(DEFSYSBYTE %%DISK-UNIT-SCSI-ADDRESS 3 0)
(DEFSYSBYTE %%DISK-UNIT-SCSI-LOGICAL-UNIT 3 3)
(DEFSYSBYTE %%DISK-UNIT-SCSI-CONTROLLER 1 6)

(DEFSYSBYTE %%DISK-UNIT-ESDI-ID 4 0)
(DEFSYSBYTE %%DISK-UNIT-ESDI-CONTROLLER 1 6)

;;; Disk Errors

(DEFENUMERATED *DISK-ERROR-CODES* (
  %DISK-ERROR-NONE
  ;; Catch-all classes for errors that don't fit anywhere else.
  %DISK-ERROR-CONTROLLER-FAULT
  %DISK-ERROR-DRIVE-FAULT
  ;; Couldn't select the appropriate unit.
  %DISK-ERROR-SELECT
  ;; Couldn't find the desired blocks, due to positioning error
  %DISK-ERROR-SEEK
  %DISK-ERROR-SEARCH
  ;; An overrun anywhere in the disk system.
  %DISK-ERROR-OVERRUN
  ;; Uncorrectable data corruption detected by controller ECC logic.
  %DISK-ERROR-ECC
  ;; Any other form of data corruption (checksum errors, datapath parity errors, etc).
  %DISK-ERROR-DATA
  ;; A client-requested read-compare failed.
  %DISK-ERROR-COMPARE))

(DEFSYSCONSTANT %DISK-EVENT-OBJECT-SIZE 17.)		;excluding header and name

;;;; Disk driver and other possible clients.
(DEFSYSCONSTANT %WIRED-EVENT-LOG-SIZE 512.)

(DEFENUMERATED *DCW-CLASSES*
  (%CLASS-NOP  				; Non-paging DCW (e.g. user disk and non-xfer)
   %CLASS-WRITE				; Writing to page file
   %CLASS-FETCH				; Fetch from the page file
   %CLASS-PREFETCH			; Prefetch from the page file
   %CLASS-PREFETCH-MARK			; Same, but next ref causes automatic prefetch ahead
   %CLASS-FETCH-LOAD			; Fetch from the load file (sets modified)
   %CLASS-PREFETCH-LOAD			; Prefetch from the load file (sets modified)
   %CLASS-PREFETCH-LOAD-MARK		; Prefetch from the load file, and then mark
   %CLASS-USER				; User disk IO (sets modified)
   %CLASS-NETBOOT-READ			; reading for netboot; send packet
   %CLASS-NETBOOT-WRITE			; writing for netboot; return packet
   ))

;;; Type of entries for page-trace
(DEFENUMERATED *PAGE-TRACE-CLASSES*
  (%PAGE-TRACE-REPLACE
   %PAGE-TRACE-WRITE			; Must = %CLASS-WRITE
   %PAGE-TRACE-FETCH			; Must = %CLASS-FETCH
   %PAGE-TRACE-PREFETCH			; Must = %CLASS-PREFETCH
   %PAGE-TRACE-PREFETCH-MARK		; Must = %CLASS-PREFETCH-MARK
   %PAGE-TRACE-FETCH-LOAD		; Must = %CLASS-FETCH-LOAD
   %PAGE-TRACE-PREFETCH-LOAD		; Must = %CLASS-PREFETCH-LOAD
   %PAGE-TRACE-PREFETCH-LOAD-MARK	; Must = %CLASS-PREFETCH-LOAD-MARK
   %PAGE-TRACE-CREATE-PAGE
   %PAGE-TRACE-FLUSHABLE-PAGE-FAULT
   %PAGE-TRACE-PREFETCHED-PAGE-FAULT
   %PAGE-TRACE-END
   %PAGE-TRACE-FLUSH-FRAME))


;;;; Memory instruction fields

(DEFSYSBYTE %%MEMORY-CYCLE-TYPE 4 6)
(DEFSYSBYTE %%MEMORY-FIXNUM-ONLY 1 5)
(DEFSYSBYTE %%MEMORY-SET-CDR-NEXT 1 4)
(DEFSYSBYTE %%MEMORY-LAST-WORD 1 3)
(DEFSYSBYTE %%MEMORY-NO-INCREMENT 1 2)

(DEFENUMERATED *MEMORY-CYCLE-TYPES* (
  %MEMORY-DATA-READ
  %MEMORY-DATA-WRITE
  %MEMORY-BIND-READ
  %MEMORY-BIND-WRITE
  %MEMORY-BIND-READ-NO-MONITOR
  %MEMORY-BIND-WRITE-NO-MONITOR
  %MEMORY-HEADER
  %MEMORY-STRUCTURE-OFFSET
  %MEMORY-SCAVENGE
  %MEMORY-CDR
  %MEMORY-GC-COPY
  %MEMORY-RAW
  %MEMORY-RAW-TRANSLATE
  ))



;;;; Processor state spy.

(DEFSYSCONSTANT %SPY-COMMAND-RUN 0)
(DEFSYSCONSTANT %SPY-COMMAND-STOP 1)
(DEFSYSCONSTANT %SPY-COMMAND-PING 2)

(DEFSYSCONSTANT %SPY-STATUS-RUNNING 0)
(DEFSYSCONSTANT %SPY-STATUS-STOPPED 1)
(DEFSYSCONSTANT %SPY-STATUS-INDETERMINATE 2)

;;; Registers saved and restored by a spy halt.
(DEFSYSCONSTANT *SPY-BLOCK-REGISTERS* '(
; %REGISTER-BAR-0
  %REGISTER-BAR-1				;must be first
  %REGISTER-BAR-2
  %REGISTER-BAR-3
; %REGISTER-TOS
  %REGISTER-EVENT-COUNT
  %REGISTER-BINDING-STACK-POINTER
  %REGISTER-CATCH-BLOCK-LIST
  %REGISTER-CONTROL-STACK-LIMIT
  %REGISTER-CONTROL-STACK-EXTRA-LIMIT
  %REGISTER-BINDING-STACK-LIMIT
  %REGISTER-PHT-BASE
  %REGISTER-PHT-MASK
  %REGISTER-COUNT-MAP-RELOADS
  %REGISTER-LIST-CACHE-AREA
  %REGISTER-LIST-CACHE-ADDRESS
  %REGISTER-LIST-CACHE-LENGTH
  %REGISTER-STRUCTURE-CACHE-AREA
  %REGISTER-STRUCTURE-CACHE-ADDRESS
  %REGISTER-STRUCTURE-CACHE-LENGTH
  %REGISTER-STACK-FRAME-MAXIMUM-SIZE
  %REGISTER-STACK-CACHE-DUMP-QUANTUM
; %REGISTER-CONSTANT-NIL
; %REGISTER-CONSTANT-T
; %REGISTER-EA
  %REGISTER-FP
  %REGISTER-LP
; %REGISTER-E.SP
; %REGISTER-C.MACRO-SP
  %REGISTER-STACK-CACHE-LOWER-BOUND
; %REGISTER-PHT-HASH-0
; %REGISTER-PHT-HASH-1
; %REGISTER-PHT-HASH-2
; %REGISTER-PHT-HASH-3
; %REGISTER-E.PC
; %REGISTER-D.PC
; %REGISTER-I.PC
  %REGISTER-CONTINUATION
  %REGISTER-ALU-AND-ROTATE-CONTROL
  %REGISTER-CONTROL-REGISTER
; %REGISTER-CR.ARGUMENT-SIZE
  %REGISTER-EPHEMERAL-OLDSPACE-REGISTER
  %REGISTER-ZONE-OLDSPACE-REGISTER
; %REGISTER-CHIP-REVISION
  %REGISTER-FP-COPROCESSOR-PRESENT
; %REGISTER-MICROCODE-RETURN-ADDRESS
  %REGISTER-PREEMPT-REGISTER
  %REGISTER-ICACHE-CONTROL
  %REGISTER-PREFETCHER-CONTROL
  %REGISTER-MAP-CACHE-CONTROL
  %REGISTER-MEMORY-CONTROL
; %REGISTER-ECC-LOG				;clears on read
; %REGISTER-ECC-LOG-ADDRESS			;clears on read
  %REGISTER-STACK-CACHE-OVERFLOW-LIMIT
; %REGISTER-UCODE-ROM-CONTENTS
; %REGISTER-ENTRY-MAXIMUM-ARGUMENTS
; %REGISTER-LEXICAL-VARIABLE
; %REGISTER-INSTRUCTION
; %REGISTER-MEMORY-DATA
; %REGISTER-DATA-PINS
; %REGISTER-EXTENSION-REGISTER
; %REGISTER-ARRAY-HEADER-LENGTH
  ))



;;; Internal register definitions; too bad these weren't done using
;;; REGISTER-NAME.FIELD-NAME notation, as was done above.

(DEFSYSBYTE %%BAR-REGISTER 2 10.)

;;; ICache control
(DEFSYSBYTE %%ICACHE-ENABLE 1 0)

;;; Prefetcher control
(DEFSYSBYTE %%PREFETCHER-ENABLE 1 0)
(DEFSYSBYTE %%PREFETCHER-LOW-MARK 4 1)		;Sign-extended
(DEFSYSBYTE %%PREFETCHER-HIGH-MARK 4 5)

;;; %REGISTER-ALU-AND-ROTATE-CONTROL fields (DP-OP in hardware spec)

(DEFSYSBYTE %%ALU-BYTE-R	   5  0.)
(DEFSYSBYTE %%ALU-BYTE-S	   5  5.)
(DEFSYSBYTE %%ALU-FUNCTION         6 10.)
(DEFSYSBYTE %%ALU-FUNCTION-CLASS   2 14.)
(DEFSYSBYTE %%ALU-FUNCTION-BITS    4 10.)
(DEFSYSBYTE %%ALU-CONDITION	   5 16.)
(DEFSYSBYTE %%ALU-CONDITION-SENSE  1 21.)

;; The following are implemented in Rev3 only.
;; Software forces them to the proper value for compatible operation in Rev1 and Rev2.
(DEFSYSBYTE %%ALU-OUTPUT-CONDITION 1 22.)
(DEFSYSBYTE %%ALU-ENABLE-CONDITION-EXCEPTION 1 23.)
(DEFSYSBYTE %%ALU-ENABLE-LOAD-CIN 1 24.)

(DEFENUMERATED *ALU-CONDITION-SENSES*
  (%ALU-CONDITION-SENSE-TRUE
   %ALU-CONDITION-SENSE-FALSE))

(DEFENUMERATED *ALU-CONDITIONS*
  (%ALU-CONDITION-SIGNED-LESS-THAN-OR-EQUAL	  ;00
   %ALU-CONDITION-SIGNED-LESS-THAN		  ;01
   %ALU-CONDITION-NEGATIVE			  ;02
   %ALU-CONDITION-SIGNED-OVERFLOW		  ;03
   %ALU-CONDITION-UNSIGNED-LESS-THAN-OR-EQUAL	  ;04
   %ALU-CONDITION-UNSIGNED-LESS-THAN		  ;05
   %ALU-CONDITION-ZERO				  ;06
   %ALU-CONDITION-HIGH-25-ZERO			  ;07
   %ALU-CONDITION-EQ				  ;10
   %ALU-CONDITION-OP1-EPHEMERALP		  ;11
   %ALU-CONDITION-OP1-TYPE-ACCEPTABLE		  ;12
   %ALU-CONDITION-OP1-TYPE-CONDITION		  ;13
   %ALU-CONDITION-RESULT-TYPE-NIL		  ;14
   %ALU-CONDITION-OP2-FIXNUM			  ;15
   %ALU-CONDITION-FALSE				  ;16
   %ALU-CONDITION-RESULT-CDR-LOW		  ;17
   %ALU-CONDITION-CLEANUP-BITS-SET		  ;20
   %ALU-CONDITION-ADDRESS-IN-STACK-CACHE	  ;21
   %ALU-CONDITION-PENDING-SEQUENCE-BREAK-ENABLED  ;22
   %ALU-CONDITION-EXTRA-STACK-MODE		  ;23
   %ALU-CONDITION-FEP-MODE			  ;24
   %ALU-CONDITION-FP-COPROCESSOR-PRESENT	  ;25
   %ALU-CONDITION-OP1-OLDSPACEP			  ;26
   %ALU-CONDITION-STACK-CACHE-OVERFLOW		  ;27
   %ALU-CONDITION-OR-LOGIC-VARIABLE		  ;30
   ))

(DEFENUMERATED *ALU-FUNCTION-CLASSES*
  (%ALU-FUNCTION-CLASS-BOOLEAN
   %ALU-FUNCTION-CLASS-BYTE
   %ALU-FUNCTION-CLASS-ADDER
   %ALU-FUNCTION-CLASS-MULTIPLY-DIVIDE))

(DEFENUMERATED *ALU-FUNCTIONS*
  (%ALU-FUNCTION-OP-BOOLEAN-0
   %ALU-FUNCTION-OP-BOOLEAN-1
   %ALU-FUNCTION-OP-DPB
   %ALU-FUNCTION-OP-LDB
   %ALU-FUNCTION-OP-ADD
   %ALU-FUNCTION-OP-RESERVED
   %ALU-FUNCTION-OP-MULTIPLY-STEP
   %ALU-FUNCTION-OP-MULTIPLY-INVERT-STEP
   %ALU-FUNCTION-OP-DIVIDE-STEP
   %ALU-FUNCTION-OP-DIVIDE-INVERT-STEP))

(DEFENUMERATED *ALU-BYTE-BACKGROUNDS*
  (%ALU-BYTE-BACKGROUND-OP1
   %ALU-BYTE-BACKGROUND-ROTATE-LATCH
   %ALU-BYTE-BACKGROUND-ZERO))

(DEFENUMERATED *ALU-BYTE-ROTATE-LATCH*
  (%ALU-BYTE-HOLD-ROTATE-LATCH
   %ALU-BYTE-SET-ROTATE-LATCH))

(DEFENUMERATED *ALU-ADD-OP2-ACTIONS*
  (%ALU-ADD-OP2-PASS
   %ALU-ADD-OP2-INVERT))

(DEFENUMERATED *ALU-ADDER-OPS*
  (%ALU-ADD-OP2
   %ALU-ADD-ZERO))

;; Memory  Control Register
(DEFSYSBYTE %%MEMORY-CONTROL-ECC-ENABLE 1 0)
(DEFSYSBYTE %%MEMORY-CONTROL-INTERLEAVE-MASK 2 1)
(DEFSYSBYTE %%MEMORY-CONTROL-CHECK-BIT-TEST-MODE-ENABLE 1 3)

(DEFENUMERATED *MEMORY-CONTROL-INTERLEAVE-MASKS*
	       (%MEMORY-CONTROL-INTERLEAVE-1-WAY
		%MEMORY-CONTROL-INTERLEAVE-2-WAY
		%MEMORY-CONTROL-INTERLEAVE-INFINITE
		%MEMORY-CONTROL-INTERLEAVE-4-WAY))

;; ECC Log Register
(DEFSYSBYTE %%ECC-LOG-ERROR-OCCURRED 1 31.)
(DEFSYSBYTE %%ECC-LOG-ERROR-LOST 1 30.)
(DEFSYSBYTE %%ECC-LOG-SYNDROME 8 0)
(DEFSYSBYTE %%ECC-LOG-ACCESS-MASK 3 27.) ;; BITS USED IN *ECC-ERROR-LOG* INDICATING ACCESS TYPE

;; Map Cache Control Register
(DEFSYSBYTE %%MAP-CACHE-ENABLE 1 0)
(DEFSYSBYTE %%MAP-CACHE-PAGE-MODE-ENABLE 1 1)
(DEFSYSBYTE %%MAP-CACHE-PAGE-MODE-BANKS 2 2)

(DEFENUMERATED *MAP-CACHE-PAGE-MODE-BANKS*
	       (%MAP-CACHE-PAGE-MODE-1-BANK
		 %MAP-CACHE-PAGE-MODE-2-BANK))


(DEFENUMERATED *CRASH-STATES*
	       (%CRASH-NO-CRASH
		%CRASH-FATAL-ERROR
		%CRASH-TRAP))

(DEFENUMERATED *CRASH-ACTIONS*
	       (%CRASH-HALT
		%CRASH-REBOOT
		%CRASH-RESTART))


;;;; FEP/Lisp communication constants

;;; FEP sets *SYSTEM-TYPE* to one of these before starting Lisp --
;;;   The SYSTEM-CASE macro assumes that the low order 8 bits of all system types are unique.
;;;   If you ever define system types where this isn't true, you'll have to update the
;;;   TYPE-VALUE internal function of SYSTEM-CASE-EXPANDER in SYS:SYS2;MACRO.

(DEFSYSCONSTANT %SYSTEM-TYPE-I-EMULATOR-0 #o1000)
(DEFSYSCONSTANT %SYSTEM-TYPE-I-EMULATOR-1 #o1001)
(DEFSYSCONSTANT %SYSTEM-TYPE-VSBC #o1002)
(DEFSYSCONSTANT %SYSTEM-TYPE-UX400G #o1003)
(DEFSYSCONSTANT %SYSTEM-TYPE-XL400 #o1004)
(DEFSYSCONSTANT %SYSTEM-TYPE-IBUS #o1005)
(DEFSYSCONSTANT %SYSTEM-TYPE-MACIVORY-1&2 #o1006)
(DEFSYSCONSTANT %SYSTEM-TYPE-UX400S #o1007)
(DEFSYSCONSTANT %SYSTEM-TYPE-ZORA #o1010)
(DEFSYSCONSTANT %SYSTEM-TYPE-XL1200 #o1011)
(DEFSYSCONSTANT %SYSTEM-TYPE-UX1200S #o1012)
(DEFSYSCONSTANT %SYSTEM-TYPE-UX1200G #o1013)
(DEFSYSCONSTANT %SYSTEM-TYPE-MACIVORY-3 #o1014)
(DEFSYSCONSTANT %SYSTEM-TYPE-NXP1000 #o1015)
(DEFSYSCONSTANT %SYSTEM-TYPE-ALPHA-VLM #o1016)

;;; These are the operands to cold-load-stream-output-character

(DEFSYSCONSTANT *COLD-LOAD-OP-DRAW-CHAR* 0)			;default
(DEFSYSCONSTANT *COLD-LOAD-OP-SET-CURSORPOS* 1)
(DEFSYSCONSTANT *COLD-LOAD-OP-CLEAR-REST-OF-LINE* 2)
(DEFSYSCONSTANT *COLD-LOAD-OP-CLEAR-REST-OF-WINDOW* 3)
(DEFSYSCONSTANT *COLD-LOAD-OP-DISPLAY-LOZENGED-STRING* 4)	;lozenge, char is width
(DEFSYSCONSTANT *COLD-LOAD-OP-LOZENGED-CHAR* 5)			;small font
(DEFSYSCONSTANT *COLD-LOAD-OP-BEEP* 12)
(DEFSYSCONSTANT *COLD-LOAD-OP-SELECT* 13) 
(DEFSYSCONSTANT *COLD-LOAD-OP-DESELECT* 14)

(DEFENUMERATED *SLB-CONSOLE-BYTE-TYPES*
	       (%TYPE-MOUSE-SWITCH 
		%TYPE-MOUSE-MOVE
		%TYPE-ALL-KEYS-UP
		%TYPE-STATUS
		%TYPE-KEY-DOWN
		%TYPE-KEY-UP
		%TYPE-SERIAL-WINDOW
		%TYPE-SERIAL-IN))

(DEFENUMERATED *RUN-LIGHTS*
	       (SCAVENGE-RUN-LIGHT
		TRANSPORT-RUN-LIGHT
		DISK-RUN-LIGHT
		PROCESS-RUN-LIGHT
		DISK-SAVE-RUN-LIGHT
		NETWORK-RUN-LIGHT
		SPARE-RUN-LIGHT			;to get next in right place
		NETBOOT-PROGRESS-BAR		;about where real progress bar is
		))



;;;; FPA

;;; Define a bit to enable/disable the FPA in fp-coprocessor-present.
(DEFSYSBYTE %%FPA-ENABLE 1 0)

;;;---Ogilvie will give a real address for :init.
;;; Operations: unary-minus, zerop, minusp, and plusp are not supported
;;; by the FPA.  They are not included in the table of supported
;;; operations.  The naming convention for FPA operations established is
;;; here and requires that the name must include one of the following:
;;; integer, single, double, i32, f32, or f64.  This component is used
;;; to coerce an operand to the right type for the intended operation.
;;;
;;; The status registers are not arranged consecutively or contiguously,
;;; due to address lines being tied directly to AAin ABin MAin and MBin.
;;; The following pairs consist of status register number and
;;; coprocessor offset (from status base) which describe the status
;;; register layout: (0 0) (1 4) (2 8) (3 12.) (4 1) (5 5) (6 9) (7 13.)
;;; (8 2) (9 6) (10. 10.) (11. 14.)  The reset register is after the
;;; status registers.


;; Single precision addresses
(DEFSYSCONSTANT %WTL3164-OP-ADD-SINGLE 0)
(DEFSYSCONSTANT %WTL3164-OP-SUBTRACT-SINGLE 4)
(DEFSYSCONSTANT %WTL3164-OP-MULTIPLY-SINGLE 10)
(DEFSYSCONSTANT %WTL3164-OP-DIVIDE-SINGLE 14)
(DEFSYSCONSTANT %WTL3164-OP-DIVIDE-SINGLE-RATIONAL 44)
(DEFSYSCONSTANT %WTL3164-OP-EQUAL-SINGLE-POP 100)
(DEFSYSCONSTANT %WTL3164-OP-LESSP-SINGLE-POP 104)
(DEFSYSCONSTANT %WTL3164-OP-GREATERP-SINGLE-POP 110)
(DEFSYSCONSTANT %WTL3164-OP-EQUAL-SINGLE-NOPOP 120)
(DEFSYSCONSTANT %WTL3164-OP-LESSP-SINGLE-NOPOP 124)
(DEFSYSCONSTANT %WTL3164-OP-GREATERP-SINGLE-NOPOP 130)

;; Double precision addresses
(DEFSYSCONSTANT %WTL3164-OP-ADD-DOUBLE 400)
(DEFSYSCONSTANT %WTL3164-OP-SUBTRACT-DOUBLE 404)
(DEFSYSCONSTANT %WTL3164-OP-MULTIPLY-DOUBLE 410)
(DEFSYSCONSTANT %WTL3164-OP-DIVIDE-DOUBLE 414)
(DEFSYSCONSTANT %WTL3164-OP-EQUAL-DOUBLE-POP 500)
(DEFSYSCONSTANT %WTL3164-OP-LESSP-DOUBLE-POP 504)
(DEFSYSCONSTANT %WTL3164-OP-GREATERP-DOUBLE-POP 510)

;; Special addresses
(DEFSYSCONSTANT %WTL3164-OP-F64F32-ROUND 440)
(DEFSYSCONSTANT %WTL3164-OP-F32F64-ROUND 444)
(DEFSYSCONSTANT %WTL3164-OP-F64I32-TRUNCATE 450)
(DEFSYSCONSTANT %WTL3164-OP-F32I32-TRUNCATE 454)
(DEFSYSCONSTANT %WTL3164-OP-I32F64-ROUND 460)
(DEFSYSCONSTANT %WTL3164-OP-I32F32-TRUNCATE 464)
(DEFSYSCONSTANT %WTL3164-OP-F64I32-ROUND 550)
(DEFSYSCONSTANT %WTL3164-OP-F32I32-ROUND 554)
(DEFSYSCONSTANT %WTL3164-OP-MULTIPLY-INTEGER 560)
(DEFSYSCONSTANT %WTL3164-OP-SQRT-SINGLE 650)
(DEFSYSCONSTANT %WTL3164-OP-SQRT-DOUBLE 654)

;; Control operations
(DEFSYSCONSTANT %WTL3164-OP-STATUS 760)
(DEFSYSCONSTANT %WTL3164-OP-RESET 776)
(DEFSYSCONSTANT %WTL3164-OP-INIT 756)

;;; Single precision operations.
(DEFSYSCONSTANT *WTL3164-SINGLE-OPERATIONS*
  '(%WTL3164-OP-ADD-SINGLE
    %WTL3164-OP-SUBTRACT-SINGLE
    %WTL3164-OP-MULTIPLY-SINGLE 
    %WTL3164-OP-DIVIDE-SINGLE
    %WTL3164-OP-DIVIDE-SINGLE-RATIONAL
    %WTL3164-OP-EQUAL-SINGLE-POP
    %WTL3164-OP-LESSP-SINGLE-POP
    %WTL3164-OP-GREATERP-SINGLE-POP
    %WTL3164-OP-EQUAL-SINGLE-NOPOP
    %WTL3164-OP-LESSP-SINGLE-NOPOP
    %WTL3164-OP-GREATERP-SINGLE-NOPOP))

;;; Double precision operations.
(DEFSYSCONSTANT *WTL3164-DOUBLE-OPERATIONS*
  '(%WTL3164-OP-ADD-DOUBLE
    %WTL3164-OP-SUBTRACT-DOUBLE
    %WTL3164-OP-MULTIPLY-DOUBLE
    %WTL3164-OP-DIVIDE-DOUBLE
    %WTL3164-OP-EQUAL-DOUBLE-POP
    %WTL3164-OP-LESSP-DOUBLE-POP
    %WTL3164-OP-GREATERP-DOUBLE-POP))

;;; Special operations.  The status and reset operations is omitted
;;; because they doesn't follow the same operational procedure as the
;;; other special operations.  The operation :multiply-integer has also
;;; been omitted because it's the only diadic operation, the rest are
;;; modadic.  :multiply integer is handled specially later.
(DEFSYSCONSTANT *WTL3164-SPECIAL-OPERATIONS*
  '(%WTL3164-OP-F64F32-ROUND
    %WTL3164-OP-F32F64-ROUND
    %WTL3164-OP-F64I32-TRUNCATE
    %WTL3164-OP-F32I32-TRUNCATE
    %WTL3164-OP-I32F64-ROUND
    %WTL3164-OP-I32F32-TRUNCATE
    %WTL3164-OP-F64I32-ROUND
    %WTL3164-OP-F32I32-ROUND
    %WTL3164-OP-SQRT-SINGLE
    %WTL3164-OP-SQRT-DOUBLE))

;;;  Define a list of all the arithmetic operations.  Status, reset, and
;;;  init are not included.
(DEFSYSCONSTANT *WTL3164-FPA-OPERATIONS*
  '(%WTL3164-OP-ADD-SINGLE
    %WTL3164-OP-SUBTRACT-SINGLE
    %WTL3164-OP-MULTIPLY-SINGLE 
    %WTL3164-OP-DIVIDE-SINGLE
    %WTL3164-OP-DIVIDE-SINGLE-RATIONAL
    %WTL3164-OP-EQUAL-SINGLE-POP
    %WTL3164-OP-LESSP-SINGLE-POP
    %WTL3164-OP-GREATERP-SINGLE-POP
    %WTL3164-OP-EQUAL-SINGLE-NOPOP
    %WTL3164-OP-LESSP-SINGLE-NOPOP
    %WTL3164-OP-GREATERP-SINGLE-NOPOP
    %WTL3164-OP-ADD-DOUBLE
    %WTL3164-OP-SUBTRACT-DOUBLE
    %WTL3164-OP-MULTIPLY-DOUBLE
    %WTL3164-OP-DIVIDE-DOUBLE
    %WTL3164-OP-EQUAL-DOUBLE-POP
    %WTL3164-OP-LESSP-DOUBLE-POP
    %WTL3164-OP-GREATERP-DOUBLE-POP
    %WTL3164-OP-F64F32-ROUND
    %WTL3164-OP-F32F64-ROUND
    %WTL3164-OP-F64I32-TRUNCATE
    %WTL3164-OP-F32I32-TRUNCATE
    %WTL3164-OP-I32F64-ROUND
    %WTL3164-OP-I32F32-TRUNCATE
    %WTL3164-OP-F64I32-ROUND
    %WTL3164-OP-F32I32-ROUND
    %WTL3164-OP-SQRT-SINGLE
    %WTL3164-OP-SQRT-DOUBLE
    %WTL3164-OP-MULTIPLY-INTEGER))

;;;
;;; FPA status
;;;
;;; For the sake of brevity, "fpa" is used in forming register names
;;; that are really WTL3164 specific.  This shouldn't cause any problems
;;; (atleast until another FPA is supported).

;;; Status register names and offsets
(DEFENUMERATED *WTL3164-STATUS-REGISTERS*
  (FPA-MODES-0
   FPA-MODES-1
   FPA-TRAP-ENABLES
   FPA-STICKY-BITS
   FPA-MULTIPLY-DESTINATION-0
   FPA-ALU-DESTINATION-0
   FPA-MULTIPLY-STATUS-0
   FPA-DIVIDE-DESTINATION
   FPA-MULTIPLY-DESTINATION-1
   FPA-ALU-DESTINATION-1
   FPA-MULTIPLY-STATUS-1
   FPA-DIVIDE-STATUS))

;;; fpa status register select lines
(DEFSYSBYTE %%FPA-MAIN 1 0)
(DEFSYSBYTE %%FPA-AAIN 1 1)
(DEFSYSBYTE %%FPA-MBIN 1 2)
(DEFSYSBYTE %%FPA-ABIN 1 3)
(DEFSYSBYTE %%FPA-STATUS 8 24.)			;status (read or write) is done from high byte

;;; fpa-modes-0
(DEFSYSBYTE %%FPA0.FAST-MODE 1 0)
(DEFSYSBYTE %%FPA0.ROUNDING-MODE 2 1)
(DEFSYSBYTE %%FPA0.INTERNAL-NEUT-ON 1 3)
(DEFSYSBYTE %%FPA0.SR0-MBZ 2 4)
(DEFSYSBYTE %%FPA0.FPEX-STICKY 1 6)
(DEFSYSBYTE %%FPA0.MULTIPLIER-LATENCY 1 7)

;;; fpa-modes-1
(DEFSYSBYTE %%FPA1.IO-MODE 5 0)
(DEFSYSBYTE %%FPA1.IO-MODE.PUMP 1 0)
(DEFSYSBYTE %%FPA1.IO-MODE.CONFIG 1 1)
(DEFSYSBYTE %%FPA1.IO-MODE.DELAY-LOAD 1 2)
(DEFSYSBYTE %%FPA1.IO-MODE.DELAY-STORE-DATA 1 3)
(DEFSYSBYTE %%FPA1.IO-MODE.DELAY-STORE 1 4)
(DEFSYSBYTE %%FPA1.FPEX-DELAY 1 5)
(DEFSYSBYTE %%FPA1.BYPASS-ON 1 6)
(DEFSYSBYTE %%FPA1.MBZ-OR-XL-SOFTWARE-UNDERFLOW 1 7)

;;; fpa-trap-enables-2 and fpa-sticky-bits-3
(DEFSYSBYTE %%FPA.IOVF 1 0)
(DEFSYSBYTE %%FPA.INX 1 1)
(DEFSYSBYTE %%FPA.UNF 1 2)
(DEFSYSBYTE %%FPA.OVF 1 3)
(DEFSYSBYTE %%FPA.DNRM 1 4)
(DEFSYSBYTE %%FPA.DVZ 1 5)
(DEFSYSBYTE %%FPA.INV 1 6)
(DEFSYSBYTE %%FPA.NAN 1 7)

;;; fpa-multiply-destination-0
(DEFSYSBYTE %%FPA4.MDEST0 5 0)
(DEFSYSBYTE %%FPA4.TDEST0 2 5)
(DEFSYSBYTE %%FPA4.SR4-MBZ 1 7)

;;; fpa-alu-destination-0
(DEFSYSBYTE %%FPA5.ADEST0 5 0)
(DEFSYSBYTE %%FPA5.SR5-MBZ 3 5)

;;; fpa-multiply-status-0
(DEFSYSBYTE %%FPA6.MSTAT0 4 0)
(DEFSYSBYTE %%FPA6.ASTAT0 4 4)

;;; fpa-divide-destination
(DEFSYSBYTE %%FPA7.DIVDEST 5 0)
(DEFSYSBYTE %%FPA7.SR7-MBZ 3 5)

;;; fpa-multiply-destination-1
(DEFSYSBYTE %%FPA8.MDEST1 5 0)
(DEFSYSBYTE %%FPA8.TDEST1 2 5)
(DEFSYSBYTE %%FPA8.SR8-MBZ 1 7)

;;; fpa-alu-destination-1
(DEFSYSBYTE %%FPA9.ADEST1 5 0)
(DEFSYSBYTE %%FPA9.SR9-MBZ 3 5)

;;; fpa-multiply-status-1
(DEFSYSBYTE %%FPA10.MSTAT1 4 0)
(DEFSYSBYTE %%FPA10.ASTAT1 4 4)

;;; fpa-divide-status
(DEFSYSBYTE %%FPA11.DIVSTAT 4 0)
(DEFSYSBYTE %%FPA11.CARRY 1 4)
(DEFSYSBYTE %%FPA11.FPCN 1 5)
(DEFSYSBYTE %%FPA11.DSR-IN-PROGRESS 1 6)	;dsr  divide/square root
(DEFSYSBYTE %%FPA11.FPEX-TAKEN 1 7)

;;;

;In %SOFTWARE-CONFIGURATION
(DEFSYSBYTE %%SOFTWARE-CONFIGURATION-LMFS-FSPT-UNIT 4 0)


;;;; Miscellaneous hardware definitions shared with FEP, Boot ROM, etc.

;;; Some board-specific registers
(DEFSTORAGE (MERLIN-II-CACHE-CONTROL-REGISTER
	      :STRUCTURE NIL
	      :FORWARDABLE NIL
	      :PHYSICAL T
	      :FIXNUM-ONLY T
	      :PRESERVE-CDR-CODES NIL
	      :DEFAULT-POINTER (SYS:%MAKE-PHYSICAL-ADDRESS #x0A000004))
  ((MERLIN-II-CACHE-CONTROL-REGISTER)
   (MERLIN-II-CACHE-CONTROL.MODE 2 0)
   (MERLIN-II-CACHE-CONTROL.DIAGNOSTIC-MODE 1 2)
   (MERLIN-II-CACHE-CONTROL.CLEAR-TAGS 1 3)))

(DEFENUMERATED *MERLIN-II-CACHE-CONTROL-MODES*
  (%MERLIN-II-CACHE-MODE-RESERVED
    %MERLIN-II-CACHE-MODE-INSTRUCTIONS-ENABLED
    %MERLIN-II-CACHE-MODE-ENABLED
    %MERLIN-II-CACHE-MODE-DISABLED))

;; For our purposes, we consider the NVRAM to consist of 8 banks of 256
;; bytes each (with the last bank containing the clock).  The FEP uses
;; the zeroth bank.  FYI, Minima uses the 1st bank (this seems like a
;; suitably unfindable place to document that.)
(DEFSTORAGE (MERLIN-NVRAM-FEP-OPTIONS
	      :STRUCTURE NIL
	      :FORWARDABLE NIL
	      :PHYSICAL T
	      :FIXNUM-ONLY T
	      :PRESERVE-CDR-CODES NIL
	      :DEFAULT-POINTER (SYS:%MAKE-PHYSICAL-ADDRESS #o01100000000))
  ;; Note only the low byte is really there
  (MERLIN-NVRAM-FEP-MAGIC-COOKIE-0 8 0)		;Sanity
  (MERLIN-NVRAM-FEP-MAGIC-COOKIE-1 8 0)		
  (MERLIN-NVRAM-FEP-OPTIONS-VERSION 8 0)	;Increments if any incompatible change
  (MERLIN-NVRAM-FEP-SIZE 8 0)			;Bytes in use
  (MERLIN-NVRAM-FEP-CHECKSUM 8 0)		;Like ID-PROM checksum, with this byte 0
  ((MERLIN-NVRAM-FEP-CHECKSUM-START)		;First checksummed byte
   (MERLIN-NVRAM-FEP-COLOR-SYSTEM-TYPE 8 0)) ;None, Univision, photon, 4-board, etc.
  (MERLIN-NVRAM-FEP-COLOR-SYSTEM-NUMBER 8 0)	;System number determines base address
  (MERLIN-NVRAM-FEP-COLOR-SYSTEM-SYNC-VERSION 8 0)	;Sanity that file is same
  (MERLIN-NVRAM-FEP-COLOR-SYSTEM-SYNC-NUMBER 8 0)	;Index into file
  (MERLIN-NVRAM-FEP-SERIAL-CONSOLE-TYPE 8 0)	;None, ASCII, X3.64, etc.
  (MERLIN-NVRAM-FEP-SERIAL-CONSOLE-PORT 8 0)	;where
  (MERLIN-NVRAM-FEP-SERIAL-CONSOLE-BAUD 8 0)	;use SERIAL;CONSOLE-INTERFACE encoding
  (MERLIN-NVRAM-FEP-SERIAL-CONSOLE-BITS 8 0)	;ditto, encodes bits, stop, parity
  ;; serial height, width, meta-p, etc?
  (MERLIN-NVRAM-FEP-PRINT-ERRORS 8 0)		;FEP *print-errors* setting
  (MERLIN-NVRAM-FEP-PLAY-MUSIC 8 0)
  (MERLIN-NVRAM-FEP-DEVICE-PROM-DEBUGGING 8 0)
  )

(DEFSYSCONSTANT %MERLIN-NVRAM-FEP-MAGIC-COOKIE-0 #o125)
(DEFSYSCONSTANT %MERLIN-NVRAM-FEP-MAGIC-COOKIE-1 #o252)
(DEFSYSCONSTANT %MERLIN-NVRAM-FEP-OPTIONS-VERSION 1)

(DEFENUMERATED *FEP-COLOR-SYSTEM-TYPES*
  (%FEP-COLOR-SYSTEM-TYPE-NONE
   %FEP-COLOR-SYSTEM-TYPE-UNIVISION
   %FEP-COLOR-SYSTEM-TYPE-FRAMETHROWER))

(DEFENUMERATED *FEP-SERIAL-CONSOLE-TYPES*
  (%FEP-SERIAL-CONSOLE-TYPE-NONE
   %FEP-SERIAL-CONSOLE-TYPE-ASCII
   %FEP-SERIAL-CONSOLE-TYPE-X3.64))

(DEFENUMERATED *IVORY-REVISIONS*
  (%IVORY-REVISION-0
   %IVORY-REVISION-1?
   %IVORY-REVISION-1
   %IVORY-REVISION-2?
   %IVORY-REVISION-2
   %IVORY-REVISION-2A
   %IVORY-REVISION-2B
   %IVORY-REVISION-3?
   %IVORY-REVISION-3
   %IVORY-REVISION-4?
   %IVORY-REVISION-4
   %IVORY-REVISION-4A
   %IVORY-REVISION-5))
